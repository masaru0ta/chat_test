// ▼ ここにコピーしたIDを貼り付けてください ▼
const SPREADSHEET_ID = '1pkQRmrP4IIqN-SmfZCIFuPmhurLob-UAGDlDnEMxGaU';
// デフォルトのシート名（パラメータがない場合はこれを使用）
const DEFAULT_SHEET_NAME = 'action';

/**
 * 共通のシート取得関数
 * ID指定で確実にシートをつかみます
 * @param {string} sheetName - 取得したいシート名
 */
function getSheet(sheetName) {
  return SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(sheetName);
}

/**
 * 読み取り (GET)
 * URLパラメータ 'sheet' でシート名を指定可能にする
 * 例: .../exec?sheet=character
 * メタデータのみ取得: .../exec?meta=true
 */
function doGet(e) {
  // メタデータのみ返す（最終更新日時）
  if (e.parameter.meta === 'true') {
    var file = DriveApp.getFileById(SPREADSHEET_ID);
    var driveUpdated = file.getLastUpdated();

    // API経由の更新日時を取得
    var apiUpdatedStr = PropertiesService.getScriptProperties().getProperty('lastUpdated');
    var apiUpdated = apiUpdatedStr ? new Date(apiUpdatedStr) : null;

    // 新しい方を返す
    var lastUpdated = (apiUpdated && apiUpdated > driveUpdated) ? apiUpdated : driveUpdated;

    return ContentService.createTextOutput(JSON.stringify({
      lastUpdated: lastUpdated.toISOString()
    }));
  }

  // パラメータからシート名を取得。指定がなければ DEFAULT_SHEET_NAME を使用
  var sheetName = e.parameter.sheet || DEFAULT_SHEET_NAME;

  var sheet = getSheet(sheetName);

  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({
      error: "Sheet not found",
      requested_sheet: sheetName,
      message: "指定されたシート（" + sheetName + "）が見つかりません。"
    }))
    .setMimeType(ContentService.MimeType.JSON);
  }

  var rows = sheet.getDataRange().getValues();

  if (rows.length === 0) {
    return ContentService.createTextOutput(JSON.stringify([]))
      .setMimeType(ContentService.MimeType.JSON);
  }

  var headers = rows.shift();

  var data = rows.map(function(row) {
    var obj = {};
    headers.forEach(function(header, i) {
      if (header) obj[header] = row[i];
    });
    return obj;
  });

  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * 書き込み (POST)
 * URLパラメータ 'sheet' でシート名を指定可能にする
 * action=update で単一フィールド更新モード
 */
function doPost(e) {
  try {
    var sheetName = e.parameter.sheet || DEFAULT_SHEET_NAME;
    var sheet = getSheet(sheetName);

    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: 'Sheet not found: ' + sheetName
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // 単一フィールド更新モード
    if (e.parameter.action === 'update') {
      var updateData = JSON.parse(e.postData.contents);
      var updateHeaders = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      var idColIndex = updateHeaders.indexOf(updateData.idField) + 1;
      var fieldColIndex = updateHeaders.indexOf(updateData.fieldName) + 1;

      if (idColIndex <= 0) {
        return ContentService.createTextOutput(JSON.stringify({
          status: 'error',
          message: 'ID column not found: ' + updateData.idField
        })).setMimeType(ContentService.MimeType.JSON);
      }
      if (fieldColIndex <= 0) {
        return ContentService.createTextOutput(JSON.stringify({
          status: 'error',
          message: 'Field column not found: ' + updateData.fieldName
        })).setMimeType(ContentService.MimeType.JSON);
      }

      var updateLastRow = sheet.getLastRow();
      if (updateLastRow > 1) {
        var idValues = sheet.getRange(2, idColIndex, updateLastRow - 1, 1).getValues();
        for (var i = 0; i < idValues.length; i++) {
          if (idValues[i][0] === updateData.idValue) {
            sheet.getRange(i + 2, fieldColIndex).setValue(updateData.fieldValue);
            PropertiesService.getScriptProperties().setProperty('lastUpdated', new Date().toISOString());
            return ContentService.createTextOutput(JSON.stringify({
              status: 'success',
              message: 'Updated ' + updateData.fieldName + ' for ' + updateData.idValue
            })).setMimeType(ContentService.MimeType.JSON);
          }
        }
      }
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: 'Record not found: ' + updateData.idValue
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // 通常の全体書き込みモード
    var lastRow = sheet.getLastRow();
    var currentDataCount = lastRow > 1 ? lastRow - 1 : 0;

    var parsedData = JSON.parse(e.postData.contents);
    var dataList = Array.isArray(parsedData) ? parsedData : [parsedData];

    var IS_LOG_SHEET = sheetName === 'llm_req_log';

    // 安全装置（llm_req_log の場合のみ制限を解除）
    if (!IS_LOG_SHEET && dataList.length < currentDataCount) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: 'Safety Check Failed: Received ' + dataList.length + ' rows, but sheet has ' + currentDataCount + ' rows. Update aborted.'
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // ヘッダー取得
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

    // 書き込み用データ作成
    var newRows = dataList.map(function(item) {
      return headers.map(function(header) {
        return item[header] !== undefined ? item[header] : '';
      });
    });

    // 既存データクリア
    if (currentDataCount > 0) {
      sheet.getRange(2, 1, currentDataCount, sheet.getLastColumn()).clearContent();
    }

    // 新規データ書き込み
    if (newRows.length > 0) {
      sheet.getRange(2, 1, newRows.length, newRows[0].length).setValues(newRows);
    }

    // API更新日時を記録（ログシート以外）
    if (!IS_LOG_SHEET) {
      PropertiesService.getScriptProperties().setProperty('lastUpdated', new Date().toISOString());
    }

    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      message: 'Replaced all data. Old: ' + currentDataCount + ', New: ' + newRows.length + (IS_LOG_SHEET ? ' (Log sheet override allowed)' : '')
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
