<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generator (GAS連携)</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        /* ページ固有スタイル */
        .container { max-width: 1200px; }

        #status { margin-top: 10px; }

        .btn-generate { font-size: 16px; padding: 12px 30px; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
        }

        .panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            margin: 0 0 15px 0;
            color: #4a9eff;
            font-size: 1.1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a2a2a;
            color: #fff;
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .result-panel {
            display: flex;
            flex-direction: column;
        }

        #result-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            border-radius: 4px;
            padding: 10px;
        }

        #result-container img {
            max-width: 100%;
            border-radius: 4px;
        }

        .result-placeholder {
            color: #666;
            text-align: center;
        }

        .generation-info {
            margin-top: 10px;
            padding: 10px;
            background: #222;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #888;
        }

        .prompt-preview {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 10px;
            word-break: break-word;
        }

        .prompt-preview strong {
            color: #4a9eff;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Image Generator (GAS連携)</h1>

    <div class="main-content">
        <div class="panel">
            <h2>生成設定</h2>

            <div class="form-group">
                <label>モデル</label>
                <select id="model">
                    <option value="">-- GASから読み込んでください --</option>
                </select>
            </div>

            <div class="form-group">
                <label>キャラクター</label>
                <select id="character" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>場所</label>
                <select id="place" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>アクション</label>
                <select id="action" onchange="updateActionPrompt()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>構図</label>
                <select id="composition" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>追加プロンプト</label>
                <textarea id="customPrompt" placeholder="追加のプロンプトを入力"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>幅</label>
                    <input type="number" id="width" value="1024" min="512" max="2048" step="64">
                </div>
                <div class="form-group">
                    <label>高さ</label>
                    <input type="number" id="height" value="1024" min="512" max="2048" step="64">
                </div>
            </div>

            <div class="form-group">
                <label>Seed (-1=ランダム)</label>
                <input type="number" id="seed" value="-1">
            </div>

            <div class="prompt-preview">
                <strong>プロンプトプレビュー:</strong><br>
                <span id="promptPreview" style="color: #27ae60;">--</span>
                <br><br>
                <strong>ネガティブ:</strong><br>
                <span id="negativePreview" style="color: #e74c3c;">--</span>
            </div>

        </div>

        <div class="panel result-panel">
            <h2>生成結果</h2>
            <div style="margin-bottom: 15px; text-align: center;">
                <button class="btn btn-generate" onclick="handleGenerateImage()" id="generateBtn">画像生成</button>
            </div>
            <div id="result-container">
                <div class="result-placeholder">画像を生成してください</div>
            </div>
            <div id="generation-info" class="generation-info" style="display: none;"></div>
        </div>
    </div>

    <div class="settings-bar" style="margin-top: 20px;">
        <div class="settings-row">
            <label>GAS URL:</label>
            <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
            <button class="btn btn-primary" onclick="loadAllFromGas()">GASから読み込み</button>
        </div>
        <div class="settings-row">
            <label>Runware API Key:</label>
            <input type="password" id="apiKey" placeholder="Runware API Keyを入力">
        </div>
        <div id="status"></div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/prompt-utils.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script>
    // ページ固有のストレージキー
    const GAS_URL_KEY = 'image_gen_gas_url';
    const API_KEY_KEY = 'image_gen_api_key';

    // データストア
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let relationships = [];
    let costumes = [];

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
        // 共通関数で設定を読み込み
        const settings = loadSettings(GAS_URL_KEY, API_KEY_KEY);
        if (settings.gasUrl) {
            document.getElementById('gasUrl').value = settings.gasUrl;
        }
        if (settings.apiKey) {
            document.getElementById('apiKey').value = settings.apiKey;
        }

        // プロンプトプレビュー更新（customPromptのみ編集可能）
        document.getElementById('customPrompt').addEventListener('input', updatePromptPreview);
    });

    function doSaveSettings() {
        const gasUrl = document.getElementById('gasUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        saveSettings(GAS_URL_KEY, API_KEY_KEY, gasUrl, apiKey);
    }

    // GASから全データ読み込み
    async function loadAllFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        doSaveSettings();
        showStatus('読み込み中...', 'loading');

        try {
            // モデル、キャラクター、場所、アクション、関係性、衣装を並列で読み込み
            const [modelData, characterData, placeData, actionData, relationshipData, costumeData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action'),
                fetchGasData(baseUrl, 'relationship'),
                fetchGasData(baseUrl, 'costume')
            ]);

            models = parseModels(modelData);
            updateModelSelect();

            characters = parseCharacters(characterData);
            updateCharacterSelect();

            places = parsePlaces(placeData);
            updatePlaceSelect();

            actions = parseActionsWithCompositions(actionData);
            updateActionSelect();

            relationships = parseRelationships(relationshipData);
            costumes = parseCostumes(costumeData);

            showStatus(`読み込み完了: モデル${Object.keys(models).length}件, キャラ${characters.length}件, 場所${places.length}件, アクション${actions.length}件`);

        } catch (error) {
            console.error(error);
            showStatus('読み込みエラー: ' + error.message, 'error');
        }
    }

    function updateModelSelect() {
        const select = document.getElementById('model');
        select.innerHTML = '<option value="">-- モデルを選択 --</option>';
        Object.keys(models).forEach(modelId => {
            const option = document.createElement('option');
            option.value = modelId;
            option.textContent = models[modelId].name;
            select.appendChild(option);
        });

        // 最初のモデルを選択してデフォルト値を適用
        if (Object.keys(models).length > 0) {
            select.value = Object.keys(models)[0];
            applyModelDefaults();
        }
    }

    function updateCharacterSelect() {
        const select = document.getElementById('character');
        select.innerHTML = '<option value="">（なし）</option>';
        characters.forEach((char, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = char.name + (char.series ? ` (${char.series})` : '');
            select.appendChild(option);
        });
    }

    function updatePlaceSelect() {
        const select = document.getElementById('place');
        select.innerHTML = '<option value="">（なし）</option>';
        places.forEach((place, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = place.name;
            select.appendChild(option);
        });
    }

    // 選択データ取得ヘルパー
    function getSelectedModelData(prop) {
        const id = document.getElementById('model').value;
        return (id && models[id]) ? (models[id][prop] || '') : '';
    }

    function getSelectedData(selectId, dataArray, prop) {
        const idx = document.getElementById(selectId).value;
        return (idx !== '' && dataArray[idx]) ? (dataArray[idx][prop] || '') : '';
    }

    function updateActionSelect() {
        const select = document.getElementById('action');
        select.innerHTML = '<option value="">（なし）</option>';
        actions.forEach((action, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = action.name;
            select.appendChild(option);
        });
    }

    function applyModelDefaults() {
        updatePromptPreview();
    }

    function updateActionPrompt() {
        const index = document.getElementById('action').value;
        const compositions = (index !== '' && actions[index]) ? actions[index].compositions : [];
        updateCompositionSelect(compositions);
        updatePromptPreview();
    }

    function updateCompositionSelect(compositions) {
        const select = document.getElementById('composition');
        const previousValue = select.value;
        select.innerHTML = '<option value="">（なし）</option>';

        if (compositions && compositions.length > 0) {
            // BESTオプションを追加
            const bestOption = document.createElement('option');
            bestOption.value = 'BEST';
            bestOption.textContent = 'BEST（自動選択）';
            select.appendChild(bestOption);

            // 個別の構図を追加
            compositions.forEach((comp, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = comp.name + (comp.quality ? ` [${comp.quality}]` : '');
                select.appendChild(option);
            });

            // 以前BESTだった場合は維持、そうでなければデフォルトでBEST
            if (previousValue === 'BEST' || previousValue === '') {
                select.value = 'BEST';
            } else {
                // 以前の選択を維持しようとする（同じインデックスがあれば）
                const prevIndex = parseInt(previousValue);
                if (!isNaN(prevIndex) && prevIndex < compositions.length) {
                    select.value = prevIndex;
                } else {
                    select.value = 'BEST';
                }
            }
        }
    }

    // selectBestComposition は js/prompt-utils.js で定義

    function getSelectedCompositionTag() {
        const actionIndex = document.getElementById('action').value;
        const compValue = document.getElementById('composition').value;

        if (actionIndex !== '' && compValue !== '' && actions[actionIndex]) {
            const compositions = actions[actionIndex].compositions;

            // BEST選択時
            if (compValue === 'BEST') {
                const selected = selectBestComposition(compositions);
                if (selected) {
                    return selected.tag || selected.name || '';
                }
                return '';
            }

            // 通常の構図選択
            const compIndex = parseInt(compValue);
            if (compositions && compositions[compIndex]) {
                return compositions[compIndex].tag || compositions[compIndex].name || '';
            }
        }
        return '';
    }

    function getSelectedCharacter() {
        const charIdx = document.getElementById('character').value;
        return (charIdx !== '' && characters[charIdx]) ? characters[charIdx] : null;
    }

    function buildPrompt() {
        const parts = [
            getSelectedModelData('qualityPositive'),
            getSelectedData('character', characters, 'tag'),
            getSelectedData('place', places, 'tag'),
            getSelectedData('action', actions, 'prompt'),
            getSelectedCompositionTag(),
            document.getElementById('customPrompt').value.trim(),
            getSelectedData('place', places, 'additionalTag'),
            getSelectedData('character', characters, 'additionalTag')
        ].filter(p => p);
        return cleanPrompt(parts.join(', '));
    }

    function buildNegativePrompt() {
        return getSelectedModelData('qualityNegative');
    }

    function updatePromptPreview() {
        // プレビューでは置換後の結果を表示
        const prompt = replaceCharacterTags(buildPrompt(), getSelectedCharacter());
        document.getElementById('promptPreview').textContent = prompt || '--';
        document.getElementById('negativePreview').textContent = buildNegativePrompt() || '--';
    }

    async function handleGenerateImage() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return;
        }

        const modelId = document.getElementById('model').value;
        if (!modelId) {
            alert('モデルを選択してください');
            return;
        }

        doSaveSettings();

        const model = models[modelId];
        const prompt = buildPrompt();
        const negativePrompt = buildNegativePrompt();
        const steps = model?.steps || 20;
        const cfgScale = model?.cfgScale || 7;
        const scheduler = model?.scheduler || 'Default';
        const width = parseInt(document.getElementById('width').value);
        const height = parseInt(document.getElementById('height').value);
        let seed = parseInt(document.getElementById('seed').value);
        if (seed === -1) seed = undefined;

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.textContent = '生成中...';

        const resultContainer = document.getElementById('result-container');
        resultContainer.innerHTML = '<div class="result-placeholder">生成中...</div>';

        const startTime = Date.now();

        try {
            const result = await generateImage(apiKey, modelId, prompt, {
                negativePrompt: negativePrompt,
                steps: steps,
                cfgScale: cfgScale,
                scheduler: scheduler,
                width: width,
                height: height,
                seed: seed,
                character: getSelectedCharacter()
            });

            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

            resultContainer.innerHTML = `<img src="${result.imageURL}" alt="Generated Image" onclick="window.open('${result.imageURL}', '_blank')">`;

            const infoDiv = document.getElementById('generation-info');
            infoDiv.style.display = 'block';
            infoDiv.innerHTML = `
                <div><strong>モデル:</strong> ${model?.name || modelId}</div>
                <div><strong>Seed:</strong> ${result.seed} | <strong>Steps:</strong> ${steps} | <strong>CFG:</strong> ${cfgScale}</div>
                <div><strong>生成時間:</strong> ${elapsed}秒</div>
            `;

        } catch (error) {
            console.error(error);
            resultContainer.innerHTML = `<div class="result-placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = '画像生成';
        }
    }

    // モデル選択時にデフォルト適用
    document.getElementById('model').addEventListener('change', applyModelDefaults);
</script>

</body>
</html>
