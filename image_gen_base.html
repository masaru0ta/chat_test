<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generator (GAS連携)</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background-color: #0a0a0a;
            color: #e0e0e0;
            margin: 0;
        }
        h1 { color: #4a9eff; margin-bottom: 20px; }

        .container { max-width: 1200px; margin: 0 auto; }

        .settings-bar {
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .settings-row:last-child { margin-bottom: 0; }

        .settings-bar label {
            font-weight: bold;
            color: #888;
            font-size: 0.9rem;
        }

        .settings-bar input[type="text"],
        .settings-bar input[type="password"] {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a2a2a;
            color: #fff;
        }

        .btn {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background-color: #4a9eff; }
        .btn-primary:hover:not(:disabled) { background-color: #3a8eef; }
        .btn-success { background-color: #27ae60; }
        .btn-success:hover:not(:disabled) { background-color: #219a52; }
        .btn-generate { background-color: #9b59b6; font-size: 16px; padding: 12px 30px; }
        .btn-generate:hover:not(:disabled) { background-color: #8e44ad; }

        #status {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
            font-size: 0.9rem;
        }
        .status-ok { background-color: #155724; color: #d4edda; display: block !important; }
        .status-err { background-color: #721c24; color: #f8d7da; display: block !important; }
        .status-loading { background-color: #0c5460; color: #d1ecf1; display: block !important; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
        }

        .panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            margin: 0 0 15px 0;
            color: #4a9eff;
            font-size: 1.1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a2a2a;
            color: #fff;
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        .display-field {
            padding: 10px;
            background: #111;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #aaa;
            word-break: break-word;
            min-height: 40px;
        }

        .display-field.positive { color: #27ae60; }
        .display-field.negative { color: #e74c3c; }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .result-panel {
            display: flex;
            flex-direction: column;
        }

        #result-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            border-radius: 4px;
            padding: 10px;
        }

        #result-container img {
            max-width: 100%;
            border-radius: 4px;
        }

        .result-placeholder {
            color: #666;
            text-align: center;
        }

        .generation-info {
            margin-top: 10px;
            padding: 10px;
            background: #222;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #888;
        }

        .prompt-preview {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 10px;
            word-break: break-word;
        }

        .prompt-preview strong {
            color: #4a9eff;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Image Generator (GAS連携)</h1>

    <div class="main-content">
        <div class="panel">
            <h2>生成設定</h2>

            <div class="form-group">
                <label>モデル</label>
                <select id="model">
                    <option value="">-- GASから読み込んでください --</option>
                </select>
            </div>

            <!-- 非表示の品質プロンプト（内部用） -->
            <div id="qualityPrompt" style="display:none;">--</div>
            <div id="qualityNegativePrompt" style="display:none;">--</div>

            <div class="form-group">
                <label>キャラクター</label>
                <select id="character" onchange="updateCharacterTag()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <!-- 非表示のキャラタグ（内部用） -->
            <div id="characterTag" style="display:none;">--</div>

            <div class="form-group">
                <label>場所</label>
                <select id="place" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <!-- 非表示の場所タグ（内部用） -->
            <div id="placeTag" style="display:none;">--</div>
            <div id="placeAdditionalTag" style="display:none;">--</div>

            <div class="form-group">
                <label>アクション</label>
                <select id="action" onchange="updateActionPrompt()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <!-- 非表示のアクションプロンプト（内部用） -->
            <div id="actionPrompt" style="display:none;">--</div>

            <div class="form-group">
                <label>構図</label>
                <select id="composition" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <!-- 非表示の構図タグ（内部用） -->
            <div id="compositionTag" style="display:none;">--</div>

            <div class="form-group">
                <label>追加プロンプト</label>
                <textarea id="customPrompt" placeholder="追加のプロンプトを入力"></textarea>
            </div>

            <!-- 非表示のSteps/CFG（内部用） -->
            <input type="hidden" id="steps" value="20">
            <input type="hidden" id="cfgScale" value="7">

            <div class="form-row">
                <div class="form-group">
                    <label>Seed (-1=ランダム)</label>
                    <input type="number" id="seed" value="-1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>幅</label>
                    <input type="number" id="width" value="1024" min="512" max="2048" step="64">
                </div>
                <div class="form-group">
                    <label>高さ</label>
                    <input type="number" id="height" value="1024" min="512" max="2048" step="64">
                </div>
            </div>

            <div class="prompt-preview">
                <strong>プロンプトプレビュー:</strong><br>
                <span id="promptPreview" style="color: #27ae60;">--</span>
                <br><br>
                <strong>ネガティブ:</strong><br>
                <span id="negativePreview" style="color: #e74c3c;">--</span>
            </div>

        </div>

        <div class="panel result-panel">
            <h2>生成結果</h2>
            <div style="margin-bottom: 15px; text-align: center;">
                <button class="btn btn-generate" onclick="generateImage()" id="generateBtn">画像生成</button>
            </div>
            <div id="result-container">
                <div class="result-placeholder">画像を生成してください</div>
            </div>
            <div id="generation-info" class="generation-info" style="display: none;"></div>
        </div>
    </div>

    <div class="settings-bar" style="margin-top: 20px;">
        <div class="settings-row">
            <label>GAS URL:</label>
            <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
            <button class="btn btn-primary" onclick="loadAllFromGas()">GASから読み込み</button>
        </div>
        <div class="settings-row">
            <label>Runware API Key:</label>
            <input type="password" id="apiKey" placeholder="Runware API Keyを入力">
        </div>
        <div id="status"></div>
    </div>
</div>

<script>
    const API_BASE = 'https://api.runware.ai/v1';
    const GAS_URL_KEY = 'image_gen_gas_url';
    const API_KEY_KEY = 'image_gen_api_key';

    // データストア
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];

    // 構図のカラム名一覧
    const COMPOSITION_KEYS = ['pov', 'front view', 'side view', 'from above', 'low angle', 'from behind', 'crotch focus'];

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
        const savedGasUrl = localStorage.getItem(GAS_URL_KEY);
        if (savedGasUrl) {
            document.getElementById('gasUrl').value = savedGasUrl;
        }
        const savedApiKey = localStorage.getItem(API_KEY_KEY);
        if (savedApiKey) {
            document.getElementById('apiKey').value = savedApiKey;
        }

        // プロンプトプレビュー更新（customPromptのみ編集可能）
        document.getElementById('customPrompt').addEventListener('input', updatePromptPreview);
    });

    function showStatus(msg, type = 'ok') {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = type === 'error' ? 'status-err' : type === 'loading' ? 'status-loading' : 'status-ok';
    }

    function saveSettings() {
        const gasUrl = document.getElementById('gasUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        if (gasUrl) localStorage.setItem(GAS_URL_KEY, gasUrl);
        if (apiKey) localStorage.setItem(API_KEY_KEY, apiKey);
    }

    // GASから全データ読み込み
    async function loadAllFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        saveSettings();
        showStatus('読み込み中...', 'loading');

        try {
            // モデル、キャラクター、場所、アクションを並列で読み込み
            const [modelData, characterData, placeData, actionData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action')
            ]);

            // モデル設定
            models = {};
            modelData.forEach(item => {
                const modelId = item.model_id || item.id;
                if (modelId) {
                    models[modelId] = {
                        name: item.name || modelId,
                        steps: parseInt(item.steps) || 20,
                        cfgScale: parseFloat(item.cfg) || 7,
                        scheduler: item.scheduler || 'Default',
                        qualityPositive: item['prompt positive'] || '',
                        qualityNegative: item['prompt negative'] || ''
                    };
                }
            });
            updateModelSelect();

            // キャラクター設定
            characters = characterData.map(item => ({
                name: item.name || '',
                series: item.series || '',
                tag: item.tag || '',
                profile: item.profile || ''
            }));
            updateCharacterSelect();

            // 場所設定
            places = placeData.map(item => ({
                name: item.name || '',
                tag: item.tag || '',
                additionalTag: item['additional tag'] || ''
            }));
            updatePlaceSelect();

            // アクション設定（構図情報も含める）
            actions = actionData.map(item => {
                const action = {
                    name: item['action name'] || '',
                    prompt: item.prompt || '',
                    compositions: []
                };
                // 構図情報を読み込み（NGでないもののみ）
                COMPOSITION_KEYS.forEach(key => {
                    const qualityKey = key + ' quality';
                    const tagKey = key + ' tag';
                    const quality = item[qualityKey] || '';
                    const tag = item[tagKey] || '';
                    if (quality !== 'NG') {
                        action.compositions.push({
                            name: key,
                            tag: tag
                        });
                    }
                });
                return action;
            });
            updateActionSelect();

            showStatus(`読み込み完了: モデル${Object.keys(models).length}件, キャラ${characters.length}件, 場所${places.length}件, アクション${actions.length}件`);

        } catch (error) {
            console.error(error);
            showStatus('読み込みエラー: ' + error.message, 'error');
        }
    }

    async function fetchGasData(baseUrl, sheet) {
        const url = baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'sheet=' + sheet;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`${sheet}: HTTP ${response.status}`);
        return await response.json();
    }

    function updateModelSelect() {
        const select = document.getElementById('model');
        select.innerHTML = '<option value="">-- モデルを選択 --</option>';
        Object.keys(models).forEach(modelId => {
            const option = document.createElement('option');
            option.value = modelId;
            option.textContent = models[modelId].name;
            select.appendChild(option);
        });

        // 最初のモデルを選択してデフォルト値を適用
        if (Object.keys(models).length > 0) {
            select.value = Object.keys(models)[0];
            applyModelDefaults();
        }
    }

    function updateCharacterSelect() {
        const select = document.getElementById('character');
        select.innerHTML = '<option value="">（なし）</option>';
        characters.forEach((char, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = char.name + (char.series ? ` (${char.series})` : '');
            select.appendChild(option);
        });
    }

    function updatePlaceSelect() {
        const select = document.getElementById('place');
        select.innerHTML = '<option value="">（なし）</option>';
        places.forEach((place, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = place.name;
            select.appendChild(option);
        });
    }

    function getSelectedPlaceTag() {
        const index = document.getElementById('place').value;
        if (index !== '' && places[index]) {
            return places[index].tag || '';
        }
        return '';
    }

    function getSelectedPlaceAdditionalTag() {
        const index = document.getElementById('place').value;
        if (index !== '' && places[index]) {
            return places[index].additionalTag || '';
        }
        return '';
    }

    function updateActionSelect() {
        const select = document.getElementById('action');
        select.innerHTML = '<option value="">（なし）</option>';
        actions.forEach((action, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = action.name;
            select.appendChild(option);
        });
    }

    function applyModelDefaults() {
        const modelId = document.getElementById('model').value;
        if (modelId && models[modelId]) {
            const m = models[modelId];
            document.getElementById('steps').value = m.steps;
            document.getElementById('cfgScale').value = m.cfgScale;
            document.getElementById('qualityPrompt').textContent = m.qualityPositive || '--';
            document.getElementById('qualityNegativePrompt').textContent = m.qualityNegative || '--';
        } else {
            document.getElementById('qualityPrompt').textContent = '--';
            document.getElementById('qualityNegativePrompt').textContent = '--';
        }
        updatePromptPreview();
    }

    function updateCharacterTag() {
        const index = document.getElementById('character').value;
        if (index !== '' && characters[index]) {
            document.getElementById('characterTag').textContent = characters[index].tag || '--';
        } else {
            document.getElementById('characterTag').textContent = '--';
        }
        updatePromptPreview();
    }

    function updateActionPrompt() {
        const index = document.getElementById('action').value;
        if (index !== '' && actions[index]) {
            document.getElementById('actionPrompt').textContent = actions[index].prompt || '--';
            updateCompositionSelect(actions[index].compositions);
        } else {
            document.getElementById('actionPrompt').textContent = '--';
            updateCompositionSelect([]);
        }
        updatePromptPreview();
    }

    function updateCompositionSelect(compositions) {
        const select = document.getElementById('composition');
        select.innerHTML = '<option value="">（なし）</option>';

        if (compositions && compositions.length > 0) {
            compositions.forEach((comp, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = comp.name;
                select.appendChild(option);
            });
        }

        // 構図タグをリセット
        document.getElementById('compositionTag').textContent = '--';
    }

    function getSelectedCompositionTag() {
        const actionIndex = document.getElementById('action').value;
        const compIndex = document.getElementById('composition').value;

        if (actionIndex !== '' && compIndex !== '' && actions[actionIndex]) {
            const compositions = actions[actionIndex].compositions;
            if (compositions && compositions[compIndex]) {
                // タグがあればタグを、なければ構図名自体を返す
                return compositions[compIndex].tag || compositions[compIndex].name || '';
            }
        }
        return '';
    }

    function getDisplayFieldText(id) {
        const text = document.getElementById(id).textContent.trim();
        return text === '--' ? '' : text;
    }

    function updatePromptPreview() {
        const qualityPrompt = getDisplayFieldText('qualityPrompt');
        const characterTag = getDisplayFieldText('characterTag');
        const placeTag = getSelectedPlaceTag();
        const actionPrompt = getDisplayFieldText('actionPrompt');
        const compositionTag = getSelectedCompositionTag();
        const customPrompt = document.getElementById('customPrompt').value.trim();
        const placeAdditionalTag = getSelectedPlaceAdditionalTag();

        const parts = [qualityPrompt, characterTag, placeTag, actionPrompt, compositionTag, customPrompt, placeAdditionalTag].filter(p => p);
        const fullPrompt = parts.join(', ');

        document.getElementById('promptPreview').textContent = fullPrompt || '--';

        const negativePrompt = getDisplayFieldText('qualityNegativePrompt');
        document.getElementById('negativePreview').textContent = negativePrompt || '--';
    }

    function buildPrompt() {
        const qualityPrompt = getDisplayFieldText('qualityPrompt');
        const characterTag = getDisplayFieldText('characterTag');
        const placeTag = getSelectedPlaceTag();
        const actionPrompt = getDisplayFieldText('actionPrompt');
        const compositionTag = getSelectedCompositionTag();
        const customPrompt = document.getElementById('customPrompt').value.trim();
        const placeAdditionalTag = getSelectedPlaceAdditionalTag();

        return [qualityPrompt, characterTag, placeTag, actionPrompt, compositionTag, customPrompt, placeAdditionalTag].filter(p => p).join(', ');
    }

    function buildNegativePrompt() {
        return getDisplayFieldText('qualityNegativePrompt');
    }

    // 画像生成
    async function generateImage() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return;
        }

        const modelId = document.getElementById('model').value;
        if (!modelId) {
            alert('モデルを選択してください');
            return;
        }

        saveSettings();

        const prompt = buildPrompt();
        const negativePrompt = buildNegativePrompt();
        const steps = parseInt(document.getElementById('steps').value);
        const cfgScale = parseFloat(document.getElementById('cfgScale').value);
        const width = parseInt(document.getElementById('width').value);
        const height = parseInt(document.getElementById('height').value);
        let seed = parseInt(document.getElementById('seed').value);
        if (seed === -1) seed = Math.floor(Math.random() * 2147483647);

        const scheduler = models[modelId]?.scheduler || 'Default';

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.textContent = '生成中...';

        const resultContainer = document.getElementById('result-container');
        resultContainer.innerHTML = '<div class="result-placeholder">生成中...</div>';

        const startTime = Date.now();

        try {
            const requestBody = {
                taskType: 'imageInference',
                taskUUID: crypto.randomUUID(),
                model: modelId,
                positivePrompt: prompt,
                steps: steps,
                CFGScale: cfgScale,
                scheduler: scheduler,
                width: width,
                height: height,
                seed: seed,
                numberResults: 1
            };

            // ネガティブプロンプトが2文字以上の場合のみ追加
            if (negativePrompt && negativePrompt.length >= 2) {
                requestBody.negativePrompt = negativePrompt;
            }

            const response = await fetch(API_BASE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify([requestBody])
            });

            const result = await response.json();
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

            if (result.data && result.data.length > 0 && result.data[0].imageURL) {
                const imageUrl = result.data[0].imageURL;
                const resultSeed = result.data[0].seed || seed;

                resultContainer.innerHTML = `<img src="${imageUrl}" alt="Generated Image" onclick="window.open('${imageUrl}', '_blank')">`;

                const infoDiv = document.getElementById('generation-info');
                infoDiv.style.display = 'block';
                infoDiv.innerHTML = `
                    <div><strong>モデル:</strong> ${models[modelId]?.name || modelId}</div>
                    <div><strong>Seed:</strong> ${resultSeed} | <strong>Steps:</strong> ${steps} | <strong>CFG:</strong> ${cfgScale}</div>
                    <div><strong>生成時間:</strong> ${elapsed}秒</div>
                `;


            } else if (result.errors) {
                throw new Error(result.errors.map(e => e.message).join(', '));
            } else {
                throw new Error('画像の生成に失敗しました');
            }

        } catch (error) {
            console.error(error);
            resultContainer.innerHTML = `<div class="result-placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = '画像生成';
        }
    }

    // モデル選択時にデフォルト適用
    document.getElementById('model').addEventListener('change', applyModelDefaults);
</script>

</body>
</html>
