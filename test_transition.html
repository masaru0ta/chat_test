<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Transition Test</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/transition.css">
</head>
<body>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆç”»åƒç”Ÿæˆç”¨ï¼‰ -->
<div class="status-indicator" id="statusIndicator">
    <div class="status-item image" id="statusImage">
        <div class="status-spinner"></div>
    </div>
</div>

<!-- ãƒ­ãƒƒã‚¯ç”»é¢ -->
<div class="lock-screen hidden" id="lockScreen">
    <div class="lock-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
    <div class="lock-input-container">
        <input type="password" class="lock-digit" id="lockDigit1" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit2" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit3" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit4" maxlength="1" inputmode="none" readonly>
    </div>
    <div class="lock-error" id="lockError"></div>
    <div class="lock-numpad">
        <button class="lock-numpad-btn" onclick="onNumpadInput('1')">1</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('2')">2</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('3')">3</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('4')">4</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('5')">5</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('6')">6</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('7')">7</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('8')">8</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('9')">9</button>
        <button class="lock-numpad-btn" style="visibility:hidden;"></button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('0')">0</button>
        <button class="lock-numpad-btn backspace" onclick="onNumpadBackspace()">âŒ«</button>
    </div>
</div>

<div class="app-container" id="appContainer">
    <!-- æ—§ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«ï¼ˆçµ±åˆãƒãƒ¼ã«ç§»å‹•ï¼‰ -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰" style="display:none;">â˜°</button>
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
        <div class="sidebar-content">
            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
            <div id="characters-container"></div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="current-state">
                <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                <div class="state-item">
                    <span class="state-label">ç¾åœ¨åœ°</span>
                    <span class="state-value" id="user-place">æœªé¸æŠ</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startInitialSetup()" style="width:100%; margin-bottom:10px;">åˆæœŸè¨­å®š</button>
            <button class="btn" onclick="openSettings()" style="width:100%; background:#333; color:#fff; border:1px solid #444; padding:10px; border-radius:4px; cursor:pointer;">è¨­å®š</button>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h3>è¨­å®š</h3>
                <button class="settings-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="settings-group">
                <label>GAS URL</label>
                <div class="settings-row">
                    <input type="text" id="gasUrl" placeholder="GAS URL" onchange="saveGasUrl()">
                    <button class="btn" id="llmLogToggle" onclick="toggleLLMLog()" style="padding:8px 12px; font-size:0.8rem;" title="LLMãƒ­ã‚°ä¿å­˜">OFF</button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="loadAllFromGas()" style="width:100%; margin-bottom:15px;">GASèª­ã¿è¾¼ã¿</button>
            <div class="settings-group">
                <label>OpenRouter API Key</label>
                <input type="password" id="chatApiKey" placeholder="OpenRouter API Key" onchange="saveChatApiKey()">
            </div>
            <div class="settings-group">
                <label>Runware API Key</label>
                <div class="settings-row">
                    <input type="password" id="runwareApiKey" placeholder="Runware API Key" onchange="saveRunwareApiKey()">
                    <button class="btn" id="imageGenToggle" onclick="toggleImageGen()" style="padding:8px 12px; font-size:0.8rem;">ON</button>
                </div>
            </div>
            <div class="settings-group">
                <label>LLMãƒ¢ãƒ‡ãƒ«</label>
                <select id="llmModelSelect" onchange="onLLMModelSelect()">
                    <option value="x-ai/grok-4.1-fast">Grok 4.1 Fast</option>
                    <option value="x-ai/grok-4-fast">Grok 4 Fast</option>
                </select>
            </div>
            <div class="settings-group">
                <label>ç”»åƒãƒ¢ãƒ‡ãƒ«</label>
                <select id="modelSelect" onchange="onModelSelect()">
                    <option value="">-- ç”»åƒãƒ¢ãƒ‡ãƒ«é¸æŠ --</option>
                </select>
            </div>
            <div class="settings-group">
                <label>ç™»å ´äººæ•°</label>
                <input type="number" id="characterCountInput" min="1" max="10" value="2" onchange="onCharacterCountChange()" style="width:80px;">
            </div>
            <div class="settings-group">
                <label>ãƒ­ãƒƒã‚¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰</label>
                <input type="password" id="lockPasswordInput" maxlength="4" placeholder="4æ¡ã®æ•°å­—" inputmode="numeric" pattern="[0-9]{4}" onchange="saveLockPassword()" style="width:100px;">
            </div>
            <div id="status"></div>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="chat-area">
        <div class="page-area">
            <div id="page-view">
            </div>
        </div>
        <!-- çµ±åˆã‚³ãƒãƒ³ãƒ‰ãƒãƒ¼ -->
        <div class="unified-command-bar">
            <button class="cmd-btn menu-btn" id="menu-toggle" onclick="toggleSidebar()">â‰¡</button>
            <button class="cmd-btn menu-btn" id="fullscreen-toggle" onclick="toggleFullscreen()">â›¶</button>
            <button class="cmd-btn" id="target-toggle" onclick="openMoveMenu()">ç§»å‹•</button>
            <button class="cmd-btn" id="cmd-toggle" onclick="openActionMenu()">è¡Œç‚º</button>
            <input type="text" class="cmd-input" id="command-input" placeholder="ç™ºè¨€..." onkeydown="if(event.key==='Enter')executeCommand()">
            <button class="cmd-btn nav-btn" id="prev-btn" onclick="prevPage()">å‰ã¸</button>
            <button class="cmd-btn nav-btn" id="next-btn" onclick="nextPage()">æ¬¡ã¸</button>
        </div>
        <!-- ç§»å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="move-menu" id="moveMenu" style="display:none;">
            <div class="move-menu-header">
                <span>ç§»å‹•å…ˆã‚’é¸æŠ</span>
                <button class="move-menu-close" onclick="closeMoveMenu()">Ã—</button>
            </div>
            <div class="move-menu-list" id="moveMenuList">
                <!-- ç§»å‹•å…ˆãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
        <!-- è¡Œç‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="action-menu" id="actionMenu" style="display:none;">
            <div class="action-menu-header">
                <span>è¡Œç‚ºã‚’é¸æŠ</span>
                <button class="action-menu-close" onclick="closeActionMenu()">Ã—</button>
            </div>
            <div class="action-menu-list" id="actionMenuList">
                <!-- è¡Œç‚ºãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script src="js/prompt-utils.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/lock-screen.js"></script>
<script>
    // ========== çŠ¶æ…‹ç®¡ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰ ==========
    const CACHE_KEY = STORAGE_KEYS.TRANSITION_CACHE;

    // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let relationships = [];
    let costumes = [];
    let promptTemplates = {};

    // ç¾åœ¨ã®çŠ¶æ…‹ï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰
    let currentState = {
        characterIndex: -1,
        placeIndex: -1,
        actionIndex: -1
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    let userState = {
        placeIndex: -1
    };

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ2äººåˆ†åˆæœŸå€¤ï¼‰
    let characterStatus = [
        { characterIndex: -1, placeIndex: -1, actionIndex: -1, relationshipId: 'rel_001', costumeId: 'cos_001', memo: '' },
        { characterIndex: -1, placeIndex: -1, actionIndex: -1, relationshipId: 'rel_001', costumeId: 'cos_001', memo: '' }
    ];

    // çŠ¶æ…‹å¤‰æ•°
    let currentCommandType = 'speech';
    let chatHistory = [];
    let actionHistory = [];
    let pages = [];
    let currentPageIndex = -1;
    let characterCount = 2;
    let imageGenEnabled = true;
    let llmLogEnabled = false;
    let selectedModelId = '';
    let selectedLLMModelId = 'x-ai/grok-4.1-fast';
    let moveWithCompanion = false;
    let isLoading = false;

    // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼è¡¨ç¤ºç”¨
    let typewriterBuffer = '';
    let typewriterDisplayed = '';
    let typewriterTimer = null;
    let typewriterPageIndex = -1;

    // characterStatusé…åˆ—ã‚’ç™»å ´äººæ•°ã«åˆã‚ã›ã¦èª¿æ•´
    function updateCharacterStatusArray() {
        while (characterStatus.length < characterCount) {
            characterStatus.push({
                characterIndex: -1,
                placeIndex: -1,
                actionIndex: -1,
                relationshipId: 'rel_001',
                costumeId: 'cos_001',
                memo: ''
            });
        }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveCachedData() {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
            models, characters, places, actions, relationships, costumes, promptTemplates
        }));
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadCachedData() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
                relationships = data.relationships || [];
                costumes = data.costumes || [];
                promptTemplates = data.promptTemplates || {};
                updateAllSelects();
                updateModelSelect();
                if (actions.length > 0) {
                    addSystemMessage(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
                }
            }
        } catch (e) {
            console.error('Cache load error:', e);
        }
    }
</script>
<script src="js/transition-page.js"></script>
<script src="js/transition-ui.js"></script>
<script src="js/transition-llm.js"></script>
<script>
    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆconstants.jsã‹ã‚‰å‚ç…§ï¼‰
    const CHARACTER_COUNT_KEY = STORAGE_KEYS.TRANSITION_CHARACTER_COUNT;
    const CHAT_API_KEY = STORAGE_KEYS.TRANSITION_CHAT_API_KEY;
    const RUNWARE_API_KEY = STORAGE_KEYS.TRANSITION_RUNWARE_API_KEY;
    const IMAGE_GEN_ENABLED_KEY = STORAGE_KEYS.TRANSITION_IMAGE_GEN_ENABLED;
    const LLM_LOG_ENABLED_KEY = STORAGE_KEYS.TRANSITION_LLM_LOG_ENABLED;
    const SELECTED_MODEL_KEY = STORAGE_KEYS.TRANSITION_SELECTED_MODEL;
    const SELECTED_LLM_MODEL_KEY = STORAGE_KEYS.TRANSITION_SELECTED_LLM_MODEL;
    const SIDEBAR_COLLAPSED_KEY = STORAGE_KEYS.TRANSITION_SIDEBAR_COLLAPSED;

    // ç§»å‹•å®Ÿè¡Œ
    async function executeMove(placeIndex) {
        const previousPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;

        // ã€Œä¸€ç·’ã«ã€ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç¾åœ¨åœ°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‚ä¸€ç·’ã«ç§»å‹•
        let companion = null;
        if (moveWithCompanion) {
            const charAtLocation = getCharacterAtUserLocation();
            if (charAtLocation) {
                companion = charAtLocation;
                const statusIndex = characterStatus.indexOf(charAtLocation.status);
                if (statusIndex >= 0) {
                    characterStatus[statusIndex].placeIndex = placeIndex;
                    // ç§»å‹•å…ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¤‰æ›´
                    const newPlace = places[placeIndex];
                    if (newPlace && newPlace.default_action) {
                        const newActionIndex = actions.findIndex(a => a.action_id === newPlace.default_action);
                        if (newActionIndex >= 0) {
                            characterStatus[statusIndex].actionIndex = newActionIndex;
                        }
                    }
                }
                updateCharacterStatusDisplay();
            }
        }

        userState.placeIndex = placeIndex;
        updateUserStatusDisplay();
        const newPlace = places[placeIndex];

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        await generatePages('move', '', previousPlace, newPlace, companion);
    }

    async function selectAction(actionIndex) {
        closeActionMenu();

        // è¡Œç‚ºã‚’å®Ÿè¡Œ
        currentState.actionIndex = actionIndex;
        await executeAction(actionIndex);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
        const modal = document.getElementById('settingsModal');
        if (e.target === modal) {
            closeSettings();
        }
    });

    // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    async function executeCommand() {
        const input = document.getElementById('command-input');
        const text = input.value.trim();

        // ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (!text) return;

        const chatApiKey = document.getElementById('chatApiKey').value.trim();
        if (!chatApiKey) {
            alert('OpenRouter API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        localStorage.setItem(CHAT_API_KEY, chatApiKey);

        if (userState.placeIndex < 0) {
            alert('åˆæœŸè¨­å®šã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
            return;
        }

        addCommandMessage(currentCommandType, text);
        input.value = '';

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        await generatePages(currentCommandType, text, null, null);
    }

    // Visual Viewportå¯¾å¿œï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ãƒ»æŠ˜ã‚Šç•³ã¿ã‚¹ãƒãƒ›å¯¾å¿œï¼‰
    function initVisualViewport() {
        let lastViewportWidth = window.innerWidth;
        let lastViewportHeight = window.innerHeight;

        function updateVisualViewport() {
            const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            document.documentElement.style.setProperty('--visual-viewport-height', vh + 'px');
        }

        function handleScreenSizeChange() {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            const widthDiff = Math.abs(newWidth - lastViewportWidth);
            const heightDiff = Math.abs(newHeight - lastViewportHeight);

            if (widthDiff > 100 || heightDiff > 100) {
                console.log('[Viewport] å¤§ããªã‚µã‚¤ã‚ºå¤‰åŒ–æ¤œå‡º:', lastViewportWidth, 'x', lastViewportHeight, '->', newWidth, 'x', newHeight);
                updateVisualViewport();
                setTimeout(updateVisualViewport, 50);
                setTimeout(updateVisualViewport, 150);
                setTimeout(updateVisualViewport, 300);
            } else {
                updateVisualViewport();
            }
            lastViewportWidth = newWidth;
            lastViewportHeight = newHeight;
        }

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', updateVisualViewport);
            window.visualViewport.addEventListener('scroll', updateVisualViewport);
        }
        window.addEventListener('resize', handleScreenSizeChange);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleScreenSizeChange, 100);
            setTimeout(handleScreenSizeChange, 300);
        });
        updateVisualViewport();
    }

    // è¨­å®šå€¤ã®å¾©å…ƒ
    function restoreSettings() {
        const settings = loadSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY);
        if (settings.gasUrl) document.getElementById('gasUrl').value = settings.gasUrl;

        const savedApiKey = localStorage.getItem(CHAT_API_KEY);
        if (savedApiKey) document.getElementById('chatApiKey').value = savedApiKey;

        const savedRunwareKey = localStorage.getItem(RUNWARE_API_KEY);
        if (savedRunwareKey) document.getElementById('runwareApiKey').value = savedRunwareKey;

        const savedImageGenEnabled = localStorage.getItem(IMAGE_GEN_ENABLED_KEY);
        imageGenEnabled = savedImageGenEnabled !== 'off';
        updateImageGenButton();

        const savedLLMLogEnabled = localStorage.getItem(LLM_LOG_ENABLED_KEY);
        llmLogEnabled = savedLLMLogEnabled === 'on';
        updateLLMLogButton();

        const savedModelId = localStorage.getItem(SELECTED_MODEL_KEY);
        if (savedModelId) selectedModelId = savedModelId;
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    function initKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextPage();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevPage();
            }
        });
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        initSidebarState();
        initTextToggle();
        initLockScreen();
        initVisualViewport();
        restoreSettings();
        initLLMModelSelect();
        initCharacterCount();
        loadCachedData();
        startInitialSetup();
        initKeyboardNavigation();
    });

    async function loadAllFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        localStorage.setItem(STORAGE_KEYS.GAS_URL, baseUrl);
        showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData, relationshipData, costumeData, promptData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action'),
                fetchGasData(baseUrl, 'relationship'),
                fetchGasData(baseUrl, 'costume'),
                fetchGasData(baseUrl, 'llm_prompt_template')
            ]);

            models = parseModels(modelData);
            characters = parseCharacters(characterData);
            places = parsePlaces(placeData);
            actions = parseActionsWithCompositions(actionData);
            relationships = parseRelationships(relationshipData);
            costumes = parseCostumes(costumeData);
            promptTemplates = parsePromptTemplates(promptData);

            saveCachedData();
            updateAllSelects();
            updateModelSelect();

            showStatus(`èª­è¾¼å®Œäº†: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
            addSystemMessage(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
        } catch (error) {
            console.error(error);
            showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    function updateAllSelects() {
        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å‰Šé™¤æ¸ˆã¿ - ä½•ã‚‚ã—ãªã„
    }

    async function executeAction(actionIndex) {
        const action = actions[actionIndex];
        if (!action) return;

        // æ—¢å­˜ã®æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
        document.querySelectorAll('.next-action-button-container').forEach(el => el.remove());

        const prevActionIndex = currentState.actionIndex;
        const prevAction = prevActionIndex >= 0 ? actions[prevActionIndex] : null;

        // çŠ¶æ…‹æ›´æ–°
        currentState.actionIndex = actionIndex;

        // åŒã˜å ´æ‰€ã«ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
        const charAtLocation = getCharacterAtUserLocation();
        let effectStatusIndex = -1;
        let effectMessages = []; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾Œã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ä¿å­˜
        if (charAtLocation) {
            const statusIndex = characterStatus.findIndex(s => s === charAtLocation.status);
            if (statusIndex >= 0) {
                characterStatus[statusIndex].actionIndex = actionIndex;
                console.log('[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ]', charAtLocation.character.name, 'ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°:', action.name);
                effectStatusIndex = statusIndex;

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®effectã‚’é©ç”¨ï¼ˆçŠ¶æ…‹å¤‰æ›´ã®ã¿ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¾Œã§ï¼‰
                effectMessages = applyActionEffect(action, charAtLocation, statusIndex);

                updateCharacterStatusDisplay();
            }
        }

        // å±¥æ­´ã«è¿½åŠ 
        actionHistory.push({
            timestamp: new Date().toISOString(),
            fromAction: prevAction?.action_id || null,
            toAction: action.action_id,
            character: charAtLocation?.character?.name || null,
            place: userState.placeIndex >= 0 ? places[userState.placeIndex]?.name : null
        });

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼‰
        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç™ºè¨€ãŒã‚ã‚Œã° action_with_speechã€ãªã‘ã‚Œã° action_select
        const commandInput = document.getElementById('command-input');
        const speechText = commandInput?.value?.trim() || '';
        if (speechText) {
            await generatePages('action_with_speech', speechText, null, null);
            commandInput.value = ''; // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        } else {
            await generatePages('action_select', action.name, null, null);
        }

        // effectãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ç”Ÿæˆå¾Œï¼‰
        if (effectMessages && effectMessages.length > 0) {
            effectMessages.forEach(msg => addSystemMessage(msg));
        }

        // next_actionãŒå®šç¾©ã•ã‚Œã¦ã„ã‚Œã°ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (action.next_action) {
            const nextAction = actions.find(a => a.action_id === action.next_action);
            if (nextAction) {
                addNextActionButton(nextAction);
            }
        }
    }

    // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    function addNextActionButton(nextAction) {
        if (pages.length === 0) return;

        const lastPageIndex = pages.length - 1;
        const page = pages[lastPageIndex];

        // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        if (page && !page.typewriterCompleted) {
            // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†ã‚’å¾…ã¤ï¼ˆæœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«å›ºå®šï¼‰
            setTypewriterCompleteCallback(() => {
                appendNextActionButtonToPage(lastPageIndex, nextAction);
            });
        } else {
            // ã™ã§ã«å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«è¿½åŠ 
            appendNextActionButtonToPage(lastPageIndex, nextAction);
        }
    }

    // ãƒšãƒ¼ã‚¸ã«ãƒœã‚¿ãƒ³ã‚’å®Ÿéš›ã«è¿½åŠ ã™ã‚‹
    function appendNextActionButtonToPage(pageIndex, nextAction) {
        const pageView = document.getElementById('page-view');
        const pageDiv = pageView.querySelector(`.page-content[data-page-index="${pageIndex}"]`);
        if (!pageDiv) return;

        const pageText = pageDiv.querySelector('.page-text');
        if (!pageText) return;

        // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚Œã°å‰Šé™¤
        const existingContainer = pageText.querySelector('.next-action-button-container');
        if (existingContainer) existingContainer.remove();

        // ãƒœã‚¿ãƒ³è¦ç´ ã‚’ä½œæˆï¼ˆtextDivã®å¤–ã€page-textã®æœ«å°¾ã«è¿½åŠ ï¼‰
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'next-action-button-container';
        buttonContainer.innerHTML = `<button class="next-action-button" data-action-id="${nextAction.action_id}">â–¶ ${nextAction.name}</button>`;
        pageText.appendChild(buttonContainer);

        // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        const button = buttonContainer.querySelector('.next-action-button');
        if (button) {
            button.addEventListener('click', async (e) => {
                e.stopPropagation(); // ãƒ†ã‚­ã‚¹ãƒˆãƒˆã‚°ãƒ«ã‚’é˜²æ­¢
                // ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                buttonContainer.remove();
                const actionId = button.dataset.actionId;
                const actionToExecute = actions.find(a => a.action_id === actionId);
                if (actionToExecute) {
                    const actionIdx = actions.indexOf(actionToExecute);
                    if (actionIdx >= 0) {
                        await executeAction(actionIdx);
                    }
                }
            });
        }
    }

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®effectã‚’é©ç”¨ï¼ˆçŠ¶æ…‹å¤‰æ›´ã‚’è¡Œã„ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’è¿”ã™ï¼‰
    function applyActionEffect(action, charAtLocation, statusIndex) {
        const messages = [];
        if (!action.effect || !charAtLocation) return messages;

        const effectStr = action.effect.trim();
        if (!effectStr) return messages;

        console.log('[Effect] åŠ¹æœã‚’è§£æ:', effectStr);

        // effectã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆå½¢å¼: relationship_id=rel_002,costume_id=cos_002 ã¾ãŸã¯ rel_002,cos_002ï¼‰
        const effects = parseEffectString(effectStr);

        // é–¢ä¿‚æ€§å¤‰æ›´
        if (effects.relationship_id) {
            const newRelationship = relationships.find(r => r.relationship_id === effects.relationship_id);
            if (newRelationship) {
                const oldRelationshipId = characterStatus[statusIndex].relationshipId;
                const oldRelationship = relationships.find(r => r.relationship_id === oldRelationshipId);
                characterStatus[statusIndex].relationshipId = effects.relationship_id;
                console.log('[Effect] é–¢ä¿‚æ€§å¤‰æ›´:', oldRelationship?.name, 'â†’', newRelationship.name);
                messages.push(`ğŸ­ ${charAtLocation.character.name}ã¨ã®é–¢ä¿‚æ€§ãŒã€Œ${oldRelationship?.name || 'ä¸æ˜'}ã€ã‹ã‚‰ã€Œ${newRelationship.name}ã€ã«å¤‰åŒ–ã—ã¾ã—ãŸ`);
            }
        }

        // æœè£…å¤‰æ›´ï¼ˆåŒã˜æœè£…ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        if (effects.costume_id) {
            const oldCostumeId = characterStatus[statusIndex].costumeId;
            if (effects.costume_id !== oldCostumeId) {
                const newCostume = costumes.find(c => c.costume_id === effects.costume_id);
                if (newCostume) {
                    const oldCostume = costumes.find(c => c.costume_id === oldCostumeId);
                    characterStatus[statusIndex].costumeId = effects.costume_id;
                    console.log('[Effect] æœè£…å¤‰æ›´:', oldCostume?.name, 'â†’', newCostume.name);
                    messages.push(`ğŸ‘— ${charAtLocation.character.name}ã®æœè£…ãŒã€Œ${oldCostume?.name || 'ä¸æ˜'}ã€ã‹ã‚‰ã€Œ${newCostume.name}ã€ã«å¤‰ã‚ã‚Šã¾ã—ãŸ`);
                }
            }
        }

        return messages;
    }

    // effectæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
    function parseEffectString(effectStr) {
        const result = { relationship_id: null, costume_id: null };

        // ã‚«ãƒ³ãƒã§åˆ†å‰²
        const parts = effectStr.split(',').map(p => p.trim()).filter(p => p);

        parts.forEach(part => {
            // key=valueå½¢å¼
            if (part.includes('=')) {
                const [key, value] = part.split('=').map(s => s.trim());
                if (key === 'relationship_id' || key === 'rel') {
                    result.relationship_id = value;
                } else if (key === 'costume_id' || key === 'cos') {
                    result.costume_id = value;
                }
            } else {
                // IDã®ã¿ã®å½¢å¼ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§åˆ¤å®šï¼‰
                if (part.startsWith('rel_')) {
                    result.relationship_id = part;
                } else if (part.startsWith('cos_')) {
                    result.costume_id = part;
                }
            }
        });

        return result;
    }

    function clearChat() {
        pages = [];
        currentPageIndex = -1;
        actionHistory = [];
        chatHistory = [];
        // DOMè¦ç´ ã‚’å…¨å‰Šé™¤
        const pageView = document.getElementById('page-view');
        pageView.innerHTML = '';
        console.log('[System] ãƒãƒ£ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // å±¥æ­´ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    function dumpHistory() {
        console.log('Action History:', actionHistory);
        return actionHistory;
    }

    // ä¼šè©±ãƒ¢ãƒ¼ãƒ‰å‡¦ç†
    async function handleConversationMode(chatApiKey, charAtLocation, currentPlace, userInput) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã‚’è¿½åŠ 
        addDialogue('ã‚ãªãŸ', `ã€Œ${userInput}ã€`);

        const { fullPrompt, simplePrompt } = buildCombinedPrompt('speech', userInput, null, null, charAtLocation, currentPlace, true);
        console.log('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] å®Œå…¨ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', fullPrompt);

        showStatusLLM();
        const response = await callLLM(chatApiKey, fullPrompt, 'character', charAtLocation.character, null, simplePrompt);
        hideStatusLLM();
        console.log('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®åˆ¤å®šã‚’æŠ½å‡º
        const { dialogue: parsedDialogue, narrative, newRelationshipName, relationshipMemo } = parseConversationResponse(response, charAtLocation);

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®å‡¦ç†
        updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo);

        if (parsedDialogue) {
            addDialogue(charAtLocation.character.name, parsedDialogue);
        } else {
            console.warn('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] ã‚»ãƒªãƒ•ãŒç©ºã§ã™');
        }
        // åœ°ã®æ–‡ãŒã‚ã‚Œã°è¿½åŠ 
        if (narrative) {
            addDialogue('', narrative);
        }
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢ä¿‚æ€§æ›´æ–°ï¼ˆå…±é€šå‡¦ç†ï¼‰
    function updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo) {
        if (!charAtLocation) return;

        const statusIndex = characterStatus.findIndex(s => s === charAtLocation.status);
        if (statusIndex < 0) return;

        // é–¢ä¿‚æ€§å¤‰åŒ–ãŒã‚ã‚‹å ´åˆ
        if (newRelationshipName) {
            const currentRelationshipId = charAtLocation.status.relationshipId;
            const currentRelationship = relationships.find(r => r.relationship_id === currentRelationshipId);
            const newRelationship = relationships.find(r => r.name === newRelationshipName);
            if (newRelationship && newRelationship.relationship_id !== currentRelationshipId) {
                characterStatus[statusIndex].relationshipId = newRelationship.relationship_id;
                addSystemMessage(`ğŸ’« ${charAtLocation.character.name}ã¨ã®é–¢ä¿‚æ€§ãŒã€Œ${currentRelationship?.name || 'ä¸æ˜'}ã€ã‹ã‚‰ã€Œ${newRelationship.name}ã€ã«å¤‰åŒ–ã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ä¿å­˜ï¼ˆé–¢ä¿‚æ€§å¤‰åŒ–ãŒãªãã¦ã‚‚ï¼‰
        if (relationshipMemo) {
            characterStatus[statusIndex].memo = relationshipMemo;
        }

        updateCharacterStatusDisplay();
    }

    // ç”»åƒç”Ÿæˆã‚’éåŒæœŸã«é–‹å§‹ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å›é¿ï¼‰
    function startImageGenerationAsync(charAtLocation, currentPlace) {
        const runwareApiKey = document.getElementById('runwareApiKey').value.trim();
        if (!charAtLocation || !imageGenEnabled || !runwareApiKey) {
            return null;
        }
        localStorage.setItem(RUNWARE_API_KEY, runwareApiKey);
        const charActionIndex = charAtLocation.status?.actionIndex ?? -1;
        const charCostumeId = charAtLocation.status?.costumeId ?? null;
        const charRelationshipId = charAtLocation.status?.relationshipId ?? null;
        return new Promise(resolve => {
            setTimeout(async () => {
                try {
                    const image = await generateCharacterImage(charAtLocation.character, currentPlace, charActionIndex, charCostumeId, charRelationshipId);
                    resolve(image);
                } catch (e) {
                    console.error('[ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼]', e);
                    resolve(null);
                }
            }, 0);
        });
    }

    // åˆæœŸè¨­å®šé–‹å§‹
    function startInitialSetup() {
        // cast='on' ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
        const castCharacters = characters
            .map((char, index) => ({ char, index }))
            .filter(item => item.char.cast === 'on');

        if (castCharacters.length < characterCount) {
            addSystemMessage(`cast=onã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒ${characterCount}äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚GASã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚`);
            return;
        }

        // publicãªå ´æ‰€ã‚’å–å¾—
        const publicPlaces = places
            .map((place, index) => ({ place, index }))
            .filter(item => item.place.place_type === 'public');

        if (publicPlaces.length < characterCount) {
            addSystemMessage(`publicãªå ´æ‰€ãŒ${characterCount}ã¤ä»¥ä¸Šå¿…è¦ã§ã™ã€‚`);
            return;
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆcast=onã‹ã‚‰ã€é‡è¤‡ãªã—ï¼‰
        const charIndices = [];
        const shuffledCast = [...castCharacters].sort(() => Math.random() - 0.5);
        for (let i = 0; i < characterCount; i++) {
            charIndices.push(shuffledCast[i].index);
        }

        // å ´æ‰€ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆé‡è¤‡ãªã—ï¼‰
        const placeIndices = [];
        while (placeIndices.length < characterCount) {
            const randItem = publicPlaces[Math.floor(Math.random() * publicPlaces.length)];
            if (!placeIndices.includes(randItem.index)) {
                placeIndices.push(randItem.index);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚è¨­å®šï¼‰
        for (let i = 0; i < characterCount; i++) {
            const place = places[placeIndices[i]];
            // å ´æ‰€ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            let actionIndex = -1;
            if (place && place.default_action) {
                actionIndex = actions.findIndex(a => a.action_id === place.default_action);
            }

            characterStatus[i] = {
                characterIndex: charIndices[i],
                placeIndex: placeIndices[i],
                actionIndex: actionIndex,
                relationshipId: 'rel_001',  // åˆæœŸå€¤
                costumeId: 'cos_001',  // æœè£…åˆæœŸå€¤
                memo: ''  // ãƒ¡ãƒ¢åˆæœŸå€¤
            };
        }

        // å¾Œæ–¹äº’æ›: currentStateã‚‚æ›´æ–°
        currentState.characterIndex = charIndices[0];
        currentState.placeIndex = placeIndices[0];
        currentState.actionIndex = -1;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸä½ç½®ã‚’ã€Œ101å·å®¤ ç„é–¢ã€ã«è¨­å®š
        const userPlaceIndex = places.findIndex(p => p.name === '101å·å®¤ ç„é–¢');
        userState.placeIndex = userPlaceIndex >= 0 ? userPlaceIndex : -1;

        updateCharacterStatusDisplay();
        updateUserStatusDisplay();

        // è¨­å®šçµæœã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è¡¨ç¤º
        const userPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;
        addSystemMessage(`åˆæœŸè¨­å®šå®Œäº†:`);
        for (let i = 0; i < characterCount; i++) {
            const char = characters[charIndices[i]];
            const place = places[placeIndices[i]];
            const action = characterStatus[i].actionIndex >= 0 ? actions[characterStatus[i].actionIndex] : null;
            addSystemMessage(`  ${char.name} â†’ ${place.name} [${action?.name || 'ãªã—'}]`);
        }
        addSystemMessage(`  ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ${userPlace ? userPlace.name : 'æœªè¨­å®š'}`);
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç¾åœ¨åœ°ã¸å˜ç‹¬ç§»å‹•
    async function moveToCharacterLocation(charStatusIndex) {
        const status = characterStatus[charStatusIndex];
        if (!status || status.placeIndex < 0) {
            console.log('[ç§»å‹•] ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å ´æ‰€ãŒæœªè¨­å®š');
            return;
        }

        // ç‹­ã„ç”»é¢ã§ã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        if (window.innerWidth <= 768 && !sidebarCollapsed) {
            toggleSidebar();
        }

        const targetPlaceIndex = status.placeIndex;

        // æ—¢ã«åŒã˜å ´æ‰€ã«ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (userState.placeIndex === targetPlaceIndex) {
            console.log('[ç§»å‹•] æ—¢ã«åŒã˜å ´æ‰€ã«ã„ã¾ã™');
            return;
        }

        const previousPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;
        const newPlace = places[targetPlaceIndex];

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´æ‰€ã‚’æ›´æ–°
        userState.placeIndex = targetPlaceIndex;
        updateUserStatusDisplay();

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆï¼ˆå˜ç‹¬ç§»å‹•ã€companion=nullï¼‰
        await generatePages('move', '', previousPlace, newPlace, null);
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜å ´æ‰€ã«ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
    function getCharacterAtUserLocation() {
        if (userState.placeIndex < 0) return null;
        for (const status of characterStatus) {
            if (status.placeIndex === userState.placeIndex && status.characterIndex >= 0) {
                return {
                    character: characters[status.characterIndex],
                    status: status
                };
            }
        }
        return null;
    }

    // ãƒšãƒ¼ã‚¸ç”Ÿæˆãƒ¡ã‚¤ãƒ³å‡¦ç†
    // companion: ä¸€ç·’ã«ç§»å‹•ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆç§»å‹•æ™‚ã®ã¿ä½¿ç”¨ï¼‰
    async function generatePages(actionType, userInput, previousPlace, newPlace, companion = null) {
        const chatApiKey = document.getElementById('chatApiKey').value.trim();
        if (!chatApiKey) {
            addSystemMessage('OpenRouter API KeyãŒå¿…è¦ã§ã™');
            return;
        }

        // èª­ã¿è¾¼ã¿é–‹å§‹
        showLoading();

        const currentPlace = places[userState.placeIndex];
        // ç§»å‹•æ™‚ã«ä¸€ç·’ã«ç§»å‹•ã—ãŸå ´åˆã¯companionã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯ç¾åœ¨åœ°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
        const charAtLocation = companion || getCharacterAtUserLocation();

        // ç™ºè¨€ã‹ã¤ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ã‚‹å ´åˆã¯ä¼šè©±ãƒ¢ãƒ¼ãƒ‰
        if (actionType === 'speech' && charAtLocation) {
            await handleConversationMode(chatApiKey, charAtLocation, currentPlace, userInput);
            hideLoading();
            return;
        }

        // ç™ºè¨€ã ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ãªã„å ´åˆ
        if (actionType === 'speech' && !charAtLocation) {
            addSystemMessage('ã“ã®å ´æ‰€ã«ã¯èª°ã‚‚ã„ã¾ã›ã‚“');
            hideLoading();
            return;
        }

        // ç§»å‹•æ™‚ã¯å³åº§ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
        let movePageIndex = -1;
        if (actionType === 'move' && newPlace) {
            const placeImage = newPlace.image || null;
            movePageIndex = addPage1(placeImage, `${newPlace.name}ã«ç§»å‹•...`);
            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§æ›´æ–°ã™ã‚‹ã®ã§showPageã‹ã‚‰ã®ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼èµ·å‹•ã‚’é˜²ã
            pages[movePageIndex].typewriterCompleted = true;
            goToLatestPage();
        }

        // char_page_count ã‚’å–å¾—ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã®ã¿ï¼‰
        const currentAction = (actionType === 'action_select' || actionType === 'action_with_speech') && currentState.actionIndex >= 0
            ? actions[currentState.actionIndex] : null;
        const charPageCount = parseInt(currentAction?.char_page_count) || 1;

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šLLMã¨ç”»åƒç”Ÿæˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
        let combinedPrompt, combinedSimplePrompt;
        if (charPageCount >= 2 && charAtLocation) {
            // è¤‡æ•°ã‚»ãƒªãƒ•ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            const result = buildMultiDialoguePrompt(actionType, userInput, charAtLocation, currentPlace, charPageCount);
            combinedPrompt = result.fullPrompt;
            combinedSimplePrompt = result.simplePrompt;
        } else {
            // é€šå¸¸ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            const result = buildCombinedPrompt(actionType, userInput, previousPlace, newPlace, charAtLocation, currentPlace, false, companion);
            combinedPrompt = result.fullPrompt;
            combinedSimplePrompt = result.simplePrompt;
        }
        console.log('[Combined] å®Œå…¨ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', combinedPrompt);
        console.log('[Combined] ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ:', combinedSimplePrompt);

        // ç”»åƒç”Ÿæˆã‚’éåŒæœŸã«é–‹å§‹ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸ã®å ´åˆã¯å¾Œã§å€‹åˆ¥ã«ç”Ÿæˆï¼‰
        const imagePromise = charPageCount >= 2 ? null : startImageGenerationAsync(charAtLocation, currentPlace);

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ç”¨ã®ãƒšãƒ¼ã‚¸ã‚’å…ˆã«ä½œæˆ
        const placeImage = currentPlace?.image || null;
        let streamPageIndex = -1;
        let useAddDialogueMode = false;  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã¯æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«è¿½è¨˜
        let appendBaseHtml = '';  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã®è¿½è¨˜ãƒ™ãƒ¼ã‚¹HTML

        if (movePageIndex >= 0) {
            // ç§»å‹•æ™‚ï¼šæ—¢å­˜ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ä½¿ç”¨
            streamPageIndex = movePageIndex;
        } else {
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ï¼šæœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«è¿½è¨˜ãƒ¢ãƒ¼ãƒ‰
            useAddDialogueMode = true;
            // ç¾åœ¨ã®æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã®HTMLã‚’ä¿å­˜
            if (pages.length > 0) {
                const lastPageIndex = pages.length - 1;
                const pageView = document.getElementById('page-view');
                const pageDiv = pageView.querySelector(`.page-content[data-page-index="${lastPageIndex}"]`);
                if (pageDiv) {
                    const textDiv = pageDiv.querySelector('.page-text > div');
                    if (textDiv) {
                        appendBaseHtml = textDiv.innerHTML;
                    }
                }
            }
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”¨ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼é–‹å§‹ï¼ˆç§»å‹•æ™‚ã®ã¿ï¼‰
        if (streamPageIndex >= 0) {
            startTypewriter(streamPageIndex);
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ
        window._streamDisplayStarted = false;
        window._chunkCallbackStarted = false;
        window._displayTextLogged = false;

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”Ÿæˆ
        const onStreamChunk = createStreamChunkHandler(streamPageIndex, useAddDialogueMode, appendBaseHtml);

        // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç”»åƒç”Ÿæˆã‚’å…ˆã«é–‹å§‹ï¼ˆLLMã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
        let imagePromises = [];
        if (charPageCount >= 2 && charAtLocation) {
            const compositionTags = getCompositionTagsForMultiplePages(actions, currentState.actionIndex, charPageCount);
            imagePromises = compositionTags.map(tag =>
                generateCharacterImageWithComposition(charAtLocation, currentPlace, currentState.actionIndex, tag)
            );
        }

        // LLMã®å¿œç­”ã‚’å¾…ã¤ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ å¯¾å¿œï¼‰- ç”»åƒç”Ÿæˆã¨ä¸¦åˆ—
        showStatusLLM();
        const response = await callLLM(chatApiKey, combinedPrompt, 'combined', null, onStreamChunk, combinedSimplePrompt);
        hideStatusLLM();

        console.log('[LLM] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã§ãƒ‘ãƒ¼ã‚¹æ–¹æ³•ã‚’åˆ†å²
        let narrative, dialogue, dialogues, newRelationshipName, relationshipMemo;
        if (charPageCount >= 2 && charAtLocation) {
            const parsed = parseMultipleDialogues(response, charAtLocation, charPageCount);
            narrative = parsed.narrative;
            dialogues = parsed.dialogues;
            newRelationshipName = parsed.newRelationshipName;
            relationshipMemo = parsed.relationshipMemo;
        } else {
            const parsed = parseCombinedResponse(response, charAtLocation);
            narrative = parsed.narrative;
            dialogue = parsed.dialogue;
            newRelationshipName = parsed.newRelationshipName;
            relationshipMemo = parsed.relationshipMemo;
        }

        // æœ€çµ‚çš„ãªåœ°ã®æ–‡ã‚’è¡¨ç¤º
        if (streamPageIndex >= 0) {
            // ç§»å‹•æ™‚ï¼šã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ã§è¡¨ç¤º
            appendToTypewriter(narrative);
            await waitForTypewriter();
            // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†å¾Œã€fullTextã‚’æ›´æ–°ã—ã¦ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            if (pages[streamPageIndex]) {
                pages[streamPageIndex].fullText = narrative;
                pages[streamPageIndex].typewriterCompleted = true;
            }
        } else if (useAddDialogueMode && narrative && pages.length > 0) {
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ï¼šã‚¹ãƒˆãƒªãƒ¼ãƒ ã§æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ã€ãƒ‡ãƒ¼ã‚¿ã®ã¿æ›´æ–°
            const lastPageIndex = pages.length - 1;
            const lastPage = pages[lastPageIndex];
            lastPage.text += (lastPage.text ? '\n' : '') + narrative;
            lastPage.fullText = lastPage.text;
        }

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®å‡¦ç†
        updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo);

        // ç”»åƒç”ŸæˆãŒãªã‘ã‚Œã°èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
        if (!imagePromise && charPageCount < 2) {
            hideLoading();
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        if (charAtLocation) {
            if (charPageCount >= 2 && dialogues && dialogues.length > 0) {
                // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼šä¸¦åˆ—ç”Ÿæˆã—ãŸç”»åƒã‚’é †æ¬¡å–å¾—ã—ã¦ãƒšãƒ¼ã‚¸ä½œæˆ
                for (let i = 0; i < dialogues.length; i++) {
                    const charImage = await imagePromises[i];
                    addPage2(charAtLocation.character.name, charImage, dialogues[i]);
                    // å„ãƒšãƒ¼ã‚¸ç”Ÿæˆå¾Œã«æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆisLoadingä¸­ã§ã‚‚å¼·åˆ¶çš„ã«ï¼‰
                    const nextBtn = document.getElementById('next-btn');
                    if (nextBtn && currentPageIndex < pages.length - 1) {
                        nextBtn.classList.add('ready');
                    }
                }
            } else if (dialogue) {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼š1ãƒšãƒ¼ã‚¸ã®ã¿
                const charImage = imagePromise ? await imagePromise : null;
                addPage2(charAtLocation.character.name, charImage, dialogue);
                updatePageStatus();
            }
        }

        // èª­ã¿è¾¼ã¿å®Œäº†
        hideLoading();
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒç”Ÿæˆï¼ˆimage_gen_base.htmlã¨åŒã˜æ–¹å¼ï¼‰
    async function generateCharacterImage(character, place, actionIndex, costumeId = null, relationshipId = null) {
        const runwareApiKey = document.getElementById('runwareApiKey').value.trim();
        if (!runwareApiKey) return null;

        // ãƒ¢ãƒ‡ãƒ«å–å¾—ï¼ˆé¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ï¼‰
        const modelId = selectedModelId || getFirstModelId(models);
        if (!modelId || !models[modelId]) {
            console.log('[ç”»åƒç”Ÿæˆ] ãƒ¢ãƒ‡ãƒ«ãŒæœªè¨­å®š');
            return null;
        }
        const model = models[modelId];

        // æ§‹å›³ã‚¿ã‚°ã‚’å–å¾—ï¼ˆBESTã‹ã‚‰é¸æŠï¼‰
        const compositionTag = getCompositionTag(actions, actionIndex);

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆimage_gen_base.htmlã¨åŒã˜é †åºï¼‰
        const parts = [
            model?.qualityPositive || '',           // å“è³ªã‚¿ã‚°ï¼ˆãƒã‚¸ãƒ†ã‚£ãƒ–ï¼‰
            character?.tag || '',                    // ã‚­ãƒ£ãƒ©ã‚¿ã‚°
            place?.tag || '',                        // å ´æ‰€ã‚¿ã‚°
            (actionIndex >= 0 && actions[actionIndex]) ? actions[actionIndex].prompt : '',  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            compositionTag,                          // æ§‹å›³ã‚¿ã‚°ï¼ˆBESTé¸æŠï¼‰
            place?.additionalTag || '',              // å ´æ‰€ã®è¿½åŠ ã‚¿ã‚°
            character?.additionalTag || ''           // ã‚­ãƒ£ãƒ©ã®è¿½åŠ ã‚¿ã‚°
        ].filter(p => p);

        if (parts.length === 0) {
            console.log('[ç”»åƒç”Ÿæˆ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
            return null;
        }

        const prompt = cleanPrompt(parts.join(', '));
        const negativePrompt = model?.qualityNegative || '';

        // costumeIdã‹ã‚‰æœè£…ã‚¿ã‚°ãƒ»camelã‚¿ã‚°ã‚’å–å¾—
        let clothesTag = '';
        let camelTag = '';
        if (costumeId) {
            const costume = costumes.find(c => c.costume_id === costumeId);
            if (costume) {
                clothesTag = costume.tag || '';
                camelTag = costume.camel_tag || '';
            }
        }

        // relationshipIdã‹ã‚‰è¡¨æƒ…ã‚¿ã‚°ã‚’å–å¾—
        let expressionTag = '';
        if (relationshipId) {
            const relationship = relationships.find(r => r.relationship_id === relationshipId);
            if (relationship) {
                expressionTag = relationship.expression || '';
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«clothes, camel, expressionè¿½åŠ 
        const characterWithExtras = character
            ? { ...character, clothes: clothesTag, camel: camelTag, expression: expressionTag }
            : { clothes: clothesTag, camel: camelTag, expression: expressionTag };
        console.log('[ç”»åƒç”Ÿæˆ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', prompt);
        console.log('[ç”»åƒç”Ÿæˆ] ãƒã‚¬ãƒ†ã‚£ãƒ–:', negativePrompt);

        showStatusImage();
        const result = await generateImage(runwareApiKey, modelId, prompt, {
            negativePrompt: negativePrompt,
            steps: model?.steps || 20,
            cfgScale: model?.cfgScale || 7,
            scheduler: model?.scheduler || 'Default',
            width: 1024,
            height: 1024,
            character: characterWithExtras
        });
        hideStatusImage();

        return result.imageURL;
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒç”Ÿæˆï¼ˆæŒ‡å®šæ§‹å›³ã‚¿ã‚°ç‰ˆï¼‰
    async function generateCharacterImageWithComposition(charAtLocation, place, actionIndex, compositionTag) {
        const runwareApiKey = document.getElementById('runwareApiKey').value.trim();
        if (!runwareApiKey) return null;

        const character = charAtLocation?.character;
        const costumeId = charAtLocation?.status?.costumeId;
        const relationshipId = charAtLocation?.status?.relationshipId;

        // ãƒ¢ãƒ‡ãƒ«å–å¾—
        const modelId = selectedModelId || getFirstModelId(models);
        if (!modelId || !models[modelId]) return null;
        const model = models[modelId];

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
        const parts = [
            model?.qualityPositive || '',
            character?.tag || '',
            place?.tag || '',
            (actionIndex >= 0 && actions[actionIndex]) ? actions[actionIndex].prompt : '',
            compositionTag,  // æŒ‡å®šã•ã‚ŒãŸæ§‹å›³ã‚¿ã‚°ã‚’ä½¿ç”¨
            place?.additionalTag || '',
            character?.additionalTag || ''
        ].filter(p => p);

        if (parts.length === 0) return null;

        const prompt = cleanPrompt(parts.join(', '));
        const negativePrompt = model?.qualityNegative || '';

        // æœè£…ãƒ»è¡¨æƒ…ã‚¿ã‚°å–å¾—
        let clothesTag = '', camelTag = '', expressionTag = '';
        if (costumeId) {
            const costume = costumes.find(c => c.costume_id === costumeId);
            if (costume) {
                clothesTag = costume.tag || '';
                camelTag = costume.camel_tag || '';
            }
        }
        if (relationshipId) {
            const relationship = relationships.find(r => r.relationship_id === relationshipId);
            if (relationship) expressionTag = relationship.expression || '';
        }

        const characterWithExtras = character
            ? { ...character, clothes: clothesTag, camel: camelTag, expression: expressionTag }
            : { clothes: clothesTag, camel: camelTag, expression: expressionTag };

        showStatusImage();
        const result = await generateImage(runwareApiKey, modelId, prompt, {
            negativePrompt: negativePrompt,
            steps: model?.steps || 20,
            cfgScale: model?.cfgScale || 7,
            scheduler: model?.scheduler || 'Default',
            width: 1024,
            height: 1024,
            character: characterWithExtras
        });
        hideStatusImage();

        return result.imageURL;
    }

</script>

</body>
</html>
