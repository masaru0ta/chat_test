<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Transition Test</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/transition.css">
</head>
<body>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆç”»åƒç”Ÿæˆç”¨ï¼‰ -->
<div class="status-indicator" id="statusIndicator">
    <div class="status-item image" id="statusImage">
        <div class="status-spinner"></div>
    </div>
</div>

<!-- ãƒ­ãƒƒã‚¯ç”»é¢ -->
<div class="lock-screen hidden" id="lockScreen">
    <div class="lock-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
    <div class="lock-input-container">
        <input type="password" class="lock-digit" id="lockDigit1" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit2" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit3" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit4" maxlength="1" inputmode="none" readonly>
    </div>
    <div class="lock-error" id="lockError"></div>
    <div class="lock-numpad">
        <button class="lock-numpad-btn" onclick="onNumpadInput('1')">1</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('2')">2</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('3')">3</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('4')">4</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('5')">5</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('6')">6</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('7')">7</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('8')">8</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('9')">9</button>
        <button class="lock-numpad-btn" style="visibility:hidden;"></button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('0')">0</button>
        <button class="lock-numpad-btn backspace" onclick="onNumpadBackspace()">âŒ«</button>
    </div>
</div>

<div class="app-container" id="appContainer">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
        <div class="sidebar-content">
            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
            <div id="characters-container"></div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="current-state">
                <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                <div class="state-item">
                    <span class="state-label">ç¾åœ¨åœ°</span>
                    <span class="state-value" id="user-place">æœªé¸æŠ</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startInitialSetup()" style="width:100%; margin-bottom:10px;">åˆæœŸè¨­å®š</button>
            <button class="btn" onclick="openSettings()" style="width:100%; background:#333; color:#fff; border:1px solid #444; padding:10px; border-radius:4px; cursor:pointer; margin-bottom:10px;">è¨­å®š</button>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn" onclick="saveGameState()" style="flex:1; background:#2a4a2a; color:#8f8; border:1px solid #4a4; padding:10px; border-radius:4px; cursor:pointer;">ã‚»ãƒ¼ãƒ–</button>
                <button class="btn" onclick="loadGameState()" style="flex:1; background:#4a2a2a; color:#f88; border:1px solid #a44; padding:10px; border-radius:4px; cursor:pointer;">ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <button class="btn" onclick="toggleFullscreen()" style="width:100%; background:#222; color:#888; border:1px solid #333; padding:10px; border-radius:4px; cursor:pointer;">å…¨ç”»é¢åˆ‡æ›¿</button>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h3>è¨­å®š</h3>
                <button class="settings-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="settings-group">
                <label>GAS URL</label>
                <div class="settings-row">
                    <input type="text" id="gasUrl" placeholder="GAS URL" onchange="saveGasUrl()">
                    <button class="btn" id="llmLogToggle" onclick="toggleLLMLog()" style="padding:8px 12px; font-size:0.8rem;" title="LLMãƒ­ã‚°ä¿å­˜">OFF</button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="loadAllFromGas()" style="width:100%; margin-bottom:15px;">GASèª­ã¿è¾¼ã¿</button>
            <div class="settings-group">
                <label>OpenRouter API Key</label>
                <input type="password" id="chatApiKey" placeholder="OpenRouter API Key" onchange="saveChatApiKey()">
            </div>
            <div class="settings-group">
                <label>Runware API Key</label>
                <div class="settings-row">
                    <input type="password" id="runwareApiKey" placeholder="Runware API Key" onchange="saveRunwareApiKey()">
                    <button class="btn" id="imageGenToggle" onclick="toggleImageGen()" style="padding:8px 12px; font-size:0.8rem;">ON</button>
                </div>
            </div>
            <div class="settings-group">
                <label>LLMãƒ¢ãƒ‡ãƒ«</label>
                <select id="llmModelSelect" onchange="onLLMModelSelect()">
                    <option value="x-ai/grok-4.1-fast">Grok 4.1 Fast</option>
                    <option value="x-ai/grok-4-fast">Grok 4 Fast</option>
                </select>
            </div>
            <div class="settings-group">
                <label>ç”»åƒãƒ¢ãƒ‡ãƒ«</label>
                <select id="modelSelect" onchange="onModelSelect()">
                    <option value="">-- ç”»åƒãƒ¢ãƒ‡ãƒ«é¸æŠ --</option>
                </select>
            </div>
            <div class="settings-group">
                <label>ç™»å ´äººæ•°</label>
                <input type="number" id="characterCountInput" min="1" max="10" value="2" onchange="onCharacterCountChange()" style="width:80px;">
            </div>
            <div class="settings-group">
                <label>ãƒ­ãƒƒã‚¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰</label>
                <input type="password" id="lockPasswordInput" maxlength="4" placeholder="4æ¡ã®æ•°å­—" inputmode="numeric" pattern="[0-9]{4}" onchange="saveLockPassword()" style="width:100px;">
            </div>
            <div class="settings-group" style="margin-top:15px; padding-top:15px; border-top:1px solid #444;">
                <label>GASè¨­å®šåŒæœŸ</label>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="saveSettingsToGas()" style="flex:1; background:#2a4a2a; color:#8f8; border:1px solid #4a4; padding:10px; border-radius:4px; cursor:pointer;">GASã«ä¿å­˜</button>
                    <button class="btn" onclick="loadSettingsFromGas()" style="flex:1; background:#2a2a4a; color:#88f; border:1px solid #44a; padding:10px; border-radius:4px; cursor:pointer;">GASã‹ã‚‰èª­è¾¼</button>
                </div>
            </div>
            <div id="status"></div>
        </div>
    </div>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="toast"></div>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="chat-area">
        <div class="page-area">
            <div id="page-view">
                <!-- ãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤ºæ™‚ã®æƒ…å ±ãƒœã‚¿ãƒ³ -->
                <button class="info-button" id="infoButton" onclick="showPageInfo()" title="ãƒšãƒ¼ã‚¸æƒ…å ±">i</button>
                <!-- ãƒšãƒ¼ã‚¸æƒ…å ±ãƒ‘ãƒãƒ« -->
                <div class="page-info-panel" id="pageInfoPanel">
                    <div class="page-info-header">
                        <h3>ãƒšãƒ¼ã‚¸æƒ…å ±</h3>
                        <button class="page-info-close" onclick="closePageInfo()">Ã—</button>
                    </div>
                    <div class="page-info-content" id="pageInfoContent">
                    </div>
                </div>
            </div>
        </div>
        <!-- çµ±åˆã‚³ãƒãƒ³ãƒ‰ãƒãƒ¼ -->
        <div class="unified-command-bar">
            <button class="cmd-btn menu-btn" id="menu-toggle" onclick="toggleSidebar()">â‰¡</button>
            <button class="cmd-btn" id="target-toggle" onclick="openMoveMenu()">ç§»å‹•</button>
            <button class="cmd-btn" id="cmd-toggle" onclick="openActionMenu()">è¡Œç‚º</button>
            <input type="text" class="cmd-input" id="command-input" placeholder="ç™ºè¨€..." onkeydown="if(event.key==='Enter')executeCommand()">
            <button class="cmd-btn nav-btn" id="prev-btn" onclick="prevPage()">å‰ã¸</button>
            <button class="cmd-btn nav-btn" id="next-btn" onclick="nextPage()">æ¬¡ã¸</button>
        </div>
        <!-- ç§»å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="move-menu" id="moveMenu" style="display:none;">
            <div class="move-menu-header">
                <span>ç§»å‹•å…ˆã‚’é¸æŠ</span>
                <button class="move-menu-close" onclick="closeMoveMenu()">Ã—</button>
            </div>
            <div class="move-menu-list" id="moveMenuList">
                <!-- ç§»å‹•å…ˆãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
        <!-- è¡Œç‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="action-menu" id="actionMenu" style="display:none;">
            <div class="action-menu-header">
                <span>è¡Œç‚ºã‚’é¸æŠ</span>
                <button class="action-menu-close" onclick="closeActionMenu()">Ã—</button>
            </div>
            <div class="action-menu-list" id="actionMenuList">
                <!-- è¡Œç‚ºãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script src="js/prompt-utils.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/lock-screen.js"></script>
<script>
    // ========== çŠ¶æ…‹ç®¡ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰ ==========
    const CACHE_KEY = STORAGE_KEYS.TRANSITION_CACHE;

    // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let relationships = [];
    let costumes = [];
    let personalities = [];
    let promptTemplates = {};

    // ç¾åœ¨ã®çŠ¶æ…‹ï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰
    let currentState = {
        characterIndex: -1,
        placeIndex: -1,
        actionIndex: -1
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    let userState = {
        placeIndex: -1
    };

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ2äººåˆ†åˆæœŸå€¤ï¼‰
    let characterStatus = [
        { characterIndex: -1, placeIndex: -1, actionIndex: -1, relationshipId: DEFAULTS.RELATIONSHIP_PRIMARY, costumeId: DEFAULTS.COSTUME, memo: '' },
        { characterIndex: -1, placeIndex: -1, actionIndex: -1, relationshipId: DEFAULTS.RELATIONSHIP_SECONDARY, costumeId: DEFAULTS.COSTUME, memo: '' }
    ];

    // çŠ¶æ…‹å¤‰æ•°
    let chatHistory = [];
    let pages = [];
    let currentPageIndex = -1;
    let characterCount = 2;
    let imageGenEnabled = true;
    let llmLogEnabled = false;
    let selectedModelId = '';
    let selectedLLMModelId = 'x-ai/grok-4.1-fast';
    let moveWithCompanion = false;
    let isLoading = false;

    // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼è¡¨ç¤ºç”¨
    let typewriterBuffer = '';
    let typewriterDisplayed = '';
    let typewriterTimer = null;
    let typewriterPageIndex = -1;

    // characterStatusé…åˆ—ã‚’ç™»å ´äººæ•°ã«åˆã‚ã›ã¦èª¿æ•´
    function updateCharacterStatusArray() {
        while (characterStatus.length < characterCount) {
            characterStatus.push({
                characterIndex: -1,
                placeIndex: -1,
                actionIndex: -1,
                relationshipId: DEFAULTS.RELATIONSHIP_PRIMARY,
                costumeId: DEFAULTS.COSTUME,
                memo: ''
            });
        }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveCachedData() {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
            models, characters, places, actions, relationships, costumes, personalities, promptTemplates
        }));
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadCachedData() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
                relationships = data.relationships || [];
                costumes = data.costumes || [];
                personalities = data.personalities || [];
                promptTemplates = data.promptTemplates || {};
                updateModelSelect();
                if (actions.length > 0) {
                    addSystemMessage(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
                }
            }
        } catch (e) {
            console.error('Cache load error:', e);
        }
    }
</script>
<script src="js/transition-page.js"></script>
<script src="js/transition-ui.js"></script>
<script src="js/transition-llm.js"></script>
<script src="js/transition-image.js"></script>
<script>
    // ç§»å‹•å®Ÿè¡Œ
    async function executeMove(placeIndex) {
        const previousPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;

        // ã€Œä¸€ç·’ã«ã€ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç¾åœ¨åœ°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‚ä¸€ç·’ã«ç§»å‹•
        let companion = null;
        if (moveWithCompanion) {
            const charAtLocation = getCharacterAtUserLocation();
            if (charAtLocation) {
                companion = charAtLocation;
                const statusIndex = characterStatus.indexOf(charAtLocation.status);
                if (statusIndex >= 0) {
                    characterStatus[statusIndex].placeIndex = placeIndex;
                    // ç§»å‹•å…ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¤‰æ›´
                    const newPlace = places[placeIndex];
                    if (newPlace && newPlace.default_action) {
                        const newActionIndex = actions.findIndex(a => a.action_id === newPlace.default_action);
                        if (newActionIndex >= 0) {
                            characterStatus[statusIndex].actionIndex = newActionIndex;
                        }
                    }
                }
                updateCharacterStatusDisplay();
            }
        }

        userState.placeIndex = placeIndex;
        updateUserStatusDisplay();
        const newPlace = places[placeIndex];

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        await generatePages('move', '', previousPlace, newPlace, companion);
    }

    async function selectAction(actionIndex) {
        closeActionMenu();

        // è¡Œç‚ºã‚’å®Ÿè¡Œ
        currentState.actionIndex = actionIndex;
        await executeAction(actionIndex);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
        const modal = document.getElementById('settingsModal');
        if (e.target === modal) {
            closeSettings();
        }
    });

    // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    async function executeCommand() {
        const input = document.getElementById('command-input');
        const text = input.value.trim();

        // ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (!text) return;

        const chatApiKey = document.getElementById('chatApiKey').value.trim();
        if (!chatApiKey) {
            alert('OpenRouter API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        localStorage.setItem(STORAGE_KEYS.TRANSITION_CHAT_API_KEY, chatApiKey);

        if (userState.placeIndex < 0) {
            alert('åˆæœŸè¨­å®šã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
            return;
        }

        addCommandMessage('speech', text);
        input.value = '';

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        await generatePages('speech', text, null, null);
    }

    // Visual Viewportå¯¾å¿œï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ãƒ»æŠ˜ã‚Šç•³ã¿ã‚¹ãƒãƒ›å¯¾å¿œï¼‰
    function initVisualViewport() {
        let lastViewportWidth = window.innerWidth;
        let lastViewportHeight = window.innerHeight;

        function updateVisualViewport() {
            const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            document.documentElement.style.setProperty('--visual-viewport-height', vh + 'px');
        }

        function handleScreenSizeChange() {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            const widthDiff = Math.abs(newWidth - lastViewportWidth);
            const heightDiff = Math.abs(newHeight - lastViewportHeight);

            if (widthDiff > 100 || heightDiff > 100) {
                console.log('[Viewport] å¤§ããªã‚µã‚¤ã‚ºå¤‰åŒ–æ¤œå‡º:', lastViewportWidth, 'x', lastViewportHeight, '->', newWidth, 'x', newHeight);
                updateVisualViewport();
                setTimeout(updateVisualViewport, 50);
                setTimeout(updateVisualViewport, 150);
                setTimeout(updateVisualViewport, 300);
            } else {
                updateVisualViewport();
            }
            lastViewportWidth = newWidth;
            lastViewportHeight = newHeight;
        }

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', updateVisualViewport);
            window.visualViewport.addEventListener('scroll', updateVisualViewport);
        }
        window.addEventListener('resize', handleScreenSizeChange);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleScreenSizeChange, 100);
            setTimeout(handleScreenSizeChange, 300);
        });
        updateVisualViewport();
    }

    // è¨­å®šå€¤ã®å¾©å…ƒ
    function restoreSettings() {
        const settings = loadSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY);
        if (settings.gasUrl) document.getElementById('gasUrl').value = settings.gasUrl;

        const savedApiKey = localStorage.getItem(STORAGE_KEYS.TRANSITION_CHAT_API_KEY);
        if (savedApiKey) document.getElementById('chatApiKey').value = savedApiKey;

        const savedRunwareKey = localStorage.getItem(STORAGE_KEYS.TRANSITION_RUNWARE_API_KEY);
        if (savedRunwareKey) document.getElementById('runwareApiKey').value = savedRunwareKey;

        const savedImageGenEnabled = localStorage.getItem(STORAGE_KEYS.TRANSITION_IMAGE_GEN_ENABLED);
        imageGenEnabled = savedImageGenEnabled !== 'off';
        updateImageGenButton();

        const savedLLMLogEnabled = localStorage.getItem(STORAGE_KEYS.TRANSITION_LLM_LOG_ENABLED);
        llmLogEnabled = savedLLMLogEnabled === 'on';
        updateLLMLogButton();

        const savedModelId = localStorage.getItem(STORAGE_KEYS.TRANSITION_SELECTED_MODEL);
        if (savedModelId) selectedModelId = savedModelId;
    }

    // GASã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadSettingsFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        showStatus('è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');

        try {
            const data = await fetchGasData(baseUrl, 'settings');
            console.log('[Settings] GASã‹ã‚‰èª­ã¿è¾¼ã¿:', data);

            // ãƒ‡ãƒ¼ã‚¿ã‚’key-valueå½¢å¼ã«å¤‰æ›ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—å½¢å¼ï¼‰
            const settings = {};
            if (data && data.length > 0) {
                for (const row of data) {
                    if (row.key) {
                        settings[row.key] = row.value ?? '';
                    }
                }
            }
            console.log('[Settings] ãƒ‘ãƒ¼ã‚¹çµæœ:', settings);

            // è¨­å®šã‚’é©ç”¨
            if (settings.chatApiKey) {
                document.getElementById('chatApiKey').value = settings.chatApiKey;
                localStorage.setItem(STORAGE_KEYS.TRANSITION_CHAT_API_KEY, settings.chatApiKey);
            }
            if (settings.runwareApiKey) {
                document.getElementById('runwareApiKey').value = settings.runwareApiKey;
                localStorage.setItem(STORAGE_KEYS.TRANSITION_RUNWARE_API_KEY, settings.runwareApiKey);
            }
            if (settings.llmLogEnabled !== undefined) {
                llmLogEnabled = settings.llmLogEnabled === 'on';
                localStorage.setItem(STORAGE_KEYS.TRANSITION_LLM_LOG_ENABLED, settings.llmLogEnabled);
                updateLLMLogButton();
            }
            if (settings.imageGenEnabled !== undefined) {
                imageGenEnabled = settings.imageGenEnabled !== 'off';
                localStorage.setItem(STORAGE_KEYS.TRANSITION_IMAGE_GEN_ENABLED, settings.imageGenEnabled);
                updateImageGenButton();
            }
            if (settings.llmModelId) {
                selectedLLMModelId = settings.llmModelId;
                localStorage.setItem(STORAGE_KEYS.TRANSITION_SELECTED_LLM_MODEL, settings.llmModelId);
                document.getElementById('llmModelSelect').value = settings.llmModelId;
            }
            if (settings.imageModelId) {
                selectedModelId = settings.imageModelId;
                localStorage.setItem(STORAGE_KEYS.TRANSITION_SELECTED_MODEL, settings.imageModelId);
                document.getElementById('modelSelect').value = settings.imageModelId;
            }
            if (settings.characterCount) {
                characterCount = parseInt(settings.characterCount) || 2;
                localStorage.setItem(STORAGE_KEYS.TRANSITION_CHARACTER_COUNT, characterCount.toString());
                document.getElementById('characterCountInput').value = characterCount;
                updateCharacterStatusArray();
            }
            if (settings.lockPassword) {
                localStorage.setItem(STORAGE_KEYS.LOCK_PASSWORD, settings.lockPassword);
                document.getElementById('lockPasswordInput').value = settings.lockPassword;
            }

            showStatus('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        } catch (error) {
            console.error('[Settings] èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            showStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    // GASã«è¨­å®šã‚’ä¿å­˜
    async function saveSettingsToGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        showStatus('è¨­å®šã‚’ä¿å­˜ä¸­...', 'loading');

        try {
            // ç¾åœ¨ã®è¨­å®šã‚’åé›†ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—å½¢å¼ï¼‰
            const settings = [
                { key: 'chatApiKey', value: document.getElementById('chatApiKey').value || '' },
                { key: 'runwareApiKey', value: document.getElementById('runwareApiKey').value || '' },
                { key: 'llmLogEnabled', value: llmLogEnabled ? 'on' : 'off' },
                { key: 'imageGenEnabled', value: imageGenEnabled ? 'on' : 'off' },
                { key: 'llmModelId', value: selectedLLMModelId || '' },
                { key: 'imageModelId', value: selectedModelId || '' },
                { key: 'characterCount', value: characterCount.toString() },
                { key: 'lockPassword', value: document.getElementById('lockPasswordInput').value || '' }
            ];

            console.log('[Settings] GASã«ä¿å­˜:', settings);
            const result = await saveGasData(baseUrl, 'settings', settings);
            console.log('[Settings] ä¿å­˜çµæœ:', result);

            // ä¿å­˜å¾Œã€GASã®æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
            const meta = await fetchGasMeta(baseUrl);
            if (meta.lastUpdated) {
                localStorage.setItem(STORAGE_KEYS.TRANSITION_GAS_LAST_UPDATED, meta.lastUpdated);
                console.log('[Settings] æ›´æ–°æ—¥æ™‚ã‚’ä¿å­˜:', meta.lastUpdated);
            }

            showStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        } catch (error) {
            console.error('[Settings] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            showStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    // èµ·å‹•æ™‚ã«GASãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯
    async function checkAndSyncSettings() {
        const baseUrl = localStorage.getItem(STORAGE_KEYS.GAS_URL);
        if (!baseUrl) return;

        showStatus('GASãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...', 'loading');

        try {
            const meta = await fetchGasMeta(baseUrl);
            const gasUpdated = meta.lastUpdated;
            const localUpdated = localStorage.getItem(STORAGE_KEYS.TRANSITION_GAS_LAST_UPDATED);

            console.log('[Sync] GASæ›´æ–°æ—¥æ™‚:', gasUpdated, 'ãƒ­ãƒ¼ã‚«ãƒ«:', localUpdated);

            // GASãŒæ–°ã—ã„å ´åˆã€å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (!localUpdated || new Date(gasUpdated) > new Date(localUpdated)) {
                console.log('[Sync] GASãŒæ–°ã—ã„ãŸã‚å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã™');
                showStatus('GASã‹ã‚‰åŒæœŸä¸­...', 'loading');

                // è¨­å®šã‚’å–å¾—
                await loadSettingsFromGas();

                // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const [modelData, characterData, placeData, actionData, relationshipData, costumeData, personalityData, promptData] = await Promise.all([
                    fetchGasData(baseUrl, 'model'),
                    fetchGasData(baseUrl, 'character'),
                    fetchGasData(baseUrl, 'place'),
                    fetchGasData(baseUrl, 'action'),
                    fetchGasData(baseUrl, 'relationship'),
                    fetchGasData(baseUrl, 'costume'),
                    fetchGasData(baseUrl, 'personality'),
                    fetchGasData(baseUrl, 'llm_prompt_template')
                ]);

                models = parseModels(modelData);
                characters = parseCharacters(characterData);
                places = parsePlaces(placeData);
                actions = parseActionsWithCompositions(actionData);
                relationships = parseRelationships(relationshipData);
                costumes = parseCostumes(costumeData);
                personalities = parsePersonalities(personalityData);
                promptTemplates = parsePromptTemplates(promptData);

                saveCachedData();
                updateModelSelect();

                localStorage.setItem(STORAGE_KEYS.TRANSITION_GAS_LAST_UPDATED, gasUpdated);
                console.log('[Sync] åŒæœŸå®Œäº†:', `${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
                showStatus(`GASåŒæœŸå®Œäº†: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
            } else {
                console.log('[Sync] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™');
                showStatus('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™');
            }
        } catch (error) {
            console.log('[Sync] åŒæœŸãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—:', error.message);
            showStatus('');
        }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    function initKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextPage();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevPage();
            }
        });
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        initSidebarState();
        initTextToggle();
        initLockScreen();
        initVisualViewport();
        restoreSettings();
        initLLMModelSelect();
        initCharacterCount();
        loadCachedData();
        startInitialSetup();
        initKeyboardNavigation();
        // GASè¨­å®šã®åŒæœŸãƒã‚§ãƒƒã‚¯ï¼ˆéåŒæœŸï¼‰
        checkAndSyncSettings();
    });

    async function loadAllFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        localStorage.setItem(STORAGE_KEYS.GAS_URL, baseUrl);
        showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData, relationshipData, costumeData, personalityData, promptData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action'),
                fetchGasData(baseUrl, 'relationship'),
                fetchGasData(baseUrl, 'costume'),
                fetchGasData(baseUrl, 'personality'),
                fetchGasData(baseUrl, 'llm_prompt_template')
            ]);

            models = parseModels(modelData);
            characters = parseCharacters(characterData);
            places = parsePlaces(placeData);
            actions = parseActionsWithCompositions(actionData);
            relationships = parseRelationships(relationshipData);
            costumes = parseCostumes(costumeData);
            personalities = parsePersonalities(personalityData);
            promptTemplates = parsePromptTemplates(promptData);

            saveCachedData();
            updateModelSelect();

            showStatus(`èª­è¾¼å®Œäº†: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
        } catch (error) {
            console.error(error);
            showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    async function executeAction(actionIndex) {
        const action = actions[actionIndex];
        if (!action) return;

        // æ—¢å­˜ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
        document.querySelectorAll('.page-action-buttons').forEach(el => el.remove());

        const prevActionIndex = currentState.actionIndex;
        const prevAction = prevActionIndex >= 0 ? actions[prevActionIndex] : null;

        // çŠ¶æ…‹æ›´æ–°
        currentState.actionIndex = actionIndex;

        // åŒã˜å ´æ‰€ã«ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
        const charAtLocation = getCharacterAtUserLocation();
        let effectStatusIndex = -1;
        let effectMessages = []; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾Œã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ä¿å­˜
        if (charAtLocation) {
            const statusIndex = characterStatus.findIndex(s => s === charAtLocation.status);
            if (statusIndex >= 0) {
                characterStatus[statusIndex].actionIndex = actionIndex;
                console.log('[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ]', charAtLocation.character.name, 'ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°:', action.name);
                effectStatusIndex = statusIndex;

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®effectã‚’é©ç”¨ï¼ˆçŠ¶æ…‹å¤‰æ›´ã®ã¿ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¾Œã§ï¼‰
                effectMessages = applyActionEffect(action, charAtLocation, statusIndex);

                updateCharacterStatusDisplay();
            }
        }

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼‰
        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç™ºè¨€ãŒã‚ã‚Œã° action_with_speechã€ãªã‘ã‚Œã° action_select
        const commandInput = document.getElementById('command-input');
        const speechText = commandInput?.value?.trim() || '';
        if (speechText) {
            await generatePages('action_with_speech', speechText, null, null);
            commandInput.value = ''; // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        } else {
            await generatePages('action_select', action.name, null, null);
        }

        // effectãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ç”Ÿæˆå¾Œï¼‰
        if (effectMessages && effectMessages.length > 0) {
            effectMessages.forEach(msg => addSystemMessage(msg));
        }

        // next_actionãŒå®šç¾©ã•ã‚Œã¦ã„ã‚Œã°ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (action.next_action) {
            const nextAction = actions.find(a => a.action_id === action.next_action);
            if (nextAction) {
                addNextActionButton(nextAction);
            }
        }
    }

    // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    function addNextActionButton(nextAction) {
        if (pages.length === 0) return;

        const lastPageIndex = pages.length - 1;
        const page = pages[lastPageIndex];

        // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        if (page && !page.typewriterCompleted) {
            // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†ã‚’å¾…ã¤ï¼ˆæœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«å›ºå®šï¼‰
            setTypewriterCompleteCallback(() => {
                appendNextActionButtonToPage(lastPageIndex, nextAction);
            });
        } else {
            // ã™ã§ã«å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«è¿½åŠ 
            appendNextActionButtonToPage(lastPageIndex, nextAction);
        }
    }

    // ãƒšãƒ¼ã‚¸ã«ãƒœã‚¿ãƒ³ã‚’å®Ÿéš›ã«è¿½åŠ ã™ã‚‹
    function appendNextActionButtonToPage(pageIndex, nextAction) {
        const container = getOrCreateButtonContainer(pageIndex);
        if (!container) return;

        // æ—¢å­˜ã®æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤
        const existingBtn = container.querySelector('.next-action-button');
        if (existingBtn) existingBtn.remove();

        // ãƒœã‚¿ãƒ³è¦ç´ ã‚’ä½œæˆ
        const button = document.createElement('button');
        button.className = 'next-action-button';
        button.dataset.actionId = nextAction.action_id;
        button.textContent = `â–¶ ${nextAction.name}`;
        button.style.cssText = 'padding:8px 24px; background:#2a4a6a; color:#8cf; border:1px solid #4a6a8a; border-radius:4px; cursor:pointer; font-size:0.9rem;';
        button.onmouseover = () => button.style.background = '#3a5a7a';
        button.onmouseout = () => button.style.background = '#2a4a6a';

        button.addEventListener('click', async (e) => {
            e.stopPropagation(); // ãƒ†ã‚­ã‚¹ãƒˆãƒˆã‚°ãƒ«ã‚’é˜²æ­¢
            // ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
            button.remove();
            // ã‚³ãƒ³ãƒ†ãƒŠãŒç©ºã«ãªã£ãŸã‚‰å‰Šé™¤
            if (container.children.length === 0) container.remove();
            const actionId = button.dataset.actionId;
            const actionToExecute = actions.find(a => a.action_id === actionId);
            if (actionToExecute) {
                const actionIdx = actions.indexOf(actionToExecute);
                if (actionIdx >= 0) {
                    await executeAction(actionIdx);
                }
            }
        });

        container.appendChild(button);
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡Œå‹•ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    function addCharacterActionButton(action, charAtLocation) {
        if (pages.length === 0) return;

        const lastPageIndex = pages.length - 1;
        const page = pages[lastPageIndex];

        // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        if (page && !page.typewriterCompleted) {
            setTypewriterCompleteCallback(() => {
                appendCharacterActionButtonToPage(lastPageIndex, action, charAtLocation);
            });
        } else {
            appendCharacterActionButtonToPage(lastPageIndex, action, charAtLocation);
        }
    }

    // ãƒšãƒ¼ã‚¸ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡Œå‹•ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    function appendCharacterActionButtonToPage(pageIndex, action, charAtLocation) {
        const container = getOrCreateButtonContainer(pageIndex);
        if (!container) return;

        // æ—¢å­˜ã®ã‚­ãƒ£ãƒ©è¡Œå‹•ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤
        const existingBtn = container.querySelector('.char-action-button');
        if (existingBtn) existingBtn.remove();

        const charName = charAtLocation?.character?.name || '';
        const button = document.createElement('button');
        button.className = 'char-action-button';
        button.dataset.actionId = action.action_id;
        button.textContent = `${charName}â–¶ ${action.name}`;
        button.style.cssText = 'padding:8px 24px; background:#4a2a6a; color:#c8f; border:1px solid #6a4a8a; border-radius:4px; cursor:pointer; font-size:0.9rem; margin-left:8px;';
        button.onmouseover = () => button.style.background = '#5a3a7a';
        button.onmouseout = () => button.style.background = '#4a2a6a';

        button.addEventListener('click', async (e) => {
            e.stopPropagation();
            button.remove();
            if (container.children.length === 0) container.remove();
            const actionId = button.dataset.actionId;
            const actionIdx = actions.findIndex(a => a.action_id === actionId);
            if (actionIdx >= 0) {
                await executeAction(actionIdx);
            }
        });

        container.appendChild(button);
    }

    // ä¼šè©±ãƒ¢ãƒ¼ãƒ‰å‡¦ç†
    async function handleConversationMode(chatApiKey, charAtLocation, currentPlace, userInput) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã‚’è¿½åŠ 
        addDialogue('ã‚ãªãŸ', `ã€Œ${userInput}ã€`);

        const { fullPrompt, simplePrompt } = buildCombinedPrompt('speech', userInput, null, null, charAtLocation, currentPlace, true);
        console.log('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] å®Œå…¨ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', fullPrompt);

        showStatusLLM();
        const response = await callLLM(chatApiKey, fullPrompt, 'character', charAtLocation.character, null, simplePrompt);
        hideStatusLLM();
        console.log('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®åˆ¤å®šã‚’æŠ½å‡º
        const { dialogue: parsedDialogue, narrative, newRelationshipName, relationshipMemo, characterAction } = parseConversationResponse(response, charAtLocation);

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®å‡¦ç†
        updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo);

        if (parsedDialogue) {
            addDialogue(charAtLocation.character.name, parsedDialogue);
        } else {
            console.warn('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] ã‚»ãƒªãƒ•ãŒç©ºã§ã™');
        }
        // åœ°ã®æ–‡ãŒã‚ã‚Œã°è¿½åŠ 
        if (narrative) {
            addDialogue('', narrative);
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡Œå‹•ãŒã‚ã‚Œã°ãƒœã‚¿ãƒ³è¡¨ç¤º
        if (characterAction) {
            const matchingAction = actions.find(a => a.name === characterAction);
            if (matchingAction) {
                addCharacterActionButton(matchingAction, charAtLocation);
            } else {
                console.warn('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] è¡Œå‹•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', characterAction);
            }
        }
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢ä¿‚æ€§æ›´æ–°ï¼ˆå…±é€šå‡¦ç†ï¼‰
    function updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo) {
        if (!charAtLocation) return;

        const statusIndex = characterStatus.findIndex(s => s === charAtLocation.status);
        if (statusIndex < 0) return;

        // é–¢ä¿‚æ€§å¤‰åŒ–ãŒã‚ã‚‹å ´åˆ
        if (newRelationshipName) {
            const currentRelationshipId = charAtLocation.status.relationshipId;
            const currentRelationship = relationships.find(r => r.relationship_id === currentRelationshipId);
            const newRelationship = relationships.find(r => r.name === newRelationshipName);
            if (newRelationship && newRelationship.relationship_id !== currentRelationshipId) {
                characterStatus[statusIndex].relationshipId = newRelationship.relationship_id;
                addSystemMessage(`ğŸ’« ${charAtLocation.character.name}ã¨ã®é–¢ä¿‚æ€§ãŒã€Œ${currentRelationship?.name || 'ä¸æ˜'}ã€ã‹ã‚‰ã€Œ${newRelationship.name}ã€ã«å¤‰åŒ–ã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ä¿å­˜ï¼ˆé–¢ä¿‚æ€§å¤‰åŒ–ãŒãªãã¦ã‚‚ï¼‰
        if (relationshipMemo) {
            characterStatus[statusIndex].memo = relationshipMemo;
        }

        updateCharacterStatusDisplay();
    }

    // åˆæœŸè¨­å®šé–‹å§‹
    function startInitialSetup() {
        // cast='on' ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
        const castCharacters = characters
            .map((char, index) => ({ char, index }))
            .filter(item => item.char.cast === 'on');

        if (castCharacters.length < characterCount) {
            addSystemMessage(`cast=onã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒ${characterCount}äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚GASã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚`);
            return;
        }

        // req_stage=1ï¼ˆå…¨å“¡ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰ã®å ´æ‰€ã‚’å–å¾—
        const publicPlaces = places
            .map((place, index) => ({ place, index }))
            .filter(item => String(item.place.req_stage) === '1');

        if (publicPlaces.length < characterCount) {
            addSystemMessage(`req_stage=1ã®å ´æ‰€ãŒ${characterCount}ã¤ä»¥ä¸Šå¿…è¦ã§ã™ã€‚`);
            return;
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆcast=onã‹ã‚‰ã€é‡è¤‡ãªã—ã€æ€§æ ¼é‡è¤‡ã¯æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
        let charIndices = [];
        let retryCount = 0;
        const maxRetries = 3;

        while (retryCount < maxRetries) {
            charIndices = [];
            const shuffledCast = [...castCharacters].sort(() => Math.random() - 0.5);
            for (let i = 0; i < characterCount; i++) {
                charIndices.push(shuffledCast[i].index);
            }

            // æ€§æ ¼ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const personalityIds = charIndices
                .map(idx => characters[idx]?.personality)
                .filter(p => p); // ç©ºã®personalityã¯é™¤å¤–

            const uniquePersonalities = new Set(personalityIds);
            if (uniquePersonalities.size === personalityIds.length) {
                // é‡è¤‡ãªã—
                break;
            }

            retryCount++;
            console.log(`[åˆæœŸè¨­å®š] æ€§æ ¼é‡è¤‡ã®ãŸã‚ãƒªãƒˆãƒ©ã‚¤ (${retryCount}/${maxRetries})`);
        }

        if (retryCount >= maxRetries) {
            console.log('[åˆæœŸè¨­å®š] æ€§æ ¼é‡è¤‡ã‚’å›é¿ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }

        // å ´æ‰€ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆé‡è¤‡ãªã—ï¼‰
        const placeIndices = [];
        while (placeIndices.length < characterCount) {
            const randItem = publicPlaces[Math.floor(Math.random() * publicPlaces.length)];
            if (!placeIndices.includes(randItem.index)) {
                placeIndices.push(randItem.index);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚è¨­å®šï¼‰
        for (let i = 0; i < characterCount; i++) {
            const place = places[placeIndices[i]];
            // å ´æ‰€ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            let actionIndex = -1;
            if (place && place.default_action) {
                actionIndex = actions.findIndex(a => a.action_id === place.default_action);
            }

            characterStatus[i] = {
                characterIndex: charIndices[i],
                placeIndex: placeIndices[i],
                actionIndex: actionIndex,
                relationshipId: i === 1 ? DEFAULTS.RELATIONSHIP_SECONDARY : DEFAULTS.RELATIONSHIP_PRIMARY,  // 2äººç›®ã¯rel_302
                costumeId: DEFAULTS.COSTUME,  // æœè£…åˆæœŸå€¤
                memo: ''  // ãƒ¡ãƒ¢åˆæœŸå€¤
            };
        }

        // å¾Œæ–¹äº’æ›: currentStateã‚‚æ›´æ–°
        currentState.characterIndex = charIndices[0];
        currentState.placeIndex = placeIndices[0];
        currentState.actionIndex = -1;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸä½ç½®ã‚’è¨­å®š
        const userPlaceIndex = places.findIndex(p => p.name === DEFAULTS.USER_START_PLACE);
        userState.placeIndex = userPlaceIndex >= 0 ? userPlaceIndex : -1;

        updateCharacterStatusDisplay();
        updateUserStatusDisplay();

        // è¨­å®šçµæœã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è¡¨ç¤º
        const userPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;
        addSystemMessage(`åˆæœŸè¨­å®šå®Œäº†:`);
        for (let i = 0; i < characterCount; i++) {
            const char = characters[charIndices[i]];
            const place = places[placeIndices[i]];
            const action = characterStatus[i].actionIndex >= 0 ? actions[characterStatus[i].actionIndex] : null;
            addSystemMessage(`  ${char.name} â†’ ${place.name} [${action?.name || 'ãªã—'}]`);
        }
        addSystemMessage(`  ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ${userPlace ? userPlace.name : 'æœªè¨­å®š'}`);
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç¾åœ¨åœ°ã¸å˜ç‹¬ç§»å‹•
    async function moveToCharacterLocation(charStatusIndex) {
        const status = characterStatus[charStatusIndex];
        if (!status || status.placeIndex < 0) {
            console.log('[ç§»å‹•] ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å ´æ‰€ãŒæœªè¨­å®š');
            return;
        }

        // ç‹­ã„ç”»é¢ã§ã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        if (window.innerWidth <= 768 && !sidebarCollapsed) {
            toggleSidebar();
        }

        const targetPlaceIndex = status.placeIndex;

        // æ—¢ã«åŒã˜å ´æ‰€ã«ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (userState.placeIndex === targetPlaceIndex) {
            console.log('[ç§»å‹•] æ—¢ã«åŒã˜å ´æ‰€ã«ã„ã¾ã™');
            return;
        }

        const previousPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;
        const newPlace = places[targetPlaceIndex];

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´æ‰€ã‚’æ›´æ–°
        userState.placeIndex = targetPlaceIndex;
        updateUserStatusDisplay();

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆï¼ˆå˜ç‹¬ç§»å‹•ã€companion=nullï¼‰
        await generatePages('move', '', previousPlace, newPlace, null);
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜å ´æ‰€ã«ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
    function getCharacterAtUserLocation() {
        if (userState.placeIndex < 0) return null;
        for (const status of characterStatus) {
            if (status.placeIndex === userState.placeIndex && status.characterIndex >= 0) {
                return {
                    character: characters[status.characterIndex],
                    status: status
                };
            }
        }
        return null;
    }

    // ãƒšãƒ¼ã‚¸ç”Ÿæˆãƒ¡ã‚¤ãƒ³å‡¦ç†
    // companion: ä¸€ç·’ã«ç§»å‹•ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆç§»å‹•æ™‚ã®ã¿ä½¿ç”¨ï¼‰
    async function generatePages(actionMode, userInput, previousPlace, newPlace, companion = null) {
        const chatApiKey = document.getElementById('chatApiKey').value.trim();
        if (!chatApiKey) {
            addSystemMessage('OpenRouter API KeyãŒå¿…è¦ã§ã™');
            return;
        }

        // èª­ã¿è¾¼ã¿é–‹å§‹
        showLoading();

        const currentPlace = places[userState.placeIndex];
        // ç§»å‹•æ™‚ã«ä¸€ç·’ã«ç§»å‹•ã—ãŸå ´åˆã¯companionã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯ç¾åœ¨åœ°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
        const charAtLocation = companion || getCharacterAtUserLocation();

        // ç™ºè¨€ã‹ã¤ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ã‚‹å ´åˆã¯ä¼šè©±ãƒ¢ãƒ¼ãƒ‰
        if (actionMode === 'speech' && charAtLocation) {
            await handleConversationMode(chatApiKey, charAtLocation, currentPlace, userInput);
            hideLoading();
            return;
        }

        // ç™ºè¨€ã ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ãªã„å ´åˆ
        if (actionMode === 'speech' && !charAtLocation) {
            addSystemMessage('ã“ã®å ´æ‰€ã«ã¯èª°ã‚‚ã„ã¾ã›ã‚“');
            hideLoading();
            return;
        }

        // ç”Ÿæˆæƒ…å ±ã‚’åé›†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆIDã®ã¿ä¿æŒã€åå‰ã¯è¡¨ç¤ºæ™‚ã«å–å¾—ï¼‰
        let genInfo = createGenInfo(actionMode, charAtLocation, currentPlace);

        // ç§»å‹•æ™‚ã¯å³åº§ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
        const movePageIndex = (actionMode === 'move' && newPlace)
            ? createMovePagePlaceholder(newPlace, genInfo)
            : -1;

        // char_page_count ã‚’å–å¾—ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã®ã¿ï¼‰
        const currentAction = (actionMode === 'action_select' || actionMode === 'action_with_speech') && currentState.actionIndex >= 0
            ? actions[currentState.actionIndex] : null;
        const charPageCount = parseInt(currentAction?.char_page_count) || 1;

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šLLMã¨ç”»åƒç”Ÿæˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
        let combinedPrompt, combinedSimplePrompt;
        if (charPageCount >= 2 && charAtLocation) {
            // è¤‡æ•°ã‚»ãƒªãƒ•ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            const result = buildMultiDialoguePrompt(actionMode, userInput, charAtLocation, currentPlace, charPageCount);
            combinedPrompt = result.fullPrompt;
            combinedSimplePrompt = result.simplePrompt;
        } else {
            // é€šå¸¸ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            const result = buildCombinedPrompt(actionMode, userInput, previousPlace, newPlace, charAtLocation, currentPlace, false, companion);
            combinedPrompt = result.fullPrompt;
            combinedSimplePrompt = result.simplePrompt;
        }
        console.log('[Combined] å®Œå…¨ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', combinedPrompt);
        console.log('[Combined] ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ:', combinedSimplePrompt);


        // ç”»åƒç”Ÿæˆã‚’éåŒæœŸã«é–‹å§‹ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸ã®å ´åˆã¯å¾Œã§å€‹åˆ¥ã«ç”Ÿæˆï¼‰
        const imagePromise = charPageCount >= 2 ? null : startImageGenerationAsync(charAtLocation, currentPlace);

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        let streamPageIndex = -1;
        let useAddDialogueMode = false;
        let onStreamChunk = null;

        if (charPageCount < 2) {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¹ãƒˆãƒªãƒ¼ãƒ è¡¨ç¤ºã‚’æœ‰åŠ¹åŒ–
            const streamSetup = setupStreamPage(movePageIndex, currentPlace);
            streamPageIndex = streamSetup.streamPageIndex;
            useAddDialogueMode = streamSetup.useAddDialogueMode;
            onStreamChunk = createStreamChunkHandler(streamPageIndex, useAddDialogueMode, streamSetup.appendBaseHtml);
        }
        // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒ è¡¨ç¤ºã—ãªã„

        // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç”»åƒç”Ÿæˆã‚’å…ˆã«é–‹å§‹ï¼ˆLLMã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
        let imagePromises = [];
        if (charPageCount >= 2 && charAtLocation) {
            const compositionTags = getCompositionTagsForMultiplePages(actions, currentState.actionIndex, charPageCount);
            imagePromises = compositionTags.map(tag =>
                generateCharacterImage({
                    charAtLocation: charAtLocation,
                    place: currentPlace,
                    actionIndex: currentState.actionIndex,
                    compositionTag: tag
                })
            );
        }

        // LLMã®å¿œç­”ã‚’å¾…ã¤ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ å¯¾å¿œï¼‰- ç”»åƒç”Ÿæˆã¨ä¸¦åˆ—
        showStatusLLM();
        const response = await callLLM(chatApiKey, combinedPrompt, 'combined', null, onStreamChunk, combinedSimplePrompt);
        hideStatusLLM();

        console.log('[LLM] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã§ãƒ‘ãƒ¼ã‚¹æ–¹æ³•ã‚’åˆ†å²
        let narrative, dialogue, dialogues, newRelationshipName, relationshipMemo;
        if (charPageCount >= 2 && charAtLocation) {
            const parsed = parseMultipleDialogues(response, charAtLocation, charPageCount);
            narrative = parsed.narrative;
            dialogues = parsed.dialogues;
            newRelationshipName = parsed.newRelationshipName;
            relationshipMemo = parsed.relationshipMemo;
        } else {
            const parsed = parseCombinedResponse(response, charAtLocation);
            narrative = parsed.narrative;
            dialogue = parsed.dialogue;
            newRelationshipName = parsed.newRelationshipName;
            relationshipMemo = parsed.relationshipMemo;
        }

        // æœ€çµ‚çš„ãªåœ°ã®æ–‡ã‚’è¡¨ç¤º
        if (charPageCount >= 2 && narrative && pages.length > 0) {
            // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼šæœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
            const lastPageIndex = pages.length - 1;
            const lastPage = pages[lastPageIndex];
            lastPage.text += (lastPage.text ? '\n' : '') + narrative;
            lastPage.fullText = lastPage.text;
            // DOMæ›´æ–°
            const pageView = document.getElementById('page-view');
            const pageDiv = pageView.querySelector(`.page-content[data-page-index="${lastPageIndex}"]`);
            if (pageDiv) {
                const textDiv = pageDiv.querySelector('.page-text > div');
                if (textDiv) {
                    textDiv.innerHTML = lastPage.text.replace(/\n/g, '<br>');
                }
            }
        } else {
            await displayNarrative(narrative, streamPageIndex, useAddDialogueMode);
        }

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®å‡¦ç†
        updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo);

        // ç”»åƒç”ŸæˆãŒãªã‘ã‚Œã°èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
        if (!imagePromise && charPageCount < 2) {
            hideLoading();
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        if (charAtLocation) {
            if (charPageCount >= 2 && dialogues && dialogues.length > 0) {
                // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼šä¸¦åˆ—ç”Ÿæˆã—ãŸç”»åƒã‚’é †æ¬¡å–å¾—ã—ã¦ãƒšãƒ¼ã‚¸ä½œæˆ
                for (let i = 0; i < dialogues.length; i++) {
                    const imageResult = await imagePromises[i];
                    const charImage = imageResult?.imageURL || null;
                    // å„ãƒšãƒ¼ã‚¸ç”¨ã® genInfo ã‚’ä½œæˆ
                    const pageGenInfo = {
                        ...genInfo,
                        imageGenInfo: imageResult?.imageGenInfo || null
                    };
                    addPage2(charAtLocation.character.name, charImage, dialogues[i], pageGenInfo);
                    enableNextButton();
                }
                // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«ã€Œã‚‚ã£ã¨ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                addMoreButton(pages.length - 1, charAtLocation, currentPlace, charPageCount);
            } else if (dialogue) {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼š1ãƒšãƒ¼ã‚¸ã®ã¿
                const imageResult = imagePromise ? await imagePromise : null;
                const charImage = imageResult?.imageURL || null;
                genInfo.imageGenInfo = imageResult?.imageGenInfo || null;
                addPage2(charAtLocation.character.name, charImage, dialogue, genInfo);
                updatePageStatus();
            }
        }

        // èª­ã¿è¾¼ã¿å®Œäº†
        hideLoading();
    }

    // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒšãƒ¼ã‚¸è¿½åŠ å¾Œã«å‘¼ã³å‡ºã™ï¼‰
    function enableNextButton() {
        const nextBtn = document.getElementById('next-btn');
        if (nextBtn && currentPageIndex < pages.length - 1) {
            nextBtn.classList.add('ready');
        }
    }

    // ãƒšãƒ¼ã‚¸ã®ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
    function getOrCreateButtonContainer(pageIndex) {
        const pageView = document.getElementById('page-view');
        const pageDiv = pageView.querySelector(`.page-content[data-page-index="${pageIndex}"]`);
        if (!pageDiv) return null;

        const pageText = pageDiv.querySelector('.page-text');
        if (!pageText) return null;

        let container = pageText.querySelector('.page-action-buttons');
        if (!container) {
            container = document.createElement('div');
            container.className = 'page-action-buttons';
            container.style.cssText = 'display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap;';
            pageText.appendChild(container);
        }
        return container;
    }

    // ã€Œã‚‚ã£ã¨ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    function addMoreButton(pageIndex, charAtLocation, currentPlace, charPageCount) {
        const container = getOrCreateButtonContainer(pageIndex);
        if (!container) return;

        // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤
        const existingBtn = container.querySelector('.more-button');
        if (existingBtn) existingBtn.remove();

        // ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
        const btn = document.createElement('button');
        btn.className = 'more-button';
        btn.textContent = 'ã‚‚ã£ã¨';
        btn.style.cssText = 'padding:8px 24px; background:#444; color:#fff; border:1px solid #666; border-radius:4px; cursor:pointer; font-size:0.9rem;';
        btn.onmouseover = () => btn.style.background = '#555';
        btn.onmouseout = () => btn.style.background = '#444';

        btn.onclick = async () => {
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';
            await generateMorePages(charAtLocation, currentPlace, charPageCount);
            btn.remove();
            // ã‚³ãƒ³ãƒ†ãƒŠãŒç©ºã«ãªã£ãŸã‚‰å‰Šé™¤
            if (container.children.length === 0) container.remove();
        };

        container.appendChild(btn);
    }

    // ã€Œã‚‚ã£ã¨ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®è¿½åŠ ãƒšãƒ¼ã‚¸ç”Ÿæˆ
    async function generateMorePages(charAtLocation, currentPlace, charPageCount) {
        const chatApiKey = document.getElementById('chatApiKey').value.trim();
        if (!chatApiKey) {
            addSystemMessage('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
        }

        showLoading();
        showStatusLLM();

        try {
            // è¤‡æ•°ã‚»ãƒªãƒ•ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰ï¼ˆã‚‚ã£ã¨ç”¨ã¯llm_015ï¼‰
            const result = buildMultiDialoguePrompt('action_select', '', charAtLocation, currentPlace, charPageCount, 'llm_015');
            console.log('[ã‚‚ã£ã¨] å®Œå…¨ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', result.fullPrompt);
            const response = await callLLM(chatApiKey, result.fullPrompt, 'assistant', charAtLocation?.character, null, result.simplePrompt);
            console.log('[ã‚‚ã£ã¨] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

            hideStatusLLM();

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
            const { narrative, dialogues, newRelationshipName, relationshipMemo } = parseMultipleDialogues(response, charAtLocation, charPageCount);

            // é–¢ä¿‚æ€§å¤‰åŒ–ã®å‡¦ç†
            updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo);

            // åœ°ã®æ–‡ãŒã‚ã‚Œã°æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
            if (narrative && pages.length > 0) {
                const lastPageIndex = pages.length - 1;
                const lastPage = pages[lastPageIndex];
                lastPage.text += (lastPage.text ? '\n' : '') + narrative;
                lastPage.fullText = lastPage.text;
                // DOMæ›´æ–°
                const pageView = document.getElementById('page-view');
                const pageDiv = pageView.querySelector(`.page-content[data-page-index="${lastPageIndex}"]`);
                if (pageDiv) {
                    const textDiv = pageDiv.querySelector('.page-text > div');
                    if (textDiv) {
                        textDiv.innerHTML = lastPage.text.replace(/\n/g, '<br>');
                    }
                }
            }

            // genInfoæ§‹ç¯‰
            const genInfo = createGenInfo('more', charAtLocation, currentPlace);

            // ãƒšãƒ¼ã‚¸ç”Ÿæˆ
            for (let i = 0; i < dialogues.length; i++) {
                // ç”»åƒç”Ÿæˆï¼ˆã‚‚ã£ã¨ç”¨ã¯ explicit ã‚’è¿½åŠ ï¼‰
                const compositionTag = getCompositionTag(actions, currentState.actionIndex);
                const imageResult = await generateCharacterImage({
                    charAtLocation: charAtLocation,
                    place: currentPlace,
                    actionIndex: currentState.actionIndex,
                    compositionTag: compositionTag,
                    promptPrefix: 'explicit'
                });
                const charImage = imageResult?.imageURL || null;

                const pageGenInfo = {
                    ...genInfo,
                    imageGenInfo: imageResult?.imageGenInfo || null
                };
                addPage2(charAtLocation.character.name, charImage, dialogues[i], pageGenInfo);
                enableNextButton();
            }

            // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const lastPageIndex = pages.length - 1;
            addMoreButton(lastPageIndex, charAtLocation, currentPlace, charPageCount);

            // next_actionãŒå®šç¾©ã•ã‚Œã¦ã„ã‚Œã°ã€Œæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ãƒœã‚¿ãƒ³ã‚‚è¿½åŠ 
            const currentAction = currentState.actionIndex >= 0 ? actions[currentState.actionIndex] : null;
            if (currentAction?.next_action) {
                const nextAction = actions.find(a => a.action_id === currentAction.next_action);
                if (nextAction) {
                    appendNextActionButtonToPage(lastPageIndex, nextAction);
                }
            }

        } catch (e) {
            console.error('[generateMorePages] ã‚¨ãƒ©ãƒ¼:', e);
            addSystemMessage('è¿½åŠ ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            hideStatusLLM();
        }

        hideLoading();
    }

    // ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½
    function saveGameState() {
        try {
            const saveData = {
                version: 1,
                timestamp: new Date().toISOString(),
                pages: pages,
                characterStatus: characterStatus,
                userState: userState,
                currentState: currentState,
                currentPageIndex: currentPageIndex,
                chatHistory: chatHistory
            };
            localStorage.setItem('transition_game_save', JSON.stringify(saveData));
            addSystemMessage('ğŸ’¾ ã‚²ãƒ¼ãƒ ã‚’ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ');
            console.log('[Save] ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä¿å­˜:', saveData);
        } catch (e) {
            console.error('[Save] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
            addSystemMessage('âŒ ã‚»ãƒ¼ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
    }

    // ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    function loadGameState() {
        try {
            const savedData = localStorage.getItem('transition_game_save');
            if (!savedData) {
                addSystemMessage('âš ï¸ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const saveData = JSON.parse(savedData);
            console.log('[Load] ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿:', saveData);

            // çŠ¶æ…‹ã‚’å¾©å…ƒ
            characterStatus = saveData.characterStatus || [];
            userState = saveData.userState || { placeIndex: -1 };
            currentState = saveData.currentState || { characterIndex: -1, placeIndex: -1, actionIndex: -1 };
            chatHistory = saveData.chatHistory || [];

            // ãƒšãƒ¼ã‚¸ã‚’å¾©å…ƒï¼ˆDOMå†æ§‹ç¯‰ï¼‰
            pages = [];
            currentPageIndex = -1;
            const pageView = document.getElementById('page-view');
            // info-buttonã¨pageInfoPanelã¯ä¿æŒã—ã€page-contentã®ã¿å‰Šé™¤
            pageView.querySelectorAll('.page-content').forEach(el => el.remove());

            if (saveData.pages && saveData.pages.length > 0) {
                for (const page of saveData.pages) {
                    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦DOMã‚’å†æ§‹ç¯‰ï¼ˆgenInfoã‚‚å¾©å…ƒï¼‰
                    if (page.type === 'character') {
                        addPage2(page.speaker, page.image, page.text, page.genInfo || null);
                    } else {
                        addPage1(page.image, page.text, page.genInfo || null);
                    }
                    // typewriterå®Œäº†çŠ¶æ…‹ã‚’å¾©å…ƒ
                    const lastIdx = pages.length - 1;
                    if (pages[lastIdx]) {
                        pages[lastIdx].typewriterCompleted = true;
                    }
                }
                // ä¿å­˜æ™‚ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                const targetPageIndex = saveData.currentPageIndex >= 0 ? saveData.currentPageIndex : pages.length - 1;
                showPage(targetPageIndex);
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            updateCharacterStatusDisplay();
            updateUserStatusDisplay();

            const savedTime = new Date(saveData.timestamp).toLocaleString('ja-JP');
            addSystemMessage(`ğŸ“‚ ã‚²ãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ (${savedTime})`);
        } catch (e) {
            console.error('[Load] èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            addSystemMessage('âŒ ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
    }

    // genInfoã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ±ºï¼ˆå…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼‰
    function resolveGenInfoObjects(genInfo) {
        if (!genInfo) return { char: null, place: null, actionIndex: -1 };
        return {
            char: genInfo.characterId ? characters.find(c => c.character_id === genInfo.characterId) : null,
            place: genInfo.placeId ? places.find(p => p.place_id === genInfo.placeId) : null,
            actionIndex: genInfo.actionId ? actions.findIndex(a => a.action_id === genInfo.actionId) : -1
        };
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«â†’GASï¼‰
    const fieldNameMapping = {
        action: { name: 'action name' }
    };

    // æ±ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç·¨é›†ãƒãƒ³ãƒ‰ãƒ©ï¼ˆãƒšãƒ¼ã‚¸æƒ…å ±ãƒ‘ãƒãƒ«ç”¨ï¼‰
    function setupFieldEditor(prefix, dataArray, idField, targetId, fieldName, sheetName, emptyText = '') {
        const editBtn = document.getElementById(`${prefix}-edit-btn`);
        if (!editBtn || !targetId) return;

        const displayRow = document.getElementById(`${prefix}-row`);
        const editRow = document.getElementById(`${prefix}-edit-row`);
        const input = document.getElementById(`${prefix}-input`);
        const display = document.getElementById(`${prefix}-display`);

        editBtn.onclick = () => {
            displayRow.style.display = 'none';
            editRow.style.display = 'flex';
            input.focus();
        };

        document.getElementById(`${prefix}-cancel-btn`).onclick = () => {
            editRow.style.display = 'none';
            displayRow.style.display = 'flex';
            const record = dataArray.find(r => r[idField] === targetId);
            input.value = record?.[fieldName] || '';
        };

        document.getElementById(`${prefix}-save-btn`).onclick = async () => {
            const newValue = input.value.trim();
            const gasUrl = document.getElementById('gasUrl').value.trim();
            if (!gasUrl) {
                showStatus('GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const record = dataArray.find(r => r[idField] === targetId);
            if (record) {
                record[fieldName] = newValue;
            }

            showStatus('ä¿å­˜ä¸­...', 'loading');
            try {
                // GASç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«å¤‰æ›
                const gasFieldName = fieldNameMapping[sheetName]?.[fieldName] || fieldName;
                // å˜ä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°API
                await updateGasField(gasUrl, sheetName, idField, targetId, gasFieldName, newValue);
                saveCachedData();
                showStatus('ä¿å­˜ã—ã¾ã—ãŸ', 'ok');
                display.textContent = newValue || emptyText;
                editRow.style.display = 'none';
                displayRow.style.display = 'flex';
            } catch (e) {
                console.error('[GAS] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                showStatus('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        };
    }

    // ãƒšãƒ¼ã‚¸æƒ…å ±: åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³HTMLç”Ÿæˆ
    function buildBasicInfoHtml(page, pageIndex, totalPages) {
        const typeLabels = { narrative: 'åœ°ã®æ–‡ãƒšãƒ¼ã‚¸', character: 'ã‚»ãƒªãƒ•ã®ãƒšãƒ¼ã‚¸' };
        let html = '<div class="page-info-section">';
        html += `<div class="page-info-section-title">ãƒšãƒ¼ã‚¸ ${pageIndex + 1}/${totalPages}</div>`;
        if (page.type) {
            html += `<div class="page-info-row"><span class="page-info-label">ç¨®åˆ¥:</span><span class="page-info-value">${typeLabels[page.type] || page.type}</span></div>`;
        }
        html += '</div>';
        return html;
    }

    // ãƒšãƒ¼ã‚¸æƒ…å ±: ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³HTMLç”Ÿæˆ
    function buildGenParamsHtml(genInfo) {
        let html = '<div class="page-info-section">';
        html += '<div class="page-info-section-title">ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div>';
        if (genInfo.actionMode) html += `<div class="page-info-row"><span class="page-info-label">mode:</span><span class="page-info-value">${escapeHtml(genInfo.actionMode)}</span></div>`;

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ï¼ˆæ€§æ ¼ã¯å¾Œã§è¡¨ç¤ºï¼‰
        const char = genInfo.characterId ? characters.find(c => c.character_id === genInfo.characterId) : null;
        if (char) {
            const charDisplay = `${escapeHtml(char.name)}`;
            const charIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.characterId)})</span>`;
            html += `<div class="page-info-row"><span class="page-info-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</span><span class="page-info-value">${charDisplay}${charIdDisplay}</span></div>`;
            const profileText = char.profile ? escapeHtml(char.profile) : 'ãªã—';
            html += `<div class="page-info-row"><span class="page-info-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:</span><span class="page-info-value" style="color:#aaa; font-size:0.85rem;">${profileText}</span></div>`;
        }
        if (genInfo.placeId) {
            const place = places.find(p => p.place_id === genInfo.placeId);
            const placeDisplay = place?.name ? `${escapeHtml(place.name)}` : '';
            const placeIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.placeId)})</span>`;
            html += `<div class="page-info-row"><span class="page-info-label">å ´æ‰€:</span><span class="page-info-value">${placeDisplay}${placeIdDisplay}</span></div>`;
        }
        if (genInfo.actionId) {
            const action = actions.find(a => a.action_id === genInfo.actionId);
            const actionDisplay = action?.name ? `${escapeHtml(action.name)}` : '';
            const actionIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.actionId)})</span>`;
            html += `<div class="page-info-row" id="action-name-row">`;
            html += `<span class="page-info-label">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</span>`;
            html += `<span class="page-info-value">`;
            html += `<span id="action-name-display">${actionDisplay}</span>${actionIdDisplay}`;
            html += ` <button id="action-name-edit-btn" style="font-size:0.7rem; padding:1px 6px; margin-left:8px; cursor:pointer;">ç·¨é›†</button>`;
            html += `</span></div>`;
            // ç·¨é›†UIï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
            html += `<div class="page-info-row" id="action-name-edit-row" style="display:none;">`;
            html += `<span class="page-info-label">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</span>`;
            html += `<span class="page-info-value" style="width:100%;">`;
            html += `<input type="text" id="action-name-input" style="width:60%; font-size:0.85rem; padding:2px 4px;" value="${escapeHtml(action?.name || '')}">`;
            html += ` <button id="action-name-save-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">æ±ºå®š</button>`;
            html += ` <button id="action-name-cancel-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">å–æ¶ˆ</button>`;
            html += `</span></div>`;
        }
        if (genInfo.costumeId) {
            const costume = costumes.find(c => c.costume_id === genInfo.costumeId);
            const costumeDisplay = costume?.name ? `${escapeHtml(costume.name)}` : '';
            const costumeIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.costumeId)})</span>`;
            html += `<div class="page-info-row"><span class="page-info-label">æœè£…:</span><span class="page-info-value">${costumeDisplay}${costumeIdDisplay}</span></div>`;
        }
        // é–¢ä¿‚æ€§
        if (genInfo.relationshipId) {
            const relationship = relationships.find(r => r.relationship_id === genInfo.relationshipId);
            const relationshipDisplay = relationship?.name ? `${escapeHtml(relationship.name)}` : '';
            const relationshipIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.relationshipId)})</span>`;
            html += `<div class="page-info-row"><span class="page-info-label">é–¢ä¿‚æ€§:</span><span class="page-info-value">${relationshipDisplay}${relationshipIdDisplay}</span></div>`;
            // descriptionç·¨é›†å¯èƒ½è¡Œ
            const descText = relationship?.description || '';
            html += `<div class="page-info-row" id="rel-desc-row">`;
            html += `<span class="page-info-label"></span>`;
            html += `<span class="page-info-value" style="color:#aaa; font-size:0.85rem;">`;
            html += `<span id="rel-desc-display">${escapeHtml(descText)}</span>`;
            html += ` <button id="rel-desc-edit-btn" style="font-size:0.7rem; padding:1px 6px; margin-left:8px; cursor:pointer;">ç·¨é›†</button>`;
            html += `</span></div>`;
            // ç·¨é›†UIï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
            html += `<div class="page-info-row" id="rel-desc-edit-row" style="display:none;">`;
            html += `<span class="page-info-label"></span>`;
            html += `<span class="page-info-value" style="width:100%;">`;
            html += `<input type="text" id="rel-desc-input" style="width:70%; font-size:0.85rem; padding:2px 4px;" value="${escapeHtml(descText)}">`;
            html += ` <button id="rel-desc-save-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">æ±ºå®š</button>`;
            html += ` <button id="rel-desc-cancel-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">å–æ¶ˆ</button>`;
            html += `</span></div>`;
            // next_relationship_reqç·¨é›†å¯èƒ½è¡Œ
            const reqText = relationship?.next_relationship_req || '';
            html += `<div class="page-info-row" id="rel-req-row">`;
            html += `<span class="page-info-label">ç™ºå±•æ¡ä»¶:</span>`;
            html += `<span class="page-info-value" style="color:#aaa; font-size:0.85rem;">`;
            html += `<span id="rel-req-display">${escapeHtml(reqText) || '(ãªã—)'}</span>`;
            html += ` <button id="rel-req-edit-btn" style="font-size:0.7rem; padding:1px 6px; margin-left:8px; cursor:pointer;">ç·¨é›†</button>`;
            html += `</span></div>`;
            // ç·¨é›†UIï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
            html += `<div class="page-info-row" id="rel-req-edit-row" style="display:none;">`;
            html += `<span class="page-info-label">ç™ºå±•æ¡ä»¶:</span>`;
            html += `<span class="page-info-value" style="width:100%;">`;
            html += `<input type="text" id="rel-req-input" style="width:60%; font-size:0.85rem; padding:2px 4px;" value="${escapeHtml(reqText)}">`;
            html += ` <button id="rel-req-save-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">æ±ºå®š</button>`;
            html += ` <button id="rel-req-cancel-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">å–æ¶ˆ</button>`;
            html += `</span></div>`;
        }
        // æ€§æ ¼ï¼ˆé–¢ä¿‚æ€§ã®å¾Œã«è¡¨ç¤ºï¼‰
        if (char?.personality) {
            const personality = personalities.find(p => p.personality_id === char.personality);
            if (personality) {
                const persDisplay = `${escapeHtml(personality.name)}`;
                const persIdDisplay = ` <span style="color:#888">(${escapeHtml(char.personality)})</span>`;
                html += `<div class="page-info-row"><span class="page-info-label">æ€§æ ¼:</span><span class="page-info-value">${persDisplay}${persIdDisplay}</span></div>`;

                // descriptionè¡¨ç¤ºï¼ˆå¸¸ã«è¡¨ç¤ºãƒ»ç·¨é›†å¯èƒ½ï¼‰
                const descText = personality.description || '';
                html += `<div class="page-info-row" id="pers-desc-row">`;
                html += `<span class="page-info-label"></span>`;
                html += `<span class="page-info-value" style="color:#aaa; font-size:0.85rem;">`;
                html += `<span id="pers-desc-display">${escapeHtml(descText) || '(ãªã—)'}</span>`;
                html += ` <button id="pers-desc-edit-btn" style="font-size:0.7rem; padding:1px 6px; margin-left:8px; cursor:pointer;">ç·¨é›†</button>`;
                html += `</span></div>`;
                // descriptionç·¨é›†UIï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
                html += `<div class="page-info-row" id="pers-desc-edit-row" style="display:none;">`;
                html += `<span class="page-info-label"></span>`;
                html += `<span class="page-info-value" style="width:100%;">`;
                html += `<input type="text" id="pers-desc-input" style="width:70%; font-size:0.85rem; padding:2px 4px;" value="${escapeHtml(descText)}">`;
                html += ` <button id="pers-desc-save-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">æ±ºå®š</button>`;
                html += ` <button id="pers-desc-cancel-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">å–æ¶ˆ</button>`;
                html += `</span></div>`;

                // é–¢ä¿‚æ€§ã®stageã«å¿œã˜ãŸèª¬æ˜ï¼ˆstage 1-4ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰
                const relationship = genInfo.relationshipId ? relationships.find(r => r.relationship_id === genInfo.relationshipId) : null;
                const stageNum = relationship?.stage ? parseInt(relationship.stage) : null;
                if (stageNum >= 1 && stageNum <= 4) {
                    const stageField = `stage_${stageNum}`;
                    const persStageText = personality[stageField] || '';

                    // stageèª¬æ˜ç·¨é›†å¯èƒ½è¡Œ
                    html += `<div class="page-info-row" id="pers-stage-row">`;
                    html += `<span class="page-info-label"><span style="color:#888; font-size:0.8rem;">(${stageField})</span></span>`;
                    html += `<span class="page-info-value" style="color:#aaa; font-size:0.85rem;">`;
                    html += `<span id="pers-stage-display">${escapeHtml(persStageText) || '(ãªã—)'}</span>`;
                    html += ` <button id="pers-stage-edit-btn" style="font-size:0.7rem; padding:1px 6px; margin-left:8px; cursor:pointer;">ç·¨é›†</button>`;
                    html += `</span></div>`;
                    // ç·¨é›†UIï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
                    html += `<div class="page-info-row" id="pers-stage-edit-row" style="display:none;">`;
                    html += `<span class="page-info-label"><span style="color:#888; font-size:0.8rem;">(${stageField})</span></span>`;
                    html += `<span class="page-info-value" style="width:100%;">`;
                    html += `<input type="text" id="pers-stage-input" data-field="${stageField}" style="width:70%; font-size:0.85rem; padding:2px 4px;" value="${escapeHtml(persStageText)}">`;
                    html += ` <button id="pers-stage-save-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">æ±ºå®š</button>`;
                    html += ` <button id="pers-stage-cancel-btn" style="font-size:0.7rem; padding:2px 8px; cursor:pointer;">å–æ¶ˆ</button>`;
                    html += `</span></div>`;
                }
            }
        }
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒå®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆagent=character ã‹ã¤ req_stage <= é–¢ä¿‚æ€§stage ã‹ã¤ req_stage <= å ´æ‰€ã®req_stageï¼‰
        if (char && genInfo.relationshipId && genInfo.placeId) {
            const relationship = relationships.find(r => r.relationship_id === genInfo.relationshipId);
            const place = places.find(p => p.place_id === genInfo.placeId);
            const currentStage = parseInt(relationship?.stage, 10) || 0;
            const placeReqStageRaw = parseInt(place?.req_stage, 10);
            // place.req_stageãŒç©º/ç„¡åŠ¹ãªã‚‰åˆ¶é™ãªã—ï¼ˆcurrentStageã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
            const maxAllowedStage = isNaN(placeReqStageRaw) ? currentStage : Math.min(currentStage, placeReqStageRaw);
            const charActions = actions.filter(action => {
                if (action.agent !== 'character') return false;
                const reqStage = parseInt(action.req_stage, 10);
                if (isNaN(reqStage)) return false;
                return reqStage <= maxAllowedStage;
            });
            if (charActions.length > 0) {
                html += `<div class="page-info-row" style="margin-top:8px;"><span class="page-info-label" style="color:#8af;">${escapeHtml(char.name)}ãŒå®Ÿè¡Œå¯èƒ½:</span></div>`;
                charActions.forEach((action, idx) => {
                    const prefix = `char-action-${idx}`;
                    html += `<div class="page-info-row" id="${prefix}-row">`;
                    html += `<span class="page-info-label"></span>`;
                    html += `<span class="page-info-value" style="color:#aaa; font-size:0.85rem;">`;
                    html += `ãƒ»<span id="${prefix}-display">${escapeHtml(action.name)}</span>`;
                    html += ` <span style="color:#888; font-size:0.75rem;">(${escapeHtml(action.action_id)})</span>`;
                    html += ` <button id="${prefix}-edit-btn" style="font-size:0.65rem; padding:0px 4px; margin-left:4px; cursor:pointer;">ç·¨é›†</button>`;
                    html += `</span></div>`;
                    // ç·¨é›†UIï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
                    html += `<div class="page-info-row" id="${prefix}-edit-row" style="display:none;">`;
                    html += `<span class="page-info-label"></span>`;
                    html += `<span class="page-info-value" style="width:100%;">`;
                    html += `<input type="text" id="${prefix}-input" style="width:60%; font-size:0.8rem; padding:2px 4px;" value="${escapeHtml(action.name)}">`;
                    html += ` <button id="${prefix}-save-btn" style="font-size:0.65rem; padding:1px 6px; cursor:pointer;">æ±ºå®š</button>`;
                    html += ` <button id="${prefix}-cancel-btn" style="font-size:0.65rem; padding:1px 6px; cursor:pointer;">å–æ¶ˆ</button>`;
                    html += `</span></div>`;
                });
            }
        }
        html += '</div>';
        return html;
    }

    // ãƒšãƒ¼ã‚¸æƒ…å ±: LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³HTMLç”Ÿæˆ
    function buildLLMPromptSectionHtml(genInfo, objects) {
        let html = '<div class="page-info-section">';
        html += '<div class="page-info-section-title">LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå†ç¾ï¼‰</div>';

        let reconstructedPrompt = null;
        try {
            const { char, place, actionIndex } = objects;

            // charAtLocationã‚’å†æ§‹ç¯‰
            let charAtLocation = null;
            if (char) {
                charAtLocation = {
                    character: char,
                    status: {
                        characterIndex: characters.indexOf(char),
                        placeIndex: place ? places.indexOf(place) : -1,
                        actionIndex: actionIndex,
                        relationshipId: genInfo.relationshipId || null,
                        costumeId: genInfo.costumeId || null
                    }
                };
            }

            // currentStateã‚’ä¸€æ™‚çš„ã«è¨­å®šã—ã¦buildCombinedPromptã‚’å‘¼ã³å‡ºã™
            const savedActionIndex = currentState.actionIndex;
            currentState.actionIndex = actionIndex;

            const result = buildCombinedPrompt(
                genInfo.actionMode,
                '',  // userInputã¯ä¿æŒã—ã¦ã„ãªã„ã®ã§ç©º
                null,  // previousPlace
                place,  // newPlace (ç§»å‹•æ™‚)
                charAtLocation,
                place,  // currentPlace
                false,  // dialogueOnly
                null   // companion
            );

            currentState.actionIndex = savedActionIndex;

            if (result && result.fullPrompt) {
                reconstructedPrompt = result.fullPrompt;
            }
        } catch (e) {
            console.log('[PageInfo] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾ã‚¨ãƒ©ãƒ¼:', e);
        }

        if (reconstructedPrompt) {
            html += `<div class="page-info-text">${escapeHtml(reconstructedPrompt)}</div>`;
        } else {
            html += '<div style="color:#888">(å†ç¾ä¸å¯)</div>';
        }
        html += '</div>';
        return html;
    }

    // ãƒšãƒ¼ã‚¸æƒ…å ±: ç”»åƒç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³HTMLç”Ÿæˆ
    function buildImageGenSectionHtml(genInfo, objects) {
        if (!genInfo.imageGenInfo) return '';

        const img = genInfo.imageGenInfo;
        const { char, place, actionIndex } = objects;

        let html = '<div class="page-info-section">';
        html += '<div class="page-info-section-title">ç”»åƒç”Ÿæˆ</div>';

        if (img.modelId) {
            const model = models[img.modelId];
            const modelDisplay = model?.name ? `${escapeHtml(model.name)}` : '';
            const modelIdDisplay = ` <span style="color:#888">(${escapeHtml(img.modelId)})</span>`;
            html += `<div class="page-info-row"><span class="page-info-label">ãƒ¢ãƒ‡ãƒ«:</span><span class="page-info-value">${modelDisplay}${modelIdDisplay}</span></div>`;
        }
        if (img.seed) html += `<div class="page-info-row"><span class="page-info-label">ã‚·ãƒ¼ãƒ‰:</span><span class="page-info-value">${img.seed}</span></div>`;
        if (img.compositionTag) html += `<div class="page-info-row"><span class="page-info-label">æ§‹å›³:</span><span class="page-info-value">${escapeHtml(img.compositionTag)}</span></div>`;

        // æœè£…ã‚¿ã‚°
        if (genInfo.costumeId) {
            const costume = costumes.find(c => c.costume_id === genInfo.costumeId);
            if (costume?.tag) html += `<div class="page-info-row"><span class="page-info-label">æœè£…ã‚¿ã‚°:</span><span class="page-info-value">${escapeHtml(costume.tag)}</span></div>`;
        }

        // è¡¨æƒ…ã‚¿ã‚°
        if (genInfo.relationshipId) {
            const rel = relationships.find(r => r.relationship_id === genInfo.relationshipId);
            if (rel?.expression) html += `<div class="page-info-row"><span class="page-info-label">è¡¨æƒ…:</span><span class="page-info-value">${escapeHtml(rel.expression)}</span></div>`;
        }

        // ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾
        try {
            const imagePromptResult = buildImageGenPrompt(
                img.modelId,
                char,
                place,
                actionIndex,
                img.compositionTag,
                genInfo.costumeId,
                genInfo.relationshipId
            );
            if (imagePromptResult?.finalPrompt) {
                html += '<div style="margin-top:8px"><span class="page-info-label">ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå†ç¾ï¼‰:</span></div>';
                html += `<div class="page-info-text">${escapeHtml(imagePromptResult.finalPrompt)}</div>`;
            }
        } catch (e) {
            console.log('[PageInfo] ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾ã‚¨ãƒ©ãƒ¼:', e);
        }

        html += '</div>';
        return html;
    }

    // ãƒšãƒ¼ã‚¸æƒ…å ±: ç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆã¸ã®é·ç§»ãƒªãƒ³ã‚¯
    function buildImageGenLinkHtml(genInfo, imageUrl) {
        if (!genInfo) return '';

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
        const params = new URLSearchParams();
        if (genInfo.characterId) params.set('characterId', genInfo.characterId);
        if (genInfo.placeId) params.set('placeId', genInfo.placeId);
        if (genInfo.actionId) params.set('actionId', genInfo.actionId);
        if (genInfo.costumeId) params.set('costumeId', genInfo.costumeId);
        if (genInfo.relationshipId) params.set('relationshipId', genInfo.relationshipId);
        if (genInfo.imageGenInfo?.seed) params.set('seed', genInfo.imageGenInfo.seed);
        if (imageUrl) params.set('imageUrl', imageUrl);

        const url = `image_gen_setting.html?${params.toString()}`;

        let html = '<div class="page-info-section" style="text-align:center; padding-top:15px; border-top:1px solid #444;">';
        html += `<a href="${url}" target="_blank" class="btn" style="display:inline-block; padding:10px 20px; background:#2a4a6a; color:#8cf; border:1px solid #4a6a8a; border-radius:4px; text-decoration:none; font-size:0.9rem;">`;
        html += 'ç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆ &rarr;';
        html += '</a>';
        html += '</div>';
        return html;
    }

    // ãƒšãƒ¼ã‚¸æƒ…å ±è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤ºæ™‚ã®æƒ…å ±ãƒœã‚¿ãƒ³ï¼‰
    function showPageInfo() {
        if (currentPageIndex < 0 || !pages[currentPageIndex]) {
            console.log('[Info] ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        const page = pages[currentPageIndex];
        const genInfo = page.genInfo;

        let html = '';

        // åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        html += buildBasicInfoHtml(page, currentPageIndex, pages.length);

        if (genInfo) {
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’1å›ã ã‘è§£æ±º
            const objects = resolveGenInfoObjects(genInfo);

            // ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += buildGenParamsHtml(genInfo);

            // LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += buildLLMPromptSectionHtml(genInfo, objects);

            // ç”»åƒç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += buildImageGenSectionHtml(genInfo, objects);

            // ç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆã¸ã®é·ç§»ãƒœã‚¿ãƒ³
            html += buildImageGenLinkHtml(genInfo, page.image);
        } else {
            html += '<div class="page-info-section"><div style="color:#888">(ç”Ÿæˆæƒ…å ±ãªã—)</div></div>';
        }

        document.getElementById('pageInfoContent').innerHTML = html;
        document.getElementById('pageInfoPanel').classList.add('active');

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿è¨­å®š
        if (genInfo?.actionId) {
            setupFieldEditor('action-name', actions, 'action_id', genInfo.actionId, 'name', 'action');
        }
        if (genInfo?.relationshipId) {
            setupFieldEditor('rel-desc', relationships, 'relationship_id', genInfo.relationshipId, 'description', 'relationship');
            setupFieldEditor('rel-req', relationships, 'relationship_id', genInfo.relationshipId, 'next_relationship_req', 'relationship', '(ãªã—)');
        }
        if (genInfo?.characterId) {
            const char = characters.find(c => c.character_id === genInfo.characterId);
            if (char?.personality) {
                // descriptionç·¨é›†UIè¨­å®šï¼ˆå¸¸ã«è¨­å®šï¼‰
                setupFieldEditor('pers-desc', personalities, 'personality_id', char.personality, 'description', 'personality', '(ãªã—)');
                // é–¢ä¿‚æ€§ã®stageã«å¿œã˜ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’å–å¾—ï¼ˆstage 1-4ã®å ´åˆã®ã¿ç·¨é›†UIè¨­å®šï¼‰
                const relationship = genInfo.relationshipId ? relationships.find(r => r.relationship_id === genInfo.relationshipId) : null;
                const stageNum = relationship?.stage ? parseInt(relationship.stage) : null;
                if (stageNum >= 1 && stageNum <= 4) {
                    const stageField = `stage_${stageNum}`;
                    setupFieldEditor('pers-stage', personalities, 'personality_id', char.personality, stageField, 'personality', '(ãªã—)');
                }
            }
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å®Ÿè¡Œå¯èƒ½ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç·¨é›†ãƒãƒ³ãƒ‰ãƒ©è¨­å®š
            if (genInfo.relationshipId && genInfo.placeId) {
                const relationship = relationships.find(r => r.relationship_id === genInfo.relationshipId);
                const place = places.find(p => p.place_id === genInfo.placeId);
                const currentStage = parseInt(relationship?.stage, 10) || 0;
                const placeReqStageRaw = parseInt(place?.req_stage, 10);
                const maxAllowedStage = isNaN(placeReqStageRaw) ? currentStage : Math.min(currentStage, placeReqStageRaw);
                const charActions = actions.filter(action => {
                    if (action.agent !== 'character') return false;
                    const reqStage = parseInt(action.req_stage, 10);
                    if (isNaN(reqStage)) return false;
                    return reqStage <= maxAllowedStage;
                });
                charActions.forEach((action, idx) => {
                    const prefix = `char-action-${idx}`;
                    setupFieldEditor(prefix, actions, 'action_id', action.action_id, 'name', 'action');
                });
            }
        }
    }

    function closePageInfo() {
        document.getElementById('pageInfoPanel').classList.remove('active');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

</script>

</body>
</html>
