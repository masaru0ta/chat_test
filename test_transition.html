<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Transition Test</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/transition.css">
</head>
<body>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆç”»åƒç”Ÿæˆç”¨ï¼‰ -->
<div class="status-indicator" id="statusIndicator">
    <div class="status-item image" id="statusImage">
        <div class="status-spinner"></div>
    </div>
</div>

<!-- ãƒ­ãƒƒã‚¯ç”»é¢ -->
<div class="lock-screen hidden" id="lockScreen">
    <div class="lock-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
    <div class="lock-input-container">
        <input type="password" class="lock-digit" id="lockDigit1" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit2" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit3" maxlength="1" inputmode="none" readonly>
        <input type="password" class="lock-digit" id="lockDigit4" maxlength="1" inputmode="none" readonly>
    </div>
    <div class="lock-error" id="lockError"></div>
    <div class="lock-numpad">
        <button class="lock-numpad-btn" onclick="onNumpadInput('1')">1</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('2')">2</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('3')">3</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('4')">4</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('5')">5</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('6')">6</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('7')">7</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('8')">8</button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('9')">9</button>
        <button class="lock-numpad-btn" style="visibility:hidden;"></button>
        <button class="lock-numpad-btn" onclick="onNumpadInput('0')">0</button>
        <button class="lock-numpad-btn backspace" onclick="onNumpadBackspace()">âŒ«</button>
    </div>
</div>

<div class="app-container" id="appContainer">
    <!-- æ—§ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«ï¼ˆçµ±åˆãƒãƒ¼ã«ç§»å‹•ï¼‰ -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰" style="display:none;">â˜°</button>
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
        <div class="sidebar-content">
            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
            <div id="characters-container"></div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="current-state">
                <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                <div class="state-item">
                    <span class="state-label">ç¾åœ¨åœ°</span>
                    <span class="state-value" id="user-place">æœªé¸æŠ</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startInitialSetup()" style="width:100%; margin-bottom:10px;">åˆæœŸè¨­å®š</button>
            <button class="btn" onclick="openSettings()" style="width:100%; background:#333; color:#fff; border:1px solid #444; padding:10px; border-radius:4px; cursor:pointer; margin-bottom:10px;">è¨­å®š</button>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn" onclick="saveGameState()" style="flex:1; background:#2a4a2a; color:#8f8; border:1px solid #4a4; padding:10px; border-radius:4px; cursor:pointer;">ã‚»ãƒ¼ãƒ–</button>
                <button class="btn" onclick="loadGameState()" style="flex:1; background:#4a2a2a; color:#f88; border:1px solid #a44; padding:10px; border-radius:4px; cursor:pointer;">ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <button class="btn" onclick="toggleFullscreen()" style="width:100%; background:#222; color:#888; border:1px solid #333; padding:10px; border-radius:4px; cursor:pointer;">å…¨ç”»é¢åˆ‡æ›¿</button>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h3>è¨­å®š</h3>
                <button class="settings-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="settings-group">
                <label>GAS URL</label>
                <div class="settings-row">
                    <input type="text" id="gasUrl" placeholder="GAS URL" onchange="saveGasUrl()">
                    <button class="btn" id="llmLogToggle" onclick="toggleLLMLog()" style="padding:8px 12px; font-size:0.8rem;" title="LLMãƒ­ã‚°ä¿å­˜">OFF</button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="loadAllFromGas()" style="width:100%; margin-bottom:15px;">GASèª­ã¿è¾¼ã¿</button>
            <div class="settings-group">
                <label>OpenRouter API Key</label>
                <input type="password" id="chatApiKey" placeholder="OpenRouter API Key" onchange="saveChatApiKey()">
            </div>
            <div class="settings-group">
                <label>Runware API Key</label>
                <div class="settings-row">
                    <input type="password" id="runwareApiKey" placeholder="Runware API Key" onchange="saveRunwareApiKey()">
                    <button class="btn" id="imageGenToggle" onclick="toggleImageGen()" style="padding:8px 12px; font-size:0.8rem;">ON</button>
                </div>
            </div>
            <div class="settings-group">
                <label>LLMãƒ¢ãƒ‡ãƒ«</label>
                <select id="llmModelSelect" onchange="onLLMModelSelect()">
                    <option value="x-ai/grok-4.1-fast">Grok 4.1 Fast</option>
                    <option value="x-ai/grok-4-fast">Grok 4 Fast</option>
                </select>
            </div>
            <div class="settings-group">
                <label>ç”»åƒãƒ¢ãƒ‡ãƒ«</label>
                <select id="modelSelect" onchange="onModelSelect()">
                    <option value="">-- ç”»åƒãƒ¢ãƒ‡ãƒ«é¸æŠ --</option>
                </select>
            </div>
            <div class="settings-group">
                <label>ç™»å ´äººæ•°</label>
                <input type="number" id="characterCountInput" min="1" max="10" value="2" onchange="onCharacterCountChange()" style="width:80px;">
            </div>
            <div class="settings-group">
                <label>ãƒ­ãƒƒã‚¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰</label>
                <input type="password" id="lockPasswordInput" maxlength="4" placeholder="4æ¡ã®æ•°å­—" inputmode="numeric" pattern="[0-9]{4}" onchange="saveLockPassword()" style="width:100px;">
            </div>
            <div class="settings-group" style="margin-top:15px; padding-top:15px; border-top:1px solid #444;">
                <label>GASè¨­å®šåŒæœŸ</label>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="saveSettingsToGas()" style="flex:1; background:#2a4a2a; color:#8f8; border:1px solid #4a4; padding:10px; border-radius:4px; cursor:pointer;">GASã«ä¿å­˜</button>
                    <button class="btn" onclick="loadSettingsFromGas()" style="flex:1; background:#2a2a4a; color:#88f; border:1px solid #44a; padding:10px; border-radius:4px; cursor:pointer;">GASã‹ã‚‰èª­è¾¼</button>
                </div>
            </div>
            <div id="status"></div>
        </div>
    </div>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="toast"></div>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="chat-area">
        <div class="page-area">
            <div id="page-view">
                <!-- ãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤ºæ™‚ã®æƒ…å ±ãƒœã‚¿ãƒ³ -->
                <button class="info-button" id="infoButton" onclick="showPageInfo()" title="ãƒšãƒ¼ã‚¸æƒ…å ±">i</button>
                <!-- ãƒšãƒ¼ã‚¸æƒ…å ±ãƒ‘ãƒãƒ« -->
                <div class="page-info-panel" id="pageInfoPanel">
                    <div class="page-info-header">
                        <h3>ãƒšãƒ¼ã‚¸æƒ…å ±</h3>
                        <button class="page-info-close" onclick="closePageInfo()">Ã—</button>
                    </div>
                    <div class="page-info-content" id="pageInfoContent">
                    </div>
                </div>
            </div>
        </div>
        <!-- çµ±åˆã‚³ãƒãƒ³ãƒ‰ãƒãƒ¼ -->
        <div class="unified-command-bar">
            <button class="cmd-btn menu-btn" id="menu-toggle" onclick="toggleSidebar()">â‰¡</button>
            <button class="cmd-btn" id="target-toggle" onclick="openMoveMenu()">ç§»å‹•</button>
            <button class="cmd-btn" id="cmd-toggle" onclick="openActionMenu()">è¡Œç‚º</button>
            <input type="text" class="cmd-input" id="command-input" placeholder="ç™ºè¨€..." onkeydown="if(event.key==='Enter')executeCommand()">
            <button class="cmd-btn nav-btn" id="prev-btn" onclick="prevPage()">å‰ã¸</button>
            <button class="cmd-btn nav-btn" id="next-btn" onclick="nextPage()">æ¬¡ã¸</button>
        </div>
        <!-- ç§»å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="move-menu" id="moveMenu" style="display:none;">
            <div class="move-menu-header">
                <span>ç§»å‹•å…ˆã‚’é¸æŠ</span>
                <button class="move-menu-close" onclick="closeMoveMenu()">Ã—</button>
            </div>
            <div class="move-menu-list" id="moveMenuList">
                <!-- ç§»å‹•å…ˆãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
        <!-- è¡Œç‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="action-menu" id="actionMenu" style="display:none;">
            <div class="action-menu-header">
                <span>è¡Œç‚ºã‚’é¸æŠ</span>
                <button class="action-menu-close" onclick="closeActionMenu()">Ã—</button>
            </div>
            <div class="action-menu-list" id="actionMenuList">
                <!-- è¡Œç‚ºãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script src="js/prompt-utils.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/lock-screen.js"></script>
<script>
    // ========== çŠ¶æ…‹ç®¡ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰ ==========
    const CACHE_KEY = STORAGE_KEYS.TRANSITION_CACHE;

    // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let relationships = [];
    let costumes = [];
    let promptTemplates = {};

    // ç¾åœ¨ã®çŠ¶æ…‹ï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰
    let currentState = {
        characterIndex: -1,
        placeIndex: -1,
        actionIndex: -1
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    let userState = {
        placeIndex: -1
    };

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ2äººåˆ†åˆæœŸå€¤ï¼‰
    let characterStatus = [
        { characterIndex: -1, placeIndex: -1, actionIndex: -1, relationshipId: 'rel_001', costumeId: 'cos_001', memo: '' },
        { characterIndex: -1, placeIndex: -1, actionIndex: -1, relationshipId: 'rel_302', costumeId: 'cos_001', memo: '' }
    ];

    // çŠ¶æ…‹å¤‰æ•°
    let currentCommandType = 'speech';
    let chatHistory = [];
    let actionHistory = [];
    let pages = [];
    let currentPageIndex = -1;
    let characterCount = 2;
    let imageGenEnabled = true;
    let llmLogEnabled = false;
    let selectedModelId = '';
    let selectedLLMModelId = 'x-ai/grok-4.1-fast';
    let moveWithCompanion = false;
    let isLoading = false;

    // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼è¡¨ç¤ºç”¨
    let typewriterBuffer = '';
    let typewriterDisplayed = '';
    let typewriterTimer = null;
    let typewriterPageIndex = -1;

    // characterStatusé…åˆ—ã‚’ç™»å ´äººæ•°ã«åˆã‚ã›ã¦èª¿æ•´
    function updateCharacterStatusArray() {
        while (characterStatus.length < characterCount) {
            characterStatus.push({
                characterIndex: -1,
                placeIndex: -1,
                actionIndex: -1,
                relationshipId: 'rel_001',
                costumeId: 'cos_001',
                memo: ''
            });
        }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveCachedData() {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
            models, characters, places, actions, relationships, costumes, promptTemplates
        }));
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadCachedData() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
                relationships = data.relationships || [];
                costumes = data.costumes || [];
                promptTemplates = data.promptTemplates || {};
                updateAllSelects();
                updateModelSelect();
                if (actions.length > 0) {
                    addSystemMessage(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
                }
            }
        } catch (e) {
            console.error('Cache load error:', e);
        }
    }
</script>
<script src="js/transition-page.js"></script>
<script src="js/transition-ui.js"></script>
<script src="js/transition-llm.js"></script>
<script>
    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆconstants.jsã‹ã‚‰å‚ç…§ï¼‰
    const CHARACTER_COUNT_KEY = STORAGE_KEYS.TRANSITION_CHARACTER_COUNT;
    const CHAT_API_KEY = STORAGE_KEYS.TRANSITION_CHAT_API_KEY;
    const RUNWARE_API_KEY = STORAGE_KEYS.TRANSITION_RUNWARE_API_KEY;
    const IMAGE_GEN_ENABLED_KEY = STORAGE_KEYS.TRANSITION_IMAGE_GEN_ENABLED;
    const LLM_LOG_ENABLED_KEY = STORAGE_KEYS.TRANSITION_LLM_LOG_ENABLED;
    const SELECTED_MODEL_KEY = STORAGE_KEYS.TRANSITION_SELECTED_MODEL;
    const SELECTED_LLM_MODEL_KEY = STORAGE_KEYS.TRANSITION_SELECTED_LLM_MODEL;
    const SIDEBAR_COLLAPSED_KEY = STORAGE_KEYS.TRANSITION_SIDEBAR_COLLAPSED;
    const GAS_LAST_UPDATED_KEY = 'transition_gas_last_updated';

    // ç§»å‹•å®Ÿè¡Œ
    async function executeMove(placeIndex) {
        const previousPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;

        // ã€Œä¸€ç·’ã«ã€ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç¾åœ¨åœ°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‚ä¸€ç·’ã«ç§»å‹•
        let companion = null;
        if (moveWithCompanion) {
            const charAtLocation = getCharacterAtUserLocation();
            if (charAtLocation) {
                companion = charAtLocation;
                const statusIndex = characterStatus.indexOf(charAtLocation.status);
                if (statusIndex >= 0) {
                    characterStatus[statusIndex].placeIndex = placeIndex;
                    // ç§»å‹•å…ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¤‰æ›´
                    const newPlace = places[placeIndex];
                    if (newPlace && newPlace.default_action) {
                        const newActionIndex = actions.findIndex(a => a.action_id === newPlace.default_action);
                        if (newActionIndex >= 0) {
                            characterStatus[statusIndex].actionIndex = newActionIndex;
                        }
                    }
                }
                updateCharacterStatusDisplay();
            }
        }

        userState.placeIndex = placeIndex;
        updateUserStatusDisplay();
        const newPlace = places[placeIndex];

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        await generatePages('move', '', previousPlace, newPlace, companion);
    }

    async function selectAction(actionIndex) {
        closeActionMenu();

        // è¡Œç‚ºã‚’å®Ÿè¡Œ
        currentState.actionIndex = actionIndex;
        await executeAction(actionIndex);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
        const modal = document.getElementById('settingsModal');
        if (e.target === modal) {
            closeSettings();
        }
    });

    // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    async function executeCommand() {
        const input = document.getElementById('command-input');
        const text = input.value.trim();

        // ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (!text) return;

        const chatApiKey = document.getElementById('chatApiKey').value.trim();
        if (!chatApiKey) {
            alert('OpenRouter API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        localStorage.setItem(CHAT_API_KEY, chatApiKey);

        if (userState.placeIndex < 0) {
            alert('åˆæœŸè¨­å®šã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
            return;
        }

        addCommandMessage(currentCommandType, text);
        input.value = '';

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        await generatePages(currentCommandType, text, null, null);
    }

    // Visual Viewportå¯¾å¿œï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ãƒ»æŠ˜ã‚Šç•³ã¿ã‚¹ãƒãƒ›å¯¾å¿œï¼‰
    function initVisualViewport() {
        let lastViewportWidth = window.innerWidth;
        let lastViewportHeight = window.innerHeight;

        function updateVisualViewport() {
            const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            document.documentElement.style.setProperty('--visual-viewport-height', vh + 'px');
        }

        function handleScreenSizeChange() {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            const widthDiff = Math.abs(newWidth - lastViewportWidth);
            const heightDiff = Math.abs(newHeight - lastViewportHeight);

            if (widthDiff > 100 || heightDiff > 100) {
                console.log('[Viewport] å¤§ããªã‚µã‚¤ã‚ºå¤‰åŒ–æ¤œå‡º:', lastViewportWidth, 'x', lastViewportHeight, '->', newWidth, 'x', newHeight);
                updateVisualViewport();
                setTimeout(updateVisualViewport, 50);
                setTimeout(updateVisualViewport, 150);
                setTimeout(updateVisualViewport, 300);
            } else {
                updateVisualViewport();
            }
            lastViewportWidth = newWidth;
            lastViewportHeight = newHeight;
        }

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', updateVisualViewport);
            window.visualViewport.addEventListener('scroll', updateVisualViewport);
        }
        window.addEventListener('resize', handleScreenSizeChange);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleScreenSizeChange, 100);
            setTimeout(handleScreenSizeChange, 300);
        });
        updateVisualViewport();
    }

    // è¨­å®šå€¤ã®å¾©å…ƒ
    function restoreSettings() {
        const settings = loadSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY);
        if (settings.gasUrl) document.getElementById('gasUrl').value = settings.gasUrl;

        const savedApiKey = localStorage.getItem(CHAT_API_KEY);
        if (savedApiKey) document.getElementById('chatApiKey').value = savedApiKey;

        const savedRunwareKey = localStorage.getItem(RUNWARE_API_KEY);
        if (savedRunwareKey) document.getElementById('runwareApiKey').value = savedRunwareKey;

        const savedImageGenEnabled = localStorage.getItem(IMAGE_GEN_ENABLED_KEY);
        imageGenEnabled = savedImageGenEnabled !== 'off';
        updateImageGenButton();

        const savedLLMLogEnabled = localStorage.getItem(LLM_LOG_ENABLED_KEY);
        llmLogEnabled = savedLLMLogEnabled === 'on';
        updateLLMLogButton();

        const savedModelId = localStorage.getItem(SELECTED_MODEL_KEY);
        if (savedModelId) selectedModelId = savedModelId;
    }

    // GASã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadSettingsFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        showStatus('è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');

        try {
            const data = await fetchGasData(baseUrl, 'settings');
            console.log('[Settings] GASã‹ã‚‰èª­ã¿è¾¼ã¿:', data);

            // ãƒ‡ãƒ¼ã‚¿ã‚’key-valueå½¢å¼ã«å¤‰æ›ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—å½¢å¼ï¼‰
            const settings = {};
            if (data && data.length > 0) {
                for (const row of data) {
                    if (row.key) {
                        settings[row.key] = row.value ?? '';
                    }
                }
            }
            console.log('[Settings] ãƒ‘ãƒ¼ã‚¹çµæœ:', settings);

            // è¨­å®šã‚’é©ç”¨
            if (settings.chatApiKey) {
                document.getElementById('chatApiKey').value = settings.chatApiKey;
                localStorage.setItem(CHAT_API_KEY, settings.chatApiKey);
            }
            if (settings.runwareApiKey) {
                document.getElementById('runwareApiKey').value = settings.runwareApiKey;
                localStorage.setItem(RUNWARE_API_KEY, settings.runwareApiKey);
            }
            if (settings.llmLogEnabled !== undefined) {
                llmLogEnabled = settings.llmLogEnabled === 'on';
                localStorage.setItem(LLM_LOG_ENABLED_KEY, settings.llmLogEnabled);
                updateLLMLogButton();
            }
            if (settings.imageGenEnabled !== undefined) {
                imageGenEnabled = settings.imageGenEnabled !== 'off';
                localStorage.setItem(IMAGE_GEN_ENABLED_KEY, settings.imageGenEnabled);
                updateImageGenButton();
            }
            if (settings.llmModelId) {
                selectedLLMModelId = settings.llmModelId;
                localStorage.setItem(SELECTED_LLM_MODEL_KEY, settings.llmModelId);
                document.getElementById('llmModelSelect').value = settings.llmModelId;
            }
            if (settings.imageModelId) {
                selectedModelId = settings.imageModelId;
                localStorage.setItem(SELECTED_MODEL_KEY, settings.imageModelId);
                document.getElementById('modelSelect').value = settings.imageModelId;
            }
            if (settings.characterCount) {
                characterCount = parseInt(settings.characterCount) || 2;
                localStorage.setItem(CHARACTER_COUNT_KEY, characterCount.toString());
                document.getElementById('characterCountInput').value = characterCount;
                updateCharacterStatusArray();
            }
            if (settings.lockPassword) {
                localStorage.setItem(STORAGE_KEYS.LOCK_PASSWORD, settings.lockPassword);
                document.getElementById('lockPasswordInput').value = settings.lockPassword;
            }

            showStatus('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        } catch (error) {
            console.error('[Settings] èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            showStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    // GASã«è¨­å®šã‚’ä¿å­˜
    async function saveSettingsToGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        showStatus('è¨­å®šã‚’ä¿å­˜ä¸­...', 'loading');

        try {
            // ç¾åœ¨ã®è¨­å®šã‚’åé›†ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—å½¢å¼ï¼‰
            const settings = [
                { key: 'chatApiKey', value: document.getElementById('chatApiKey').value || '' },
                { key: 'runwareApiKey', value: document.getElementById('runwareApiKey').value || '' },
                { key: 'llmLogEnabled', value: llmLogEnabled ? 'on' : 'off' },
                { key: 'imageGenEnabled', value: imageGenEnabled ? 'on' : 'off' },
                { key: 'llmModelId', value: selectedLLMModelId || '' },
                { key: 'imageModelId', value: selectedModelId || '' },
                { key: 'characterCount', value: characterCount.toString() },
                { key: 'lockPassword', value: document.getElementById('lockPasswordInput').value || '' }
            ];

            console.log('[Settings] GASã«ä¿å­˜:', settings);
            const result = await saveGasData(baseUrl, 'settings', settings);
            console.log('[Settings] ä¿å­˜çµæœ:', result);

            // ä¿å­˜å¾Œã€GASã®æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
            const meta = await fetchGasMeta(baseUrl);
            if (meta.lastUpdated) {
                localStorage.setItem(GAS_LAST_UPDATED_KEY, meta.lastUpdated);
                console.log('[Settings] æ›´æ–°æ—¥æ™‚ã‚’ä¿å­˜:', meta.lastUpdated);
            }

            showStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        } catch (error) {
            console.error('[Settings] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            showStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    // èµ·å‹•æ™‚ã«GASãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯
    async function checkAndSyncSettings() {
        const baseUrl = localStorage.getItem(STORAGE_KEYS.GAS_URL);
        if (!baseUrl) return;

        showStatus('GASãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...', 'loading');

        try {
            const meta = await fetchGasMeta(baseUrl);
            const gasUpdated = meta.lastUpdated;
            const localUpdated = localStorage.getItem(GAS_LAST_UPDATED_KEY);

            console.log('[Sync] GASæ›´æ–°æ—¥æ™‚:', gasUpdated, 'ãƒ­ãƒ¼ã‚«ãƒ«:', localUpdated);

            // GASãŒæ–°ã—ã„å ´åˆã€å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (!localUpdated || new Date(gasUpdated) > new Date(localUpdated)) {
                console.log('[Sync] GASãŒæ–°ã—ã„ãŸã‚å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã™');
                showStatus('GASã‹ã‚‰åŒæœŸä¸­...', 'loading');

                // è¨­å®šã‚’å–å¾—
                await loadSettingsFromGas();

                // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const [modelData, characterData, placeData, actionData, relationshipData, costumeData, promptData] = await Promise.all([
                    fetchGasData(baseUrl, 'model'),
                    fetchGasData(baseUrl, 'character'),
                    fetchGasData(baseUrl, 'place'),
                    fetchGasData(baseUrl, 'action'),
                    fetchGasData(baseUrl, 'relationship'),
                    fetchGasData(baseUrl, 'costume'),
                    fetchGasData(baseUrl, 'llm_prompt_template')
                ]);

                models = parseModels(modelData);
                characters = parseCharacters(characterData);
                places = parsePlaces(placeData);
                actions = parseActionsWithCompositions(actionData);
                relationships = parseRelationships(relationshipData);
                costumes = parseCostumes(costumeData);
                promptTemplates = parsePromptTemplates(promptData);

                saveCachedData();
                updateAllSelects();
                updateModelSelect();

                localStorage.setItem(GAS_LAST_UPDATED_KEY, gasUpdated);
                console.log('[Sync] åŒæœŸå®Œäº†:', characters.length, 'ã‚­ãƒ£ãƒ©,', places.length, 'å ´æ‰€,', actions.length, 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³');
                showStatus(`GASåŒæœŸå®Œäº†: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
            } else {
                console.log('[Sync] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™');
                showStatus('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™');
            }
        } catch (error) {
            console.log('[Sync] åŒæœŸãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—:', error.message);
            showStatus('');
        }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    function initKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextPage();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevPage();
            }
        });
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        initSidebarState();
        initTextToggle();
        initLockScreen();
        initVisualViewport();
        restoreSettings();
        initLLMModelSelect();
        initCharacterCount();
        loadCachedData();
        startInitialSetup();
        initKeyboardNavigation();
        // GASè¨­å®šã®åŒæœŸãƒã‚§ãƒƒã‚¯ï¼ˆéåŒæœŸï¼‰
        checkAndSyncSettings();
    });

    async function loadAllFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        localStorage.setItem(STORAGE_KEYS.GAS_URL, baseUrl);
        showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData, relationshipData, costumeData, promptData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action'),
                fetchGasData(baseUrl, 'relationship'),
                fetchGasData(baseUrl, 'costume'),
                fetchGasData(baseUrl, 'llm_prompt_template')
            ]);

            models = parseModels(modelData);
            characters = parseCharacters(characterData);
            places = parsePlaces(placeData);
            actions = parseActionsWithCompositions(actionData);
            relationships = parseRelationships(relationshipData);
            costumes = parseCostumes(costumeData);
            promptTemplates = parsePromptTemplates(promptData);

            saveCachedData();
            updateAllSelects();
            updateModelSelect();

            showStatus(`èª­è¾¼å®Œäº†: ${characters.length}ã‚­ãƒ£ãƒ©, ${places.length}å ´æ‰€, ${actions.length}ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`);
        } catch (error) {
            console.error(error);
            showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    function updateAllSelects() {
        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å‰Šé™¤æ¸ˆã¿ - ä½•ã‚‚ã—ãªã„
    }

    async function executeAction(actionIndex) {
        const action = actions[actionIndex];
        if (!action) return;

        // æ—¢å­˜ã®æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
        document.querySelectorAll('.next-action-button-container').forEach(el => el.remove());

        const prevActionIndex = currentState.actionIndex;
        const prevAction = prevActionIndex >= 0 ? actions[prevActionIndex] : null;

        // çŠ¶æ…‹æ›´æ–°
        currentState.actionIndex = actionIndex;

        // åŒã˜å ´æ‰€ã«ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
        const charAtLocation = getCharacterAtUserLocation();
        let effectStatusIndex = -1;
        let effectMessages = []; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾Œã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ä¿å­˜
        if (charAtLocation) {
            const statusIndex = characterStatus.findIndex(s => s === charAtLocation.status);
            if (statusIndex >= 0) {
                characterStatus[statusIndex].actionIndex = actionIndex;
                console.log('[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ]', charAtLocation.character.name, 'ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°:', action.name);
                effectStatusIndex = statusIndex;

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®effectã‚’é©ç”¨ï¼ˆçŠ¶æ…‹å¤‰æ›´ã®ã¿ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¾Œã§ï¼‰
                effectMessages = applyActionEffect(action, charAtLocation, statusIndex);

                updateCharacterStatusDisplay();
            }
        }

        // å±¥æ­´ã«è¿½åŠ 
        actionHistory.push({
            timestamp: new Date().toISOString(),
            fromAction: prevAction?.action_id || null,
            toAction: action.action_id,
            character: charAtLocation?.character?.name || null,
            place: userState.placeIndex >= 0 ? places[userState.placeIndex]?.name : null
        });

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼‰
        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç™ºè¨€ãŒã‚ã‚Œã° action_with_speechã€ãªã‘ã‚Œã° action_select
        const commandInput = document.getElementById('command-input');
        const speechText = commandInput?.value?.trim() || '';
        if (speechText) {
            await generatePages('action_with_speech', speechText, null, null);
            commandInput.value = ''; // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        } else {
            await generatePages('action_select', action.name, null, null);
        }

        // effectãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ç”Ÿæˆå¾Œï¼‰
        if (effectMessages && effectMessages.length > 0) {
            effectMessages.forEach(msg => addSystemMessage(msg));
        }

        // next_actionãŒå®šç¾©ã•ã‚Œã¦ã„ã‚Œã°ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (action.next_action) {
            const nextAction = actions.find(a => a.action_id === action.next_action);
            if (nextAction) {
                addNextActionButton(nextAction);
            }
        }
    }

    // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    function addNextActionButton(nextAction) {
        if (pages.length === 0) return;

        const lastPageIndex = pages.length - 1;
        const page = pages[lastPageIndex];

        // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        if (page && !page.typewriterCompleted) {
            // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†ã‚’å¾…ã¤ï¼ˆæœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«å›ºå®šï¼‰
            setTypewriterCompleteCallback(() => {
                appendNextActionButtonToPage(lastPageIndex, nextAction);
            });
        } else {
            // ã™ã§ã«å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«è¿½åŠ 
            appendNextActionButtonToPage(lastPageIndex, nextAction);
        }
    }

    // ãƒšãƒ¼ã‚¸ã«ãƒœã‚¿ãƒ³ã‚’å®Ÿéš›ã«è¿½åŠ ã™ã‚‹
    function appendNextActionButtonToPage(pageIndex, nextAction) {
        const pageView = document.getElementById('page-view');
        const pageDiv = pageView.querySelector(`.page-content[data-page-index="${pageIndex}"]`);
        if (!pageDiv) return;

        const pageText = pageDiv.querySelector('.page-text');
        if (!pageText) return;

        // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚Œã°å‰Šé™¤
        const existingContainer = pageText.querySelector('.next-action-button-container');
        if (existingContainer) existingContainer.remove();

        // ãƒœã‚¿ãƒ³è¦ç´ ã‚’ä½œæˆï¼ˆtextDivã®å¤–ã€page-textã®æœ«å°¾ã«è¿½åŠ ï¼‰
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'next-action-button-container';
        buttonContainer.innerHTML = `<button class="next-action-button" data-action-id="${nextAction.action_id}">â–¶ ${nextAction.name}</button>`;
        pageText.appendChild(buttonContainer);

        // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        const button = buttonContainer.querySelector('.next-action-button');
        if (button) {
            button.addEventListener('click', async (e) => {
                e.stopPropagation(); // ãƒ†ã‚­ã‚¹ãƒˆãƒˆã‚°ãƒ«ã‚’é˜²æ­¢
                // ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                buttonContainer.remove();
                const actionId = button.dataset.actionId;
                const actionToExecute = actions.find(a => a.action_id === actionId);
                if (actionToExecute) {
                    const actionIdx = actions.indexOf(actionToExecute);
                    if (actionIdx >= 0) {
                        await executeAction(actionIdx);
                    }
                }
            });
        }
    }

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®effectã‚’é©ç”¨ï¼ˆçŠ¶æ…‹å¤‰æ›´ã‚’è¡Œã„ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’è¿”ã™ï¼‰
    function applyActionEffect(action, charAtLocation, statusIndex) {
        const messages = [];
        if (!action.effect || !charAtLocation) return messages;

        const effectStr = action.effect.trim();
        if (!effectStr) return messages;

        console.log('[Effect] åŠ¹æœã‚’è§£æ:', effectStr);

        // effectã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆå½¢å¼: relationship_id=rel_002,costume_id=cos_002 ã¾ãŸã¯ rel_002,cos_002ï¼‰
        const effects = parseEffectString(effectStr);

        // é–¢ä¿‚æ€§å¤‰æ›´
        if (effects.relationship_id) {
            const newRelationship = relationships.find(r => r.relationship_id === effects.relationship_id);
            if (newRelationship) {
                const oldRelationshipId = characterStatus[statusIndex].relationshipId;
                const oldRelationship = relationships.find(r => r.relationship_id === oldRelationshipId);
                characterStatus[statusIndex].relationshipId = effects.relationship_id;
                console.log('[Effect] é–¢ä¿‚æ€§å¤‰æ›´:', oldRelationship?.name, 'â†’', newRelationship.name);
                messages.push(`ğŸ­ ${charAtLocation.character.name}ã¨ã®é–¢ä¿‚æ€§ãŒã€Œ${oldRelationship?.name || 'ä¸æ˜'}ã€ã‹ã‚‰ã€Œ${newRelationship.name}ã€ã«å¤‰åŒ–ã—ã¾ã—ãŸ`);
            }
        }

        // æœè£…å¤‰æ›´ï¼ˆåŒã˜æœè£…ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        if (effects.costume_id) {
            const oldCostumeId = characterStatus[statusIndex].costumeId;
            if (effects.costume_id !== oldCostumeId) {
                const newCostume = costumes.find(c => c.costume_id === effects.costume_id);
                if (newCostume) {
                    const oldCostume = costumes.find(c => c.costume_id === oldCostumeId);
                    characterStatus[statusIndex].costumeId = effects.costume_id;
                    console.log('[Effect] æœè£…å¤‰æ›´:', oldCostume?.name, 'â†’', newCostume.name);
                    messages.push(`ğŸ‘— ${charAtLocation.character.name}ã®æœè£…ãŒã€Œ${oldCostume?.name || 'ä¸æ˜'}ã€ã‹ã‚‰ã€Œ${newCostume.name}ã€ã«å¤‰ã‚ã‚Šã¾ã—ãŸ`);
                }
            }
        }

        return messages;
    }

    // effectæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
    function parseEffectString(effectStr) {
        const result = { relationship_id: null, costume_id: null };

        // ã‚«ãƒ³ãƒã§åˆ†å‰²
        const parts = effectStr.split(',').map(p => p.trim()).filter(p => p);

        parts.forEach(part => {
            // key=valueå½¢å¼
            if (part.includes('=')) {
                const [key, value] = part.split('=').map(s => s.trim());
                if (key === 'relationship_id' || key === 'rel') {
                    result.relationship_id = value;
                } else if (key === 'costume_id' || key === 'cos') {
                    result.costume_id = value;
                }
            } else {
                // IDã®ã¿ã®å½¢å¼ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§åˆ¤å®šï¼‰
                if (part.startsWith('rel_')) {
                    result.relationship_id = part;
                } else if (part.startsWith('cos_')) {
                    result.costume_id = part;
                }
            }
        });

        return result;
    }

    function clearChat() {
        pages = [];
        currentPageIndex = -1;
        actionHistory = [];
        chatHistory = [];
        // DOMè¦ç´ ã‚’å…¨å‰Šé™¤
        const pageView = document.getElementById('page-view');
        pageView.innerHTML = '';
        console.log('[System] ãƒãƒ£ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // å±¥æ­´ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    function dumpHistory() {
        console.log('Action History:', actionHistory);
        return actionHistory;
    }

    // ä¼šè©±ãƒ¢ãƒ¼ãƒ‰å‡¦ç†
    async function handleConversationMode(chatApiKey, charAtLocation, currentPlace, userInput) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã‚’è¿½åŠ 
        addDialogue('ã‚ãªãŸ', `ã€Œ${userInput}ã€`);

        const { fullPrompt, simplePrompt } = buildCombinedPrompt('speech', userInput, null, null, charAtLocation, currentPlace, true);
        console.log('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] å®Œå…¨ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', fullPrompt);

        showStatusLLM();
        const response = await callLLM(chatApiKey, fullPrompt, 'character', charAtLocation.character, null, simplePrompt);
        hideStatusLLM();
        console.log('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®åˆ¤å®šã‚’æŠ½å‡º
        const { dialogue: parsedDialogue, narrative, newRelationshipName, relationshipMemo } = parseConversationResponse(response, charAtLocation);

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®å‡¦ç†
        updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo);

        if (parsedDialogue) {
            addDialogue(charAtLocation.character.name, parsedDialogue);
        } else {
            console.warn('[ä¼šè©±ãƒ¢ãƒ¼ãƒ‰] ã‚»ãƒªãƒ•ãŒç©ºã§ã™');
        }
        // åœ°ã®æ–‡ãŒã‚ã‚Œã°è¿½åŠ 
        if (narrative) {
            addDialogue('', narrative);
        }
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢ä¿‚æ€§æ›´æ–°ï¼ˆå…±é€šå‡¦ç†ï¼‰
    function updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo) {
        if (!charAtLocation) return;

        const statusIndex = characterStatus.findIndex(s => s === charAtLocation.status);
        if (statusIndex < 0) return;

        // é–¢ä¿‚æ€§å¤‰åŒ–ãŒã‚ã‚‹å ´åˆ
        if (newRelationshipName) {
            const currentRelationshipId = charAtLocation.status.relationshipId;
            const currentRelationship = relationships.find(r => r.relationship_id === currentRelationshipId);
            const newRelationship = relationships.find(r => r.name === newRelationshipName);
            if (newRelationship && newRelationship.relationship_id !== currentRelationshipId) {
                characterStatus[statusIndex].relationshipId = newRelationship.relationship_id;
                addSystemMessage(`ğŸ’« ${charAtLocation.character.name}ã¨ã®é–¢ä¿‚æ€§ãŒã€Œ${currentRelationship?.name || 'ä¸æ˜'}ã€ã‹ã‚‰ã€Œ${newRelationship.name}ã€ã«å¤‰åŒ–ã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ä¿å­˜ï¼ˆé–¢ä¿‚æ€§å¤‰åŒ–ãŒãªãã¦ã‚‚ï¼‰
        if (relationshipMemo) {
            characterStatus[statusIndex].memo = relationshipMemo;
        }

        updateCharacterStatusDisplay();
    }

    // ç”»åƒç”Ÿæˆã‚’éåŒæœŸã«é–‹å§‹ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å›é¿ï¼‰
    // æˆ»ã‚Šå€¤: { imageURL, imageGenInfo } ã¾ãŸã¯ null
    function startImageGenerationAsync(charAtLocation, currentPlace) {
        const runwareApiKey = document.getElementById('runwareApiKey').value.trim();
        if (!charAtLocation || !imageGenEnabled || !runwareApiKey) {
            return null;
        }
        localStorage.setItem(RUNWARE_API_KEY, runwareApiKey);
        const charActionIndex = charAtLocation.status?.actionIndex ?? -1;
        const charCostumeId = charAtLocation.status?.costumeId ?? null;
        const charRelationshipId = charAtLocation.status?.relationshipId ?? null;
        return new Promise(resolve => {
            setTimeout(async () => {
                try {
                    const result = await generateCharacterImage(charAtLocation.character, currentPlace, charActionIndex, charCostumeId, charRelationshipId);
                    resolve(result); // { imageURL, imageGenInfo } ã¾ãŸã¯ null
                } catch (e) {
                    console.error('[ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼]', e);
                    resolve(null);
                }
            }, 0);
        });
    }

    // åˆæœŸè¨­å®šé–‹å§‹
    function startInitialSetup() {
        // cast='on' ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
        const castCharacters = characters
            .map((char, index) => ({ char, index }))
            .filter(item => item.char.cast === 'on');

        if (castCharacters.length < characterCount) {
            addSystemMessage(`cast=onã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒ${characterCount}äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚GASã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚`);
            return;
        }

        // publicãªå ´æ‰€ã‚’å–å¾—
        const publicPlaces = places
            .map((place, index) => ({ place, index }))
            .filter(item => item.place.place_type === 'public');

        if (publicPlaces.length < characterCount) {
            addSystemMessage(`publicãªå ´æ‰€ãŒ${characterCount}ã¤ä»¥ä¸Šå¿…è¦ã§ã™ã€‚`);
            return;
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆcast=onã‹ã‚‰ã€é‡è¤‡ãªã—ï¼‰
        const charIndices = [];
        const shuffledCast = [...castCharacters].sort(() => Math.random() - 0.5);
        for (let i = 0; i < characterCount; i++) {
            charIndices.push(shuffledCast[i].index);
        }

        // å ´æ‰€ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆé‡è¤‡ãªã—ï¼‰
        const placeIndices = [];
        while (placeIndices.length < characterCount) {
            const randItem = publicPlaces[Math.floor(Math.random() * publicPlaces.length)];
            if (!placeIndices.includes(randItem.index)) {
                placeIndices.push(randItem.index);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚è¨­å®šï¼‰
        for (let i = 0; i < characterCount; i++) {
            const place = places[placeIndices[i]];
            // å ´æ‰€ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            let actionIndex = -1;
            if (place && place.default_action) {
                actionIndex = actions.findIndex(a => a.action_id === place.default_action);
            }

            characterStatus[i] = {
                characterIndex: charIndices[i],
                placeIndex: placeIndices[i],
                actionIndex: actionIndex,
                relationshipId: i === 1 ? 'rel_302' : 'rel_001',  // 2äººç›®ã¯rel_302
                costumeId: 'cos_001',  // æœè£…åˆæœŸå€¤
                memo: ''  // ãƒ¡ãƒ¢åˆæœŸå€¤
            };
        }

        // å¾Œæ–¹äº’æ›: currentStateã‚‚æ›´æ–°
        currentState.characterIndex = charIndices[0];
        currentState.placeIndex = placeIndices[0];
        currentState.actionIndex = -1;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸä½ç½®ã‚’ã€Œ101å·å®¤ ç„é–¢ã€ã«è¨­å®š
        const userPlaceIndex = places.findIndex(p => p.name === '101å·å®¤ ç„é–¢');
        userState.placeIndex = userPlaceIndex >= 0 ? userPlaceIndex : -1;

        updateCharacterStatusDisplay();
        updateUserStatusDisplay();

        // è¨­å®šçµæœã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è¡¨ç¤º
        const userPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;
        addSystemMessage(`åˆæœŸè¨­å®šå®Œäº†:`);
        for (let i = 0; i < characterCount; i++) {
            const char = characters[charIndices[i]];
            const place = places[placeIndices[i]];
            const action = characterStatus[i].actionIndex >= 0 ? actions[characterStatus[i].actionIndex] : null;
            addSystemMessage(`  ${char.name} â†’ ${place.name} [${action?.name || 'ãªã—'}]`);
        }
        addSystemMessage(`  ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ${userPlace ? userPlace.name : 'æœªè¨­å®š'}`);
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç¾åœ¨åœ°ã¸å˜ç‹¬ç§»å‹•
    async function moveToCharacterLocation(charStatusIndex) {
        const status = characterStatus[charStatusIndex];
        if (!status || status.placeIndex < 0) {
            console.log('[ç§»å‹•] ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å ´æ‰€ãŒæœªè¨­å®š');
            return;
        }

        // ç‹­ã„ç”»é¢ã§ã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        if (window.innerWidth <= 768 && !sidebarCollapsed) {
            toggleSidebar();
        }

        const targetPlaceIndex = status.placeIndex;

        // æ—¢ã«åŒã˜å ´æ‰€ã«ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (userState.placeIndex === targetPlaceIndex) {
            console.log('[ç§»å‹•] æ—¢ã«åŒã˜å ´æ‰€ã«ã„ã¾ã™');
            return;
        }

        const previousPlace = userState.placeIndex >= 0 ? places[userState.placeIndex] : null;
        const newPlace = places[targetPlaceIndex];

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´æ‰€ã‚’æ›´æ–°
        userState.placeIndex = targetPlaceIndex;
        updateUserStatusDisplay();

        // ãƒšãƒ¼ã‚¸ç”Ÿæˆï¼ˆå˜ç‹¬ç§»å‹•ã€companion=nullï¼‰
        await generatePages('move', '', previousPlace, newPlace, null);
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜å ´æ‰€ã«ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
    function getCharacterAtUserLocation() {
        if (userState.placeIndex < 0) return null;
        for (const status of characterStatus) {
            if (status.placeIndex === userState.placeIndex && status.characterIndex >= 0) {
                return {
                    character: characters[status.characterIndex],
                    status: status
                };
            }
        }
        return null;
    }

    // ãƒšãƒ¼ã‚¸ç”Ÿæˆãƒ¡ã‚¤ãƒ³å‡¦ç†
    // companion: ä¸€ç·’ã«ç§»å‹•ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆç§»å‹•æ™‚ã®ã¿ä½¿ç”¨ï¼‰
    async function generatePages(actionType, userInput, previousPlace, newPlace, companion = null) {
        const chatApiKey = document.getElementById('chatApiKey').value.trim();
        if (!chatApiKey) {
            addSystemMessage('OpenRouter API KeyãŒå¿…è¦ã§ã™');
            return;
        }

        // èª­ã¿è¾¼ã¿é–‹å§‹
        showLoading();

        const currentPlace = places[userState.placeIndex];
        // ç§»å‹•æ™‚ã«ä¸€ç·’ã«ç§»å‹•ã—ãŸå ´åˆã¯companionã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯ç¾åœ¨åœ°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
        const charAtLocation = companion || getCharacterAtUserLocation();

        // ç™ºè¨€ã‹ã¤ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ã‚‹å ´åˆã¯ä¼šè©±ãƒ¢ãƒ¼ãƒ‰
        if (actionType === 'speech' && charAtLocation) {
            await handleConversationMode(chatApiKey, charAtLocation, currentPlace, userInput);
            hideLoading();
            return;
        }

        // ç™ºè¨€ã ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ãªã„å ´åˆ
        if (actionType === 'speech' && !charAtLocation) {
            addSystemMessage('ã“ã®å ´æ‰€ã«ã¯èª°ã‚‚ã„ã¾ã›ã‚“');
            hideLoading();
            return;
        }

        // ç”Ÿæˆæƒ…å ±ã‚’åé›†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆIDã®ã¿ä¿æŒã€åå‰ã¯è¡¨ç¤ºæ™‚ã«å–å¾—ï¼‰
        let genInfo = {
            actionType: actionType,
            characterId: charAtLocation?.character?.character_id || null,
            placeId: currentPlace?.place_id || null,
            actionId: currentState.actionIndex >= 0 ? actions[currentState.actionIndex]?.action_id : null,
            relationshipId: charAtLocation?.status?.relationshipId || null,
            costumeId: charAtLocation?.status?.costumeId || null,
            imageGenInfo: null
        };

        // ç§»å‹•æ™‚ã¯å³åº§ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
        let movePageIndex = -1;
        if (actionType === 'move' && newPlace) {
            const placeImage = newPlace.image || null;
            genInfo.placeId = newPlace.place_id;

            // ç§»å‹•å…ˆã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
            const newPlaceIndex = places.findIndex(p => p.place_id === newPlace.place_id);
            for (const status of characterStatus) {
                if (status.placeIndex === newPlaceIndex && status.characterIndex >= 0) {
                    const charAtNewPlace = characters[status.characterIndex];
                    genInfo.characterId = charAtNewPlace?.character_id || null;
                    genInfo.relationshipId = status.relationshipId || null;
                    genInfo.costumeId = status.costumeId || null;
                    break;
                }
            }

            // ç§»å‹•å…ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
            if (newPlace.default_action) {
                genInfo.actionId = newPlace.default_action;
            }

            movePageIndex = addPage1(placeImage, `${newPlace.name}ã«ç§»å‹•...`, genInfo);
            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§æ›´æ–°ã™ã‚‹ã®ã§showPageã‹ã‚‰ã®ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼èµ·å‹•ã‚’é˜²ã
            pages[movePageIndex].typewriterCompleted = true;
            goToLatestPage();
        }

        // char_page_count ã‚’å–å¾—ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã®ã¿ï¼‰
        const currentAction = (actionType === 'action_select' || actionType === 'action_with_speech') && currentState.actionIndex >= 0
            ? actions[currentState.actionIndex] : null;
        const charPageCount = parseInt(currentAction?.char_page_count) || 1;

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šLLMã¨ç”»åƒç”Ÿæˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
        let combinedPrompt, combinedSimplePrompt;
        if (charPageCount >= 2 && charAtLocation) {
            // è¤‡æ•°ã‚»ãƒªãƒ•ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            const result = buildMultiDialoguePrompt(actionType, userInput, charAtLocation, currentPlace, charPageCount);
            combinedPrompt = result.fullPrompt;
            combinedSimplePrompt = result.simplePrompt;
        } else {
            // é€šå¸¸ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            const result = buildCombinedPrompt(actionType, userInput, previousPlace, newPlace, charAtLocation, currentPlace, false, companion);
            combinedPrompt = result.fullPrompt;
            combinedSimplePrompt = result.simplePrompt;
        }
        console.log('[Combined] å®Œå…¨ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', combinedPrompt);
        console.log('[Combined] ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ:', combinedSimplePrompt);


        // ç”»åƒç”Ÿæˆã‚’éåŒæœŸã«é–‹å§‹ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸ã®å ´åˆã¯å¾Œã§å€‹åˆ¥ã«ç”Ÿæˆï¼‰
        const imagePromise = charPageCount >= 2 ? null : startImageGenerationAsync(charAtLocation, currentPlace);

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ç”¨ã®ãƒšãƒ¼ã‚¸ã‚’å…ˆã«ä½œæˆ
        const placeImage = currentPlace?.image || null;
        let streamPageIndex = -1;
        let useAddDialogueMode = false;  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã¯æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«è¿½è¨˜
        let appendBaseHtml = '';  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã®è¿½è¨˜ãƒ™ãƒ¼ã‚¹HTML

        if (movePageIndex >= 0) {
            // ç§»å‹•æ™‚ï¼šæ—¢å­˜ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ä½¿ç”¨
            streamPageIndex = movePageIndex;
        } else {
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ï¼šæœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«è¿½è¨˜ãƒ¢ãƒ¼ãƒ‰
            useAddDialogueMode = true;
            // ç¾åœ¨ã®æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã®HTMLã‚’ä¿å­˜
            if (pages.length > 0) {
                const lastPageIndex = pages.length - 1;
                const pageView = document.getElementById('page-view');
                const pageDiv = pageView.querySelector(`.page-content[data-page-index="${lastPageIndex}"]`);
                if (pageDiv) {
                    const textDiv = pageDiv.querySelector('.page-text > div');
                    if (textDiv) {
                        appendBaseHtml = textDiv.innerHTML;
                    }
                }
            }
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”¨ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼é–‹å§‹ï¼ˆç§»å‹•æ™‚ã®ã¿ï¼‰
        if (streamPageIndex >= 0) {
            startTypewriter(streamPageIndex);
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ
        window._streamDisplayStarted = false;
        window._chunkCallbackStarted = false;
        window._displayTextLogged = false;

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”Ÿæˆ
        const onStreamChunk = createStreamChunkHandler(streamPageIndex, useAddDialogueMode, appendBaseHtml);

        // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç”»åƒç”Ÿæˆã‚’å…ˆã«é–‹å§‹ï¼ˆLLMã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
        let imagePromises = [];
        if (charPageCount >= 2 && charAtLocation) {
            const compositionTags = getCompositionTagsForMultiplePages(actions, currentState.actionIndex, charPageCount);
            imagePromises = compositionTags.map(tag =>
                generateCharacterImageWithComposition(charAtLocation, currentPlace, currentState.actionIndex, tag)
            );
        }

        // LLMã®å¿œç­”ã‚’å¾…ã¤ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ å¯¾å¿œï¼‰- ç”»åƒç”Ÿæˆã¨ä¸¦åˆ—
        showStatusLLM();
        const response = await callLLM(chatApiKey, combinedPrompt, 'combined', null, onStreamChunk, combinedSimplePrompt);
        hideStatusLLM();

        console.log('[LLM] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã§ãƒ‘ãƒ¼ã‚¹æ–¹æ³•ã‚’åˆ†å²
        let narrative, dialogue, dialogues, newRelationshipName, relationshipMemo;
        if (charPageCount >= 2 && charAtLocation) {
            const parsed = parseMultipleDialogues(response, charAtLocation, charPageCount);
            narrative = parsed.narrative;
            dialogues = parsed.dialogues;
            newRelationshipName = parsed.newRelationshipName;
            relationshipMemo = parsed.relationshipMemo;
        } else {
            const parsed = parseCombinedResponse(response, charAtLocation);
            narrative = parsed.narrative;
            dialogue = parsed.dialogue;
            newRelationshipName = parsed.newRelationshipName;
            relationshipMemo = parsed.relationshipMemo;
        }

        // æœ€çµ‚çš„ãªåœ°ã®æ–‡ã‚’è¡¨ç¤º
        if (streamPageIndex >= 0) {
            // ç§»å‹•æ™‚ï¼šã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ã§è¡¨ç¤º
            appendToTypewriter(narrative);
            await waitForTypewriter();
            // ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼å®Œäº†å¾Œã€fullTextã‚’æ›´æ–°ã—ã¦ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            if (pages[streamPageIndex]) {
                pages[streamPageIndex].fullText = narrative;
                pages[streamPageIndex].typewriterCompleted = true;
            }
        } else if (useAddDialogueMode && narrative && pages.length > 0) {
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ï¼šã‚¹ãƒˆãƒªãƒ¼ãƒ ã§æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ã€ãƒ‡ãƒ¼ã‚¿ã®ã¿æ›´æ–°
            const lastPageIndex = pages.length - 1;
            const lastPage = pages[lastPageIndex];
            lastPage.text += (lastPage.text ? '\n' : '') + narrative;
            lastPage.fullText = lastPage.text;
        }

        // é–¢ä¿‚æ€§å¤‰åŒ–ã®å‡¦ç†
        updateCharacterRelationship(charAtLocation, newRelationshipName, relationshipMemo);

        // ç”»åƒç”ŸæˆãŒãªã‘ã‚Œã°èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
        if (!imagePromise && charPageCount < 2) {
            hideLoading();
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        if (charAtLocation) {
            if (charPageCount >= 2 && dialogues && dialogues.length > 0) {
                // è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼šä¸¦åˆ—ç”Ÿæˆã—ãŸç”»åƒã‚’é †æ¬¡å–å¾—ã—ã¦ãƒšãƒ¼ã‚¸ä½œæˆ
                for (let i = 0; i < dialogues.length; i++) {
                    const imageResult = await imagePromises[i];
                    const charImage = imageResult?.imageURL || null;
                    // å„ãƒšãƒ¼ã‚¸ç”¨ã® genInfo ã‚’ä½œæˆ
                    const pageGenInfo = {
                        ...genInfo,
                        imageGenInfo: imageResult?.imageGenInfo || null
                    };
                    addPage2(charAtLocation.character.name, charImage, dialogues[i], pageGenInfo);
                    // å„ãƒšãƒ¼ã‚¸ç”Ÿæˆå¾Œã«æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆisLoadingä¸­ã§ã‚‚å¼·åˆ¶çš„ã«ï¼‰
                    const nextBtn = document.getElementById('next-btn');
                    if (nextBtn && currentPageIndex < pages.length - 1) {
                        nextBtn.classList.add('ready');
                    }
                }
            } else if (dialogue) {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼š1ãƒšãƒ¼ã‚¸ã®ã¿
                const imageResult = imagePromise ? await imagePromise : null;
                const charImage = imageResult?.imageURL || null;
                genInfo.imageGenInfo = imageResult?.imageGenInfo || null;
                addPage2(charAtLocation.character.name, charImage, dialogue, genInfo);
                updatePageStatus();
            }
        }

        // èª­ã¿è¾¼ã¿å®Œäº†
        hideLoading();
    }

    // ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆå…±é€šé–¢æ•°ï¼‰
    // æˆ»ã‚Šå€¤: { finalPrompt, negativePrompt } ã¾ãŸã¯ null
    function buildImageGenPrompt(modelId, character, place, actionIndex, compositionTag, costumeId, relationshipId) {
        if (!modelId || !models[modelId]) return null;
        const model = models[modelId];

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆimage_gen_base.htmlã¨åŒã˜é †åºï¼‰
        const parts = [
            model?.qualityPositive || '',           // å“è³ªã‚¿ã‚°ï¼ˆãƒã‚¸ãƒ†ã‚£ãƒ–ï¼‰
            character?.tag || '',                    // ã‚­ãƒ£ãƒ©ã‚¿ã‚°
            place?.tag || '',                        // å ´æ‰€ã‚¿ã‚°
            (actionIndex >= 0 && actions[actionIndex]) ? actions[actionIndex].prompt : '',  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            compositionTag || '',                    // æ§‹å›³ã‚¿ã‚°
            place?.additionalTag || '',              // å ´æ‰€ã®è¿½åŠ ã‚¿ã‚°
            character?.additionalTag || ''           // ã‚­ãƒ£ãƒ©ã®è¿½åŠ ã‚¿ã‚°
        ].filter(p => p);

        if (parts.length === 0) return null;

        const prompt = cleanPrompt(parts.join(', '));
        const negativePrompt = model?.qualityNegative || '';

        // costumeIdã‹ã‚‰æœè£…ã‚¿ã‚°ãƒ»camelã‚¿ã‚°ã‚’å–å¾—
        let clothesTag = '';
        let camelTag = '';
        if (costumeId) {
            const costume = costumes.find(c => c.costume_id === costumeId);
            if (costume) {
                clothesTag = costume.tag || '';
                camelTag = costume.camel_tag || '';
            }
        }

        // relationshipIdã‹ã‚‰è¡¨æƒ…ã‚¿ã‚°ã‚’å–å¾—
        let expressionTag = '';
        if (relationshipId) {
            const relationship = relationships.find(r => r.relationship_id === relationshipId);
            if (relationship) {
                expressionTag = relationship.expression || '';
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«clothes, camel, expressionè¿½åŠ 
        const characterWithExtras = character
            ? { ...character, clothes: clothesTag, camel: camelTag, expression: expressionTag }
            : { clothes: clothesTag, camel: camelTag, expression: expressionTag };

        // ã‚¿ã‚°ç½®æ›ã—ã¦æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
        const finalPrompt = buildFinalPrompt(prompt, characterWithExtras);

        return { finalPrompt, negativePrompt, characterWithExtras };
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒç”Ÿæˆï¼ˆimage_gen_base.htmlã¨åŒã˜æ–¹å¼ï¼‰
    // æˆ»ã‚Šå€¤: { imageURL, imageGenInfo } ã¾ãŸã¯ null
    async function generateCharacterImage(character, place, actionIndex, costumeId = null, relationshipId = null) {
        const runwareApiKey = document.getElementById('runwareApiKey').value.trim();
        if (!runwareApiKey) return null;

        // ãƒ¢ãƒ‡ãƒ«å–å¾—ï¼ˆé¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ï¼‰
        const modelId = selectedModelId || getFirstModelId(models);
        if (!modelId || !models[modelId]) {
            console.log('[ç”»åƒç”Ÿæˆ] ãƒ¢ãƒ‡ãƒ«ãŒæœªè¨­å®š');
            return null;
        }

        // æ§‹å›³ã‚¿ã‚°ã‚’å–å¾—ï¼ˆBESTã‹ã‚‰é¸æŠï¼‰
        const compositionTag = getCompositionTag(actions, actionIndex);

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆå…±é€šé–¢æ•°ã‚’ä½¿ç”¨ï¼‰
        const promptResult = buildImageGenPrompt(modelId, character, place, actionIndex, compositionTag, costumeId, relationshipId);
        if (!promptResult) {
            console.log('[ç”»åƒç”Ÿæˆ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
            return null;
        }

        const { finalPrompt, negativePrompt, characterWithExtras } = promptResult;
        console.log('[ç”»åƒç”Ÿæˆ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', finalPrompt);
        console.log('[ç”»åƒç”Ÿæˆ] ãƒã‚¬ãƒ†ã‚£ãƒ–:', negativePrompt);

        showStatusImage();
        const result = await generateImage(runwareApiKey, modelId, finalPrompt, {
            negativePrompt: negativePrompt,
            steps: models[modelId]?.steps || 20,
            cfgScale: models[modelId]?.cfgScale || 7,
            scheduler: models[modelId]?.scheduler || 'Default',
            width: 1024,
            height: 1024,
            character: characterWithExtras
        });
        hideStatusImage();

        // ç”»åƒç”Ÿæˆæƒ…å ±ã‚’å«ã‚ã¦è¿”ã™ï¼ˆIDã®ã¿ä¿æŒã€åå‰ã¯è¡¨ç¤ºæ™‚ã«å–å¾—ï¼‰
        return {
            imageURL: result.imageURL,
            imageGenInfo: {
                modelId: modelId,
                compositionTag: compositionTag,
                seed: result.seed
            }
        };
    }

    // ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½
    function saveGameState() {
        try {
            const saveData = {
                version: 1,
                timestamp: new Date().toISOString(),
                pages: pages,
                characterStatus: characterStatus,
                userState: userState,
                currentState: currentState,
                currentPageIndex: currentPageIndex,
                actionHistory: actionHistory,
                chatHistory: chatHistory
            };
            localStorage.setItem('transition_game_save', JSON.stringify(saveData));
            addSystemMessage('ğŸ’¾ ã‚²ãƒ¼ãƒ ã‚’ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ');
            console.log('[Save] ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä¿å­˜:', saveData);
        } catch (e) {
            console.error('[Save] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
            addSystemMessage('âŒ ã‚»ãƒ¼ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
    }

    // ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    function loadGameState() {
        try {
            const savedData = localStorage.getItem('transition_game_save');
            if (!savedData) {
                addSystemMessage('âš ï¸ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const saveData = JSON.parse(savedData);
            console.log('[Load] ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿:', saveData);

            // çŠ¶æ…‹ã‚’å¾©å…ƒ
            characterStatus = saveData.characterStatus || [];
            userState = saveData.userState || { placeIndex: -1 };
            currentState = saveData.currentState || { characterIndex: -1, placeIndex: -1, actionIndex: -1 };
            actionHistory = saveData.actionHistory || [];
            chatHistory = saveData.chatHistory || [];

            // ãƒšãƒ¼ã‚¸ã‚’å¾©å…ƒï¼ˆDOMå†æ§‹ç¯‰ï¼‰
            pages = [];
            currentPageIndex = -1;
            const pageView = document.getElementById('page-view');
            pageView.innerHTML = '';

            if (saveData.pages && saveData.pages.length > 0) {
                for (const page of saveData.pages) {
                    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦DOMã‚’å†æ§‹ç¯‰
                    if (page.type === 'character') {
                        addPage2(page.speaker, page.image, page.text);
                    } else {
                        addPage1(page.image, page.text);
                    }
                    // typewriterå®Œäº†çŠ¶æ…‹ã‚’å¾©å…ƒ
                    const lastIdx = pages.length - 1;
                    if (pages[lastIdx]) {
                        pages[lastIdx].typewriterCompleted = true;
                    }
                }
                // ä¿å­˜æ™‚ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                const targetPageIndex = saveData.currentPageIndex >= 0 ? saveData.currentPageIndex : pages.length - 1;
                showPage(targetPageIndex);
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            updateCharacterStatusDisplay();
            updateUserStatusDisplay();

            const savedTime = new Date(saveData.timestamp).toLocaleString('ja-JP');
            addSystemMessage(`ğŸ“‚ ã‚²ãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ (${savedTime})`);
        } catch (e) {
            console.error('[Load] èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            addSystemMessage('âŒ ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
    }

    // ãƒšãƒ¼ã‚¸æƒ…å ±è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤ºæ™‚ã®æƒ…å ±ãƒœã‚¿ãƒ³ï¼‰
    function showPageInfo() {
        if (currentPageIndex < 0 || !pages[currentPageIndex]) {
            console.log('[Info] ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        const page = pages[currentPageIndex];
        const genInfo = page.genInfo;
        const typeLabels = { narrative: 'åœ°ã®æ–‡ãƒšãƒ¼ã‚¸', character: 'ã‚»ãƒªãƒ•ã®ãƒšãƒ¼ã‚¸' };

        let html = '';

        // åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        html += '<div class="page-info-section">';
        html += `<div class="page-info-section-title">ãƒšãƒ¼ã‚¸ ${currentPageIndex + 1}/${pages.length}</div>`;
        if (page.type) {
            html += `<div class="page-info-row"><span class="page-info-label">ç¨®åˆ¥:</span><span class="page-info-value">${typeLabels[page.type] || page.type}</span></div>`;
        }
        html += '</div>';

        if (genInfo) {
            // ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += '<div class="page-info-section">';
            html += '<div class="page-info-section-title">ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div>';
            if (genInfo.actionType) html += `<div class="page-info-row"><span class="page-info-label">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥:</span><span class="page-info-value">${escapeHtml(genInfo.actionType)}</span></div>`;
            if (genInfo.characterId) {
                const char = characters.find(c => c.character_id === genInfo.characterId);
                const charDisplay = char?.name ? `${escapeHtml(char.name)}` : '';
                const charIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.characterId)})</span>`;
                html += `<div class="page-info-row"><span class="page-info-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</span><span class="page-info-value">${charDisplay}${charIdDisplay}</span></div>`;
                const profileText = char?.profile ? escapeHtml(char.profile) : 'ãªã—';
                html += `<div class="page-info-row"><span class="page-info-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:</span><span class="page-info-value" style="color:#aaa; font-size:0.85rem;">${profileText}</span></div>`;
            }
            if (genInfo.placeId) {
                const place = places.find(p => p.place_id === genInfo.placeId);
                const placeDisplay = place?.name ? `${escapeHtml(place.name)}` : '';
                const placeIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.placeId)})</span>`;
                html += `<div class="page-info-row"><span class="page-info-label">å ´æ‰€:</span><span class="page-info-value">${placeDisplay}${placeIdDisplay}</span></div>`;
            }
            if (genInfo.actionId) {
                const action = actions.find(a => a.action_id === genInfo.actionId);
                const actionDisplay = action?.name ? `${escapeHtml(action.name)}` : '';
                const actionIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.actionId)})</span>`;
                html += `<div class="page-info-row"><span class="page-info-label">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</span><span class="page-info-value">${actionDisplay}${actionIdDisplay}</span></div>`;
            }
            if (genInfo.costumeId) {
                const costume = costumes.find(c => c.costume_id === genInfo.costumeId);
                const costumeDisplay = costume?.name ? `${escapeHtml(costume.name)}` : '';
                const costumeIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.costumeId)})</span>`;
                html += `<div class="page-info-row"><span class="page-info-label">æœè£…:</span><span class="page-info-value">${costumeDisplay}${costumeIdDisplay}</span></div>`;
            }
            if (genInfo.relationshipId) {
                const relationship = relationships.find(r => r.relationship_id === genInfo.relationshipId);
                const relationshipDisplay = relationship?.name ? `${escapeHtml(relationship.name)}` : '';
                const relationshipIdDisplay = ` <span style="color:#888">(${escapeHtml(genInfo.relationshipId)})</span>`;
                html += `<div class="page-info-row"><span class="page-info-label">é–¢ä¿‚æ€§:</span><span class="page-info-value">${relationshipDisplay}${relationshipIdDisplay}</span></div>`;
                if (relationship?.description) {
                    html += `<div class="page-info-row"><span class="page-info-label"></span><span class="page-info-value" style="color:#aaa; font-size:0.85rem;">${escapeHtml(relationship.description)}</span></div>`;
                }
                if (relationship?.next_relationship_req) {
                    html += `<div class="page-info-row"><span class="page-info-label">ç™ºå±•æ¡ä»¶:</span><span class="page-info-value" style="color:#aaa; font-size:0.85rem;">${escapeHtml(relationship.next_relationship_req)}</span></div>`;
                }
            }
            html += '</div>';

            // LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += '<div class="page-info-section">';
            html += '<div class="page-info-section-title">LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå†ç¾ï¼‰</div>';

            // genInfoã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†æ§‹ç¯‰
            let reconstructedPrompt = null;
            try {
                const char = genInfo.characterId ? characters.find(c => c.character_id === genInfo.characterId) : null;
                const place = genInfo.placeId ? places.find(p => p.place_id === genInfo.placeId) : null;
                const actionIndex = genInfo.actionId ? actions.findIndex(a => a.action_id === genInfo.actionId) : -1;

                // charAtLocationã‚’å†æ§‹ç¯‰
                let charAtLocation = null;
                if (char) {
                    charAtLocation = {
                        character: char,
                        status: {
                            characterIndex: characters.indexOf(char),
                            placeIndex: place ? places.indexOf(place) : -1,
                            actionIndex: actionIndex,
                            relationshipId: genInfo.relationshipId || null,
                            costumeId: genInfo.costumeId || null
                        }
                    };
                }

                // currentStateã‚’ä¸€æ™‚çš„ã«è¨­å®šã—ã¦buildCombinedPromptã‚’å‘¼ã³å‡ºã™
                const savedActionIndex = currentState.actionIndex;
                currentState.actionIndex = actionIndex;

                const result = buildCombinedPrompt(
                    genInfo.actionType,
                    '',  // userInputã¯ä¿æŒã—ã¦ã„ãªã„ã®ã§ç©º
                    null,  // previousPlace
                    place,  // newPlace (ç§»å‹•æ™‚)
                    charAtLocation,
                    place,  // currentPlace
                    false,  // dialogueOnly
                    null   // companion
                );

                currentState.actionIndex = savedActionIndex;

                if (result && result.fullPrompt) {
                    reconstructedPrompt = result.fullPrompt;
                }
            } catch (e) {
                console.log('[PageInfo] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾ã‚¨ãƒ©ãƒ¼:', e);
            }

            if (reconstructedPrompt) {
                html += `<div class="page-info-text">${escapeHtml(reconstructedPrompt)}</div>`;
            } else {
                html += '<div style="color:#888">(å†ç¾ä¸å¯)</div>';
            }
            html += '</div>';

            // ç”»åƒç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
            if (genInfo.imageGenInfo) {
                const img = genInfo.imageGenInfo;
                html += '<div class="page-info-section">';
                html += '<div class="page-info-section-title">ç”»åƒç”Ÿæˆ</div>';
                if (img.modelId) {
                    const model = models[img.modelId];
                    const modelDisplay = model?.name ? `${escapeHtml(model.name)}` : '';
                    const modelIdDisplay = ` <span style="color:#888">(${escapeHtml(img.modelId)})</span>`;
                    html += `<div class="page-info-row"><span class="page-info-label">ãƒ¢ãƒ‡ãƒ«:</span><span class="page-info-value">${modelDisplay}${modelIdDisplay}</span></div>`;
                }
                if (img.seed) html += `<div class="page-info-row"><span class="page-info-label">ã‚·ãƒ¼ãƒ‰:</span><span class="page-info-value">${img.seed}</span></div>`;
                if (img.compositionTag) html += `<div class="page-info-row"><span class="page-info-label">æ§‹å›³:</span><span class="page-info-value">${escapeHtml(img.compositionTag)}</span></div>`;
                // æœè£…ã‚¿ã‚°ã¯genInfo.costumeIdã‹ã‚‰å–å¾—
                if (genInfo.costumeId) {
                    const costume = costumes.find(c => c.costume_id === genInfo.costumeId);
                    if (costume?.tag) html += `<div class="page-info-row"><span class="page-info-label">æœè£…ã‚¿ã‚°:</span><span class="page-info-value">${escapeHtml(costume.tag)}</span></div>`;
                }
                // è¡¨æƒ…ã‚¿ã‚°ã¯genInfo.relationshipIdã‹ã‚‰å–å¾—
                if (genInfo.relationshipId) {
                    const rel = relationships.find(r => r.relationship_id === genInfo.relationshipId);
                    if (rel?.expression) html += `<div class="page-info-row"><span class="page-info-label">è¡¨æƒ…:</span><span class="page-info-value">${escapeHtml(rel.expression)}</span></div>`;
                }

                // ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾ï¼ˆbuildImageGenPromptã‚’ä½¿ç”¨ï¼‰
                try {
                    const char = genInfo.characterId ? characters.find(c => c.character_id === genInfo.characterId) : null;
                    const place = genInfo.placeId ? places.find(p => p.place_id === genInfo.placeId) : null;
                    const actionIndex = genInfo.actionId ? actions.findIndex(a => a.action_id === genInfo.actionId) : -1;
                    const imagePromptResult = buildImageGenPrompt(
                        img.modelId,
                        char,
                        place,
                        actionIndex,
                        img.compositionTag,
                        genInfo.costumeId,
                        genInfo.relationshipId
                    );
                    if (imagePromptResult?.finalPrompt) {
                        html += '<div style="margin-top:8px"><span class="page-info-label">ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå†ç¾ï¼‰:</span></div>';
                        html += `<div class="page-info-text">${escapeHtml(imagePromptResult.finalPrompt)}</div>`;
                    }
                } catch (e) {
                    console.log('[PageInfo] ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†ç¾ã‚¨ãƒ©ãƒ¼:', e);
                }

                html += '</div>';
            }
        } else {
            html += '<div class="page-info-section"><div style="color:#888">(ç”Ÿæˆæƒ…å ±ãªã—)</div></div>';
        }

        document.getElementById('pageInfoContent').innerHTML = html;
        document.getElementById('pageInfoPanel').classList.add('active');
    }

    function closePageInfo() {
        document.getElementById('pageInfoPanel').classList.remove('active');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒç”Ÿæˆï¼ˆæŒ‡å®šæ§‹å›³ã‚¿ã‚°ç‰ˆï¼‰
    // æˆ»ã‚Šå€¤: { imageURL, imageGenInfo } ã¾ãŸã¯ null
    async function generateCharacterImageWithComposition(charAtLocation, place, actionIndex, compositionTag) {
        const runwareApiKey = document.getElementById('runwareApiKey').value.trim();
        if (!runwareApiKey) return null;

        const character = charAtLocation?.character;
        const costumeId = charAtLocation?.status?.costumeId;
        const relationshipId = charAtLocation?.status?.relationshipId;

        // ãƒ¢ãƒ‡ãƒ«å–å¾—
        const modelId = selectedModelId || getFirstModelId(models);
        if (!modelId || !models[modelId]) return null;

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆå…±é€šé–¢æ•°ã‚’ä½¿ç”¨ï¼‰
        const promptResult = buildImageGenPrompt(modelId, character, place, actionIndex, compositionTag, costumeId, relationshipId);
        if (!promptResult) return null;

        const { finalPrompt, negativePrompt, characterWithExtras } = promptResult;

        showStatusImage();
        const result = await generateImage(runwareApiKey, modelId, finalPrompt, {
            negativePrompt: negativePrompt,
            steps: models[modelId]?.steps || 20,
            cfgScale: models[modelId]?.cfgScale || 7,
            scheduler: models[modelId]?.scheduler || 'Default',
            width: 1024,
            height: 1024,
            character: characterWithExtras
        });
        hideStatusImage();

        return {
            imageURL: result.imageURL,
            imageGenInfo: {
                modelId: modelId,
                compositionTag: compositionTag,
                seed: result.seed
            }
        };
    }

</script>

</body>
</html>
