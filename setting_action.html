<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アクション設定</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        /* 横幅制限解除 */
        .container {
            max-width: none;
        }

        /* カードグリッド: 固定幅で列数可変 */
        .card-grid {
            grid-template-columns: repeat(auto-fill, 180px);
        }

        .card {
            width: 180px;
        }

        /* ページ固有スタイル */
        .action-prompt {
            font-size: 0.7rem;
            color: #aaa;
            line-height: 1.3;
            max-height: 50px;
            overflow-y: auto;
        }

        /* 詳細ページ固有 */
        .detail-info .field-value {
            background: #1a1a1a;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 1rem;
            white-space: pre-wrap;
            word-break: break-word;
            border: 1px solid #333;
        }

        .detail-info .field-value.editable {
            width: 100%;
            min-height: 120px;
            resize: vertical;
            color: #e0e0e0;
            font-family: inherit;
        }

        .detail-info .field-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .detail-info .field-row label {
            color: #888;
            font-size: 0.85rem;
            white-space: nowrap;
            min-width: 100px;
        }

        .detail-info .field-row input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .detail-info .field-row input:focus,
        .detail-info .field-row select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .detail-info .field-row select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .card-info .card-name {
            text-align: left;
        }

        .card-info .action-link {
            font-size: 0.7rem;
            color: #888;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .detail-info .field-value.editable:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .detail-header .btn-save {
            margin-right: 10px;
        }

        .detail-header #detail-status {
            margin-right: 15px;
        }

        /* 構図セクション */
        .composition-section {
            border-top: 1px solid #333;
            padding-top: 30px;
        }

        .composition-title {
            color: #4a9eff;
            margin: 0 0 20px 0;
            font-size: 1.2rem;
        }

        .composition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 180px);
            gap: 15px;
        }

        .composition-item {
            text-align: center;
            width: 180px;
        }

        .composition-label {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .composition-quality {
            margin-bottom: 8px;
            display: flex;
            gap: 2px;
        }

        .quality-btn {
            flex: 1;
            padding: 4px 2px;
            border: 1px solid #444;
            background: #222;
            color: #888;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quality-btn:first-child {
            border-radius: 4px 0 0 4px;
        }

        .quality-btn:last-child {
            border-radius: 0 4px 4px 0;
        }

        .quality-btn:hover:not(.active) {
            background: #333;
        }

        .quality-btn.active {
            cursor: default;
        }

        .quality-btn.active-none {
            background: #555;
            color: #fff;
            border-color: #666;
        }

        .quality-btn.active-ng {
            background: #c0392b;
            color: #fff;
            border-color: #e74c3c;
        }

        .quality-btn.active-good {
            background: #d68910;
            color: #fff;
            border-color: #f39c12;
        }

        .quality-btn.active-best {
            background: #1e8449;
            color: #fff;
            border-color: #27ae60;
        }

        .composition-image {
            width: 100%;
            aspect-ratio: 1;
            background: #111;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .composition-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .composition-image .placeholder {
            color: #666;
            font-size: 0.75rem;
        }

        .composition-image.disabled {
            opacity: 0.3;
        }

        .composition-tag-input {
            width: 100%;
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid #333;
            background: #222;
            color: #e0e0e0;
            font-size: 0.7rem;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        .composition-tag-input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .composition-tag-input::placeholder {
            color: #666;
        }

        /* 翻訳エリア */
        .translate-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        .translate-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .translate-row textarea {
            flex: 1;
        }

        .btn-translate {
            padding: 10px 20px;
            background: #4a9eff;
            white-space: nowrap;
        }

        .btn-translate:hover {
            background: #3a8eef;
        }

        .translate-output {
            margin-top: 10px;
            padding: 12px 15px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.9rem;
            min-height: 40px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .translate-output:empty::before {
            content: '翻訳結果がここに表示されます';
            color: #666;
        }

        .translate-output.loading::before {
            content: '翻訳中...';
            color: #4a9eff;
        }

        .translate-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
        }

        .translate-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .translate-label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 4px;
        }

        .translate-text {
            padding: 8px 12px;
            background: #252525;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .translate-text:hover {
            background: #2a3a4a;
        }

        .translate-text.copied {
            background: #1a4a1a;
        }

        .translate-error {
            color: #ff6b6b;
        }

        /* 詳細ページ2ペインレイアウト */
        .detail-page.active {
            display: flex;
        }

        .action-chain-pane {
            width: 210px;
            min-width: 210px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 15px;
            background: #1a1a1a;
            height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
        }

        .detail-right-pane {
            flex: 1;
            margin-left: 230px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .detail-right-pane .detail-header {
            position: relative;
            flex-shrink: 0;
        }

        .detail-right-pane .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: none;
            margin: 0;
        }

        .detail-right-pane .detail-main {
            max-width: none;
        }

        .detail-right-pane .composition-section {
            max-width: none;
        }

        .action-chain-pane h4 {
            color: #888;
            font-size: 0.8rem;
            margin: 0 0 15px 0;
            font-weight: normal;
        }

        .chain-item {
            width: 180px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.15s;
        }

        .chain-item:hover {
            transform: scale(1.03);
        }

        .chain-item.current {
            outline: 2px solid #4a9eff;
            border-radius: 8px;
        }

        .chain-item .chain-thumbnail {
            width: 100%;
            aspect-ratio: 1;
            background: #111;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chain-item .chain-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chain-item .chain-thumbnail .placeholder {
            color: #444;
            font-size: 0.7rem;
        }

        .chain-item .chain-name {
            font-size: 0.75rem;
            color: #aaa;
            text-align: center;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chain-item.current .chain-name {
            color: #4a9eff;
            font-weight: bold;
        }

        .chain-arrow {
            color: #444;
            font-size: 1.2rem;
            margin: 5px 0;
        }

    </style>
</head>
<body>

<div class="container">
    <h1>アクション設定</h1>

    <!-- アクショングリッド -->
    <div id="action-grid" class="card-grid">
        <div class="empty-message">「GASから読み込み」ボタンでアクションデータを読み込んでください</div>
    </div>

    <!-- 設定バー -->
    <div class="settings-bar" style="margin-top: 20px;">
        <div class="settings-row">
            <label>GAS URL:</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
            <button class="btn btn-primary" onclick="loadAllFromGas()">GASから読み込み</button>
            <button class="btn btn-save" onclick="saveToGas()">GASに保存</button>
            <button class="btn btn-generate" onclick="generateAllImages()" id="generateAllBtn">全アクション画像生成</button>
        </div>
        <div class="settings-row">
            <label>Runware API Key:</label>
            <input type="password" id="apiKey" placeholder="Runware API Keyを入力">
            <label style="margin-left: 20px;">OpenRouter API Key:</label>
            <input type="password" id="openrouterApiKey" placeholder="OpenRouter API Keyを入力">
        </div>
        <div id="status"></div>
    </div>
</div>

<!-- アクション詳細ページ -->
<div id="detail-page" class="detail-page">
    <!-- 左ペイン: アクションチェーン -->
    <div class="action-chain-pane">
        <h4>アクションの流れ</h4>
        <div id="action-chain"></div>
    </div>

    <!-- 右ペイン: ヘッダー + コンテンツ -->
    <div class="detail-right-pane">
        <div class="detail-header">
            <button class="detail-back" onclick="closeDetailPage()">← 戻る</button>
            <h1 class="detail-title" id="detail-title"></h1>
            <div class="header-selects">
                <label>キャラ:</label>
                <select id="preview-character"></select>
                <label>場所:</label>
                <select id="preview-place"></select>
            </div>
            <button class="btn btn-save" onclick="saveToGas()">GASに保存</button>
            <div id="detail-status"></div>
            <div class="detail-nav">
                <button class="btn btn-nav" onclick="navigateAction(-1)" id="btn-prev">← 前</button>
                <button class="btn btn-nav" onclick="navigateAction(1)" id="btn-next">次 →</button>
            </div>
        </div>
        <div class="detail-content">
            <div class="detail-main">
                <div class="detail-image-section">
                    <div class="detail-image-area" id="detail-image"></div>
                    <button class="btn btn-generate" onclick="generateDetailImage()">画像生成</button>
                </div>
                <div class="detail-info">
                    <div class="field-label">Action ID: <span id="detail-action-id" style="color: #4a9eff; font-weight: normal;"></span></div>
                    <div class="field-label">アクション名</div>
                    <input type="text" class="field-value editable" id="detail-name" onchange="updateActionName(this.value)" style="min-height: auto;">
                    <div class="field-row">
                        <label>アクションタイプ:</label>
                        <input type="text" id="detail-action-type" onchange="updateActionField('action_type', this.value)">
                    </div>
                    <div class="field-row">
                        <label>前提アクション:</label>
                        <select id="detail-pre-action" onchange="updateActionField('pre_action', this.value)"></select>
                    </div>
                    <div class="field-row">
                        <label>公開アクション:</label>
                        <select id="detail-public-action" onchange="updateActionField('public_action', this.value)"></select>
                    </div>
                    <div class="field-row">
                        <label>次アクション:</label>
                        <select id="detail-next-action" onchange="updateActionField('next_action', this.value)"></select>
                    </div>
                    <div class="field-label">プロンプト</div>
                    <textarea class="field-value editable" id="detail-prompt" onchange="updateActionPrompt(this.value)"></textarea>
                </div>
            </div>

            <!-- 構図セクション -->
            <div class="composition-section">
                <h3 class="composition-title">構図別プレビュー</h3>
                <div id="composition-grid" class="composition-grid"></div>
            </div>

            <!-- 翻訳エリア -->
            <div class="translate-section">
                <div class="field-label">プロンプト翻訳（日→英）</div>
                <div class="translate-row">
                    <textarea class="field-value editable" id="translate-input" placeholder="日本語で入力..." style="min-height: 60px;"></textarea>
                    <button class="btn btn-translate" onclick="translatePrompt()">翻訳</button>
                </div>
                <div class="translate-output" id="translate-output"></div>
            </div>
        </div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/prompt-utils.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script>
    const GAS_DATA_KEY = 'gas_data_cache_action';
    const ACTION_IMAGES_KEY = 'action_images';
    const COMPOSITION_IMAGES_KEY = 'composition_images';
    const QUALITY_OPTIONS = [
        { value: '未評価', label: '未評価', activeClass: 'active-none' },
        { value: 'NG', label: 'NG', activeClass: 'active-ng' },
        { value: 'good', label: 'GOOD', activeClass: 'active-good' },
        { value: 'best', label: 'BEST', activeClass: 'active-best' }
    ];

    // データストア
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let relationships = [];
    let actionImages = {}; // アクション名 -> 画像URL
    let compositionImages = {}; // アクション名 -> { composition名: url }

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
        const settings = loadSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY);
        if (settings.gasUrl) document.getElementById('apiUrl').value = settings.gasUrl;
        if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
        // OpenRouter API Key
        const openrouterKey = localStorage.getItem(STORAGE_KEYS.OPENROUTER_API_KEY) || '';
        if (openrouterKey) document.getElementById('openrouterApiKey').value = openrouterKey;
        loadCachedData();
    });

    // キャッシュデータを保存
    function saveCachedData() {
        const data = {
            models: models,
            characters: characters,
            places: places,
            actions: actions,
            relationships: relationships
        };
        localStorage.setItem(GAS_DATA_KEY, JSON.stringify(data));
        localStorage.setItem(ACTION_IMAGES_KEY, JSON.stringify(actionImages));
        localStorage.setItem(COMPOSITION_IMAGES_KEY, JSON.stringify(compositionImages));
    }

    // キャッシュデータを復元
    function loadCachedData() {
        try {
            const cachedData = localStorage.getItem(GAS_DATA_KEY);
            if (cachedData) {
                const data = JSON.parse(cachedData);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
                relationships = data.relationships || [];
            }

            const cachedImages = localStorage.getItem(ACTION_IMAGES_KEY);
            if (cachedImages) {
                actionImages = JSON.parse(cachedImages);
            }

            const cachedComposition = localStorage.getItem(COMPOSITION_IMAGES_KEY);
            if (cachedComposition) {
                compositionImages = JSON.parse(cachedComposition);
            }

            // データがあればグリッドを描画
            if (actions.length > 0) {
                renderActionGrid();
                showStatusWithDetail(`キャッシュから復元: モデル${Object.keys(models).length}件, アクション${actions.length}件`);
            }
        } catch (error) {
            console.error('キャッシュ復元エラー:', error);
        }
    }

    function doSaveSettings() {
        const gasUrl = document.getElementById('apiUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        saveSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY, gasUrl, apiKey);
        // OpenRouter API Key
        const openrouterKey = document.getElementById('openrouterApiKey').value.trim();
        if (openrouterKey) localStorage.setItem(STORAGE_KEYS.OPENROUTER_API_KEY, openrouterKey);
    }

    function showStatusWithDetail(msg, type = 'ok') {
        showStatus(msg, type);
        // 詳細画面が開いている場合はそちらにも表示
        const detailStatus = document.getElementById('detail-status');
        if (detailStatus && currentDetailIndex >= 0) {
            detailStatus.textContent = msg;
            detailStatus.className = type === 'error' ? 'status-err' : type === 'loading' ? 'status-loading' : 'status-ok';
            if (type === 'ok') {
                setTimeout(() => {
                    detailStatus.textContent = '';
                    detailStatus.className = '';
                }, 3000);
            }
        }
    }

    // GASから全データ読み込み
    async function loadAllFromGas() {
        const baseUrl = document.getElementById('apiUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        doSaveSettings();
        showStatusWithDetail('読み込み中...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData, relationshipData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action'),
                fetchGasData(baseUrl, 'relationship')
            ]);

            // 共通パーサーを使用
            models = parseModels(modelData);
            characters = parseCharacters(characterData);
            places = parsePlaces(placeData);
            relationships = parseRelationships(relationshipData);

            // 既存のact_xxx形式のIDから最大番号を取得
            let maxNum = 0;
            actionData.forEach(item => {
                const id = item['action_id'] || '';
                const match = id.match(/^act_(\d+)$/);
                if (match) {
                    const num = parseInt(match[1], 10);
                    if (num > maxNum) maxNum = num;
                }
            });

            // アクション設定（品質正規化とenabled付き）
            actions = actionData.map(item => {
                let actionId = item['action_id'] || '';
                if (!actionId) {
                    maxNum++;
                    actionId = 'act_' + String(maxNum).padStart(3, '0');
                }

                const action = {
                    action_id: actionId,
                    name: item['action name'] || '',
                    prompt: item.prompt || '',
                    action_type: item['action_type'] || '',
                    pre_action: item['pre-action'] || '',
                    public_action: item['public-action'] || '',
                    next_action: item['next-action'] || '',
                    compositions: []
                };
                COMPOSITION_KEYS.forEach(key => {
                    const qualityKey = key + ' quality';
                    const tagKey = key + ' tag';
                    const rawQuality = item[qualityKey] || '';
                    const tag = item[tagKey] || '';

                    // quality値を正規化
                    let quality = '未評価';
                    if (rawQuality === 'NG' || rawQuality === 'ng') {
                        quality = 'NG';
                    } else if (rawQuality === 'best' || rawQuality === 'Best') {
                        quality = 'best';
                    } else if (rawQuality === 'good' || rawQuality === 'Good') {
                        quality = 'good';
                    }

                    action.compositions.push({
                        name: key,
                        tag: tag,
                        quality: quality,
                        enabled: quality !== 'NG'
                    });
                });
                return action;
            });

            // キャッシュに保存
            saveCachedData();

            renderActionGrid();
            showStatusWithDetail(`読み込み完了: モデル${Object.keys(models).length}件, キャラ${characters.length}件, 場所${places.length}件, アクション${actions.length}件`);

        } catch (error) {
            console.error(error);
            showStatusWithDetail('読み込みエラー: ' + error.message, 'error');
        }
    }

    // アクショングリッドを描画
    function renderActionGrid() {
        const container = document.getElementById('action-grid');

        if (actions.length === 0) {
            container.innerHTML = '<div class="empty-message">アクションデータがありません</div>';
            return;
        }

        container.innerHTML = actions.map((action, index) => {
            const preActionName = getActionNameById(action.pre_action);
            const nextActionName = getActionNameById(action.next_action);
            return `
            <div class="card" id="card-${index}">
                <div class="card-image" id="image-${index}">
                    ${actionImages[action.action_id]
                        ? `<img src="${actionImages[action.action_id]}" alt="${action.name}" onclick="openDetailPage(${index})">`
                        : `<div class="placeholder" onclick="openDetailPage(${index})" style="cursor:pointer;">画像未生成</div>`
                    }
                </div>
                <div class="card-info">
                    <div class="action-link">${preActionName ? '↓ ' + preActionName : '&nbsp;'}</div>
                    <div class="card-name">${action.name || '(名前未設定)'}</div>
                    <div class="action-link">${nextActionName ? '↓ ' + nextActionName : '&nbsp;'}</div>
                </div>
            </div>
        `}).join('');
    }

    // action_idからアクション名を取得
    function getActionNameById(actionId) {
        if (!actionId) return '';
        const action = actions.find(a => a.action_id === actionId);
        return action ? action.name : '';
    }

    // モデルリストの最初のモデルを取得
    function getFirstModel() {
        return Object.keys(models)[0] || null;
    }

    // 画像生成前のバリデーション（APIキー/モデル確認）
    function validateGenerateSettings() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return null;
        }
        const modelId = getFirstModel();
        if (!modelId) {
            alert('モデルが見つかりません。GASから読み込んでください。');
            return null;
        }
        doSaveSettings();
        return { apiKey, modelId };
    }

    // プロンプト構築（compIndexを指定しない場合はBEST構図を自動選択）
    function buildActionPrompt(actionIndex, compIndex = null) {
        const action = actions[actionIndex];
        if (!action) return '';

        const model = models[getFirstModel()] || {};
        const charIndex = parseInt(document.getElementById('preview-character')?.value);
        const placeIndex = parseInt(document.getElementById('preview-place')?.value);
        const char = charIndex >= 0 ? (characters[charIndex] || {}) : {};
        const place = placeIndex >= 0 ? (places[placeIndex] || {}) : {};

        // 構図タグ: 指定があればその構図、なければBEST選択
        let compositionTag;
        if (compIndex !== null && action.compositions[compIndex]) {
            const comp = action.compositions[compIndex];
            compositionTag = comp.tag || comp.name;
        } else {
            const selectedComp = selectBestComposition(action.compositions);
            compositionTag = selectedComp ? (selectedComp.tag || selectedComp.name) : 'front view';
        }

        return [
            model.qualityPositive || '',
            char.tag || '',
            place.tag || '',
            action.prompt || '',
            compositionTag,
            place.additionalTag || '',
            char.additionalTag || ''
        ].filter(p => p).join(', ');
    }

    // selectBestComposition は js/prompt-utils.js で定義

    // 単一アクションの画像生成
    async function generateSingleImage(actionIndex) {
        const settings = validateGenerateSettings();
        if (!settings) return;

        const action = actions[actionIndex];
        const imageDiv = document.getElementById(`image-${actionIndex}`);
        imageDiv.innerHTML = '<div class="generating">生成中...</div>';

        try {
            const prompt = buildActionPrompt(actionIndex);
            const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
            actionImages[action.action_id] = imageUrl;
            saveCachedData();
            imageDiv.innerHTML = `<img src="${imageUrl}" alt="${action.name}" onclick="openDetailPage(${actionIndex})">`;
        } catch (error) {
            console.error(error);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        }
    }

    // 全アクションの画像を生成
    async function generateAllImages() {
        const settings = validateGenerateSettings();
        if (!settings) return;

        if (actions.length === 0) {
            alert('アクションがありません');
            return;
        }

        const btn = document.getElementById('generateAllBtn');
        btn.disabled = true;

        showStatusWithDetail(`画像生成中: 0/${actions.length}`, 'loading');

        for (let i = 0; i < actions.length; i++) {
            const action = actions[i];
            const imageDiv = document.getElementById(`image-${i}`);
            imageDiv.innerHTML = '<div class="generating">生成中...</div>';

            try {
                const prompt = buildActionPrompt(i);
                const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
                actionImages[action.action_id] = imageUrl;
                saveCachedData();
                imageDiv.innerHTML = `<img src="${imageUrl}" alt="${action.name}" onclick="openDetailPage(${i})">`;
                showStatusWithDetail(`画像生成中: ${i + 1}/${actions.length}`, 'loading');
            } catch (error) {
                console.error(error);
                imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー</div>`;
            }

            // レート制限対策で少し待つ
            if (i < actions.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        btn.disabled = false;
        showStatusWithDetail(`画像生成完了: ${actions.length}件`);
    }

    // 詳細ページ関連
    let currentDetailIndex = -1;

    // アクションチェーンを取得（前提アクション→現在→次アクション）
    function getActionChain(actionId) {
        const chain = [];
        const visited = new Set();

        // 前提アクションを遡る
        let current = actions.find(a => a.action_id === actionId);
        const preActions = [];
        while (current && current.pre_action && !visited.has(current.pre_action)) {
            visited.add(current.pre_action);
            const preAction = actions.find(a => a.action_id === current.pre_action);
            if (preAction) {
                preActions.unshift(preAction);
                current = preAction;
            } else {
                break;
            }
        }

        // チェーンに前提アクションを追加
        chain.push(...preActions);

        // 現在のアクションを追加
        const currentAction = actions.find(a => a.action_id === actionId);
        if (currentAction) {
            chain.push(currentAction);
        }

        // 次アクションを辿る
        visited.clear();
        current = currentAction;
        while (current && current.next_action && !visited.has(current.next_action)) {
            visited.add(current.next_action);
            const nextAction = actions.find(a => a.action_id === current.next_action);
            if (nextAction) {
                chain.push(nextAction);
                current = nextAction;
            } else {
                break;
            }
        }

        return chain;
    }

    // アクションチェーンをレンダリング
    function renderActionChain() {
        const container = document.getElementById('action-chain');
        const action = actions[currentDetailIndex];
        if (!action) {
            container.innerHTML = '';
            return;
        }

        const chain = getActionChain(action.action_id);

        let html = '';
        chain.forEach((chainAction, index) => {
            const isCurrent = chainAction.action_id === action.action_id;
            const imageUrl = actionImages[chainAction.action_id];
            const actionIndex = actions.findIndex(a => a.action_id === chainAction.action_id);

            if (index > 0) {
                html += '<div class="chain-arrow">↓</div>';
            }

            html += `
                <div class="chain-item ${isCurrent ? 'current' : ''}" onclick="openDetailPage(${actionIndex})">
                    <div class="chain-thumbnail">
                        ${imageUrl
                            ? `<img src="${imageUrl}" alt="${chainAction.name}">`
                            : '<span class="placeholder">No Image</span>'
                        }
                    </div>
                    <div class="chain-name">${chainAction.name || '(名前未設定)'}</div>
                </div>
            `;
        });

        if (chain.length === 0) {
            html = '<div style="color: #666; font-size: 0.8rem; text-align: center;">チェーンなし</div>';
        }

        container.innerHTML = html;
    }

    function openDetailPage(index) {
        const action = actions[index];
        if (!action) return;

        currentDetailIndex = index;
        updateDetailPage();

        // 詳細ページを表示
        document.getElementById('detail-page').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function updateDetailPage() {
        const action = actions[currentDetailIndex];
        if (!action) return;

        // データを設定
        document.getElementById('detail-title').textContent = action.name || '(名前未設定)';
        document.getElementById('detail-action-id').textContent = action.action_id || '(未設定)';
        document.getElementById('detail-name').value = action.name || '';
        document.getElementById('detail-prompt').value = action.prompt || '';
        document.getElementById('detail-action-type').value = action.action_type || '';

        // アクション選択プルダウンを更新
        updateActionSelectOptions('detail-pre-action', action.pre_action);
        updateActionSelectOptions('detail-public-action', action.public_action);
        updateActionSelectOptions('detail-next-action', action.next_action);

        // 画像を設定
        const imageDiv = document.getElementById('detail-image');
        const imageUrl = actionImages[action.action_id];
        if (imageUrl) {
            imageDiv.innerHTML = `<img src="${imageUrl}" alt="${action.name}" onclick="window.open('${imageUrl}', '_blank')">`;
        } else {
            imageDiv.innerHTML = '<div class="placeholder">画像未生成</div>';
        }

        // プルダウンを更新
        updatePreviewSelects();

        // 構図グリッドを更新
        updateCompositionGrid();

        // アクションチェーンを更新
        renderActionChain();

        // ナビゲーションボタンの状態を更新
        document.getElementById('btn-prev').disabled = currentDetailIndex <= 0;
        document.getElementById('btn-next').disabled = currentDetailIndex >= actions.length - 1;
    }

    function updatePreviewSelects() {
        const charSelect = document.getElementById('preview-character');
        const placeSelect = document.getElementById('preview-place');

        const charValue = charSelect.value;
        const placeValue = placeSelect.value;

        charSelect.innerHTML = '<option value="-1">無し</option>' + characters.map((char, index) =>
            `<option value="${index}">${char.name || '(名前なし)'}</option>`
        ).join('');

        placeSelect.innerHTML = '<option value="-1">無し</option>' + places.map((place, index) =>
            `<option value="${index}">${place.name || '(名前なし)'}</option>`
        ).join('');

        if (charValue !== '' && parseInt(charValue) >= -1 && parseInt(charValue) < characters.length) charSelect.value = charValue;
        if (placeValue !== '' && parseInt(placeValue) >= -1 && parseInt(placeValue) < places.length) placeSelect.value = placeValue;
    }

    function updateCompositionGrid() {
        const action = actions[currentDetailIndex];
        if (!action) return;

        const container = document.getElementById('composition-grid');
        const actionCompositions = compositionImages[action.action_id] || {};

        container.innerHTML = action.compositions.map((comp, index) => {
            const imageUrl = actionCompositions[comp.name];
            const disabledClass = comp.enabled ? '' : 'disabled';

            return `
                <div class="composition-item">
                    <div class="composition-label">${comp.name}</div>
                    <div class="composition-quality">
                        ${QUALITY_OPTIONS.map(q => {
                            const isActive = comp.quality === q.value;
                            const activeClass = isActive ? `active ${q.activeClass}` : '';
                            return `<button class="quality-btn ${activeClass}" ${isActive ? 'disabled' : ''} onclick="updateCompositionQuality(${index}, '${q.value}')">${q.label}</button>`;
                        }).join('')}
                    </div>
                    <div class="composition-image ${disabledClass}" id="comp-image-${index}">
                        ${imageUrl
                            ? `<img src="${imageUrl}" alt="${comp.name}" onclick="window.open('${imageUrl}', '_blank')">`
                            : `<div class="placeholder">${comp.enabled ? '未生成' : 'NG'}</div>`
                        }
                    </div>
                    <input type="text" class="composition-tag-input" value="${comp.tag || ''}" placeholder="構図補正タグ" onchange="updateCompositionTag(${index}, this.value)">
                    <button class="btn btn-generate btn-small" onclick="generateCompositionImage(${index})">生成</button>
                </div>
            `;
        }).join('');
    }

    // 構図のquality更新
    function updateCompositionQuality(compIndex, quality) {
        if (currentDetailIndex < 0) return;

        const action = actions[currentDetailIndex];
        if (!action || !action.compositions[compIndex]) return;

        // BESTを選択した場合、他のBESTをGOODに変更
        if (quality === 'best') {
            action.compositions.forEach((comp, index) => {
                if (index !== compIndex && comp.quality === 'best') {
                    comp.quality = 'good';
                }
            });
        }

        action.compositions[compIndex].quality = quality;
        action.compositions[compIndex].enabled = quality !== 'NG';

        saveCachedData();

        // グリッドを再描画
        updateCompositionGrid();
    }

    // 構図補正タグ更新
    function updateCompositionTag(compIndex, tag) {
        if (currentDetailIndex < 0) return;

        const action = actions[currentDetailIndex];
        if (!action || !action.compositions[compIndex]) return;

        action.compositions[compIndex].tag = tag;

        saveCachedData();
    }

    // アクション選択プルダウンを更新
    function updateActionSelectOptions(selectId, selectedValue) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">無し</option>' + actions.map(action =>
            `<option value="${action.action_id}">${action.name} [${action.action_id}]</option>`
        ).join('');
        select.value = selectedValue || '';
    }

    // アクション名更新
    function updateActionName(name) {
        if (currentDetailIndex < 0) return;

        const action = actions[currentDetailIndex];
        if (!action) return;

        action.name = name;
        document.getElementById('detail-title').textContent = name || '(名前未設定)';
        saveCachedData();
        renderActionGrid();
    }

    // アクションプロンプト更新
    function updateActionPrompt(prompt) {
        if (currentDetailIndex < 0) return;

        const action = actions[currentDetailIndex];
        if (!action) return;

        action.prompt = prompt;
        saveCachedData();

        // 一覧のカードも更新
        renderActionGrid();
    }

    function updateActionField(field, value) {
        if (currentDetailIndex < 0) return;

        const action = actions[currentDetailIndex];
        if (!action) return;

        action[field] = value;

        // 前提アクションを設定したとき、その前提アクションの次アクションが空なら自動設定
        if (field === 'pre_action' && value) {
            const preAction = actions.find(a => a.action_id === value);
            if (preAction && !preAction.next_action) {
                preAction.next_action = action.action_id;
            }
        }

        // 次アクションを設定したとき、その次アクションの前提アクションが空なら自動設定
        if (field === 'next_action' && value) {
            const nextAction = actions.find(a => a.action_id === value);
            if (nextAction && !nextAction.pre_action) {
                nextAction.pre_action = action.action_id;
            }
        }

        saveCachedData();
        renderActionGrid();

        // アクションリンクが変更されたらチェーンを更新
        if (field === 'pre_action' || field === 'next_action') {
            renderActionChain();
        }
    }

    function closeDetailPage() {
        document.getElementById('detail-page').classList.remove('active');
        document.body.style.overflow = '';
        currentDetailIndex = -1;
    }

    function navigateAction(direction) {
        const newIndex = currentDetailIndex + direction;
        if (newIndex >= 0 && newIndex < actions.length) {
            currentDetailIndex = newIndex;
            updateDetailPage();
        }
    }

    // キーボードナビゲーション
    document.addEventListener('keydown', (e) => {
        // 詳細ページが開いていない場合は無視
        if (currentDetailIndex < 0) return;

        // 入力フォーカス中は無視
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateAction(-1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateAction(1);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateChain(-1);
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateChain(1);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            closeDetailPage();
        }
    });

    // アクションチェーン内をナビゲート
    function navigateChain(direction) {
        const action = actions[currentDetailIndex];
        if (!action) return;

        const chain = getActionChain(action.action_id);
        const currentChainIndex = chain.findIndex(a => a.action_id === action.action_id);

        if (currentChainIndex < 0) return;

        const newChainIndex = currentChainIndex + direction;
        if (newChainIndex >= 0 && newChainIndex < chain.length) {
            const targetAction = chain[newChainIndex];
            const targetIndex = actions.findIndex(a => a.action_id === targetAction.action_id);
            if (targetIndex >= 0) {
                openDetailPage(targetIndex);
            }
        }
    }

    async function generateDetailImage() {
        if (currentDetailIndex < 0) return;

        const settings = validateGenerateSettings();
        if (!settings) return;

        const action = actions[currentDetailIndex];
        const detailImageDiv = document.getElementById('detail-image');
        const cardImageDiv = document.getElementById(`image-${currentDetailIndex}`);

        detailImageDiv.innerHTML = '<div class="placeholder">生成中...</div>';

        try {
            const prompt = buildActionPrompt(currentDetailIndex);
            const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
            actionImages[action.action_id] = imageUrl;
            saveCachedData();

            // 詳細ページ画像を更新
            detailImageDiv.innerHTML = `<img src="${imageUrl}" alt="${action.name}" onclick="window.open('${imageUrl}', '_blank')">`;

            // カード画像も更新
            cardImageDiv.innerHTML = `<img src="${imageUrl}" alt="${action.name}" onclick="openDetailPage(${currentDetailIndex})">`;
        } catch (error) {
            console.error(error);
            detailImageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        }
    }

    // 構図画像生成
    async function generateCompositionImage(compIndex) {
        if (currentDetailIndex < 0) return;

        const settings = validateGenerateSettings();
        if (!settings) return;

        const action = actions[currentDetailIndex];
        const comp = action.compositions[compIndex];
        if (!comp) return;

        const imageDiv = document.getElementById(`comp-image-${compIndex}`);
        imageDiv.innerHTML = '<div class="placeholder">生成中...</div>';

        try {
            const prompt = buildActionPrompt(currentDetailIndex, compIndex);
            const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);

            // 保存
            if (!compositionImages[action.action_id]) {
                compositionImages[action.action_id] = {};
            }
            compositionImages[action.action_id][comp.name] = imageUrl;
            saveCachedData();

            // 表示更新
            imageDiv.innerHTML = `<img src="${imageUrl}" alt="${comp.name}" onclick="window.open('${imageUrl}', '_blank')">`;
        } catch (error) {
            console.error(error);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー</div>`;
        }
    }

    // 選択中のキャラクターを取得
    function getSelectedCharacter() {
        const charIndex = parseInt(document.getElementById('preview-character')?.value);
        return charIndex >= 0 ? (characters[charIndex] || null) : null;
    }

    // プロンプト指定で画像生成（共通関数を使用）
    async function generateImageWithPrompt(modelId, apiKey, prompt) {
        const model = models[modelId] || {};
        const result = await generateImage(apiKey, modelId, prompt, {
            negativePrompt: model.qualityNegative || '',
            steps: model.steps || 20,
            cfgScale: model.cfgScale || 7,
            scheduler: model.scheduler || 'Default',
            character: getSelectedCharacter()
        });
        return result.imageURL;
    }

    // GASに保存
    async function saveToGas() {
        const baseUrl = document.getElementById('apiUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        if (actions.length === 0) {
            alert('保存するアクションデータがありません');
            return;
        }

        doSaveSettings();
        showStatusWithDetail('GASに保存中...', 'loading');

        try {
            // アクションデータをGAS形式に変換
            const gasData = actions.map(action => {
                const row = {
                    'action_id': action.action_id,
                    'action name': action.name,
                    'prompt': action.prompt,
                    'action_type': action.action_type,
                    'pre-action': action.pre_action,
                    'public-action': action.public_action,
                    'next-action': action.next_action
                };

                // 各構図のquality/tagを追加
                action.compositions.forEach(comp => {
                    row[comp.name + ' quality'] = comp.quality === '未評価' ? '' : comp.quality;
                    row[comp.name + ' tag'] = comp.tag || '';
                });

                return row;
            });

            // GASに送信（共通関数を使用）
            const result = await saveGasData(baseUrl, 'action', gasData);

            if (result.status === 'success') {
                showStatusWithDetail('GASに保存しました: ' + result.message);
            } else {
                throw new Error(result.message || '保存に失敗しました');
            }
        } catch (error) {
            console.error(error);
            showStatusWithDetail('保存エラー: ' + error.message, 'error');
        }
    }

    // HTMLエスケープ
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // クリックでクリップボードにコピー
    function copyToClipboard(element) {
        const text = element.textContent;
        navigator.clipboard.writeText(text).then(() => {
            element.classList.add('copied');
            setTimeout(() => element.classList.remove('copied'), 1000);
        });
    }

    // プロンプト翻訳（日→英）
    async function translatePrompt() {
        const input = document.getElementById('translate-input').value.trim();
        const output = document.getElementById('translate-output');

        if (!input) {
            output.innerHTML = '';
            return;
        }

        const apiKey = document.getElementById('openrouterApiKey').value.trim();
        if (!apiKey) {
            output.innerHTML = '<div class="translate-error">OpenRouter API Keyを設定してください</div>';
            return;
        }

        // 設定を保存
        localStorage.setItem(STORAGE_KEYS.OPENROUTER_API_KEY, apiKey);

        output.innerHTML = '';
        output.classList.add('loading');

        try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'x-ai/grok-4.1-fast',
                    messages: [
                        {
                            role: 'system',
                            content: `You are an expert at creating English prompts for AI image generation (Stable Diffusion, etc.).
Given a Japanese description, provide:
1. A direct translation as comma-separated English tags
2. Two alternative prompt suggestions with different styles or approaches

Output in this exact JSON format:
{
  "translation": "direct translation tags here",
  "alternatives": [
    "alternative prompt 1",
    "alternative prompt 2"
  ]
}
Output ONLY the JSON, no explanations.`
                        },
                        {
                            role: 'user',
                            content: input
                        }
                    ]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || response.statusText);
            }

            const data = await response.json();
            const result = data.choices?.[0]?.message?.content || '';

            output.classList.remove('loading');

            // JSONをパース
            try {
                const parsed = JSON.parse(result);
                let html = '';

                // 翻訳結果
                html += '<div class="translate-item">';
                html += '<div class="translate-label">翻訳:</div>';
                html += `<div class="translate-text" onclick="copyToClipboard(this)">${escapeHtml(parsed.translation || '')}</div>`;
                html += '</div>';

                // 代替案
                if (parsed.alternatives && parsed.alternatives.length > 0) {
                    parsed.alternatives.forEach((alt, i) => {
                        html += '<div class="translate-item">';
                        html += `<div class="translate-label">候補${i + 1}:</div>`;
                        html += `<div class="translate-text" onclick="copyToClipboard(this)">${escapeHtml(alt)}</div>`;
                        html += '</div>';
                    });
                }

                output.innerHTML = html;
            } catch (e) {
                // JSONパースに失敗した場合はそのまま表示
                output.innerHTML = `<div class="translate-item"><div class="translate-text" onclick="copyToClipboard(this)">${escapeHtml(result)}</div></div>`;
            }
        } catch (error) {
            output.classList.remove('loading');
            output.innerHTML = '<div class="translate-error">エラー: ' + escapeHtml(error.message) + '</div>';
        }
    }
</script>

</body>
</html>
