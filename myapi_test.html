<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS API Test Client (Read/Write)</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f4f4f9; color: #333; }
        h1 { color: #444; }
        h2 { font-size: 1.2rem; margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 15px; }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 14px; box-sizing: border-box; resize: vertical; }
        
        .btn { padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        .btn-get { background-color: #007bff; }
        .btn-get:hover { background-color: #0056b3; }
        .btn-post { background-color: #28a745; }
        .btn-post:hover { background-color: #218838; }
        
        #status { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
        .status-ok { background-color: #d4edda; color: #155724; display: block !important; }
        .status-err { background-color: #f8d7da; color: #721c24; display: block !important; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
        th { background-color: #f8f9fa; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>

<div class="container">
    <h1>GAS API èª­ã¿æ›¸ããƒ†ã‚¹ãƒˆ</h1>

    <div class="card">
        <label>GAS ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã® URL:</label>
        <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
    </div>

    <div class="card">
        <h2>ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ (GET)</h2>
        <button class="btn btn-get" onclick="loadData()">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º</button>
        <div id="table-container"></div>
    </div>

    <div class="card">
        <h2>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ (POST)</h2>
        <p style="font-size:0.9rem; color:#666;">â€» ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä»¥ä¸‹ã®JSONã§<b>å…¨ä»¶æ›¸ãæ›ãˆ</b>ã¾ã™ã€‚å®‰å…¨è£…ç½®ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿æ•°ãŒæ¸›ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚</p>
        <textarea id="jsonInput">
[
  {
    "action name": "Running",
    "prompt": "running fast, dynamic pose",
    "pov tag": "side view"
  },
  {
    "action name": "Jumping",
    "prompt": "jumping high in the sky",
    "pov tag": "low angle"
  }
]
        </textarea>
        <br><br>
        <button class="btn btn-post" onclick="sendData()">JSON ã‚’é€ä¿¡ã—ã¦æ›¸ãæ›ãˆã‚‹</button>
    </div>

    <div id="status"></div>
</div>

<script>
    const API_URL_KEY = 'gas_api_url';

    // åˆæœŸåŒ–: ä¿å­˜ã•ã‚ŒãŸURLã‚’å¾©å…ƒ
    document.addEventListener('DOMContentLoaded', () => {
        const savedUrl = localStorage.getItem(API_URL_KEY);
        if (savedUrl) {
            document.getElementById('apiUrl').value = savedUrl;
        }
    });

    // URLä¿å­˜
    function saveApiUrl() {
        const url = document.getElementById('apiUrl').value.trim();
        if (url) {
            localStorage.setItem(API_URL_KEY, url);
        }
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showStatus(msg, isError = false) {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = isError ? 'status-err' : 'status-ok';
    }

    // GET: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadData() {
        const url = document.getElementById('apiUrl').value.trim();
        const container = document.getElementById('table-container');
        
        if (!url) { alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

        saveApiUrl();
        showStatus('èª­ã¿è¾¼ã¿ä¸­...');
        container.innerHTML = '';

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            showStatus(`å–å¾—æˆåŠŸ: ${data.length} ä»¶`);
            renderTable(data);
            
            // èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ç”¨ã‚¨ãƒªã‚¢ã«ã‚‚åæ˜ ï¼ˆç·¨é›†ã—ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
            if(data.length > 0) {
                document.getElementById('jsonInput').value = JSON.stringify(data, null, 2);
            }

        } catch (error) {
            console.error(error);
            showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        }
    }

    // POST: ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿
    async function sendData() {
        const url = document.getElementById('apiUrl').value.trim();
        const jsonStr = document.getElementById('jsonInput').value;

        if (!url) { alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

        saveApiUrl();

        try {
            // JSONã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
            const jsonData = JSON.parse(jsonStr);
            
            showStatus('é€ä¿¡ä¸­... (æ•°ç§’ã‹ã‹ã‚Šã¾ã™)');

            // é‡è¦: GASã¸ã®POSTã¯ CORS ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ Content-Type: text/plain ã§é€ã‚‹ã®ãŒå®šçŸ³ã§ã™
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    "Content-Type": "text/plain;charset=utf-8" 
                },
                body: JSON.stringify(jsonData)
            });

            const result = await response.json();

            if (result.status === 'success') {
                showStatus('æ›¸ãè¾¼ã¿æˆåŠŸï¼ ' + result.message);
                // æˆåŠŸã—ãŸã‚‰è¡¨ç¤ºã‚’æ›´æ–°
                loadData();
            } else {
                showStatus('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + result.message, true);
            }

        } catch (error) {
            console.error(error);
            showStatus('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        }
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–¢æ•°
    function renderTable(data) {
        const container = document.getElementById('table-container');
        if (!data || data.length === 0) {
            container.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');
        
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(key => {
                const td = document.createElement('td');
                td.textContent = row[key] !== undefined ? row[key] : '';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        container.appendChild(table);
    }
</script>

</body>
</html>