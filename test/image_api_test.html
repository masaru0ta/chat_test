<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS Upload & Delete Test</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; background-color: #f4f4f9; }
        .container { background: white; border: 1px solid #ddd; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #333; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Old IDç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç›®ç«‹ãŸã›ã‚‹ */
        #oldFileId { background-color: #fff0f0; border-color: #ffcccc; }

        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #status { margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 4px; white-space: pre-wrap; word-break: break-all; border-left: 5px solid #ccc; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è‰²åˆ†ã‘ */
        .status-success { border-left-color: #28a745 !important; background-color: #d4edda !important; color: #155724; }
        .status-error { border-left-color: #dc3545 !important; background-color: #f8d7da !important; color: #721c24; }

        #preview-area { margin-top: 20px; text-align: center; min-height: 150px; display: flex; align-items: center; justify-content: center; background: #fafafa; border: 2px dashed #ddd; border-radius: 8px; }
        #uploaded-image { max-width: 100%; max-height: 400px; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ”„ ä¸Šæ›¸ãå‰Šé™¤ãƒ†ã‚¹ãƒˆ</h2>
        
        <div class="form-group">
            <label for="apiUrl">GAS Web App URL:</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
        </div>
        
        <div class="form-group">
            <label for="oldFileId">å‰Šé™¤ã™ã‚‹ Old File ID (ä»»æ„):</label>
            <input type="text" id="oldFileId" placeholder="åˆå›ã¯ç©ºæ¬„ã§OK (æ¬¡å›ã‹ã‚‰è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™)">
            <small style="color: #666;">â€»ã“ã“ã«IDãŒå…¥ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ãã®IDã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</small>
        </div>

        <div class="form-group">
            <label for="fileInput">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ:</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <button id="uploadBtn" onclick="uploadImage()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ</button>

        <div id="status">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        
        <div id="preview-area">
            <span id="placeholder-text">ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
            <img id="uploaded-image" src="" alt="Uploaded Image">
        </div>
    </div>

    <script>
        async function uploadImage() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const oldFileIdInput = document.getElementById('oldFileId');
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('status');
            const uploadBtn = document.getElementById('uploadBtn');
            const imgPreview = document.getElementById('uploaded-image');
            const placeholder = document.getElementById('placeholder-text');

            // ãƒªã‚»ãƒƒãƒˆ
            statusDiv.textContent = "å‡¦ç†ä¸­...";
            statusDiv.className = "";
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!apiUrl) { alert("GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            if (fileInput.files.length === 0) { alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

            const file = fileInput.files[0];
            const oldFileId = oldFileIdInput.value.trim();

            uploadBtn.disabled = true;

            try {
                // Base64å¤‰æ›
                const base64String = await toBase64(file);
                const rawBase64 = base64String.split(',')[1];

                // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½œæˆ (oldFileIdã‚’å«ã‚ã‚‹)
                const payload = {
                    filename: file.name,
                    mimeType: file.type,
                    image: rawBase64,
                    oldFileId: oldFileId // ç©ºæ–‡å­—ãªã‚‰ç„¡è¦–ã•ã‚Œã‚‹
                };

                // é€ä¿¡
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();

                if (result.status === 'success') {
                    // æˆåŠŸæ™‚ã®å‡¦ç†
                    statusDiv.className = "status-success";
                    let msg = `âœ… **æˆåŠŸ**\n${result.message}\n\n[New File ID]: ${result.data.fileId}`;
                    
                    // æ¬¡å›ç”¨ã«Old IDæ¬„ã‚’è‡ªå‹•æ›´æ–°
                    oldFileIdInput.value = result.data.fileId;
                    msg += `\n\nğŸ‘‰ æ¬¡ã®ãƒ†ã‚¹ãƒˆç”¨ã«ã€ŒOld File IDã€æ¬„ã‚’ã“ã®IDã§æ›´æ–°ã—ã¾ã—ãŸã€‚`;
                    
                    statusDiv.innerHTML = msg.replace(/\n/g, '<br>');

                    // ç”»åƒè¡¨ç¤º
                    imgPreview.src = result.data.directUrl;
                    imgPreview.style.display = 'block';
                    placeholder.style.display = 'none';
                    
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error(error);
                statusDiv.className = "status-error";
                statusDiv.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n" + error.message;
            } finally {
                uploadBtn.disabled = false;
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>