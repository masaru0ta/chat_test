<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>キャラクター設定</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        /* ページ固有スタイル - キャラクターグリッド（8列） */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
        }

        .character-series {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .character-profile {
            font-size: 0.65rem;
            color: #aaa;
            line-height: 1.3;
            max-height: 40px;
            overflow-y: auto;
        }

        /* 全身画像セクション */
        .fullbody-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #333;
        }

        .fullbody-title {
            color: #4a9eff;
            margin: 0 0 15px 0;
            font-size: 1.2rem;
        }

        .fullbody-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .fullbody-settings label {
            color: #888;
            font-size: 0.9rem;
        }

        .fullbody-select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #333;
            background: #222;
            color: #e0e0e0;
            font-size: 0.9rem;
            min-width: 200px;
        }

        .fullbody-select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .fullbody-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .fullbody-item {
            text-align: center;
        }

        .fullbody-label {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .fullbody-image {
            width: 100%;
            aspect-ratio: 832 / 1216;
            background: #111;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .fullbody-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
        }

        .fullbody-image .placeholder {
            color: #666;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>キャラクター設定</h1>

    <!-- キャラクターグリッド -->
    <div id="character-grid" class="character-grid">
        <div class="empty-message">「GASから読み込み」ボタンでキャラクターデータを読み込んでください</div>
    </div>

    <!-- 設定バー -->
    <div class="settings-bar" style="margin-top: 20px;">
        <div class="settings-row">
            <label>GAS URL:</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
            <button class="btn btn-primary" onclick="loadAllFromGas()">GASから読み込み</button>
            <button class="btn btn-save" onclick="saveImagesToGas()">GASに保存</button>
            <button class="btn btn-generate" onclick="generateAllImages()" id="generateAllBtn">全キャラ画像生成</button>
        </div>
        <div class="settings-row">
            <label>Runware API Key:</label>
            <input type="password" id="apiKey" placeholder="Runware API Keyを入力">
        </div>
        <div class="settings-row">
            <label>画像アップロードGAS URL:</label>
            <input type="text" id="imageUploadUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec (画像保存用)">
        </div>
        <div id="status"></div>
    </div>
</div>

<!-- キャラクター詳細ページ -->
<div id="detail-page" class="detail-page">
    <div class="detail-header">
        <button class="detail-back" onclick="closeDetailPage()">← 戻る</button>
        <h1 class="detail-title" id="detail-title"></h1>
        <div class="detail-nav">
            <button class="btn btn-nav" onclick="navigateCharacter(-1)" id="btn-prev">← 前</button>
            <button class="btn btn-nav" onclick="navigateCharacter(1)" id="btn-next">次 →</button>
        </div>
    </div>
    <div class="detail-content">
        <div class="detail-main">
            <div class="detail-image-section">
                <div class="detail-image-area" id="detail-image"></div>
                <button class="btn btn-generate" onclick="generateDetailImage()">画像生成</button>
            </div>
            <div class="detail-info">
                <div class="field-label">シリーズ</div>
                <input type="text" class="field-input" id="detail-series" onchange="updateCharacterField('series', this.value)">
                <div class="field-label">キャラタグ</div>
                <input type="text" class="field-input" id="detail-tag" onchange="updateCharacterField('tag', this.value)">
                <div class="field-label">プロフィール</div>
                <textarea class="field-textarea" id="detail-profile" onchange="updateCharacterField('profile', this.value)"></textarea>
                <div class="field-label">ユニフォーム1</div>
                <input type="text" class="field-input" id="detail-uniform1" onchange="updateCharacterField('uniform1', this.value)">
                <div class="field-label">ユニフォーム2</div>
                <input type="text" class="field-input" id="detail-uniform2" onchange="updateCharacterField('uniform2', this.value)">
                <div class="field-label">Additional Tag</div>
                <input type="text" class="field-input" id="detail-additionalTag" onchange="updateCharacterField('additionalTag', this.value)">
            </div>
        </div>
        <!-- 全身画像エリア -->
        <div class="fullbody-section">
            <h3 class="fullbody-title">全身画像</h3>
            <div class="fullbody-settings">
                <label>場所:</label>
                <select id="fullbody-place" class="fullbody-select"></select>
            </div>
            <div class="fullbody-grid">
                <div class="fullbody-item">
                    <div class="fullbody-label">通常</div>
                    <div class="fullbody-image" id="fullbody-normal"></div>
                    <button class="btn btn-generate btn-small" onclick="generateFullbodyImage('normal')">生成</button>
                </div>
                <div class="fullbody-item">
                    <div class="fullbody-label">ユニフォーム1</div>
                    <div class="fullbody-image" id="fullbody-uniform1"></div>
                    <button class="btn btn-generate btn-small" onclick="generateFullbodyImage('uniform1')">生成</button>
                </div>
                <div class="fullbody-item">
                    <div class="fullbody-label">ユニフォーム2</div>
                    <div class="fullbody-image" id="fullbody-uniform2"></div>
                    <button class="btn btn-generate btn-small" onclick="generateFullbodyImage('uniform2')">生成</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script>
    const GAS_DATA_KEY = 'gas_data_cache';
    const CHAR_IMAGES_KEY = 'character_images';
    const FULLBODY_IMAGES_KEY = 'fullbody_images';

    // データストア
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let characterImages = {};
    let originalGasImages = {};
    let fullbodyImages = {};
    let currentDetailIndex = -1;

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
        const settings = loadSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY);
        if (settings.gasUrl) document.getElementById('apiUrl').value = settings.gasUrl;
        if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
        const savedImageUploadUrl = localStorage.getItem(STORAGE_KEYS.IMAGE_UPLOAD_URL);
        if (savedImageUploadUrl) document.getElementById('imageUploadUrl').value = savedImageUploadUrl;
        loadCachedData();
    });

    // キーボード操作（詳細ページで左右キーでナビゲート）
    document.addEventListener('keydown', (e) => {
        if (currentDetailIndex < 0) return;
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (e.key === 'ArrowLeft') navigateCharacter(-1);
        if (e.key === 'ArrowRight') navigateCharacter(1);
    });

    function saveCachedData() {
        const data = { models, characters, places, actions };
        localStorage.setItem(GAS_DATA_KEY, JSON.stringify(data));
        localStorage.setItem(CHAR_IMAGES_KEY, JSON.stringify(characterImages));
        localStorage.setItem(FULLBODY_IMAGES_KEY, JSON.stringify(fullbodyImages));
    }

    function loadCachedData() {
        try {
            const cachedData = localStorage.getItem(GAS_DATA_KEY);
            if (cachedData) {
                const data = JSON.parse(cachedData);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
            }
            const cachedImages = localStorage.getItem(CHAR_IMAGES_KEY);
            if (cachedImages) characterImages = JSON.parse(cachedImages);
            const cachedFullbody = localStorage.getItem(FULLBODY_IMAGES_KEY);
            if (cachedFullbody) fullbodyImages = JSON.parse(cachedFullbody);

            if (characters.length > 0) {
                renderCharacterGrid();
                showStatus(`キャッシュから復元: モデル${Object.keys(models).length}件, キャラ${characters.length}件`);
            }
        } catch (error) {
            console.error('キャッシュ復元エラー:', error);
        }
    }

    function doSaveSettings() {
        const gasUrl = document.getElementById('apiUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const imageUploadUrl = document.getElementById('imageUploadUrl').value.trim();
        saveSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY, gasUrl, apiKey);
        if (imageUploadUrl) localStorage.setItem(STORAGE_KEYS.IMAGE_UPLOAD_URL, imageUploadUrl);
    }

    async function loadAllFromGas() {
        const baseUrl = document.getElementById('apiUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        doSaveSettings();
        showStatus('読み込み中...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action')
            ]);

            models = parseModels(modelData);
            places = parsePlaces(placeData);
            actions = parseActionsWithCompositions(actionData);

            // キャラクター設定（画像URL処理があるため個別）
            originalGasImages = {};
            characters = characterData.map(item => {
                const char = parseCharacters([item])[0];
                if (item.image) {
                    characterImages[char.name] = item.image;
                    if (isGoogleDriveUrl(item.image)) {
                        originalGasImages[char.name] = item.image;
                    }
                }
                return char;
            });

            saveCachedData();
            renderCharacterGrid();
            showStatus(`読み込み完了: モデル${Object.keys(models).length}件, キャラ${characters.length}件, 場所${places.length}件, アクション${actions.length}件`);
        } catch (error) {
            console.error(error);
            showStatus('読み込みエラー: ' + error.message, 'error');
        }
    }

    // RunwareのURLかどうかを判定
    function isRunwareUrl(url) {
        return url && (url.includes('runware.ai') || url.includes('im.runware'));
    }

    // GoogleドライブのURLかどうかを判定
    function isGoogleDriveUrl(url) {
        return url && (url.includes('drive.google.com') || url.includes('lh3.googleusercontent.com'));
    }

    // GoogleドライブURLからfileIdを抽出
    function extractGoogleDriveFileId(url) {
        if (!url) return null;
        // drive.google.com/uc?id=XXXX 形式
        let match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match) return match[1];
        // drive.google.com/file/d/XXXX/ 形式
        match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (match) return match[1];
        return null;
    }

    // 画像URLをBase64に変換
    async function imageUrlToBase64(url) {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // GASに画像をアップロードして永続URLを取得
    async function uploadImageToGas(baseUrl, base64Data, filename, oldFileId = null) {
        const payload = {
            filename: filename,
            mimeType: 'image/png',
            image: base64Data
        };

        // 古いファイルIDがあれば追加（削除用）
        if (oldFileId) {
            payload.oldFileId = oldFileId;
        }

        const response = await fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.status === 'success' && result.data && result.data.directUrl) {
            return result.data.directUrl;
        }
        throw new Error(result.message || '画像アップロード失敗');
    }

    // GASにキャラクター画像URLを保存
    async function saveImagesToGas() {
        const baseUrl = document.getElementById('apiUrl').value.trim();
        const imageUploadUrl = document.getElementById('imageUploadUrl').value.trim();

        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }
        if (characters.length === 0) {
            alert('保存するキャラクターがありません');
            return;
        }

        const runwareCount = characters.filter(char => isRunwareUrl(characterImages[char.name])).length;
        if (runwareCount > 0 && !imageUploadUrl) {
            alert('Runware画像をアップロードするには「画像アップロードGAS URL」を入力してください');
            return;
        }

        let confirmMsg = `${characters.length} 件のキャラクターをGASに保存しますか？`;
        if (runwareCount > 0) {
            confirmMsg += `\n\n※ ${runwareCount} 件のRunware画像をGASにアップロードします（時間がかかります）`;
        }
        if (!confirm(confirmMsg)) return;

        doSaveSettings();
        showStatus('保存中...', 'loading');

        try {
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const imageUrl = characterImages[char.name];

                if (isRunwareUrl(imageUrl)) {
                    showStatus(`画像アップロード中: ${i + 1}/${characters.length} (${char.name})`, 'loading');
                    try {
                        const base64Data = await imageUrlToBase64(imageUrl);
                        const safeTag = (char.tag || char.name).replace(/[\/\\:*?"<>|,\s]+/g, '_').replace(/^_+|_+$/g, '');
                        const filename = `${safeTag || 'character'}.png`;
                        const oldImageUrl = originalGasImages[char.name];
                        const oldFileId = oldImageUrl ? extractGoogleDriveFileId(oldImageUrl) : null;

                        const gasUrl = await uploadImageToGas(imageUploadUrl, base64Data, filename, oldFileId);
                        characterImages[char.name] = gasUrl;
                        originalGasImages[char.name] = gasUrl;
                        saveCachedData();

                        const imageDiv = document.getElementById(`image-${i}`);
                        if (imageDiv) {
                            imageDiv.innerHTML = `<img src="${gasUrl}" alt="${char.name}" onclick="openDetailPage(${i})">`;
                        }
                    } catch (error) {
                        console.error(`${char.name}の画像アップロード失敗:`, error);
                    }
                }
            }

            const dataToSave = characters.map(char => ({
                name: char.name,
                series: char.series,
                tag: char.tag,
                profile: char.profile,
                uniform1: char.uniform1 || '',
                uniform2: char.uniform2 || '',
                'additional tag': char.additionalTag || '',
                image: characterImages[char.name] || ''
            }));

            showStatus('キャラクターデータ保存中...', 'loading');
            const result = await saveGasData(baseUrl, 'character', dataToSave);

            if (result.status === 'success') {
                showStatus('保存成功: ' + result.message);
            } else {
                showStatus('サーバーエラー: ' + result.message, 'error');
            }
        } catch (error) {
            console.error(error);
            showStatus('保存エラー: ' + error.message, 'error');
        }
    }

    function renderCharacterGrid() {
        const container = document.getElementById('character-grid');

        if (characters.length === 0) {
            container.innerHTML = '<div class="empty-message">キャラクターデータがありません</div>';
            return;
        }

        container.innerHTML = characters.map((char, index) => `
            <div class="card" id="card-${index}">
                <div class="card-image" id="image-${index}">
                    ${characterImages[char.name]
                        ? `<img src="${characterImages[char.name]}" alt="${char.name}" onclick="openDetailPage(${index})">`
                        : `<div class="placeholder" onclick="openDetailPage(${index})" style="cursor:pointer;">画像未生成</div>`
                    }
                </div>
                <div class="card-info">
                    <div class="card-name">${char.name || '(名前未設定)'}</div>
                    <div class="character-series">${char.series || ''}</div>
                    <div class="character-profile">${char.profile || ''}</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-generate btn-small" onclick="generateSingleImage(${index})">画像生成</button>
                </div>
            </div>
        `).join('');
    }

    function getFirstModel() {
        return Object.keys(models)[0] || null;
    }

    function validateGenerateSettings() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return null;
        }
        const modelId = getFirstModel();
        if (!modelId) {
            alert('モデルが見つかりません。GASから読み込んでください。');
            return null;
        }
        doSaveSettings();
        return { apiKey, modelId };
    }

    function getFrontViewTag(action) {
        if (!action || !action.compositions) return 'front view';
        const frontView = action.compositions.find(c => c.name === 'front view');
        return frontView?.tag || frontView?.name || 'front view';
    }

    function buildCharacterPrompt(charIndex) {
        const char = characters[charIndex];
        if (!char) return '';

        const model = models[getFirstModel()] || {};
        const place = places[0] || {};
        const action = actions[0] || {};
        const compositionTag = getFrontViewTag(action);

        return [
            model.qualityPositive || '',
            char.tag || '',
            place.tag || '',
            action.prompt || '',
            compositionTag,
            char.uniform1 || '',
            place.additionalTag || '',
            char.additionalTag || ''
        ].filter(p => p).join(', ');
    }

    async function generateSingleImage(charIndex) {
        const settings = validateGenerateSettings();
        if (!settings) return;

        const char = characters[charIndex];
        const imageDiv = document.getElementById(`image-${charIndex}`);
        imageDiv.innerHTML = '<div class="generating">生成中...</div>';

        try {
            const imageUrl = await doGenerateImage(settings.modelId, settings.apiKey, buildCharacterPrompt(charIndex), 1024, 1024);
            characterImages[char.name] = imageUrl;
            saveCachedData();
            imageDiv.innerHTML = `<img src="${imageUrl}" alt="${char.name}" onclick="openDetailPage(${charIndex})">`;
        } catch (error) {
            console.error(error);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        }
    }

    async function generateAllImages() {
        const settings = validateGenerateSettings();
        if (!settings) return;

        if (characters.length === 0) {
            alert('キャラクターがありません');
            return;
        }

        const btn = document.getElementById('generateAllBtn');
        btn.disabled = true;
        showStatus(`画像生成中: 0/${characters.length}`, 'loading');

        for (let i = 0; i < characters.length; i++) {
            const char = characters[i];
            const imageDiv = document.getElementById(`image-${i}`);
            imageDiv.innerHTML = '<div class="generating">生成中...</div>';

            try {
                const imageUrl = await doGenerateImage(settings.modelId, settings.apiKey, buildCharacterPrompt(i), 1024, 1024);
                characterImages[char.name] = imageUrl;
                saveCachedData();
                imageDiv.innerHTML = `<img src="${imageUrl}" alt="${char.name}" onclick="openDetailPage(${i})">`;
                showStatus(`画像生成中: ${i + 1}/${characters.length}`, 'loading');
            } catch (error) {
                console.error(error);
                imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー</div>`;
            }

            if (i < characters.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        btn.disabled = false;
        showStatus(`画像生成完了: ${characters.length}件`);
    }

    function openDetailPage(index) {
        if (!characters[index]) return;

        currentDetailIndex = index;
        updateDetailPage();

        // 詳細ページを表示
        document.getElementById('detail-page').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function updateDetailPage() {
        const char = characters[currentDetailIndex];
        if (!char) return;

        // データを設定
        document.getElementById('detail-title').textContent = char.name || '(名前未設定)';
        document.getElementById('detail-series').value = char.series || '';
        document.getElementById('detail-tag').value = char.tag || '';
        document.getElementById('detail-profile').value = char.profile || '';
        document.getElementById('detail-uniform1').value = char.uniform1 || '';
        document.getElementById('detail-uniform2').value = char.uniform2 || '';
        document.getElementById('detail-additionalTag').value = char.additionalTag || '';

        // 画像を設定
        const imageDiv = document.getElementById('detail-image');
        const imageUrl = characterImages[char.name];
        if (imageUrl) {
            imageDiv.innerHTML = `<img src="${imageUrl}" alt="${char.name}" onclick="window.open('${imageUrl}', '_blank')">`;
        } else {
            imageDiv.innerHTML = '<div class="placeholder">画像未生成</div>';
        }

        // 全身画像を設定
        const charFullbody = fullbodyImages[char.name] || {};
        updateFullbodyImage('normal', charFullbody.normal);
        updateFullbodyImage('uniform1', charFullbody.uniform1);
        updateFullbodyImage('uniform2', charFullbody.uniform2);

        // 場所プルダウンを更新
        updatePlaceSelect();

        // ナビゲーションボタンの状態を更新
        document.getElementById('btn-prev').disabled = currentDetailIndex <= 0;
        document.getElementById('btn-next').disabled = currentDetailIndex >= characters.length - 1;
    }

    function updateFullbodyImage(type, url) {
        const div = document.getElementById(`fullbody-${type}`);
        if (url) {
            div.innerHTML = `<img src="${url}" alt="${type}" onclick="window.open('${url}', '_blank')">`;
        } else {
            div.innerHTML = '<div class="placeholder">未生成</div>';
        }
    }

    function updatePlaceSelect() {
        const select = document.getElementById('fullbody-place');
        const currentValue = select.value;

        select.innerHTML = places.map((place, index) =>
            `<option value="${index}">${place.name || '(名前なし)'}</option>`
        ).join('');

        // 以前の選択を維持
        if (currentValue && parseInt(currentValue) < places.length) {
            select.value = currentValue;
        }
    }

    function closeDetailPage() {
        document.getElementById('detail-page').classList.remove('active');
        document.body.style.overflow = '';
        currentDetailIndex = -1;
    }

    // キャラクターフィールドを更新
    function updateCharacterField(field, value) {
        if (currentDetailIndex < 0) return;

        const char = characters[currentDetailIndex];
        if (!char) return;

        char[field] = value;
        saveCachedData();

        // カードのグリッド表示も更新（シリーズやプロフィールが変わった場合）
        renderCharacterGrid();
    }

    function navigateCharacter(direction) {
        const newIndex = currentDetailIndex + direction;
        if (newIndex >= 0 && newIndex < characters.length) {
            currentDetailIndex = newIndex;
            updateDetailPage();
        }
    }

    async function generateDetailImage() {
        if (currentDetailIndex < 0) return;

        const settings = validateGenerateSettings();
        if (!settings) return;

        const char = characters[currentDetailIndex];
        const detailImageDiv = document.getElementById('detail-image');
        const cardImageDiv = document.getElementById(`image-${currentDetailIndex}`);

        detailImageDiv.innerHTML = '<div class="placeholder">生成中...</div>';

        try {
            const imageUrl = await doGenerateImage(settings.modelId, settings.apiKey, buildCharacterPrompt(currentDetailIndex), 1024, 1024);
            characterImages[char.name] = imageUrl;
            saveCachedData();

            // 詳細ページ画像を更新
            detailImageDiv.innerHTML = `<img src="${imageUrl}" alt="${char.name}" onclick="window.open('${imageUrl}', '_blank')">`;

            // カード画像も更新
            cardImageDiv.innerHTML = `<img src="${imageUrl}" alt="${char.name}" onclick="openDetailPage(${currentDetailIndex})">`;
        } catch (error) {
            console.error(error);
            detailImageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        }
    }

    // 全身画像生成
    async function generateFullbodyImage(type) {
        if (currentDetailIndex < 0) return;

        const settings = validateGenerateSettings();
        if (!settings) return;

        if (actions.length < 2) {
            alert('アクションデータが不足しています（2番目のアクションが必要）');
            return;
        }

        if (places.length < 1) {
            alert('場所データが不足しています');
            return;
        }

        const char = characters[currentDetailIndex];
        const imageDiv = document.getElementById(`fullbody-${type}`);
        imageDiv.innerHTML = '<div class="placeholder">生成中...</div>';

        try {
            const prompt = buildFullbodyPrompt(currentDetailIndex, type);
            const imageUrl = await doGenerateImage(settings.modelId, settings.apiKey, prompt, 832, 1216);

            // 保存
            if (!fullbodyImages[char.name]) {
                fullbodyImages[char.name] = {};
            }
            fullbodyImages[char.name][type] = imageUrl;
            saveCachedData();

            // 表示更新
            imageDiv.innerHTML = `<img src="${imageUrl}" alt="${type}" onclick="window.open('${imageUrl}', '_blank')">`;
        } catch (error) {
            console.error(error);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー</div>`;
        }
    }

    // 全身画像用プロンプト生成
    function buildFullbodyPrompt(charIndex, type) {
        const char = characters[charIndex];
        const modelId = getFirstModel();
        const model = models[modelId] || {};

        // アクションリストの2番目、選択された場所
        const action = actions[1] || {};
        const placeIndex = parseInt(document.getElementById('fullbody-place').value) || 0;
        const place = places[placeIndex] || {};

        const outfitTag = (type !== 'normal' && char[type]) || '';

        const parts = [
            model.qualityPositive || '',
            char.tag || '',
            outfitTag,
            place.tag || '',
            action.prompt || '',
            'full body',
            place.additionalTag || '',
            char.additionalTag || ''  // キャラクターのadditional tag
        ].filter(p => p);

        return parts.join(', ');
    }

    // 画像生成ヘルパー
    async function doGenerateImage(modelId, apiKey, prompt, width, height) {
        const model = models[modelId];
        const result = await generateImage(apiKey, modelId, prompt, {
            negativePrompt: model?.qualityNegative || '',
            steps: model?.steps || 20,
            cfgScale: model?.cfgScale || 7,
            scheduler: model?.scheduler || 'Default',
            width,
            height
        });
        return result.imageURL;
    }
</script>

</body>
</html>
