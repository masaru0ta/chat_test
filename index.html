<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grok Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #eee;
            height: 100%;
            height: 100dvh;
            display: flex;
            overflow: hidden;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar {
            width: 240px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s;
        }

        #sidebar.collapsed {
            width: 0;
            border-right: none;
            overflow: hidden;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
        body:has(#sidebar:not(.collapsed)) #header-menu-toggle {
            display: none;
        }

        #sidebar-header {
            padding: 0.75rem;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        #sidebar-toggle {
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            flex-shrink: 0;
        }

        #sidebar-toggle:hover {
            color: #2d5a7b;
        }

        #sidebar-header h2 {
            font-size: 1.2rem;
            color: #2d5a7b;
            white-space: nowrap;
            overflow: hidden;
        }

        #sidebar.collapsed #sidebar-header h2 {
            display: none;
        }

        #sidebar-header #mobile-project {
            display: none;
            font-size: 0.9rem;
            color: #2d5a7b;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ç”»åƒãƒˆã‚°ãƒ«ã‚’éè¡¨ç¤º */
        #sidebar-image-toggle {
            display: none;
        }

        #sidebar-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .menu-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s;
            border: none;
            background: transparent;
            color: #aaa;
            font-size: 0.95rem;
            text-align: left;
            width: 100%;
            flex-shrink: 0;
        }

        .menu-item:hover {
            background: #111;
            color: #eee;
        }

        .menu-item.active {
            background: #111;
            color: #2d5a7b;
            border-left: 3px solid #2d5a7b;
        }

        .menu-item-icon {
            font-size: 1.1rem;
            width: 1.5rem;
            text-align: center;
            flex-shrink: 0;
        }

        .menu-item-text {
            white-space: nowrap;
            overflow: hidden;
        }

        #sidebar.collapsed .menu-item-text {
            display: none;
        }

        #sidebar.collapsed .panel-list {
            display: none !important;
        }

        .menu-spacer {
            flex: 1;
        }

        .menu-item.settings {
            border-top: 1px solid #333;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼çµ±è¨ˆ */
        #sidebar-stats {
            padding: 0.75rem 1rem;
            border-top: 1px solid #333;
            font-size: 0.8rem;
        }

        #sidebar.collapsed #sidebar-stats {
            display: none;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #888;
            text-decoration: none;
        }

        a.stat-label:hover {
            color: #2d5a7b;
        }

        .stat-value {
            color: #2d5a7b;
            font-weight: bold;
        }

        .stat-reset-btn {
            width: 100%;
            padding: 0.4rem;
            background: transparent;
            border: 1px solid #333;
            color: #888;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .stat-reset-btn:hover {
            border-color: #2d5a7b;
            color: #2d5a7b;
        }

        /* ãƒ‘ãƒãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .panel-list {
            flex: 1;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            border-top: 1px solid #333;
        }

        .panel-list.show {
            display: flex;
        }

        .panel-header {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ å…±é€š */
        .list-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            transition: background 0.2s;
            border: none;
            background: transparent;
            color: #888;
            font-size: 0.85rem;
            text-align: left;
            width: 100%;
            border-bottom: 1px solid #333;
        }

        .list-item:hover {
            background: #111;
            color: #eee;
        }

        .list-item.active {
            background: #111;
            color: #2d5a7b;
        }

        .list-item-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .list-item-btn {
            color: #888;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }

        .list-item-btn:hover {
            color: #2d5a7b;
        }

        .list-item-btn.delete {
            color: #2d5a7b;
        }

        .list-item-btn.delete:hover {
            background: #2d5a7b;
            color: white;
        }

        .list-item-images {
            font-size: 0.75rem;
            color: #2d5a7b;
            background: #1a2a3a;
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
            flex-shrink: 0;
        }

        .list-item.new-item {
            color: #2d5a7b;
            font-weight: 500;
        }

        .list-item.new-item:hover {
            color: #3d6a8b;
        }

        .list-item.delete-all-btn {
            color: #c0392b;
            font-size: 0.8rem;
            justify-content: center;
        }

        .list-item.delete-all-btn:hover {
            background: #c0392b;
            color: white;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 0.75rem;
            width: 80%;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: #2d5a7b;
            font-size: 1.1rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1.25rem;
        }

        .modal-close:hover {
            color: #2d5a7b;
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.flex-grow {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group.flex-grow textarea {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #aaa;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: #111;
            border: 1px solid #333;
            border-radius: 0.5rem;
            color: #eee;
            font-size: 0.95rem;
            outline: none;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #2d5a7b;
        }

        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: #111;
            border: 1px solid #333;
            border-radius: 0.5rem;
            color: #eee;
            font-size: 0.95rem;
            outline: none;
            cursor: pointer;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .modal-footer-left {
            display: flex;
        }

        .modal-footer-right {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2d5a7b;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #3d6a8b;
        }

        .btn-secondary {
            background: transparent;
            color: #aaa;
            border: 1px solid #333;
        }

        .btn-secondary:hover {
            color: #eee;
            border-color: #888;
        }

        .btn-danger {
            background: transparent;
            color: #2d5a7b;
            border: 1px solid #2d5a7b;
        }

        .btn-danger:hover {
            background: #2d5a7b;
            color: white;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        header {
            background: #1a1a1a;
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #current-project {
            font-size: 0.8rem;
            color: #2d5a7b;
        }

        #header-menu-toggle,
        #header-image-toggle {
            position: absolute;
            background: transparent;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            transition: color 0.2s;
        }

        #header-menu-toggle {
            left: 1rem;
        }

        #header-image-toggle {
            right: 1rem;
        }

        #header-menu-toggle:hover,
        #header-image-toggle:hover {
            color: #2d5a7b;
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .user {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
            background: #2d5a7b;
            color: white;
        }

        .assistant {
            width: 100%;
            padding: 0.5rem 0;
            color: #eee;
        }

        .system-msg {
            align-self: center;
            background: #333;
            color: #888;
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
        }

        .reasoning {
            font-size: 0.85rem;
            color: #888;
            background: #0d0d0d;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #2d5a7b;
        }

        .reasoning-toggle {
            cursor: pointer;
            color: #2d5a7b;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .reasoning-content {
            display: none;
        }

        .reasoning-content.show {
            display: block;
        }

        #input-container {
            padding: 1rem;
            background: #1a1a1a;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #333;
            border-radius: 1.5rem;
            background: #111;
            color: #eee;
            font-size: 1rem;
            outline: none;
        }

        #message-input:focus {
            border-color: #2d5a7b;
        }

        #send-btn {
            padding: 0.75rem 1.5rem;
            background: #2d5a7b;
            color: white;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        #send-btn:hover {
            background: #3d6a8b;
        }

        #generate-image-btn {
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
            color: #888;
            line-height: 1;
        }

        #generate-image-btn:hover {
            background: #333;
            color: #2d5a7b;
        }

        #generate-image-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #send-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            gap: 0.3rem;
            padding: 1rem;
        }

        .loading span {
            width: 8px;
            height: 8px;
            background: #2d5a7b;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .empty-message {
            color: #666;
            text-align: center;
            padding: 2rem 1rem;
            font-size: 0.9rem;
        }

        .clickable-word {
            text-decoration: underline;
            cursor: pointer;
        }

        .clickable-word:hover {
            opacity: 0.7;
        }

        .clickable-choice {
            cursor: pointer;
            color: #6b9dc4;
            font-weight: bold;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }

        .clickable-choice:hover {
            background: #333;
            color: #8bb8d8;
        }

        .character-settings {
            display: flex;
            gap: 1rem;
        }

        .character-group {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }

        .character-group-title {
            font-weight: bold;
            color: #aaa;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #333;
        }

        .character-row {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .character-row label {
            font-size: 0.8rem;
            color: #888;
        }

        .character-row label code {
            font-size: 0.7rem;
            color: #6b9dc4;
            background: #222;
            padding: 0.1rem 0.3rem;
            border-radius: 0.2rem;
        }

        .character-row input[type="text"] {
            width: 100%;
            padding: 0.4rem;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 0.25rem;
            color: #eee;
            font-size: 0.85rem;
        }

        .character-row input[type="color"] {
            width: 40px;
            height: 30px;
            padding: 0;
            border: 1px solid #333;
            border-radius: 0.25rem;
            cursor: pointer;
            background: transparent;
        }

        /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
        #resize-handle {
            width: 5px;
            background: #333;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        #resize-handle:hover {
            background: #2d5a7b;
        }

        #resize-handle.dragging {
            background: #2d5a7b;
        }

        body.resizing {
            cursor: col-resize;
            user-select: none;
        }

        body.resizing * {
            cursor: col-resize !important;
        }

        body.resizing #right-sidebar {
            transition: none;
        }

        /* ç”»åƒãƒ‘ãƒãƒ«ãŒé–‰ã˜ã¦ã„ã‚‹ã¨ãã¯ãƒãƒ³ãƒ‰ãƒ«ã‚’éè¡¨ç¤º */
        body:has(#right-sidebar.collapsed) #resize-handle {
            display: none;
        }

        /* å³å´ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆç”»åƒè¡¨ç¤ºç”¨ï¼‰ */
        #right-sidebar {
            width: 300px;
            background: #1a1a1a;
            border-left: none;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s;
        }

        #right-sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
        body:has(#right-sidebar:not(.collapsed)) #header-image-toggle {
            display: none;
        }

        #right-sidebar-header {
            padding: 0.75rem;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        #right-sidebar-toggle,
        #right-sidebar-menu-toggle {
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            flex-shrink: 0;
        }

        #right-sidebar-toggle:hover,
        #right-sidebar-menu-toggle:hover {
            color: #2d5a7b;
        }

        /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’éè¡¨ç¤º */
        #right-sidebar-menu-toggle,
        #right-sidebar-project {
            display: none;
        }

        #right-sidebar-header h2 {
            font-size: 1.2rem;
            color: #2d5a7b;
            white-space: nowrap;
            overflow: hidden;
        }

        #right-sidebar.collapsed #right-sidebar-header h2 {
            display: none;
        }

        #image-container {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        #right-sidebar.collapsed #image-container {
            display: none;
        }

        .image-wrapper {
            margin-bottom: 1rem;
        }

        .generated-image {
            width: 100%;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .generated-image:hover {
            opacity: 0.8;
        }

        /* ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            cursor: pointer;
            overflow-y: auto;
            padding: 1rem;
        }

        .image-modal.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .image-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 95%;
            cursor: default;
            margin: auto;
        }

        .image-modal-content img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .image-modal-controls {
            margin-top: 1rem;
            background: #1a1a1a;
            border-radius: 0.5rem;
            padding: 0.75rem;
            max-width: 600px;
            width: 100%;
            flex-shrink: 0;
        }

        .image-modal-prompt {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 0.75rem;
            max-height: 80px;
            overflow-y: auto;
            word-break: break-word;
            line-height: 1.4;
        }

        .image-modal-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .image-modal-btn {
            flex: 1;
            padding: 0.6rem 1rem;
            background: #333;
            border: none;
            color: #eee;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .image-modal-btn:hover {
            background: #2d5a7b;
        }

        .image-modal-btn.active {
            background: #2d5a7b;
        }

        .image-modal-btn.delete {
            background: #4a2020;
        }

        .image-modal-btn.delete:hover {
            background: #c0392b;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                height: 100%;
                max-height: none;
                border-right: none;
                border-bottom: none;
                overflow-y: auto;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 100;
            }

            #sidebar.collapsed {
                width: 100%;
                height: auto;
                max-height: 50px;
                overflow: hidden;
                position: relative;
            }

            #sidebar.collapsed #sidebar-menu {
                display: none;
            }

            #sidebar.collapsed #sidebar-stats {
                display: none;
            }

            #sidebar-menu {
                overflow: visible;
            }

            #sidebar-header #mobile-project {
                display: block;
            }

            #sidebar-header h2 {
                display: none;
            }

            /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ç”»åƒãƒˆã‚°ãƒ«ã‚’è¡¨ç¤º */
            #sidebar.collapsed #sidebar-image-toggle {
                display: block;
                position: absolute;
                right: 0.75rem;
                background: transparent;
                border: none;
                color: #aaa;
                font-size: 1.2rem;
                cursor: pointer;
                padding: 0.25rem;
            }

            #sidebar.collapsed #sidebar-image-toggle:hover {
                color: #2d5a7b;
            }

            header {
                display: none;
            }

            #main {
                flex: 1;
                min-height: 0;
            }

            .modal {
                width: 95%;
                height: 95vh;
            }

            .character-settings {
                flex-direction: column;
            }

            #message-input {
                flex: 1;
                min-width: 0;
            }

            #send-btn {
                padding: 0.75rem 1rem;
            }

            .panel-list {
                max-height: none;
                flex: 1;
                overflow-y: auto;
            }

            #resize-handle {
                width: 100%;
                height: 12px;
                cursor: row-resize;
                order: -1;
                display: none;
            }

            body.image-panel-open #resize-handle {
                display: block;
            }

            body.resizing,
            body.resizing * {
                cursor: row-resize !important;
            }

            #right-sidebar {
                width: 100%;
                height: 40%;
                border-left: none;
                border-bottom: none;
                order: -2;
            }

            #right-sidebar.collapsed {
                display: none !important;
            }

            #right-sidebar-header {
                justify-content: space-between;
            }

            /* ç”»åƒãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’éè¡¨ç¤º */
            body.image-panel-open #sidebar.collapsed {
                display: none !important;
            }

            /* ç”»åƒãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’è¡¨ç¤º */
            body.image-panel-open #right-sidebar-menu-toggle {
                display: block;
            }

            body.image-panel-open #right-sidebar-project {
                display: block;
                flex: 1;
                text-align: center;
                font-size: 0.9rem;
                color: #2d5a7b;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* ç”»åƒãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯mainã®padding-topã‚’0ã« */
            body.image-panel-open #main {
                padding-top: 0 !important;
            }

            #right-sidebar {
                display: flex;
                flex-direction: column;
            }

            #right-sidebar #image-container {
                overflow-x: auto;
                overflow-y: hidden;
                padding: 0.5rem;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: flex-start;
                min-height: 0;
                flex-direction: row;
                gap: 0.5rem;
            }

            #right-sidebar .image-wrapper {
                height: 100%;
                width: auto;
                margin: 0 !important;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            #right-sidebar .generated-image {
                max-height: 100%;
                max-width: none;
                width: auto;
                height: 100%;
                object-fit: contain;
                border-radius: 0.5rem;
            }

        }
    </style>
</head>
<body>
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div id="sidebar">
        <div id="sidebar-header">
            <button id="sidebar-toggle">â‰¡</button>
            <h2>Grok Chat</h2>
            <span id="mobile-project"></span>
            <button id="sidebar-image-toggle">ğŸ–¼ï¸</button>
        </div>
        <div id="sidebar-menu">
            <button class="menu-item" id="menu-new-chat">
                <span class="menu-item-icon">+</span>
                <span class="menu-item-text">æ–°è¦ãƒãƒ£ãƒƒãƒˆ</span>
            </button>
            <button class="menu-item" id="menu-projects">
                <span class="menu-item-icon">ğŸ“</span>
                <span class="menu-item-text">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
            </button>
            <button class="menu-item" id="menu-history">
                <span class="menu-item-icon">ğŸ“œ</span>
                <span class="menu-item-text">å±¥æ­´</span>
            </button>

            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆ -->
            <div id="project-list" class="panel-list">
                <div class="panel-header">
                    <span>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
                </div>
                <div id="project-items"></div>
            </div>

            <!-- å±¥æ­´ãƒªã‚¹ãƒˆ -->
            <div id="history-list" class="panel-list">
                <div class="panel-header">
                    <span>ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´</span>
                </div>
                <div id="history-items"></div>
            </div>

            <div class="menu-spacer"></div>

            <!-- çµ±è¨ˆæƒ…å ± -->
            <div id="sidebar-stats">
                <div class="stat-item">
                    <a class="stat-label" href="https://openrouter.ai/settings/credits" target="_blank">OpenRouter æ®‹é«˜</a>
                    <span class="stat-value" id="credit-balance">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç´¯è¨ˆ OpenRouter ã‚³ã‚¹ãƒˆ</span>
                    <span class="stat-value" id="total-cost">$0.00</span>
                </div>
                <div class="stat-item" id="runware-balance-item" style="display: none;">
                    <a class="stat-label" href="https://my.runware.ai/wallet" target="_blank">Runware æ®‹é«˜</a>
                    <span class="stat-value" id="runware-balance">--</span>
                </div>
                <div class="stat-item" id="runware-cost-item" style="display: none;">
                    <span class="stat-label">ç´¯è¨ˆ Runware ã‚³ã‚¹ãƒˆ</span>
                    <span class="stat-value" id="total-runware-cost">$0.00</span>
                </div>
                <button class="stat-reset-btn" id="clear-cost-btn">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <button class="menu-item settings" id="menu-settings">
                <span class="menu-item-icon">âš™ï¸</span>
                <span class="menu-item-text">è¨­å®š</span>
            </button>
        </div>
    </div>

    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="project-modal">
        <div class="modal">
            <div class="modal-body">
                <div class="form-group">
                    <label for="project-name">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                    <input type="text" id="project-name" placeholder="ä¾‹: è‹±èªç¿»è¨³ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ">
                </div>
                <div class="form-group flex-grow">
                    <label for="project-prompt">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
                    <textarea id="project-prompt" placeholder="ä¾‹: ã‚ãªãŸã¯å„ªç§€ãªè‹±èªç¿»è¨³è€…ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæ—¥æœ¬èªã‚’è‡ªç„¶ãªè‹±èªã«ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button class="btn btn-danger" id="project-delete" style="display: none;">å‰Šé™¤</button>
                </div>
                <div class="modal-footer-right">
                    <button class="btn btn-secondary" id="project-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="btn btn-primary" id="project-save">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal" style="height: auto; max-height: 90vh;">
            <div class="modal-header">
                <h3>è¨­å®š</h3>
                <button class="modal-close" id="settings-modal-close">Ã—</button>
            </div>
            <div class="modal-body" style="display: block;">
                <div class="form-group">
                    <label for="api-key-input">OpenRouter APIã‚­ãƒ¼</label>
                    <input type="password" id="api-key-input" placeholder="sk-or-v1-...">
                    <div style="font-size: 0.75rem; color: #888; margin-top: 0.25rem;">
                        <a href="https://openrouter.ai/keys" target="_blank" style="color: #2d5a7b;">APIã‚­ãƒ¼ã‚’å–å¾—</a>
                    </div>
                </div>
                <div class="form-group">
                    <label for="chat-model-select">ä¼šè©±ç”¨ãƒ¢ãƒ‡ãƒ«</label>
                    <select id="chat-model-select">
                        <option value="x-ai/grok-3-mini">Grok 3 Mini ($0.30/$0.50)</option>
                        <option value="x-ai/grok-4-fast">Grok 4 Fast ($0.20/$0.50)</option>
                        <option value="x-ai/grok-4.1-fast" selected>Grok 4.1 Fast ($0.20/$0.50)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="image-model-select">ç”»åƒç”Ÿæˆç”¨ãƒ¢ãƒ‡ãƒ«</label>
                    <select id="image-model-select">
                        <option value="google/gemini-2.5-flash-image" selected>Gemini 2.5 Flash Image ($0.30/$2.50)</option>
                        <option value="runware:z-image@turbo">Runware / Z-Image Turbo</option>
                        <option value="civitai:481162@558910">Runware / Aoi-Realistic-Pony</option>
                        <option value="civitai:457669@691683">Runware / PinkiePie Pony Mix</option>
                        <option value="x:42@1761560">Runware / WAI-NSFW-illustrious-SDXL v14</option>
                    </select>
                </div>
                <div class="form-group" id="runware-api-key-group" style="display: none;">
                    <label for="runware-api-key-input">Runware APIã‚­ãƒ¼</label>
                    <input type="password" id="runware-api-key-input" placeholder="Runware API Key">
                    <div style="font-size: 0.75rem; color: #888; margin-top: 0.25rem;">
                        <a href="https://my.runware.ai/" target="_blank" style="color: #2d5a7b;">APIã‚­ãƒ¼ã‚’å–å¾—</a>
                    </div>
                </div>
                <div class="form-group">
                    <label>ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾é ¼æ–‡</label>
                    <button class="btn btn-secondary" id="open-image-prompt-editor" style="width: 100%; text-align: left;">
                        <span id="image-prompt-preview" style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                    </button>
                </div>
                <div class="form-group">
                    <label for="click-prompt">ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ{word}ãŒå˜èªã«ç½®æ›ã•ã‚Œã¾ã™ï¼‰</label>
                    <input type="text" id="click-prompt" placeholder="ä¾‹: {word}ã«ã¤ã„ã¦è©³ã—ã">
                </div>
                <div class="form-group">
                    <label>å¼·èª¿è¨­å®š</label>
                    <div class="character-settings">
                        <div class="character-group">
                            <div class="character-group-title">å¼·èª¿ï¼‘</div>
                            <div class="character-row">
                                <label>åç§°ï¼‘ <code>{name1}</code></label>
                                <input type="text" id="name1">
                            </div>
                            <div class="character-row">
                                <label>é€šç§°ï¼‘ <code>{nickname1}</code></label>
                                <input type="text" id="nickname1">
                            </div>
                            <div class="character-row">
                                <label>æ–‡å­—è‰²</label>
                                <input type="color" id="color1" value="#00cc66">
                            </div>
                        </div>
                        <div class="character-group">
                            <div class="character-group-title">å¼·èª¿ï¼’</div>
                            <div class="character-row">
                                <label>åç§°ï¼’ <code>{name2}</code></label>
                                <input type="text" id="name2">
                            </div>
                            <div class="character-row">
                                <label>é€šç§°ï¼’ <code>{nickname2}</code></label>
                                <input type="text" id="nickname2">
                            </div>
                            <div class="character-row">
                                <label>æ–‡å­—è‰²</label>
                                <input type="color" id="color2" value="#00cc66">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <a href="runware-test.html" target="_blank" style="color: #2d5a7b; font-size: 0.85rem;">ğŸ¨ Runware ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</a>
                </div>
                <div class="modal-footer-right">
                    <button class="btn btn-primary" id="settings-close">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå€‹åˆ¥ã®ç”»åƒç”¨ï¼‰ -->
    <div class="modal-overlay" id="edit-prompt-modal">
        <div class="modal" style="width: 90%; height: 80vh;">
            <div class="modal-header">
                <h3>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†</h3>
                <button class="modal-close" id="edit-prompt-modal-close">Ã—</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column;">
                <div class="form-group flex-grow" style="flex: 1; display: flex; flex-direction: column;">
                    <textarea id="edit-prompt-textarea" style="flex: 1; resize: none; font-family: monospace; font-size: 0.95rem; line-height: 1.5;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button class="btn btn-secondary" id="edit-prompt-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
                <div class="modal-footer-right">
                    <button class="btn btn-secondary" id="edit-prompt-save">ä¿å­˜</button>
                    <button class="btn btn-primary" id="edit-prompt-generate">ä¿å­˜ã—ã¦ç”Ÿæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="image-prompt-modal">
        <div class="modal" style="width: 90%; height: 90vh;">
            <div class="modal-header">
                <h3>ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾é ¼æ–‡</h3>
                <button class="modal-close" id="image-prompt-modal-close">Ã—</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column;">
                <div class="form-group flex-grow" style="flex: 1; display: flex; flex-direction: column;">
                    <label for="image-gen-prompt">ä¼šè©±ã®çŠ¶æ³ã‹ã‚‰ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã•ã›ã‚‹æŒ‡ç¤ºæ–‡</label>
                    <textarea id="image-gen-prompt" style="flex: 1; resize: none; font-family: monospace; font-size: 0.9rem; line-height: 1.5;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button class="btn btn-secondary" id="image-prompt-reset">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                </div>
                <div class="modal-footer-right">
                    <button class="btn btn-primary" id="image-prompt-save">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="main">
        <header>
            <button id="header-menu-toggle" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">â˜°</button>
            <div id="current-project"></div>
            <button id="header-image-toggle" title="ç”»åƒã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã">ğŸ–¼ï¸</button>
        </header>

        <div id="chat-container"></div>

        <div id="input-container">
            <button id="generate-image-btn" title="ç¾åœ¨ã®çŠ¶æ³ã‹ã‚‰ç”»åƒã‚’ç”Ÿæˆ">ğŸ¨</button>
            <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off">
            <button id="send-btn">é€ä¿¡</button>
        </div>
    </div>

    <!-- ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« -->
    <div id="resize-handle"></div>

    <!-- å³å´ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆç”»åƒè¡¨ç¤ºç”¨ï¼‰ -->
    <div id="right-sidebar" class="collapsed">
        <div id="right-sidebar-header">
            <button id="right-sidebar-menu-toggle">â˜°</button>
            <span id="right-sidebar-project"></span>
            <button id="right-sidebar-toggle">ğŸ–¼ï¸</button>
        </div>
        <div id="image-container">
            <div class="empty-message">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
    </div>

    <!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="image-modal" class="image-modal" onclick="closeImageModal(event)">
        <div class="image-modal-content">
            <img id="image-modal-img" src="" alt="">
            <div id="image-modal-controls" class="image-modal-controls">
                <div id="image-modal-prompt" class="image-modal-prompt"></div>
                <div class="image-modal-buttons">
                    <button id="image-modal-copy" class="image-modal-btn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    <button id="image-modal-edit" class="image-modal-btn">âœ ç·¨é›†</button>
                    <button id="image-modal-generate" class="image-modal-btn">ğŸ¨ å†ç”Ÿæˆ</button>
                    <button id="image-modal-delete" class="image-modal-btn delete">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiKey = '';
        let runwareApiKey = '';
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        const CREDITS_URL = 'https://openrouter.ai/api/v1/credits';
        const RUNWARE_API_URL = 'https://api.runware.ai/v1';

        const STORAGE_KEY = 'grok-chat-data';
        const SESSIONS_KEY = 'grok-chat-sessions';
        const PROJECTS_KEY = 'grok-chat-projects';

        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const headerMenuToggle = document.getElementById('header-menu-toggle');
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const clearCostBtn = document.getElementById('clear-cost-btn');
        const totalCostEl = document.getElementById('total-cost');
        const totalRunwareCostEl = document.getElementById('total-runware-cost');
        const creditBalanceEl = document.getElementById('credit-balance');
        const runwareBalanceEl = document.getElementById('runware-balance');
        const runwareBalanceItem = document.getElementById('runware-balance-item');
        const runwareCostItem = document.getElementById('runware-cost-item');
        const chatModelSelect = document.getElementById('chat-model-select');
        const imageModelSelect = document.getElementById('image-model-select');
        const clickPromptInput = document.getElementById('click-prompt');
        const apiKeyInput = document.getElementById('api-key-input');
        const runwareApiKeyInput = document.getElementById('runware-api-key-input');
        const runwareApiKeyGroup = document.getElementById('runware-api-key-group');
        const imageGenPromptInput = document.getElementById('image-gen-prompt');
        const imagePromptPreview = document.getElementById('image-prompt-preview');
        const imagePromptModal = document.getElementById('image-prompt-modal');
        const generateImageBtn = document.getElementById('generate-image-btn');
        const rightSidebar = document.getElementById('right-sidebar');
        const rightSidebarToggle = document.getElementById('right-sidebar-toggle');
        const rightSidebarMenuToggle = document.getElementById('right-sidebar-menu-toggle');
        const rightSidebarProject = document.getElementById('right-sidebar-project');
        const headerImageToggle = document.getElementById('header-image-toggle');
        const sidebarImageToggle = document.getElementById('sidebar-image-toggle');
        const imageContainer = document.getElementById('image-container');
        const historyList = document.getElementById('history-list');
        const historyItems = document.getElementById('history-items');
        const projectList = document.getElementById('project-list');
        const projectItems = document.getElementById('project-items');
        const projectModal = document.getElementById('project-modal');
        const currentProjectEl = document.getElementById('current-project');

        // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
        let currentSessionId = null;
        let currentProjectId = null;
        let messages = [];
        let chatHistory = [];
        let currentSessionImages = [];
        const MAX_SESSION_IMAGES = 50; // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®æœ€å¤§ç”»åƒä¿æŒæšæ•°

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆ
        let totalCost = 0;
        let totalRunwareCost = 0;

        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        let clickPrompt = '{word}ã«ã¤ã„ã¦è©³ã—ã';

        // ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾é ¼æ–‡
        const DEFAULT_IMAGE_GEN_PROMPT = 'ç¾åœ¨ã®ä¼šè©±ã®çŠ¶æ³ã‚’è¡¨ã™ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã€è‹±èªã®ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’1ã¤ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã€èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚';
        let imageGenPrompt = DEFAULT_IMAGE_GEN_PROMPT;

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°é–¢æ•°
        function updateImagePromptPreview() {
            const preview = imageGenPrompt || DEFAULT_IMAGE_GEN_PROMPT;
            imagePromptPreview.textContent = preview.substring(0, 50) + (preview.length > 50 ? '...' : '');
        }

        // å¼·èª¿è¨­å®š
        let highlightSettings = {
            h1: { name: '', nickname: '', color: '#00cc66' },
            h2: { name: '', nickname: '', color: '#00cc66' }
        };

        // ãƒ‡ãƒ¼ã‚¿
        let sessions = [];
        let projects = [];

        // ç·¨é›†ä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
        let editingProjectId = null;

        // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        // ========== ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† ==========
        function saveSessions() {
            localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));
        }

        function loadSessions() {
            const saved = localStorage.getItem(SESSIONS_KEY);
            if (saved) {
                sessions = JSON.parse(saved);
            }
        }

        function saveCurrentSession() {
            if (!currentSessionId || messages.length === 0) return;

            const sessionIndex = sessions.findIndex(s => s.id === currentSessionId);
            const sessionData = {
                id: currentSessionId,
                title: formatDateTime(currentSessionId),
                messages: messages,
                chatHistory: chatHistory,
                projectId: currentProjectId,
                createdAt: currentSessionId,
                images: currentSessionImages.length > 0 ? [...currentSessionImages] : [],
                imageFormatV2: true  // ç”»åƒé…åˆ—ãŒå¤ã„é †ï¼ˆå…ˆé ­ãŒæœ€å¤ï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
            };

            if (sessionIndex >= 0) {
                sessions[sessionIndex] = sessionData;
            } else {
                sessions.unshift(sessionData);
            }
            saveSessions();
        }

        function loadSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                currentSessionId = session.id;
                currentProjectId = session.projectId || null;
                messages = [...session.messages];
                chatHistory = [...session.chatHistory];

                chatContainer.innerHTML = '';
                chatHistory.forEach(item => {
                    addMessageToDOM(item.role, item.content, item.reasoning);
                });

                // ç”»åƒã‚’å¾©å…ƒ
                clearImageSidebar();
                // æ–°å½¢å¼ï¼ˆimagesé…åˆ—ï¼‰ã¨æ—§å½¢å¼ï¼ˆlastImageï¼‰ã®ä¸¡æ–¹ã«å¯¾å¿œ
                if (session.images && session.images.length > 0) {
                    // æ—§å½¢å¼ï¼ˆæ–°ã—ã„ç”»åƒãŒå…ˆé ­ï¼‰ã‚’æ–°å½¢å¼ï¼ˆå¤ã„ç”»åƒãŒå…ˆé ­ï¼‰ã«å¤‰æ›
                    if (!session.imageFormatV2) {
                        currentSessionImages = [...session.images].reverse();
                    } else {
                        currentSessionImages = [...session.images];
                    }
                    // å¤ã„é †ã‹ã‚‰è¡¨ç¤ºï¼ˆä¸ŠãŒå¤ã„ã€ä¸‹ãŒæ–°ã—ã„ï¼‰
                    currentSessionImages.forEach(img => {
                        addImageToSidebar(img.url, img.prompt || '', true);
                    });
                    // æ–°å½¢å¼ã§ä¿å­˜
                    saveCurrentSession();
                } else if (session.lastImage && session.lastImage.url) {
                    // æ—§å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
                    currentSessionImages = [{ ...session.lastImage }];
                    addImageToSidebar(session.lastImage.url, session.lastImage.prompt || '', true);
                } else {
                    currentSessionImages = [];
                }

                updateCurrentProjectDisplay();
                saveGlobalSettings();
                renderHistoryList();
                closeMobileMenu();
            }
        }

        function replacePromptVariables(prompt) {
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã®å¤‰æ•°ã‚’ç½®æ›
            return prompt
                .replace(/\{name1\}/g, highlightSettings.h1.name || '')
                .replace(/\{nickname1\}/g, highlightSettings.h1.nickname || '')
                .replace(/\{name2\}/g, highlightSettings.h2.name || '')
                .replace(/\{nickname2\}/g, highlightSettings.h2.nickname || '');
        }

        function startNewSession(projectId = null) {
            saveCurrentSession();

            currentSessionId = Date.now();
            currentProjectId = projectId;
            messages = [];
            chatHistory = [];
            chatContainer.innerHTML = '';
            currentSessionImages = [];
            clearImageSidebar();

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®š
            if (projectId) {
                const project = projects.find(p => p.id === projectId);
                if (project && project.prompt) {
                    const expandedPrompt = replacePromptVariables(project.prompt);
                    messages.push({ role: 'system', content: expandedPrompt });
                    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const div = document.createElement('div');
                    div.className = 'message system-msg';
                    div.textContent = `ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${project.name}ã€ã‚’é–‹å§‹`;
                    chatContainer.appendChild(div);
                }
            }

            updateCurrentProjectDisplay();
            saveGlobalSettings();
            renderHistoryList();
        }

        function deleteSession(sessionId, event) {
            event.stopPropagation();
            if (!confirm('ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            sessions = sessions.filter(s => s.id !== sessionId);
            saveSessions();

            if (currentSessionId === sessionId) {
                if (sessions.length > 0) {
                    loadSession(sessions[0].id);
                } else {
                    startNewSession();
                }
            }

            renderHistoryList();
        }

        function deleteAllSessions() {
            if (!confirm('å…¨ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚ã‚¯ãƒªã‚¢
            currentSessionId = null;
            currentProjectId = null;
            messages = [];
            chatHistory = [];
            chatContainer.innerHTML = '';

            sessions = [];
            saveSessions();
            saveGlobalSettings();

            // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
            currentSessionId = Date.now();
            updateCurrentProjectDisplay();
            renderHistoryList();
        }

        function renderHistoryList() {
            historyItems.innerHTML = '';

            if (sessions.length === 0) {
                historyItems.innerHTML = '<div class="empty-message">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // å…¨å‰Šé™¤ãƒœã‚¿ãƒ³
            const deleteAllBtn = document.createElement('button');
            deleteAllBtn.className = 'list-item delete-all-btn';
            deleteAllBtn.textContent = 'å…¨ã¦ã®å±¥æ­´ã‚’å‰Šé™¤';
            deleteAllBtn.addEventListener('click', deleteAllSessions);
            historyItems.appendChild(deleteAllBtn);

            sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'list-item' + (session.id === currentSessionId ? ' active' : '');

                // ç”»åƒæšæ•°ã‚’è¨ˆç®—ï¼ˆæ–°å½¢å¼ã¨æ—§å½¢å¼ã«å¯¾å¿œï¼‰
                let imageCount = 0;
                if (session.images && session.images.length > 0) {
                    imageCount = session.images.length;
                } else if (session.lastImage && session.lastImage.url) {
                    imageCount = 1;
                }
                const imageCountText = imageCount > 0 ? `<span class="list-item-images">ğŸ–¼ï¸${imageCount}</span>` : '';

                item.innerHTML = `
                    <span class="list-item-title">${session.title}</span>
                    ${imageCountText}
                    <button class="list-item-btn delete" title="å‰Šé™¤">Ã—</button>
                `;
                item.addEventListener('click', () => loadSession(session.id));
                item.querySelector('.list-item-btn').addEventListener('click', (e) => deleteSession(session.id, e));
                historyItems.appendChild(item);
            });
        }

        function toggleHistoryPanel() {
            projectList.classList.remove('show');
            historyList.classList.toggle('show');
            if (historyList.classList.contains('show')) {
                renderHistoryList();
            }
        }

        // ========== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† ==========
        function saveProjects() {
            localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects));
        }

        function loadProjects() {
            const saved = localStorage.getItem(PROJECTS_KEY);
            if (saved) {
                projects = JSON.parse(saved);
            }
        }

        function renderProjectList() {
            projectItems.innerHTML = '';

            // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœã‚¿ãƒ³
            const newItem = document.createElement('div');
            newItem.className = 'list-item new-item';
            newItem.innerHTML = `<span class="list-item-title">+ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>`;
            newItem.addEventListener('click', () => openProjectModal());
            projectItems.appendChild(newItem);

            if (projects.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-message';
                empty.textContent = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“';
                projectItems.appendChild(empty);
                return;
            }

            projects.forEach(project => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span class="list-item-title">${project.name}</span>
                    <button class="list-item-btn" title="ç·¨é›†">âœ</button>
                `;
                item.querySelector('.list-item-title').addEventListener('click', () => startProjectChat(project.id));
                item.querySelector('.list-item-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openProjectModal(project.id);
                });
                projectItems.appendChild(item);
            });
        }

        function toggleProjectPanel() {
            historyList.classList.remove('show');
            projectList.classList.toggle('show');
            if (projectList.classList.contains('show')) {
                renderProjectList();
            }
        }

        function openProjectModal(projectId = null) {
            editingProjectId = projectId;
            const nameInput = document.getElementById('project-name');
            const promptInput = document.getElementById('project-prompt');
            const deleteBtn = document.getElementById('project-delete');

            if (projectId) {
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    nameInput.value = project.name;
                    promptInput.value = project.prompt;
                    deleteBtn.style.display = 'block';
                }
            } else {
                nameInput.value = '';
                promptInput.value = '';
                deleteBtn.style.display = 'none';
            }

            projectModal.classList.add('show');
            nameInput.focus();
        }

        function closeProjectModal() {
            projectModal.classList.remove('show');
            editingProjectId = null;
        }

        function saveProject() {
            const name = document.getElementById('project-name').value.trim();
            const prompt = document.getElementById('project-prompt').value.trim();

            if (!name) {
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (editingProjectId) {
                const index = projects.findIndex(p => p.id === editingProjectId);
                if (index >= 0) {
                    projects[index].name = name;
                    projects[index].prompt = prompt;
                }
            } else {
                projects.push({
                    id: Date.now(),
                    name: name,
                    prompt: prompt,
                    createdAt: Date.now()
                });
            }

            saveProjects();
            closeProjectModal();
            renderProjectList();
        }

        function deleteProject(projectId) {
            if (!confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            projects = projects.filter(p => p.id !== projectId);
            saveProjects();
            closeProjectModal();
            renderProjectList();
        }

        async function startProjectChat(projectId) {
            startNewSession(projectId);
            projectList.classList.remove('show');
            closeMobileMenu();

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            const project = projects.find(p => p.id === projectId);
            if (project && project.prompt) {
                if (!apiKey) {
                    alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§OpenRouter APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    document.getElementById('settings-modal').classList.add('show');
                    return;
                }
                sendBtn.disabled = true;
                await streamResponse(messages);
                sendBtn.disabled = false;
            }

            if (!isMobile()) {
                messageInput.focus();
            }
        }

        function updateCurrentProjectDisplay() {
            const mobileProjectEl = document.getElementById('mobile-project');
            if (currentProjectId) {
                const project = projects.find(p => p.id === currentProjectId);
                if (project) {
                    currentProjectEl.textContent = `ğŸ“ ${project.name}`;
                    mobileProjectEl.textContent = `ğŸ“ ${project.name}`;
                    rightSidebarProject.textContent = `ğŸ“ ${project.name}`;
                    return;
                }
            }
            currentProjectEl.textContent = '';
            mobileProjectEl.textContent = '';
            rightSidebarProject.textContent = '';
        }

        // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š ==========
        function saveGlobalSettings() {
            const data = {
                totalCost,
                totalRunwareCost,
                chatModel: chatModelSelect.value,
                imageModel: imageModelSelect.value,
                currentSessionId,
                currentProjectId,
                clickPrompt,
                imageGenPrompt,
                highlightSettings,
                apiKey,
                runwareApiKey
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadGlobalSettings() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                totalCost = data.totalCost || 0;
                totalRunwareCost = data.totalRunwareCost || 0;
                currentSessionId = data.currentSessionId || null;
                currentProjectId = data.currentProjectId || null;
                clickPrompt = data.clickPrompt || '{word}ã«ã¤ã„ã¦è©³ã—ã';
                imageGenPrompt = data.imageGenPrompt || DEFAULT_IMAGE_GEN_PROMPT;
                apiKey = data.apiKey || '';
                runwareApiKey = data.runwareApiKey || '';
                if (data.highlightSettings) {
                    highlightSettings = data.highlightSettings;
                }

                if (data.chatModel || data.selectedModel) {
                    chatModelSelect.value = data.chatModel || data.selectedModel;
                }
                if (data.imageModel) {
                    imageModelSelect.value = data.imageModel;
                }

                clickPromptInput.value = clickPrompt;
                imageGenPromptInput.value = imageGenPrompt;
                updateImagePromptPreview();
                apiKeyInput.value = apiKey;
                runwareApiKeyInput.value = runwareApiKey;
                totalCostEl.textContent = '$' + totalCost.toFixed(2);
                totalRunwareCostEl.textContent = '$' + totalRunwareCost.toFixed(2);

                // Runwareé¸æŠæ™‚ã¯APIã‚­ãƒ¼å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
                updateRunwareApiKeyVisibility();
            }
            loadHighlightSettings();
        }

        function updateRunwareApiKeyVisibility() {
            const isRunware = imageModelSelect.value.startsWith('runware:') || imageModelSelect.value.startsWith('civitai:') || imageModelSelect.value.startsWith('x:');
            runwareApiKeyGroup.style.display = isRunware ? 'block' : 'none';
            runwareBalanceItem.style.display = isRunware ? 'flex' : 'none';
            runwareCostItem.style.display = isRunware ? 'flex' : 'none';
            if (isRunware && runwareApiKey) {
                fetchRunwareBalance();
            }
        }

        function loadHighlightSettings() {
            document.getElementById('name1').value = highlightSettings.h1.name || '';
            document.getElementById('nickname1').value = highlightSettings.h1.nickname || '';
            document.getElementById('color1').value = highlightSettings.h1.color || '#00cc66';
            document.getElementById('name2').value = highlightSettings.h2.name || '';
            document.getElementById('nickname2').value = highlightSettings.h2.nickname || '';
            document.getElementById('color2').value = highlightSettings.h2.color || '#00cc66';
        }

        function saveHighlightSettings() {
            highlightSettings.h1.name = document.getElementById('name1').value;
            highlightSettings.h1.nickname = document.getElementById('nickname1').value;
            highlightSettings.h1.color = document.getElementById('color1').value;
            highlightSettings.h2.name = document.getElementById('name2').value;
            highlightSettings.h2.nickname = document.getElementById('nickname2').value;
            highlightSettings.h2.color = document.getElementById('color2').value;
            saveGlobalSettings();
        }

        // ========== ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ==========
        async function fetchCredits() {
            if (!apiKey) {
                creditBalanceEl.textContent = '--';
                return;
            }
            try {
                const response = await fetch(CREDITS_URL, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    const balance = data.data.total_credits - data.data.total_usage;
                    creditBalanceEl.textContent = '$' + balance.toFixed(2);
                }
            } catch (error) {
                creditBalanceEl.textContent = 'ã‚¨ãƒ©ãƒ¼';
            }
        }

        async function fetchRunwareBalance() {
            if (!runwareApiKey) {
                runwareBalanceEl.textContent = '--';
                return;
            }
            try {
                const response = await fetch(RUNWARE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${runwareApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify([
                        {
                            taskType: 'accountManagement',
                            taskUUID: generateUUID(),
                            operation: 'getDetails'
                        }
                    ])
                });
                const data = await response.json();
                const result = Array.isArray(data.data) ? data.data[0] : data.data;
                if (result && result.balance !== undefined) {
                    runwareBalanceEl.textContent = '$' + result.balance.toFixed(2);
                }
            } catch (error) {
                runwareBalanceEl.textContent = 'ã‚¨ãƒ©ãƒ¼';
            }
        }

        function updateStats(cost) {
            totalCost += cost;
            totalCostEl.textContent = '$' + totalCost.toFixed(2);
            saveGlobalSettings();
            fetchCredits(); // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹é«˜ã‚‚æ›´æ–°
        }

        function updateRunwareStats(cost) {
            totalRunwareCost += cost;
            totalRunwareCostEl.textContent = '$' + totalRunwareCost.toFixed(2);
            saveGlobalSettings();
        }

        function parseClickableWords(text) {
            // [word] ã‚’æ¤œå‡ºã—ã¦ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªspanã«å¤‰æ›ï¼ˆæ‹¬å¼§ã¯è¡¨ç¤ºã—ãªã„ï¼‰
            let result = text.replace(/\[([^\]]+)\]/g, (match, word) => {
                const encoded = encodeURIComponent(word);
                return `<span class="clickable-word" onclick="askAbout('${encoded}')">${word}</span>`;
            });

            // ã€é¸æŠè‚¢ã€‘ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ç•ªå·ä»˜ããƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
            if (text.includes('ã€é¸æŠè‚¢ã€‘')) {
                result = result.replace(/^(\d+)\.\s?/gm, (match, num) => {
                    return `<span class="clickable-choice" onclick="sendChoice('${num}')">${num}.</span> `;
                });
            }

            return result;
        }

        window.sendChoice = function(num) {
            messageInput.value = num;
            sendMessage();
        };

        function parseDialogueColors(text) {
            // å¼·èª¿è¨­å®šã«åŸºã¥ã„ã¦è‰²ã‚’ä»˜ã‘ã‚‹
            let result = text;

            // åç§°ï¼‘ã§è‰²ä»˜ã‘
            if (highlightSettings.h1.name) {
                const pattern = new RegExp(`^(${escapeRegex(highlightSettings.h1.name)})(ï¼š|:)(.*)$`, 'gm');
                result = result.replace(pattern, (match, name, colon, dialogue) => {
                    return `<span style="color: ${highlightSettings.h1.color}">${name}${colon}${dialogue}</span>`;
                });
            }

            // åç§°ï¼’ã§è‰²ä»˜ã‘
            if (highlightSettings.h2.name) {
                const pattern = new RegExp(`^(${escapeRegex(highlightSettings.h2.name)})(ï¼š|:)(.*)$`, 'gm');
                result = result.replace(pattern, (match, name, colon, dialogue) => {
                    return `<span style="color: ${highlightSettings.h2.color}">${name}${colon}${dialogue}</span>`;
                });
            }

            return result;
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.askAbout = function(encodedWord) {
            const word = decodeURIComponent(encodedWord);
            const query = clickPrompt.replace(/{word}/g, word);
            messageInput.value = query;
            sendMessage();
        };

        function addMessageToDOM(role, content, reasoning = null) {
            if (role === 'system') return; // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„

            const div = document.createElement('div');
            div.className = `message ${role}`;

            const escapedContent = escapeHtml(content);
            let parsedContent = parseClickableWords(escapedContent);
            parsedContent = parseDialogueColors(parsedContent);

            if (reasoning) {
                const toggleId = 'reasoning-' + Date.now() + Math.random();
                div.innerHTML = `
                    <div class="reasoning-toggle" onclick="toggleReasoning('${toggleId}')">
                        ğŸ’­ æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’è¡¨ç¤º
                    </div>
                    <div id="${toggleId}" class="reasoning-content">
                        <div class="reasoning">${escapeHtml(reasoning)}</div>
                    </div>
                    ${parsedContent}
                `;
            } else {
                div.innerHTML = parsedContent;
            }

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addMessage(role, content, reasoning = null) {
            if (messages.length === 0 && !currentSessionId) {
                currentSessionId = Date.now();
                saveGlobalSettings();
            }

            addMessageToDOM(role, content, reasoning);
            chatHistory.push({ role, content, reasoning });
            saveCurrentSession();
        }

        window.toggleReasoning = function(id) {
            const el = document.getElementById(id);
            el.classList.toggle('show');
        };

        function showLoading() {
            const div = document.createElement('div');
            div.className = 'message assistant loading';
            div.id = 'loading';
            div.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.remove();
        }

        function clearCost() {
            if (confirm('ç´¯è¨ˆã‚³ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                totalCost = 0;
                totalRunwareCost = 0;
                totalCostEl.textContent = '$0.00';
                totalRunwareCostEl.textContent = '$0.00';
                saveGlobalSettings();
            }
        }

        function isMobile() {
            return window.innerWidth <= 768;
        }

        function closeMobileMenu() {
            if (isMobile()) {
                sidebar.classList.add('collapsed');
            }
        }

        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;

            if (!apiKey) {
                alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§OpenRouter APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                document.getElementById('settings-modal').classList.add('show');
                return;
            }

            messageInput.value = '';
            sendBtn.disabled = true;

            addMessage('user', content);
            messages.push({ role: 'user', content });

            await streamResponse(messages);

            sendBtn.disabled = false;
            if (!isMobile()) {
                messageInput.focus();
            }
            renderHistoryList();
        }

        // ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isImageModel(model) {
            return model.includes('gemini') && model.includes('image');
        }

        // ç”»åƒã‚’å³å´ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¿½åŠ 
        function addImageToSidebar(imageUrl, prompt = '', skipSave = false) {
            // ç”»åƒæƒ…å ±ã‚’é…åˆ—ã«è¿½åŠ ï¼ˆæœ«å°¾ã«è¿½åŠ ã€å¤ã„é †ã«ä¸¦ã¶ï¼‰
            if (!skipSave) {
                currentSessionImages.push({ url: imageUrl, prompt: prompt });
                // æœ€å¤§æšæ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
                if (currentSessionImages.length > MAX_SESSION_IMAGES) {
                    currentSessionImages = currentSessionImages.slice(-MAX_SESSION_IMAGES);
                }
                saveCurrentSession();
            }

            // ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            const emptyMsg = imageContainer.querySelector('.empty-message');
            if (emptyMsg) {
                emptyMsg.remove();
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';

            const img = document.createElement('img');
            img.src = imageUrl;
            img.className = 'generated-image';
            img.onclick = () => {
                openImageModal(imageUrl, prompt);
            };

            wrapper.appendChild(img);

            // æœ€æ–°ã®ç”»åƒã‚’ä¸‹ã«è¿½åŠ 
            imageContainer.appendChild(wrapper);
            // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            img.onload = () => {
                imageContainer.scrollTop = imageContainer.scrollHeight;
            };
            // æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹å ´åˆã‚‚å¯¾å¿œ
            if (img.complete) {
                imageContainer.scrollTop = imageContainer.scrollHeight;
            }
        }

        // ç”»åƒã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        function clearImageSidebar() {
            imageContainer.innerHTML = '<div class="empty-message">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }

        // ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ«
        let currentModalPrompt = '';
        let currentModalImageUrl = '';
        let currentModalImageIndex = -1;

        function openImageModal(imageUrl, prompt) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('image-modal-img');
            const modalPrompt = document.getElementById('image-modal-prompt');
            const controls = document.getElementById('image-modal-controls');

            modalImg.src = imageUrl;
            currentModalImageUrl = imageUrl;
            currentModalPrompt = prompt || '';

            // ç¾åœ¨ã®ç”»åƒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            currentModalImageIndex = currentSessionImages.findIndex(img => img.url === imageUrl);

            if (prompt) {
                modalPrompt.textContent = prompt;
                controls.style.display = 'block';
            } else {
                controls.style.display = 'none';
            }

            modal.classList.add('show');
        }

        function navigateModalImage(direction) {
            if (currentSessionImages.length === 0) return;

            let newIndex = currentModalImageIndex + direction;

            // ç¯„å›²å¤–ãªã‚‰å¾ªç’°
            if (newIndex < 0) {
                newIndex = currentSessionImages.length - 1;
            } else if (newIndex >= currentSessionImages.length) {
                newIndex = 0;
            }

            const newImage = currentSessionImages[newIndex];
            if (newImage) {
                const modalImg = document.getElementById('image-modal-img');
                const modalPrompt = document.getElementById('image-modal-prompt');
                const controls = document.getElementById('image-modal-controls');

                modalImg.src = newImage.url;
                currentModalImageUrl = newImage.url;
                currentModalPrompt = newImage.prompt || '';
                currentModalImageIndex = newIndex;

                if (newImage.prompt) {
                    modalPrompt.textContent = newImage.prompt;
                    controls.style.display = 'block';
                } else {
                    controls.style.display = 'none';
                }
            }
        }

        function closeImageModal(event) {
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é–‰ã˜ãªã„
            if (event && event.target.closest('.image-modal-content')) {
                return;
            }
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        document.getElementById('image-modal-copy').addEventListener('click', () => {
            const btn = document.getElementById('image-modal-copy');
            navigator.clipboard.writeText(currentModalPrompt).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆ';
                btn.classList.add('active');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('active');
                }, 1500);
            });
        });

        document.getElementById('image-modal-edit').addEventListener('click', (e) => {
            e.stopPropagation();
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');
            const promptEl = document.getElementById('image-modal-prompt');
            openEditPromptModal(promptEl);
        });

        document.getElementById('image-modal-generate').addEventListener('click', async () => {
            await generateImageWithPrompt(currentModalPrompt);
        });

        document.getElementById('image-modal-delete').addEventListener('click', () => {
            if (!currentModalImageUrl) return;

            // é…åˆ—ã‹ã‚‰å‰Šé™¤
            const index = currentSessionImages.findIndex(img => img.url === currentModalImageUrl);
            if (index !== -1) {
                currentSessionImages.splice(index, 1);
                saveCurrentSession();
            }

            // DOMã‹ã‚‰å‰Šé™¤
            const images = imageContainer.querySelectorAll('.generated-image');
            images.forEach(img => {
                if (img.src === currentModalImageUrl) {
                    img.closest('.image-wrapper').remove();
                }
            });

            // ç”»åƒãŒãªããªã£ãŸã‚‰ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (imageContainer.querySelectorAll('.image-wrapper').length === 0) {
                imageContainer.innerHTML = '<div class="empty-message">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>';
            }

            // æ¬¡ã®ç”»åƒãŒã‚ã‚Œã°è¡¨ç¤ºã€ãªã‘ã‚Œã°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            if (currentSessionImages.length === 0) {
                closeImageModal();
            } else {
                // åŒã˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ç”»åƒãŒã‚ã‚Œã°è¡¨ç¤ºï¼ˆæ¬¡ã®ç”»åƒï¼‰ã€ãªã‘ã‚Œã°å‰ã®ç”»åƒ
                let newIndex = index;
                if (newIndex >= currentSessionImages.length) {
                    newIndex = currentSessionImages.length - 1;
                }
                const newImage = currentSessionImages[newIndex];
                if (newImage) {
                    const modalImg = document.getElementById('image-modal-img');
                    const modalPrompt = document.getElementById('image-modal-prompt');
                    const controls = document.getElementById('image-modal-controls');

                    modalImg.src = newImage.url;
                    currentModalImageUrl = newImage.url;
                    currentModalPrompt = newImage.prompt || '';
                    currentModalImageIndex = newIndex;

                    if (newImage.prompt) {
                        modalPrompt.textContent = newImage.prompt;
                        controls.style.display = 'block';
                    } else {
                        controls.style.display = 'none';
                    }
                } else {
                    closeImageModal();
                }
            }
        });

        // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§å‰å¾Œã®ç”»åƒã«ç§»å‹•
        document.getElementById('image-modal-img').addEventListener('click', (e) => {
            if (currentSessionImages.length <= 1) return;

            const img = e.target;
            const rect = img.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const halfWidth = rect.width / 2;

            if (clickX < halfWidth) {
                // å·¦åŠåˆ†ã‚¯ãƒªãƒƒã‚¯: å‰ã®ç”»åƒ
                navigateModalImage(-1);
            } else {
                // å³åŠåˆ†ã‚¯ãƒªãƒƒã‚¯: æ¬¡ã®ç”»åƒ
                navigateModalImage(1);
            }
        });

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        const editPromptModal = document.getElementById('edit-prompt-modal');
        const editPromptTextarea = document.getElementById('edit-prompt-textarea');
        let currentEditingPromptEl = null;

        function openEditPromptModal(promptEl) {
            currentEditingPromptEl = promptEl;
            editPromptTextarea.value = promptEl.textContent;
            editPromptModal.classList.add('show');
            editPromptTextarea.focus();
        }

        function closeEditPromptModal() {
            editPromptModal.classList.remove('show');
            currentEditingPromptEl = null;
        }

        document.getElementById('edit-prompt-modal-close').addEventListener('click', closeEditPromptModal);
        document.getElementById('edit-prompt-cancel').addEventListener('click', closeEditPromptModal);

        document.getElementById('edit-prompt-save').addEventListener('click', () => {
            if (currentEditingPromptEl) {
                const newPrompt = editPromptTextarea.value.trim();
                currentEditingPromptEl.textContent = newPrompt;
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ç·¨é›†ã—ãŸå ´åˆã¯currentModalPromptã‚‚æ›´æ–°
                if (currentEditingPromptEl.id === 'image-modal-prompt') {
                    currentModalPrompt = newPrompt;
                }
            }
            closeEditPromptModal();
        });

        document.getElementById('edit-prompt-generate').addEventListener('click', async () => {
            const newPrompt = editPromptTextarea.value.trim();
            if (currentEditingPromptEl && newPrompt) {
                currentEditingPromptEl.textContent = newPrompt;
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ç·¨é›†ã—ãŸå ´åˆã¯currentModalPromptã‚‚æ›´æ–°
                if (currentEditingPromptEl.id === 'image-modal-prompt') {
                    currentModalPrompt = newPrompt;
                }
                closeEditPromptModal();
                await generateImageWithPrompt(newPrompt);
            }
        });

        editPromptModal.addEventListener('click', (e) => {
            if (e.target === editPromptModal) {
                closeEditPromptModal();
            }
        });

        // UUIDç”Ÿæˆ
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Runware APIã§ç”»åƒç”Ÿæˆ
        async function generateImageWithRunware(imagePrompt) {
            const selectedModel = imageModelSelect.value;

            // ãƒ¢ãƒ‡ãƒ«åˆ¥ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
            const modelParams = {
                'runware:z-image@turbo': {
                    steps: 9,
                    CFGScale: 0,
                    scheduler: undefined,
                    positivePrefix: '',
                    negativePrompt: ''
                },
                'civitai:481162@558910': {
                    steps: 25,
                    CFGScale: 7,
                    scheduler: 'Euler',
                    positivePrefix: 'score_9, score_8_up, score_7_up, ',
                    negativePrompt: 'score_6, score_5, score_4, source_furry, source_pony, source_cartoon, 3d, blur,'
                },
                'civitai:457669@691683': {
                    steps: 20,
                    CFGScale: 7.5,
                    scheduler: 'Default',
                    positivePrefix: 'score_9, score_8_up, score_7_up, ',
                    negativePrompt: 'score_6, score_5, score_4, source_furry, source_pony, source_cartoon, 3d, blur,'
                },
                'x:42@1761560': {
                    steps: 30,
                    CFGScale: 7,
                    scheduler: 'Default',
                    positivePrefix: 'masterpiece, ultra-HD, cinematic lighting, ',
                    negativePrompt: 'bad anatomy, deformed hands, missing finger, worst quality, low quality, displeasing, watermark, text, artist name, signature, hearts,'
                }
            };
            const params = modelParams[selectedModel] || modelParams['runware:z-image@turbo'];

            const finalPrompt = params.positivePrefix + imagePrompt;

            const requestBody = {
                taskType: 'imageInference',
                taskUUID: generateUUID(),
                positivePrompt: finalPrompt,
                model: selectedModel,
                width: 1024,
                height: 1024,
                steps: params.steps,
                CFGScale: params.CFGScale,
                numberResults: 1,
                outputType: 'URL',
                includeCost: true
            };

            if (params.scheduler) {
                requestBody.scheduler = params.scheduler;
            }

            if (params.negativePrompt) {
                requestBody.negativePrompt = params.negativePrompt;
            }

            const response = await fetch(RUNWARE_API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${runwareApiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify([requestBody])
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Runware API ã‚¨ãƒ©ãƒ¼');
            }

            const data = await response.json();
            const results = Array.isArray(data.data) ? data.data : [data.data];

            for (const result of results) {
                if (result.imageURL) {
                    addImageToSidebar(result.imageURL, imagePrompt);
                }
                if (result.cost) {
                    updateRunwareStats(result.cost);
                }
            }

            if (results.some(r => r.imageURL)) {
                rightSidebar.classList.remove('collapsed');
                if (isMobile()) document.body.classList.add('image-panel-open');
                fetchRunwareBalance();
            } else {
                throw new Error('ç”»åƒã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ');
            }
        }

        // æŒ‡å®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ç”»åƒç”Ÿæˆ
        async function generateImageWithPrompt(imagePrompt) {
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            const isRunware = imageModelSelect.value.startsWith('runware:') || imageModelSelect.value.startsWith('civitai:') || imageModelSelect.value.startsWith('x:');
            if (isRunware && !runwareApiKey) {
                alert('Runware APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            generateImageBtn.disabled = true;
            generateImageBtn.textContent = 'â³ ç”Ÿæˆä¸­...';

            try {
                if (isRunware) {
                    await generateImageWithRunware(imagePrompt);
                } else {
                    // OpenRouter API (Geminiç­‰)
                    const imageResponse = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: imageModelSelect.value,
                            messages: [{ role: 'user', content: imagePrompt }],
                            modalities: ['text', 'image'],
                            stream: false
                        })
                    });

                    if (!imageResponse.ok) {
                        throw new Error('ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }

                    const imageResult = await imageResponse.json();
                    const choice = imageResult.choices?.[0];
                    const message = choice?.message;

                    const finishReason = choice?.finish_reason;
                    const nativeReason = choice?.native_finish_reason;
                    if (finishReason !== 'stop' || (nativeReason && nativeReason !== 'STOP')) {
                        const blockReasons = {
                            'content_filter': 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
                            'PROHIBITED_CONTENT': 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
                            'IMAGE_PROHIBITED_CONTENT': 'ç”»åƒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
                            'IMAGE_SAFETY': 'ç”»åƒå®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
                            'SAFETY': 'å®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼'
                        };
                        const reason = blockReasons[nativeReason] || blockReasons[finishReason] || 'ä¸æ˜ãªç†ç”±';
                        alert(`${reason}ã«ã‚ˆã‚Šç”»åƒç”ŸæˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ`);
                        return;
                    }

                    if (message?.images && Array.isArray(message.images)) {
                        for (const img of message.images) {
                            if (img.image_url?.url) {
                                addImageToSidebar(img.image_url.url, imagePrompt);
                            }
                        }
                        rightSidebar.classList.remove('collapsed');
                        if (isMobile()) document.body.classList.add('image-panel-open');
                    } else {
                        alert('ç”»åƒã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    }

                    if (imageResult.usage) {
                        updateStats(imageResult.usage.cost || 0);
                    }
                }
            } catch (error) {
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                generateImageBtn.disabled = false;
                generateImageBtn.textContent = 'ğŸ¨ ç”»åƒç”Ÿæˆ';
            }
        }

        // ç”»åƒç”Ÿæˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        async function generateImageFromContext() {
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            const isRunware = imageModelSelect.value.startsWith('runware:') || imageModelSelect.value.startsWith('civitai:') || imageModelSelect.value.startsWith('x:');
            if (isRunware && !runwareApiKey) {
                alert('Runware APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                document.getElementById('settings-modal').classList.add('show');
                return;
            }

            if (messages.length === 0) {
                alert('ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚');
                return;
            }

            generateImageBtn.disabled = true;
            generateImageBtn.textContent = 'â³ ç”Ÿæˆä¸­...';

            try {
                // 1. ä¼šè©±ç”¨ãƒ¢ãƒ‡ãƒ«ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã‚’ä¾é ¼
                const promptRequest = [...messages, {
                    role: 'user',
                    content: imageGenPrompt
                }];

                const promptResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: chatModelSelect.value,
                        messages: promptRequest,
                        stream: false
                    })
                });

                if (!promptResponse.ok) {
                    throw new Error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const promptResult = await promptResponse.json();
                const imagePrompt = promptResult.choices?.[0]?.message?.content?.trim();

                if (!imagePrompt) {
                    throw new Error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }

                // ä½¿ç”¨é‡ã‚’è¨˜éŒ²
                if (promptResult.usage) {
                    updateStats(promptResult.usage.cost || 0);
                }

                // 2. ç”»åƒç”Ÿæˆ
                if (isRunware) {
                    // Runware API
                    await generateImageWithRunware(imagePrompt);
                } else {
                    // OpenRouter API (Geminiç­‰)
                    const imageResponse = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: imageModelSelect.value,
                            messages: [{ role: 'user', content: imagePrompt }],
                            modalities: ['text', 'image'],
                            stream: false
                        })
                    });

                    if (!imageResponse.ok) {
                        throw new Error('ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }

                    const imageResult = await imageResponse.json();
                    console.log('Image API Response:', imageResult);

                    const choice = imageResult.choices?.[0];
                    const message = choice?.message;

                    // ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
                    const finishReason = choice?.finish_reason;
                    const nativeReason = choice?.native_finish_reason;
                    if (finishReason !== 'stop' || (nativeReason && nativeReason !== 'STOP')) {
                        const blockReasons = {
                            'content_filter': 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
                            'PROHIBITED_CONTENT': 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
                            'IMAGE_PROHIBITED_CONTENT': 'ç”»åƒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
                            'IMAGE_SAFETY': 'ç”»åƒå®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
                            'SAFETY': 'å®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼'
                        };
                        const reason = blockReasons[nativeReason] || blockReasons[finishReason] || 'ä¸æ˜ãªç†ç”±';
                        alert(`${reason}ã«ã‚ˆã‚Šç”»åƒç”ŸæˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ`);
                        return;
                    }

                    // ç”»åƒã‚’è¡¨ç¤º
                    if (message?.images && Array.isArray(message.images)) {
                        for (const img of message.images) {
                            if (img.image_url?.url) {
                                addImageToSidebar(img.image_url.url, imagePrompt);
                            }
                        }
                        rightSidebar.classList.remove('collapsed');
                        if (isMobile()) document.body.classList.add('image-panel-open');
                    } else {
                        alert('ç”»åƒã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    }

                    // ä½¿ç”¨é‡ã‚’è¨˜éŒ²
                    if (imageResult.usage) {
                        updateStats(imageResult.usage.cost || 0);
                    }
                }

            } catch (error) {
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                generateImageBtn.disabled = false;
                generateImageBtn.textContent = 'ğŸ¨ ç”»åƒç”Ÿæˆ';
            }
        }

        async function streamResponse(msgs) {
            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
            const div = document.createElement('div');
            div.className = 'message assistant';
            chatContainer.appendChild(div);

            let fullContent = '';
            let reasoning = '';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: chatModelSelect.value,
                        messages: msgs,
                        stream: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const errorMsg = error.error?.message || response.statusText;
                    if (errorMsg.includes('User not found') || errorMsg.includes('Invalid API key')) {
                        div.textContent = 'ã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„';
                    } else {
                        div.textContent = `ã‚¨ãƒ©ãƒ¼: ${errorMsg}`;
                    }
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                const delta = parsed.choices?.[0]?.delta;

                                if (delta?.reasoning) {
                                    reasoning += delta.reasoning;
                                    updateStreamingMessage(div, fullContent, reasoning);
                                }
                                if (delta?.content) {
                                    fullContent += delta.content;
                                    updateStreamingMessage(div, fullContent, reasoning);
                                }

                                // ä½¿ç”¨é‡æƒ…å ±ï¼ˆæœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ã«å«ã¾ã‚Œã‚‹å ´åˆï¼‰
                                if (parsed.usage) {
                                    const cost = parsed.usage.cost || 0;
                                    updateStats(cost);
                                }
                            } catch (e) {
                                // JSONè§£æã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                            }
                        }
                    }
                }

                // å®Œäº†å¾Œã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
                if (fullContent) {
                    messages.push({ role: 'assistant', content: fullContent });
                    chatHistory.push({ role: 'assistant', content: fullContent, reasoning: reasoning || null });
                    saveCurrentSession();
                    // æœ€çµ‚çš„ãªãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’é©ç”¨
                    updateStreamingMessage(div, fullContent, reasoning, true);

                    // ç”»åƒãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚Œã°è‡ªå‹•ã§ç”»åƒç”Ÿæˆ
                    if (!rightSidebar.classList.contains('collapsed')) {
                        generateImageFromContext();
                    }
                }

            } catch (error) {
                div.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateStreamingMessage(div, content, reasoning, final = false) {
            if (final) {
                // æœ€çµ‚æ›´æ–°æ™‚ã¯ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’é©ç”¨
                const escapedContent = escapeHtml(content);
                let parsedContent = parseClickableWords(escapedContent);
                parsedContent = parseDialogueColors(parsedContent);

                if (reasoning) {
                    const toggleId = 'reasoning-' + Date.now() + Math.random();
                    div.innerHTML = `
                        <div class="reasoning-toggle" onclick="toggleReasoning('${toggleId}')">
                            ğŸ’­ æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’è¡¨ç¤º
                        </div>
                        <div id="${toggleId}" class="reasoning-content">
                            <div class="reasoning">${escapeHtml(reasoning)}</div>
                        </div>
                        ${parsedContent}
                    `;
                } else {
                    div.innerHTML = parsedContent;
                }
            } else {
                // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã‚‚è‰²ä»˜ã‘ã‚’é©ç”¨
                const escapedContent = escapeHtml(content);
                const coloredContent = parseDialogueColors(escapedContent);

                let html = '';
                if (reasoning) {
                    html += `<div class="reasoning" style="margin-bottom: 0.5rem;">${escapeHtml(reasoning)}</div>`;
                }
                html += coloredContent;
                div.innerHTML = html;
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ========== ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ ==========
        const resizeHandle = document.getElementById('resize-handle');
        let isResizing = false;
        let startPos = 0;
        let startSize = 0;
        const MIN_WIDTH = 150;
        const MAX_WIDTH = 800;
        const MIN_HEIGHT = 100;
        const MAX_HEIGHT_RATIO = 0.7; // ç”»é¢ã®70%ã¾ã§

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            if (isMobile()) {
                startPos = e.clientY;
                startSize = rightSidebar.offsetHeight;
            } else {
                startPos = e.clientX;
                startSize = rightSidebar.offsetWidth;
            }
            document.body.classList.add('resizing');
            resizeHandle.classList.add('dragging');
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            if (isMobile()) {
                // ãƒ¢ãƒã‚¤ãƒ«: é«˜ã•ã‚’å¤‰æ›´
                const deltaY = e.clientY - startPos;
                let newHeight = startSize + deltaY;
                const maxHeight = window.innerHeight * MAX_HEIGHT_RATIO;
                newHeight = Math.max(MIN_HEIGHT, Math.min(maxHeight, newHeight));
                rightSidebar.style.height = newHeight + 'px';
            } else {
                // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: å¹…ã‚’å¤‰æ›´
                const deltaX = startPos - e.clientX;
                let newWidth = startSize + deltaX;
                newWidth = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, newWidth));
                rightSidebar.style.width = newWidth + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.classList.remove('resizing');
                resizeHandle.classList.remove('dragging');
            }
        });

        // ã‚¿ãƒƒãƒå¯¾å¿œ
        resizeHandle.addEventListener('touchstart', (e) => {
            isResizing = true;
            if (isMobile()) {
                startPos = e.touches[0].clientY;
                startSize = rightSidebar.offsetHeight;
            } else {
                startPos = e.touches[0].clientX;
                startSize = rightSidebar.offsetWidth;
            }
            document.body.classList.add('resizing');
            resizeHandle.classList.add('dragging');
            e.preventDefault();
        });

        document.addEventListener('touchmove', (e) => {
            if (!isResizing) return;

            if (isMobile()) {
                const deltaY = e.touches[0].clientY - startPos;
                let newHeight = startSize + deltaY;
                const maxHeight = window.innerHeight * MAX_HEIGHT_RATIO;
                newHeight = Math.max(MIN_HEIGHT, Math.min(maxHeight, newHeight));
                rightSidebar.style.height = newHeight + 'px';
            } else {
                const deltaX = startPos - e.touches[0].clientX;
                let newWidth = startSize + deltaX;
                newWidth = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, newWidth));
                rightSidebar.style.width = newWidth + 'px';
            }
        });

        document.addEventListener('touchend', () => {
            if (isResizing) {
                isResizing = false;
                document.body.classList.remove('resizing');
                resizeHandle.classList.remove('dragging');
            }
        });

        // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        window.addEventListener('resize', () => {
            if (isMobile()) {
                rightSidebar.style.width = '';
            } else {
                rightSidebar.style.height = '';
            }
        });

        // ========== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ==========
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
            historyList.classList.remove('show');
            projectList.classList.remove('show');
        });

        headerMenuToggle.addEventListener('click', () => {
            sidebar.classList.remove('collapsed');
        });

        rightSidebarMenuToggle.addEventListener('click', () => {
            sidebar.classList.remove('collapsed');
        });

        rightSidebarToggle.addEventListener('click', () => {
            rightSidebar.classList.toggle('collapsed');
            // é–‰ã˜ã‚‹ã¨ãã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (rightSidebar.classList.contains('collapsed')) {
                rightSidebar.style.width = '';
                rightSidebar.style.height = '';
            }
            if (isMobile()) {
                rightSidebar.classList.toggle('show-mobile');
                document.body.classList.toggle('image-panel-open', !rightSidebar.classList.contains('collapsed'));
            }
        });

        headerImageToggle.addEventListener('click', () => {
            rightSidebar.classList.remove('collapsed');
            if (isMobile()) {
                rightSidebar.classList.add('show-mobile');
                document.body.classList.add('image-panel-open');
            }
        });

        sidebarImageToggle.addEventListener('click', () => {
            rightSidebar.classList.remove('collapsed');
            if (isMobile()) {
                rightSidebar.classList.add('show-mobile');
                document.body.classList.add('image-panel-open');
            }
        });

        document.getElementById('menu-new-chat').addEventListener('click', () => {
            if (messages.length === 0) return;
            startNewSession();
            closeMobileMenu();
        });

        document.getElementById('menu-history').addEventListener('click', toggleHistoryPanel);
        document.getElementById('menu-projects').addEventListener('click', toggleProjectPanel);

        document.getElementById('project-cancel').addEventListener('click', closeProjectModal);
        document.getElementById('project-save').addEventListener('click', saveProject);
        document.getElementById('project-delete').addEventListener('click', () => {
            if (editingProjectId) {
                deleteProject(editingProjectId);
            }
        });

        projectModal.addEventListener('click', (e) => {
            if (e.target === projectModal) closeProjectModal();
        });

        const settingsModal = document.getElementById('settings-modal');

        document.getElementById('menu-settings').addEventListener('click', () => {
            settingsModal.classList.add('show');
        });

        document.getElementById('settings-modal-close').addEventListener('click', () => {
            settingsModal.classList.remove('show');
        });

        document.getElementById('settings-close').addEventListener('click', () => {
            settingsModal.classList.remove('show');
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) settingsModal.classList.remove('show');
        });

        // å¼·èª¿è¨­å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        ['name1', 'nickname1', 'color1', 'name2', 'nickname2', 'color2'].forEach(id => {
            document.getElementById(id).addEventListener('input', saveHighlightSettings);
        });

        sendBtn.addEventListener('click', sendMessage);
        clearCostBtn.addEventListener('click', clearCost);
        chatModelSelect.addEventListener('change', saveGlobalSettings);
        imageModelSelect.addEventListener('change', () => {
            updateRunwareApiKeyVisibility();
            saveGlobalSettings();
        });
        runwareApiKeyInput.addEventListener('input', () => {
            runwareApiKey = runwareApiKeyInput.value;
            saveGlobalSettings();
            if (runwareApiKey) {
                fetchRunwareBalance();
            }
        });
        generateImageBtn.addEventListener('click', generateImageFromContext);
        clickPromptInput.addEventListener('input', () => {
            clickPrompt = clickPromptInput.value || '{word}ã«ã¤ã„ã¦è©³ã—ã';
            saveGlobalSettings();
        });

        // ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        document.getElementById('open-image-prompt-editor').addEventListener('click', () => {
            imageGenPromptInput.value = imageGenPrompt;
            imagePromptModal.classList.add('show');
        });

        document.getElementById('image-prompt-modal-close').addEventListener('click', () => {
            imagePromptModal.classList.remove('show');
        });

        document.getElementById('image-prompt-save').addEventListener('click', () => {
            imageGenPrompt = imageGenPromptInput.value || DEFAULT_IMAGE_GEN_PROMPT;
            updateImagePromptPreview();
            saveGlobalSettings();
            imagePromptModal.classList.remove('show');
        });

        document.getElementById('image-prompt-reset').addEventListener('click', () => {
            imageGenPromptInput.value = DEFAULT_IMAGE_GEN_PROMPT;
        });

        imagePromptModal.addEventListener('click', (e) => {
            if (e.target === imagePromptModal) {
                imagePromptModal.classList.remove('show');
            }
        });

        apiKeyInput.addEventListener('input', () => {
            apiKey = apiKeyInput.value;
            saveGlobalSettings();
            if (apiKey) {
                fetchCredits();
            }
        });
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });


        // ========== åˆæœŸåŒ– ==========
        loadSessions();
        loadProjects();
        loadGlobalSettings();

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
        if (!clickPromptInput.value) {
            clickPromptInput.value = clickPrompt;
        }
        updateImagePromptPreview();

        if (currentSessionId) {
            const session = sessions.find(s => s.id === currentSessionId);
            if (session) {
                currentProjectId = session.projectId || null;
                messages = [...session.messages];
                chatHistory = [...session.chatHistory];
                chatHistory.forEach(item => {
                    addMessageToDOM(item.role, item.content, item.reasoning);
                });
                // ç”»åƒã‚’å¾©å…ƒï¼ˆæ–°å½¢å¼ã¨æ—§å½¢å¼ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
                if (session.images && session.images.length > 0) {
                    currentSessionImages = [...session.images];
                    [...session.images].reverse().forEach(img => {
                        addImageToSidebar(img.url, img.prompt || '', true);
                    });
                } else if (session.lastImage && session.lastImage.url) {
                    currentSessionImages = [{ ...session.lastImage }];
                    addImageToSidebar(session.lastImage.url, session.lastImage.prompt || '', true);
                }
            }
        }

        updateCurrentProjectDisplay();
        fetchCredits(); // åˆæœŸåŒ–æ™‚ã«ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹é«˜ã‚’å–å¾—
        if (!isMobile()) {
            messageInput.focus();
        }
    </script>
</body>
</html>
