<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generator (詳細設定)</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        /* ページ固有スタイル */
        .container { max-width: 1200px; }

        #status { margin-top: 10px; }

        .btn-generate { font-size: 16px; padding: 12px 30px; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
        }

        .panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            margin: 0 0 15px 0;
            color: #4a9eff;
            font-size: 1.1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a2a2a;
            color: #fff;
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .result-panel {
            display: flex;
            flex-direction: column;
        }

        #result-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            border-radius: 4px;
            padding: 10px;
        }

        #result-container img {
            max-width: 100%;
            border-radius: 4px;
            cursor: pointer;
        }

        .result-placeholder {
            color: #666;
            text-align: center;
        }

        .generation-info {
            margin-top: 10px;
            padding: 10px;
            background: #222;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #888;
        }

        .prompt-preview {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 10px;
            word-break: break-word;
        }

        .prompt-preview strong {
            color: #4a9eff;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 15px;
            color: #4a9eff;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .param-info {
            background: #1a2a1a;
            border: 1px solid #2a4a2a;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #8f8;
        }

        .param-info strong {
            color: #afa;
        }
    </style>
</head>
<body>

<div class="container">
    <a href="javascript:void(0)" onclick="closeOrBack()" class="back-link">&larr; ゲームに戻る</a>
    <h1>Image Generator (詳細設定)</h1>

    <!-- URLパラメータ表示 -->
    <div class="param-info" id="paramInfo" style="display: none;">
        <strong>遷移パラメータ:</strong> <span id="paramDisplay"></span>
    </div>

    <div class="main-content">
        <div class="panel">
            <h2>生成設定</h2>

            <div class="form-group">
                <label>モデル</label>
                <select id="model" onchange="applyModelDefaults()">
                    <option value="">-- モデルを選択 --</option>
                </select>
            </div>

            <div class="form-group">
                <label>キャラクター</label>
                <select id="character" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>場所</label>
                <select id="place" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>アクション</label>
                <select id="action" onchange="updateActionPrompt()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>構図</label>
                <select id="composition" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>服装</label>
                    <select id="costume" onchange="updatePromptPreview()">
                        <option value="">（なし）</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>関係性（表情）</label>
                    <select id="relationship" onchange="updatePromptPreview()">
                        <option value="">（なし）</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>追加プロンプト</label>
                <textarea id="customPrompt" placeholder="追加のプロンプトを入力" oninput="updatePromptPreview()"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>幅</label>
                    <input type="number" id="width" value="1024" min="512" max="2048" step="64">
                </div>
                <div class="form-group">
                    <label>高さ</label>
                    <input type="number" id="height" value="1024" min="512" max="2048" step="64">
                </div>
            </div>

            <div class="form-group">
                <label>Seed (-1=ランダム)</label>
                <input type="number" id="seed" value="-1">
            </div>

            <div class="prompt-preview">
                <strong>プロンプトプレビュー:</strong><br>
                <span id="promptPreview" style="color: #27ae60;">--</span>
                <br><br>
                <strong>ネガティブ:</strong><br>
                <span id="negativePreview" style="color: #e74c3c;">--</span>
            </div>

        </div>

        <div class="panel result-panel">
            <h2>生成結果</h2>
            <div style="margin-bottom: 15px; text-align: center;">
                <button class="btn btn-generate" onclick="handleGenerateImage()" id="generateBtn">画像生成</button>
            </div>
            <div id="result-container">
                <div class="result-placeholder">画像を生成してください</div>
            </div>
            <div id="generation-info" class="generation-info" style="display: none;"></div>
        </div>
    </div>

    <div class="settings-bar" style="margin-top: 20px;">
        <div class="settings-row">
            <label>GAS URL:</label>
            <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
            <button class="btn btn-primary" onclick="loadAllFromGas()">GASから読み込み</button>
        </div>
        <div class="settings-row">
            <label>Runware API Key:</label>
            <input type="password" id="apiKey" placeholder="Runware API Keyを入力">
        </div>
        <div id="status"></div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/prompt-utils.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script>
    // ストレージキー（test_transition.htmlと共通）
    const CACHE_KEY = STORAGE_KEYS.TRANSITION_CACHE;

    // データストア
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let relationships = [];
    let costumes = [];

    // URLパラメータから初期値を取得
    const urlParams = new URLSearchParams(window.location.search);
    const initialParams = {
        characterId: urlParams.get('characterId'),
        placeId: urlParams.get('placeId'),
        actionId: urlParams.get('actionId'),
        costumeId: urlParams.get('costumeId'),
        relationshipId: urlParams.get('relationshipId'),
        compositionIndex: urlParams.get('compositionIndex'),
        seed: urlParams.get('seed')
    };

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
        // 設定を読み込み（test_transition.htmlと共通のストレージ）
        const gasUrl = localStorage.getItem(STORAGE_KEYS.GAS_URL);
        if (gasUrl) {
            document.getElementById('gasUrl').value = gasUrl;
        }
        const apiKey = localStorage.getItem(STORAGE_KEYS.TRANSITION_RUNWARE_API_KEY);
        if (apiKey) {
            document.getElementById('apiKey').value = apiKey;
        }

        // キャッシュからデータを読み込み
        loadCachedData();

        // URLパラメータ表示
        displayUrlParams();

        // シードがあれば設定
        if (initialParams.seed) {
            document.getElementById('seed').value = initialParams.seed;
        }
    });

    // URLパラメータを表示
    function displayUrlParams() {
        const params = [];
        if (initialParams.characterId) params.push(`キャラ=${initialParams.characterId}`);
        if (initialParams.placeId) params.push(`場所=${initialParams.placeId}`);
        if (initialParams.actionId) params.push(`アクション=${initialParams.actionId}`);
        if (initialParams.costumeId) params.push(`服装=${initialParams.costumeId}`);
        if (initialParams.relationshipId) params.push(`関係性=${initialParams.relationshipId}`);

        if (params.length > 0) {
            document.getElementById('paramInfo').style.display = 'block';
            document.getElementById('paramDisplay').textContent = params.join(', ');
        }
    }

    // キャッシュデータを読み込み
    function loadCachedData() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
                relationships = data.relationships || [];
                costumes = data.costumes || [];

                updateAllSelects();
                applyInitialParams();
                showStatus(`キャッシュから復元: モデル${Object.keys(models).length}件, キャラ${characters.length}件`);
            }
        } catch (e) {
            console.error('Cache load error:', e);
        }
    }

    // キャッシュデータを保存
    function saveCachedData() {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
            models, characters, places, actions, relationships, costumes
        }));
    }

    // 全セレクトボックスを更新
    function updateAllSelects() {
        updateModelSelect();
        updateCharacterSelect();
        updatePlaceSelect();
        updateActionSelect();
        updateCostumeSelect();
        updateRelationshipSelect();
    }

    // URLパラメータから初期値を適用
    function applyInitialParams() {
        // モデル（保存された選択を復元）
        const savedModelId = localStorage.getItem(STORAGE_KEYS.TRANSITION_SELECTED_MODEL);
        if (savedModelId && models[savedModelId]) {
            document.getElementById('model').value = savedModelId;
        }

        // キャラクター
        if (initialParams.characterId) {
            const charIndex = characters.findIndex(c => c.character_id === initialParams.characterId);
            if (charIndex >= 0) {
                document.getElementById('character').value = charIndex;
            }
        }

        // 場所
        if (initialParams.placeId) {
            const placeIndex = places.findIndex(p => p.place_id === initialParams.placeId);
            if (placeIndex >= 0) {
                document.getElementById('place').value = placeIndex;
            }
        }

        // アクション
        if (initialParams.actionId) {
            const actionIndex = actions.findIndex(a => a.action_id === initialParams.actionId);
            if (actionIndex >= 0) {
                document.getElementById('action').value = actionIndex;
                updateActionPrompt(); // 構図リストを更新
            }
        }

        // 構図（アクション設定後に適用）
        if (initialParams.compositionIndex !== null) {
            const compSelect = document.getElementById('composition');
            const compIndex = parseInt(initialParams.compositionIndex);
            if (!isNaN(compIndex) && compIndex < compSelect.options.length) {
                compSelect.value = compIndex;
            }
        }

        // 服装
        if (initialParams.costumeId) {
            const costumeIndex = costumes.findIndex(c => c.costume_id === initialParams.costumeId);
            if (costumeIndex >= 0) {
                document.getElementById('costume').value = costumeIndex;
            }
        }

        // 関係性
        if (initialParams.relationshipId) {
            const relIndex = relationships.findIndex(r => r.relationship_id === initialParams.relationshipId);
            if (relIndex >= 0) {
                document.getElementById('relationship').value = relIndex;
            }
        }

        updatePromptPreview();
    }

    // 設定を保存
    function doSaveSettings() {
        const gasUrl = document.getElementById('gasUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        if (gasUrl) localStorage.setItem(STORAGE_KEYS.GAS_URL, gasUrl);
        if (apiKey) localStorage.setItem(STORAGE_KEYS.TRANSITION_RUNWARE_API_KEY, apiKey);
    }

    // GASから全データ読み込み
    async function loadAllFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        doSaveSettings();
        showStatus('読み込み中...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData, relationshipData, costumeData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action'),
                fetchGasData(baseUrl, 'relationship'),
                fetchGasData(baseUrl, 'costume')
            ]);

            models = parseModels(modelData);
            characters = parseCharacters(characterData);
            places = parsePlaces(placeData);
            actions = parseActionsWithCompositions(actionData);
            relationships = parseRelationships(relationshipData);
            costumes = parseCostumes(costumeData);

            saveCachedData();
            updateAllSelects();
            applyInitialParams();

            showStatus(`読み込み完了: モデル${Object.keys(models).length}件, キャラ${characters.length}件, 場所${places.length}件, アクション${actions.length}件`);

        } catch (error) {
            console.error(error);
            showStatus('読み込みエラー: ' + error.message, 'error');
        }
    }

    function updateModelSelect() {
        const select = document.getElementById('model');
        select.innerHTML = '<option value="">-- モデルを選択 --</option>';
        Object.keys(models).forEach(modelId => {
            const option = document.createElement('option');
            option.value = modelId;
            option.textContent = models[modelId].name;
            select.appendChild(option);
        });

        // 保存されたモデルまたは最初のモデルを選択
        const savedModelId = localStorage.getItem(STORAGE_KEYS.TRANSITION_SELECTED_MODEL);
        if (savedModelId && models[savedModelId]) {
            select.value = savedModelId;
        } else if (Object.keys(models).length > 0) {
            select.value = Object.keys(models)[0];
        }
        applyModelDefaults();
    }

    function updateCharacterSelect() {
        const select = document.getElementById('character');
        select.innerHTML = '<option value="">（なし）</option>';
        characters.forEach((char, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = char.name + (char.series ? ` (${char.series})` : '');
            select.appendChild(option);
        });
    }

    function updatePlaceSelect() {
        const select = document.getElementById('place');
        select.innerHTML = '<option value="">（なし）</option>';
        places.forEach((place, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = place.name;
            select.appendChild(option);
        });
    }

    function updateActionSelect() {
        const select = document.getElementById('action');
        select.innerHTML = '<option value="">（なし）</option>';
        actions.forEach((action, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = action.name;
            select.appendChild(option);
        });
    }

    function updateCostumeSelect() {
        const select = document.getElementById('costume');
        select.innerHTML = '<option value="">（なし）</option>';
        costumes.forEach((costume, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = costume.name;
            select.appendChild(option);
        });
    }

    function updateRelationshipSelect() {
        const select = document.getElementById('relationship');
        select.innerHTML = '<option value="">（なし）</option>';
        relationships.forEach((rel, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = rel.name + (rel.expression ? ` [${rel.expression}]` : '');
            select.appendChild(option);
        });
    }

    // 選択データ取得ヘルパー
    function getSelectedModelData(prop) {
        const id = document.getElementById('model').value;
        return (id && models[id]) ? (models[id][prop] || '') : '';
    }

    function getSelectedData(selectId, dataArray, prop) {
        const idx = document.getElementById(selectId).value;
        return (idx !== '' && dataArray[idx]) ? (dataArray[idx][prop] || '') : '';
    }

    function getSelectedObject(selectId, dataArray) {
        const idx = document.getElementById(selectId).value;
        return (idx !== '' && dataArray[idx]) ? dataArray[idx] : null;
    }

    function applyModelDefaults() {
        const modelId = document.getElementById('model').value;
        if (modelId) {
            localStorage.setItem(STORAGE_KEYS.TRANSITION_SELECTED_MODEL, modelId);
        }
        updatePromptPreview();
    }

    function updateActionPrompt() {
        const index = document.getElementById('action').value;
        const compositions = (index !== '' && actions[index]) ? actions[index].compositions : [];
        updateCompositionSelect(compositions);
        updatePromptPreview();
    }

    function updateCompositionSelect(compositions) {
        const select = document.getElementById('composition');
        const previousValue = select.value;
        select.innerHTML = '<option value="">（なし）</option>';

        if (compositions && compositions.length > 0) {
            // BESTオプションを追加
            const bestOption = document.createElement('option');
            bestOption.value = 'BEST';
            bestOption.textContent = 'BEST（自動選択）';
            select.appendChild(bestOption);

            // 個別の構図を追加
            compositions.forEach((comp, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = comp.name + (comp.quality ? ` [${comp.quality}]` : '');
                select.appendChild(option);
            });

            // 以前BESTだった場合は維持、そうでなければデフォルトでBEST
            if (previousValue === 'BEST' || previousValue === '') {
                select.value = 'BEST';
            } else {
                const prevIndex = parseInt(previousValue);
                if (!isNaN(prevIndex) && prevIndex < compositions.length) {
                    select.value = prevIndex;
                } else {
                    select.value = 'BEST';
                }
            }
        }
    }

    function getSelectedCompositionTag() {
        const actionIndex = document.getElementById('action').value;
        const compValue = document.getElementById('composition').value;

        if (actionIndex !== '' && compValue !== '' && actions[actionIndex]) {
            const compositions = actions[actionIndex].compositions;

            if (compValue === 'BEST') {
                const selected = selectBestComposition(compositions);
                return selected?.tag || selected?.name || '';
            }

            const compIndex = parseInt(compValue);
            if (compositions && compositions[compIndex]) {
                return compositions[compIndex].tag || compositions[compIndex].name || '';
            }
        }
        return '';
    }

    // キャラクターオブジェクトに服装・表情を追加して取得
    function getSelectedCharacterWithExtras() {
        const character = getSelectedObject('character', characters);
        if (!character) return null;

        const costume = getSelectedObject('costume', costumes);
        const relationship = getSelectedObject('relationship', relationships);

        return {
            ...character,
            clothes: costume?.tag || '',
            camel: costume?.camel_tag || '',
            expression: relationship?.expression || ''
        };
    }

    function buildPrompt() {
        const parts = [
            getSelectedModelData('qualityPositive'),
            getSelectedData('character', characters, 'tag'),
            getSelectedData('place', places, 'tag'),
            getSelectedData('action', actions, 'prompt'),
            getSelectedCompositionTag(),
            document.getElementById('customPrompt').value.trim(),
            getSelectedData('place', places, 'additionalTag'),
            getSelectedData('character', characters, 'additionalTag')
        ].filter(p => p);
        return cleanPrompt(parts.join(', '));
    }

    function buildNegativePrompt() {
        return getSelectedModelData('qualityNegative');
    }

    function updatePromptPreview() {
        const prompt = buildPrompt();
        const characterWithExtras = getSelectedCharacterWithExtras();
        const finalPrompt = buildFinalPrompt(prompt, characterWithExtras);
        document.getElementById('promptPreview').textContent = finalPrompt || '--';
        document.getElementById('negativePreview').textContent = buildNegativePrompt() || '--';
    }

    async function handleGenerateImage() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return;
        }

        const modelId = document.getElementById('model').value;
        if (!modelId) {
            alert('モデルを選択してください');
            return;
        }

        doSaveSettings();

        const model = models[modelId];
        const prompt = buildPrompt();
        const characterWithExtras = getSelectedCharacterWithExtras();
        const finalPrompt = buildFinalPrompt(prompt, characterWithExtras);
        const negativePrompt = buildNegativePrompt();
        const steps = model?.steps || 20;
        const cfgScale = model?.cfgScale || 7;
        const scheduler = model?.scheduler || 'Default';
        const width = parseInt(document.getElementById('width').value);
        const height = parseInt(document.getElementById('height').value);
        let seed = parseInt(document.getElementById('seed').value);
        if (seed === -1) seed = undefined;

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.textContent = '生成中...';

        const resultContainer = document.getElementById('result-container');
        resultContainer.innerHTML = '<div class="result-placeholder">生成中...</div>';

        const startTime = Date.now();

        try {
            const result = await generateImage(apiKey, modelId, finalPrompt, {
                negativePrompt: negativePrompt,
                steps: steps,
                cfgScale: cfgScale,
                scheduler: scheduler,
                width: width,
                height: height,
                seed: seed,
                character: characterWithExtras
            });

            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

            resultContainer.innerHTML = `<img src="${result.imageURL}" alt="Generated Image" onclick="window.open('${result.imageURL}', '_blank')">`;

            const infoDiv = document.getElementById('generation-info');
            infoDiv.style.display = 'block';

            // 選択情報を表示
            const charName = getSelectedData('character', characters, 'name') || 'なし';
            const placeName = getSelectedData('place', places, 'name') || 'なし';
            const actionName = getSelectedData('action', actions, 'name') || 'なし';
            const costumeName = getSelectedData('costume', costumes, 'name') || 'なし';
            const relName = getSelectedData('relationship', relationships, 'name') || 'なし';

            infoDiv.innerHTML = `
                <div><strong>モデル:</strong> ${model?.name || modelId}</div>
                <div><strong>キャラ:</strong> ${charName} | <strong>場所:</strong> ${placeName}</div>
                <div><strong>アクション:</strong> ${actionName} | <strong>服装:</strong> ${costumeName}</div>
                <div><strong>関係性:</strong> ${relName}</div>
                <div><strong>Seed:</strong> ${result.seed} | <strong>Steps:</strong> ${steps} | <strong>CFG:</strong> ${cfgScale}</div>
                <div><strong>生成時間:</strong> ${elapsed}秒</div>
            `;

        } catch (error) {
            console.error(error);
            resultContainer.innerHTML = `<div class="result-placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = '画像生成';
        }
    }

    // モデル選択時にデフォルト適用
    document.getElementById('model').addEventListener('change', applyModelDefaults);

    // 戻る/閉じる処理
    function closeOrBack() {
        // 新しいタブで開かれた場合（履歴がない場合）はタブを閉じる
        if (window.history.length <= 1 || document.referrer === '') {
            window.close();
            // window.close() が効かない場合（一部ブラウザ）はメッセージ表示
            setTimeout(() => {
                alert('このタブを閉じてゲームに戻ってください');
            }, 100);
        } else {
            history.back();
        }
    }
</script>

</body>
</html>
