<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generator (詳細設定)</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        /* 固定ヘッダーバー */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .fixed-header .btn-back {
            background: #333;
            color: #ccc;
            border: 1px solid #555;
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .fixed-header .btn-back:hover {
            background: #444;
            color: #fff;
        }

        .fixed-header .header-thumbnail {
            width: 50px;
            height: 50px;
            background: #111;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fixed-header .header-thumbnail img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: all 0.3s ease;
        }

        .fixed-header .thumbnail-placeholder {
            color: #555;
            font-size: 0.75rem;
        }

        /* 拡大時のスタイル */
        .fixed-header.expanded {
            flex-direction: column;
            padding: 10px 20px 15px 20px;
        }

        .fixed-header.expanded .header-row {
            display: flex;
            width: 100%;
            align-items: center;
            gap: 15px;
        }

        /* 展開画像エリア（通常時は非表示） */
        .fixed-header .expanded-image {
            display: none;
        }

        .fixed-header.expanded .expanded-image {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 15px;
        }

        .fixed-header.expanded .expanded-image img {
            max-width: 90vw;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 4px;
        }

        .fixed-header.expanded .expanded-image .no-image-message {
            color: #666;
            font-size: 0.9rem;
        }

        .fixed-header .header-row {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .fixed-header .header-spacer {
            flex: 1;
        }

        .fixed-header .header-buttons {
            display: flex;
            gap: 10px;
        }

        .fixed-header .btn {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        /* ページ固有スタイル */
        .container {
            padding-top: 60px; /* 固定ヘッダー分の余白 */
            transition: padding-top 0.3s ease;
        }


        #status { margin-top: 10px; }

        .btn-generate { font-size: 16px; padding: 12px 30px; }

        .main-content {
            display: block;
        }

        /* 2ペインレイアウト（横幅が広い場合） */
        .two-pane-container {
            display: block;
        }

        /* 左ペイン生成結果エリア（デフォルト非表示） */
        .left-pane-result {
            display: none;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .left-pane-result img {
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
        }

        .left-pane-result .result-placeholder {
            color: #666;
            text-align: center;
            padding: 40px 20px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: none;
            }

            .two-pane-container {
                display: grid;
                grid-template-columns: 3fr 7fr;
                gap: 20px;
            }

            .left-pane, .right-pane {
                min-width: 0;
            }

            .right-pane {
                max-height: calc(100vh - 100px);
                overflow-y: auto;
                container-type: inline-size;
                padding-right: 10px;
            }

            /* 2ペイン時: ヘッダーサムネイルを非表示、左ペイン結果を表示 */
            .fixed-header .header-thumbnail {
                display: none !important;
            }

            .left-pane-result {
                display: block;
            }

            .character-edit-section {
                margin-top: 0 !important;
                padding-top: 0 !important;
                border-top: none !important;
            }
        }

        .panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            margin: 0 0 15px 0;
            color: #4a9eff;
            font-size: 1.1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a2a2a;
            color: #fff;
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .result-panel {
            display: flex;
            flex-direction: column;
        }

        #result-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            border-radius: 4px;
            padding: 10px;
        }

        #result-container img {
            max-width: 100%;
            border-radius: 4px;
            cursor: pointer;
        }

        .result-placeholder {
            color: #666;
            text-align: center;
        }

        .generation-info {
            margin-top: 10px;
            padding: 10px;
            background: #222;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #888;
        }

        .prompt-preview {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 10px;
            word-break: break-word;
        }

        .prompt-preview strong {
            color: #4a9eff;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 15px;
            color: #4a9eff;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* キャラクター編集セクション */
        .character-edit-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        .character-edit-section h2 {
            color: #4a9eff;
            font-size: 1.1rem;
            margin: 0 0 15px 0;
        }

        .edit-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .edit-layout { grid-template-columns: 1fr; }
        }

        /* コンテナクエリ: 右ペインの幅に応じてレイアウト変更 */
        @container (max-width: 750px) {
            .edit-layout { grid-template-columns: 1fr; }
        }

        .edit-image-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .edit-image-area {
            width: 100%;
            aspect-ratio: 1 / 1;
            max-height: 400px;
            background: #111;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .edit-image-area img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
        }

        .edit-image-area .placeholder {
            color: #666;
            font-size: 0.9rem;
        }

        .edit-fields-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .edit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 700px) {
            .edit-grid { grid-template-columns: 1fr; }
        }

        .edit-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .field-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .field-row label {
            font-size: 0.8rem;
            color: #888;
        }

        .field-row input,
        .field-row textarea,
        .field-row select {
            padding: 8px 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a2a2a;
            color: #fff;
            font-size: 0.9rem;
        }

        .field-row textarea {
            min-height: 60px;
            resize: vertical;
        }

        .field-row input:focus,
        .field-row textarea:focus,
        .field-row select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .field-id {
            font-size: 0.8rem;
            color: #4a9eff;
        }

        .edit-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-save-char {
            background: #2a4a2a;
            color: #8f8;
            border: 1px solid #4a4;
        }

        .btn-save-char:hover {
            background: #3a5a3a;
        }

        .no-character-message {
            color: #888;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        /* アクション編集セクション */
        .action-edit-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        .action-edit-section h2 {
            color: #4a9eff;
            font-size: 1.1rem;
            margin: 0 0 15px 0;
        }

        .action-fields-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .prompt-field {
            grid-column: 1 / -1;
        }

        .prompt-field textarea {
            min-height: 80px;
        }

        /* 構図セクション */
        .composition-section {
            border-top: 1px solid #333;
            padding-top: 20px;
            margin-top: 20px;
        }

        .composition-title {
            color: #4a9eff;
            margin: 0 0 15px 0;
            font-size: 1rem;
        }

        .composition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 160px);
            gap: 15px;
        }

        .composition-item {
            text-align: center;
            width: 160px;
        }

        .composition-label {
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 6px;
        }

        .composition-quality {
            margin-bottom: 6px;
            display: flex;
            gap: 2px;
        }

        .quality-btn {
            flex: 1;
            padding: 3px 2px;
            border: 1px solid #444;
            background: #222;
            color: #888;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quality-btn:first-child {
            border-radius: 4px 0 0 4px;
        }

        .quality-btn:last-child {
            border-radius: 0 4px 4px 0;
        }

        .quality-btn:hover:not(.active) {
            background: #333;
        }

        .quality-btn.active {
            cursor: default;
        }

        .quality-btn.active-none {
            background: #555;
            color: #fff;
            border-color: #666;
        }

        .quality-btn.active-ng {
            background: #c0392b;
            color: #fff;
            border-color: #e74c3c;
        }

        .quality-btn.active-good {
            background: #d68910;
            color: #fff;
            border-color: #f39c12;
        }

        .quality-btn.active-best {
            background: #1e8449;
            color: #fff;
            border-color: #27ae60;
        }

        .composition-image {
            width: 100%;
            aspect-ratio: 1;
            background: #111;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 6px;
            overflow: hidden;
        }

        .composition-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .composition-image .placeholder {
            color: #666;
            font-size: 0.7rem;
        }

        .composition-image.disabled {
            opacity: 0.3;
        }

        .composition-tag-input {
            width: 100%;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid #333;
            background: #222;
            color: #e0e0e0;
            font-size: 0.65rem;
            margin-bottom: 6px;
            box-sizing: border-box;
        }

        .composition-tag-input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .btn-small {
            font-size: 0.7rem;
            padding: 4px 8px;
        }

        .no-action-message {
            color: #888;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        .btn-save-action {
            background: #2a4a2a;
            color: #8f8;
            border: 1px solid #4a4;
        }

        .btn-save-action:hover {
            background: #3a5a3a;
        }

        /* 場所編集セクション */
        .place-edit-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        .place-edit-section h2 {
            color: #4a9eff;
            font-size: 1.1rem;
            margin: 0 0 15px 0;
        }

        .place-fields-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .tag-field {
            grid-column: 1 / -1;
        }

        .tag-field textarea {
            min-height: 60px;
        }

        .no-place-message {
            color: #888;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        .btn-save-place {
            background: #2a4a2a;
            color: #8f8;
            border: 1px solid #4a4;
        }

        .btn-save-place:hover {
            background: #3a5a3a;
        }
    </style>
</head>
<body>

<!-- 固定ヘッダーバー -->
<div class="fixed-header" id="fixedHeader">
    <div class="header-row">
        <button class="btn btn-back" onclick="closeOrBack()">戻る</button>
        <div id="result-container" class="header-thumbnail" onclick="toggleHeaderExpand(event)">
            <div class="thumbnail-placeholder">--</div>
        </div>
        <div class="header-spacer"></div>
        <div class="header-buttons">
            <button class="btn btn-generate" onclick="handleGenerateImage()" id="generateBtn">生成</button>
            <button class="btn btn-save-action" id="saveBtn" onclick="saveAllToGas()">保存</button>
        </div>
    </div>
    <div id="expanded-image-container" class="expanded-image"></div>
</div>

<div class="container">
    <div class="two-pane-container">
        <div class="left-pane">
            <!-- 2ペイン時の生成結果表示エリア -->
            <div id="left-pane-result" class="left-pane-result">
                <div class="result-placeholder">生成結果がここに表示されます</div>
            </div>
            <div class="main-content">
                <div class="panel">
                    <h2>生成設定</h2>

            <div class="form-group">
                <label>モデル</label>
                <select id="model" onchange="applyModelDefaults()">
                    <option value="">-- モデルを選択 --</option>
                </select>
            </div>

            <div class="form-group">
                <label>キャラクター</label>
                <select id="character" onchange="onCharacterChange()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>場所</label>
                <select id="place" onchange="onPlaceChange()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>アクション</label>
                <select id="action" onchange="updateActionPrompt()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-group">
                <label>構図</label>
                <select id="composition" onchange="updatePromptPreview()">
                    <option value="">（なし）</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>服装</label>
                    <select id="costume" onchange="updatePromptPreview()">
                        <option value="">（なし）</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>関係性（表情）</label>
                    <select id="relationship" onchange="updatePromptPreview()">
                        <option value="">（なし）</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>追加プロンプト</label>
                <textarea id="customPrompt" placeholder="追加のプロンプトを入力" oninput="updatePromptPreview()"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>幅</label>
                    <input type="number" id="width" value="1024" min="512" max="2048" step="64">
                </div>
                <div class="form-group">
                    <label>高さ</label>
                    <input type="number" id="height" value="1024" min="512" max="2048" step="64">
                </div>
            </div>

            <div class="form-group">
                <label>Seed (-1=ランダム)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="seed" value="-1" style="flex: 1;">
                    <button class="btn btn-small" style="background: #555; color: #fff;" onclick="document.getElementById('seed').value = -1">-1</button>
                </div>
            </div>

            <div class="prompt-preview">
                <strong>プロンプトプレビュー:</strong><br>
                <span id="promptPreview" style="color: #27ae60;">--</span>
                <br><br>
                <strong>ネガティブ:</strong><br>
                <span id="negativePreview" style="color: #e74c3c;">--</span>
            </div>

                </div>
            </div>

            <div class="settings-bar" style="margin-top: 20px;">
                <div class="settings-row">
                    <label>GAS URL:</label>
                    <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
                    <button class="btn btn-primary" onclick="loadAllFromGas()">GASから読み込み</button>
                </div>
                <div class="settings-row">
                    <label>画像アップロードGAS URL:</label>
                    <input type="text" id="imageUploadUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec (画像保存用)">
                </div>
                <div class="settings-row">
                    <label>Runware API Key:</label>
                    <input type="password" id="apiKey" placeholder="Runware API Keyを入力">
                </div>
                <div id="status"></div>
            </div>
        </div>

        <div class="right-pane">
            <!-- キャラクター編集セクション -->
            <div class="character-edit-section" id="characterEditSection">
                <h2>キャラクター詳細編集</h2>
                <div id="characterEditContent">
                    <div class="no-character-message">キャラクターを選択してください</div>
                </div>
            </div>

            <!-- アクション編集セクション -->
            <div class="action-edit-section" id="actionEditSection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 style="margin: 0;">アクション詳細編集</h2>
                    <button class="btn" onclick="copyAndCreateNewAction()" style="padding: 5px 10px; font-size: 0.85rem; background: #2a4a6a; color: #8cf; border: 1px solid #4a6a8a;">コピーして新規アクション作成</button>
                </div>
                <div id="actionEditContent">
                    <div class="no-action-message">アクションを選択してください</div>
                </div>
            </div>

            <!-- 場所編集セクション -->
            <div class="place-edit-section" id="placeEditSection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 style="margin: 0;">場所詳細編集</h2>
                    <button class="btn" onclick="copyAndCreateNewPlace()" style="padding: 5px 10px; font-size: 0.85rem; background: #2a4a6a; color: #8cf; border: 1px solid #4a6a8a;">コピーして新規場所作成</button>
                </div>
                <div id="placeEditContent">
                    <div class="no-place-message">場所を選択してください</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/prompt-utils.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script>
    // ストレージキー（test_transition.htmlと共通）
    const CACHE_KEY = STORAGE_KEYS.TRANSITION_CACHE;
    const COMPOSITION_IMAGES_KEY = 'setting_composition_images';

    // 品質オプション
    const QUALITY_OPTIONS = [
        { value: '未評価', label: '未評価', activeClass: 'active-none' },
        { value: 'NG', label: 'NG', activeClass: 'active-ng' },
        { value: 'good', label: 'GOOD', activeClass: 'active-good' },
        { value: 'best', label: 'BEST', activeClass: 'active-best' }
    ];

    // データストア
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let relationships = [];
    let costumes = [];
    let personalities = [];
    let promptTemplates = {};
    let compositionImages = {}; // アクションID -> { 構図名: imageUrl }

    // URLパラメータから初期値を取得
    const urlParams = new URLSearchParams(window.location.search);
    const initialParams = {
        characterId: urlParams.get('characterId'),
        placeId: urlParams.get('placeId'),
        actionId: urlParams.get('actionId'),
        costumeId: urlParams.get('costumeId'),
        relationshipId: urlParams.get('relationshipId'),
        compositionIndex: urlParams.get('compositionIndex'),
        seed: urlParams.get('seed'),
        imageUrl: urlParams.get('imageUrl')
    };

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
        // 設定を読み込み（test_transition.htmlと共通のストレージ）
        const gasUrl = localStorage.getItem(STORAGE_KEYS.GAS_URL);
        if (gasUrl) {
            document.getElementById('gasUrl').value = gasUrl;
        }
        const imageUploadUrl = localStorage.getItem(STORAGE_KEYS.IMAGE_UPLOAD_URL);
        if (imageUploadUrl) {
            document.getElementById('imageUploadUrl').value = imageUploadUrl;
        }
        const apiKey = localStorage.getItem(STORAGE_KEYS.TRANSITION_RUNWARE_API_KEY);
        if (apiKey) {
            document.getElementById('apiKey').value = apiKey;
        }

        // キャッシュからデータを読み込み
        loadCachedData();

        // シードがあれば設定
        if (initialParams.seed) {
            document.getElementById('seed').value = initialParams.seed;
        }
    });

    // キャッシュデータを読み込み
    function loadCachedData() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
                relationships = data.relationships || [];
                costumes = data.costumes || [];
                personalities = data.personalities || [];
                promptTemplates = data.promptTemplates || {};

                updateAllSelects();
                applyInitialParams();
                showStatus(`キャッシュから復元: モデル${Object.keys(models).length}件, キャラ${characters.length}件`);
            }

            // 構図画像キャッシュを読み込み
            const cachedCompImages = localStorage.getItem(COMPOSITION_IMAGES_KEY);
            if (cachedCompImages) {
                compositionImages = JSON.parse(cachedCompImages);
            }
        } catch (e) {
            console.error('Cache load error:', e);
        }
    }

    // キャッシュデータを保存
    function saveCachedData() {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
            models, characters, places, actions, relationships, costumes, personalities, promptTemplates
        }));
        localStorage.setItem(COMPOSITION_IMAGES_KEY, JSON.stringify(compositionImages));
    }

    // 全セレクトボックスを更新
    function updateAllSelects() {
        updateModelSelect();
        updateCharacterSelect();
        updatePlaceSelect();
        updateActionSelect();
        updateCostumeSelect();
        updateRelationshipSelect();
    }

    // URLパラメータから初期値を適用
    function applyInitialParams() {
        // モデル（保存された選択を復元）
        const savedModelId = localStorage.getItem(STORAGE_KEYS.TRANSITION_SELECTED_MODEL);
        if (savedModelId && models[savedModelId]) {
            document.getElementById('model').value = savedModelId;
        }

        // キャラクター
        if (initialParams.characterId) {
            const charIndex = characters.findIndex(c => c.character_id === initialParams.characterId);
            if (charIndex >= 0) {
                document.getElementById('character').value = charIndex;
            }
        }

        // 場所
        if (initialParams.placeId) {
            const placeIndex = places.findIndex(p => p.place_id === initialParams.placeId);
            if (placeIndex >= 0) {
                document.getElementById('place').value = placeIndex;
            }
        }

        // アクション
        if (initialParams.actionId) {
            const actionIndex = actions.findIndex(a => a.action_id === initialParams.actionId);
            if (actionIndex >= 0) {
                document.getElementById('action').value = actionIndex;
                updateActionPrompt(); // 構図リストを更新
            }
        }

        // 構図（アクション設定後に適用）
        if (initialParams.compositionIndex !== null) {
            const compSelect = document.getElementById('composition');
            const compIndex = parseInt(initialParams.compositionIndex);
            if (!isNaN(compIndex) && compIndex < compSelect.options.length) {
                compSelect.value = compIndex;
            }
        }

        // 服装
        if (initialParams.costumeId) {
            const costumeIndex = costumes.findIndex(c => c.costume_id === initialParams.costumeId);
            if (costumeIndex >= 0) {
                document.getElementById('costume').value = costumeIndex;
            }
        }

        // 関係性
        if (initialParams.relationshipId) {
            const relIndex = relationships.findIndex(r => r.relationship_id === initialParams.relationshipId);
            if (relIndex >= 0) {
                document.getElementById('relationship').value = relIndex;
            }
        }

        // URLパラメータから渡された画像を表示
        if (initialParams.imageUrl) {
            const resultContainer = document.getElementById('result-container');
            const leftPaneResult = document.getElementById('left-pane-result');
            resultContainer.innerHTML = `<img src="${initialParams.imageUrl}" alt="Generated Image">`;
            leftPaneResult.innerHTML = `<img src="${initialParams.imageUrl}" alt="Generated Image" onclick="window.open('${initialParams.imageUrl}', '_blank')">`;
        }

        updatePromptPreview();
        updateCharacterEditUI();
        updateActionEditUI();
        updatePlaceEditUI();
    }

    // 設定を保存
    function doSaveSettings() {
        const gasUrl = document.getElementById('gasUrl').value.trim();
        const imageUploadUrl = document.getElementById('imageUploadUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        if (gasUrl) localStorage.setItem(STORAGE_KEYS.GAS_URL, gasUrl);
        if (imageUploadUrl) localStorage.setItem(STORAGE_KEYS.IMAGE_UPLOAD_URL, imageUploadUrl);
        if (apiKey) localStorage.setItem(STORAGE_KEYS.TRANSITION_RUNWARE_API_KEY, apiKey);
    }

    // GASから全データ読み込み
    async function loadAllFromGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        doSaveSettings();
        showStatus('読み込み中...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData, relationshipData, costumeData, personalityData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action'),
                fetchGasData(baseUrl, 'relationship'),
                fetchGasData(baseUrl, 'costume'),
                fetchGasData(baseUrl, 'personality')
            ]);

            models = parseModels(modelData);
            characters = parseCharacters(characterData);
            places = parsePlaces(placeData);
            actions = parseActionsWithCompositions(actionData);
            relationships = parseRelationships(relationshipData);
            costumes = parseCostumes(costumeData);
            personalities = parsePersonalities(personalityData);

            saveCachedData();
            updateAllSelects();
            applyInitialParams();

            showStatus(`読み込み完了: モデル${Object.keys(models).length}件, キャラ${characters.length}件, 場所${places.length}件, アクション${actions.length}件`);

        } catch (error) {
            console.error(error);
            showStatus('読み込みエラー: ' + error.message, 'error');
        }
    }

    function updateModelSelect() {
        const select = document.getElementById('model');
        select.innerHTML = '<option value="">-- モデルを選択 --</option>';
        Object.keys(models).forEach(modelId => {
            const option = document.createElement('option');
            option.value = modelId;
            option.textContent = models[modelId].name;
            select.appendChild(option);
        });

        // 保存されたモデルまたは最初のモデルを選択
        const savedModelId = localStorage.getItem(STORAGE_KEYS.TRANSITION_SELECTED_MODEL);
        if (savedModelId && models[savedModelId]) {
            select.value = savedModelId;
        } else if (Object.keys(models).length > 0) {
            select.value = Object.keys(models)[0];
        }
        applyModelDefaults();
    }

    function updateCharacterSelect() {
        const select = document.getElementById('character');
        select.innerHTML = '<option value="">（なし）</option>';
        characters.forEach((char, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = char.name + (char.series ? ` (${char.series})` : '');
            select.appendChild(option);
        });
    }

    function updatePlaceSelect() {
        const select = document.getElementById('place');
        select.innerHTML = '<option value="">（なし）</option>';
        places.forEach((place, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = place.name;
            select.appendChild(option);
        });
    }

    function updateActionSelect() {
        const select = document.getElementById('action');
        select.innerHTML = '<option value="">（なし）</option>';
        actions.forEach((action, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = action.name;
            select.appendChild(option);
        });
    }

    function updateCostumeSelect() {
        const select = document.getElementById('costume');
        select.innerHTML = '<option value="">（なし）</option>';
        costumes.forEach((costume, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = costume.name;
            select.appendChild(option);
        });
    }

    function updateRelationshipSelect() {
        const select = document.getElementById('relationship');
        select.innerHTML = '<option value="">（なし）</option>';
        relationships.forEach((rel, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = rel.name + (rel.expression ? ` [${rel.expression}]` : '');
            select.appendChild(option);
        });
    }

    // 選択データ取得ヘルパー
    function getSelectedModelData(prop) {
        const id = document.getElementById('model').value;
        return (id && models[id]) ? (models[id][prop] || '') : '';
    }

    function getSelectedData(selectId, dataArray, prop) {
        const idx = document.getElementById(selectId).value;
        return (idx !== '' && dataArray[idx]) ? (dataArray[idx][prop] || '') : '';
    }

    function getSelectedObject(selectId, dataArray) {
        const idx = document.getElementById(selectId).value;
        return (idx !== '' && dataArray[idx]) ? dataArray[idx] : null;
    }

    function applyModelDefaults() {
        const modelId = document.getElementById('model').value;
        if (modelId) {
            localStorage.setItem(STORAGE_KEYS.TRANSITION_SELECTED_MODEL, modelId);
        }
        updatePromptPreview();
    }

    function updateActionPrompt() {
        const index = document.getElementById('action').value;
        const compositions = (index !== '' && actions[index]) ? actions[index].compositions : [];
        updateCompositionSelect(compositions);
        updatePromptPreview();
        updateActionEditUI();
    }

    function updateCompositionSelect(compositions) {
        const select = document.getElementById('composition');
        const previousValue = select.value;
        select.innerHTML = '<option value="">（なし）</option>';

        if (compositions && compositions.length > 0) {
            // BESTオプションを追加
            const bestOption = document.createElement('option');
            bestOption.value = 'BEST';
            bestOption.textContent = 'BEST（自動選択）';
            select.appendChild(bestOption);

            // 個別の構図を追加（NG以外）
            compositions.forEach((comp, index) => {
                // NGは選択肢から除外
                if (comp.quality === 'NG') return;

                const option = document.createElement('option');
                option.value = index;
                option.textContent = comp.name + (comp.quality ? ` [${comp.quality}]` : '');
                select.appendChild(option);
            });

            // 以前BESTだった場合は維持、そうでなければデフォルトでBEST
            if (previousValue === 'BEST' || previousValue === '') {
                select.value = 'BEST';
            } else {
                const prevIndex = parseInt(previousValue);
                if (!isNaN(prevIndex) && prevIndex < compositions.length) {
                    select.value = prevIndex;
                } else {
                    select.value = 'BEST';
                }
            }
        }
    }

    function getSelectedCompositionTag() {
        const actionIndex = document.getElementById('action').value;
        const compValue = document.getElementById('composition').value;

        if (actionIndex !== '' && compValue !== '' && actions[actionIndex]) {
            const compositions = actions[actionIndex].compositions;

            if (compValue === 'BEST') {
                const selected = selectBestComposition(compositions);
                return selected?.tag || selected?.name || '';
            }

            const compIndex = parseInt(compValue);
            if (compositions && compositions[compIndex]) {
                return compositions[compIndex].tag || compositions[compIndex].name || '';
            }
        }
        return '';
    }

    // キャラクターオブジェクトに服装・表情を追加して取得
    function getSelectedCharacterWithExtras() {
        const character = getSelectedObject('character', characters);
        if (!character) return null;

        const costume = getSelectedObject('costume', costumes);
        const relationship = getSelectedObject('relationship', relationships);

        return {
            ...character,
            clothes: costume?.tag || '',
            camel: costume?.camel_tag || '',
            expression: relationship?.expression || ''
        };
    }

    function buildPrompt() {
        const parts = [
            getSelectedModelData('qualityPositive'),
            getSelectedData('character', characters, 'tag'),
            getSelectedData('place', places, 'tag'),
            getSelectedData('action', actions, 'prompt'),
            getSelectedCompositionTag(),
            document.getElementById('customPrompt').value.trim(),
            getSelectedData('place', places, 'additionalTag'),
            getSelectedData('character', characters, 'additionalTag')
        ].filter(p => p);
        return cleanPrompt(parts.join(', '));
    }

    function buildNegativePrompt() {
        return getSelectedModelData('qualityNegative');
    }

    function updatePromptPreview() {
        const prompt = buildPrompt();
        const characterWithExtras = getSelectedCharacterWithExtras();
        const finalPrompt = buildFinalPrompt(prompt, characterWithExtras);
        document.getElementById('promptPreview').textContent = finalPrompt || '--';
        document.getElementById('negativePreview').textContent = buildNegativePrompt() || '--';
    }

    async function handleGenerateImage() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return;
        }

        const modelId = document.getElementById('model').value;
        if (!modelId) {
            alert('モデルを選択してください');
            return;
        }

        doSaveSettings();

        const model = models[modelId];
        const prompt = buildPrompt();
        const characterWithExtras = getSelectedCharacterWithExtras();
        const finalPrompt = buildFinalPrompt(prompt, characterWithExtras);
        const negativePrompt = buildNegativePrompt();
        const steps = model?.steps || 20;
        const cfgScale = model?.cfgScale || 7;
        const scheduler = model?.scheduler || 'Default';
        const width = parseInt(document.getElementById('width').value);
        const height = parseInt(document.getElementById('height').value);
        let seed = parseInt(document.getElementById('seed').value);
        if (seed === -1) seed = undefined;

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.textContent = '生成中...';

        const resultContainer = document.getElementById('result-container');
        const leftPaneResult = document.getElementById('left-pane-result');
        resultContainer.innerHTML = '<div class="thumbnail-placeholder">...</div>';
        leftPaneResult.innerHTML = '<div class="result-placeholder">生成中...</div>';

        try {
            const result = await generateImage(apiKey, modelId, finalPrompt, {
                negativePrompt: negativePrompt,
                steps: steps,
                cfgScale: cfgScale,
                scheduler: scheduler,
                width: width,
                height: height,
                seed: seed,
                character: characterWithExtras
            });

            resultContainer.innerHTML = `<img src="${result.imageURL}" alt="Generated Image" title="Seed: ${result.seed}">`;
            leftPaneResult.innerHTML = `<img src="${result.imageURL}" alt="Generated Image" title="Seed: ${result.seed}" onclick="window.open('${result.imageURL}', '_blank')">`;

        } catch (error) {
            console.error(error);
            const errorMsg = translateApiError(error.message);
            resultContainer.innerHTML = `<div class="thumbnail-placeholder" style="color: #e74c3c;">!</div>`;
            leftPaneResult.innerHTML = `<div class="result-placeholder" style="color: #e74c3c;">${escapeHtml(errorMsg)}</div>`;
            showStatus(errorMsg, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = '生成';
        }
    }

    // モデル選択時にデフォルト適用
    document.getElementById('model').addEventListener('change', applyModelDefaults);

    // キャラクター選択時
    function onCharacterChange() {
        updatePromptPreview();
        updateCharacterEditUI();
    }

    // 戻る/閉じる処理
    function closeOrBack() {
        // 新しいタブで開かれた場合（履歴がない場合）はタブを閉じる
        if (window.history.length <= 1 || document.referrer === '') {
            window.close();
            // window.close() が効かない場合（一部ブラウザ）はメッセージ表示
            setTimeout(() => {
                alert('このタブを閉じてゲームに戻ってください');
            }, 100);
        } else {
            history.back();
        }
    }

    // ヘッダー拡大/縮小トグル
    function toggleHeaderExpand(event) {
        const header = document.getElementById('fixedHeader');
        const expandedContainer = document.getElementById('expanded-image-container');
        const container = document.querySelector('.container');
        const isExpanding = !header.classList.contains('expanded');

        if (isExpanding) {
            // 展開時: サムネイルの画像を大きく表示
            const thumbnailImg = document.querySelector('#result-container img');
            if (thumbnailImg) {
                expandedContainer.innerHTML = `<img src="${thumbnailImg.src}" alt="生成結果" onclick="openImageInNewTab(event)">`;
            } else {
                expandedContainer.innerHTML = '<div class="no-image-message">画像がありません</div>';
            }
        }

        header.classList.toggle('expanded');
        document.body.classList.toggle('header-expanded');

        // ヘッダー高さに合わせてコンテナの余白を調整
        requestAnimationFrame(() => {
            if (header.classList.contains('expanded')) {
                const headerHeight = header.offsetHeight;
                container.style.paddingTop = (headerHeight + 10) + 'px';
            } else {
                container.style.paddingTop = '60px';
            }
        });
    }

    // 展開された大きな画像を新しいタブで開く
    function openImageInNewTab(event) {
        event.stopPropagation();
        const img = event.target;
        if (img && img.src) {
            window.open(img.src, '_blank');
        }
    }

    // キャラクター編集UIを更新
    function updateCharacterEditUI() {
        const charIdx = document.getElementById('character').value;
        const container = document.getElementById('characterEditContent');

        if (charIdx === '' || !characters[charIdx]) {
            container.innerHTML = '<div class="no-character-message">キャラクターを選択してください</div>';
            return;
        }

        const char = characters[charIdx];
        const imageUrl = char.image || '';

        container.innerHTML = `
            <div class="edit-layout">
                <div class="edit-image-section">
                    <div class="edit-image-area" id="edit-char-image">
                        ${imageUrl
                            ? `<img src="${imageUrl}" alt="${escapeHtml(char.name)}" onclick="window.open('${imageUrl}', '_blank')">`
                            : '<div class="placeholder">画像未設定</div>'
                        }
                    </div>
                    <button class="btn btn-generate" onclick="generateCharacterImage()">標準画像生成</button>
                </div>
                <div class="edit-fields-section">
                    <div class="edit-grid">
                        <div class="edit-column">
                            <div class="field-row">
                                <label>Character ID</label>
                                <span class="field-id">${char.character_id || '(未設定)'}</span>
                            </div>
                            <div class="field-row">
                                <label>名前</label>
                                <input type="text" id="edit-name" value="${escapeHtml(char.name || '')}" onchange="updateCharacterField('name', this.value)">
                            </div>
                            <div class="field-row">
                                <label>シリーズ</label>
                                <input type="text" id="edit-series" value="${escapeHtml(char.series || '')}" onchange="updateCharacterField('series', this.value)">
                            </div>
                            <div class="field-row">
                                <label>キャラタグ</label>
                                <input type="text" id="edit-tag" value="${escapeHtml(char.tag || '')}" onchange="updateCharacterField('tag', this.value)">
                            </div>
                            <div class="field-row">
                                <label>プロフィール</label>
                                <textarea id="edit-profile" onchange="updateCharacterField('profile', this.value)">${escapeHtml(char.profile || '')}</textarea>
                            </div>
                        </div>
                        <div class="edit-column">
                            <div class="field-row">
                                <label>ユニフォーム1</label>
                                <input type="text" id="edit-uniform1" value="${escapeHtml(char.uniform1 || '')}" onchange="updateCharacterField('uniform1', this.value)">
                            </div>
                            <div class="field-row">
                                <label>ユニフォーム2</label>
                                <input type="text" id="edit-uniform2" value="${escapeHtml(char.uniform2 || '')}" onchange="updateCharacterField('uniform2', this.value)">
                            </div>
                            <div class="field-row">
                                <label>Additional Tag</label>
                                <input type="text" id="edit-additionalTag" value="${escapeHtml(char.additionalTag || '')}" onchange="updateCharacterField('additionalTag', this.value)">
                            </div>
                            <div class="field-row">
                                <label>Cast</label>
                                <input type="text" id="edit-cast" value="${escapeHtml(char.cast || '')}" onchange="updateCharacterField('cast', this.value)">
                            </div>
                            <div class="field-row">
                                <label>Personality</label>
                                <select id="edit-personality" onchange="updateCharacterField('personality', this.value)">
                                    <option value="">-- 選択 --</option>
                                    ${personalities.map(p => `<option value="${p.personality_id}"${p.personality_id === char.personality ? ' selected' : ''}>${p.name || p.personality_id}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // HTML エスケープ
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // APIエラーメッセージを日本語に変換
    function translateApiError(message) {
        if (!message) return '不明なエラー';

        // よくあるエラーパターンを日本語に変換
        if (message.includes('sexual content involving minors')) {
            return 'コンテンツポリシー違反: 未成年に関する不適切なコンテンツが検出されました';
        }
        if (message.includes('safety policies') || message.includes('content policy')) {
            return 'コンテンツポリシー違反: 安全性ポリシーに違反するプロンプトが検出されました';
        }
        if (message.includes('Request blocked')) {
            return 'リクエストがブロックされました: プロンプトがポリシーに違反しています';
        }
        if (message.includes('Invalid API key') || message.includes('Unauthorized')) {
            return 'APIキーが無効です';
        }
        if (message.includes('Rate limit') || message.includes('Too many requests')) {
            return 'リクエスト制限: しばらく待ってから再試行してください';
        }
        if (message.includes('insufficient') || message.includes('credits') || message.includes('balance')) {
            return 'クレジット不足: アカウントの残高を確認してください';
        }
        if (message.includes('network') || message.includes('Network')) {
            return 'ネットワークエラー: 接続を確認してください';
        }
        if (message.includes('timeout') || message.includes('Timeout')) {
            return 'タイムアウト: リクエストがタイムアウトしました';
        }

        // 変換できない場合は元のメッセージを返す
        return message;
    }

    // キャラクターフィールドを更新
    function updateCharacterField(field, value) {
        const charIdx = document.getElementById('character').value;
        if (charIdx === '' || !characters[charIdx]) return;

        characters[charIdx][field] = value;
        saveCachedData();

        // 名前が変わった場合はセレクトボックスも更新
        if (field === 'name') {
            updateCharacterSelect();
            document.getElementById('character').value = charIdx;
        }

        // プロンプトプレビューを更新
        updatePromptPreview();
    }

    // 標準キャラクター画像を生成
    async function generateCharacterImage() {
        const charIdx = document.getElementById('character').value;
        if (charIdx === '' || !characters[charIdx]) {
            alert('キャラクターを選択してください');
            return;
        }

        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return;
        }

        const modelId = document.getElementById('model').value;
        if (!modelId || !models[modelId]) {
            alert('モデルを選択してください');
            return;
        }

        const char = characters[charIdx];
        const model = models[modelId];
        const imageDiv = document.getElementById('edit-char-image');
        imageDiv.innerHTML = '<div class="placeholder">生成中...</div>';

        // 現在の選択を保存
        const savedPlace = document.getElementById('place').value;
        const savedAction = document.getElementById('action').value;
        const savedComposition = document.getElementById('composition').value;
        const savedCustomPrompt = document.getElementById('customPrompt').value;

        try {
            // places[0], actions[0], front view に設定
            document.getElementById('place').value = places.length > 0 ? '0' : '';
            document.getElementById('action').value = actions.length > 0 ? '0' : '';

            // front view の構図インデックスを取得して設定
            if (actions.length > 0 && actions[0].compositions) {
                const frontViewIndex = actions[0].compositions.findIndex(c => c.name === 'front view');
                if (frontViewIndex >= 0) {
                    document.getElementById('composition').value = frontViewIndex;
                }
            }

            // カスタムプロンプトをクリア
            document.getElementById('customPrompt').value = '';

            // 構図プレビューと全く同じ方法でプロンプト構築
            const prompt = buildPrompt();
            const characterWithExtras = getSelectedCharacterWithExtras();
            const finalPrompt = buildFinalPrompt(prompt, characterWithExtras);
            const negativePrompt = buildNegativePrompt();

            // seedも構図プレビューと同様に取得
            let seed = parseInt(document.getElementById('seed').value);
            if (seed === -1) seed = undefined;

            const result = await generateImage(apiKey, modelId, finalPrompt, {
                negativePrompt: negativePrompt,
                steps: model.steps || 20,
                cfgScale: model.cfgScale || 7,
                scheduler: model.scheduler || 'Default',
                width: 1024,
                height: 1024,
                seed: seed,
                character: characterWithExtras
            });

            // 画像URLを保存
            characters[charIdx].image = result.imageURL;
            saveCachedData();

            // 画像を表示
            imageDiv.innerHTML = `<img src="${result.imageURL}" alt="${escapeHtml(char.name)}" onclick="window.open('${result.imageURL}', '_blank')">`;
            showStatus('標準画像を生成しました');

        } catch (error) {
            console.error(error);
            const errorMsg = translateApiError(error.message);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">${escapeHtml(errorMsg)}</div>`;
        } finally {
            // 選択を復元
            document.getElementById('place').value = savedPlace;
            document.getElementById('action').value = savedAction;
            document.getElementById('composition').value = savedComposition;
            document.getElementById('customPrompt').value = savedCustomPrompt;
            updatePromptPreview();
        }
    }

    // front view の構図タグを取得
    function getFrontViewTag(action) {
        if (!action || !action.compositions) return 'front view';
        const frontView = action.compositions.find(c => c.name === 'front view');
        return frontView?.tag || frontView?.name || 'front view';
    }

    // RunwareのURLかどうかを判定
    function isRunwareUrl(url) {
        return url && (url.includes('runware.ai') || url.includes('im.runware'));
    }

    // GoogleドライブURLからfileIdを抽出
    function extractGoogleDriveFileId(url) {
        if (!url) return null;
        // drive.google.com/uc?id=XXXX 形式
        let match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match) return match[1];
        // drive.google.com/file/d/XXXX/ 形式
        match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (match) return match[1];
        return null;
    }

    // 画像URLをBase64に変換
    async function imageUrlToBase64(url) {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // GASに画像をアップロードして永続URLを取得
    async function uploadImageToGas(baseUrl, base64Data, filename, oldFileId = null) {
        const payload = {
            filename: filename,
            mimeType: 'image/png',
            image: base64Data
        };

        // 古いファイルIDがあれば追加（削除用）
        if (oldFileId) {
            payload.oldFileId = oldFileId;
        }

        const response = await fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.status === 'success' && result.data && result.data.directUrl) {
            return result.data.directUrl;
        }
        throw new Error(result.message || '画像アップロード失敗');
    }

    // キャラクターをGASに保存
    async function saveCharacterToGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        const charIdx = document.getElementById('character').value;
        if (charIdx === '' || !characters[charIdx]) {
            alert('キャラクターを選択してください');
            return;
        }

        showStatus('保存中...', 'loading');

        try {
            // 全キャラクターデータを保存（GASは全件上書き）
            const dataToSave = characters.map(char => ({
                character_id: char.character_id || '',
                name: char.name || '',
                series: char.series || '',
                tag: char.tag || '',
                profile: char.profile || '',
                uniform1: char.uniform1 || '',
                uniform2: char.uniform2 || '',
                'additional tag': char.additionalTag || '',
                cast: char.cast || '',
                personality: char.personality || '',
                image: char.image || ''
            }));

            const result = await saveGasData(baseUrl, 'character', dataToSave);

            if (result.status === 'success') {
                showStatus('保存成功: ' + result.message);
            } else {
                showStatus('サーバーエラー: ' + result.message, 'error');
            }
        } catch (error) {
            console.error(error);
            showStatus('保存エラー: ' + error.message, 'error');
        }
    }

    // コピーして新規アクション作成
    function copyAndCreateNewAction() {
        const actionIdx = document.getElementById('action').value;
        if (actionIdx === '' || !actions[actionIdx]) {
            alert('コピー元のアクションを選択してください');
            return;
        }

        const sourceAction = actions[actionIdx];

        // 既存のact_xxx形式のIDから最大番号を取得
        let maxNum = 0;
        actions.forEach(action => {
            const match = (action.action_id || '').match(/^act_(\d+)$/);
            if (match) {
                const num = parseInt(match[1], 10);
                if (num > maxNum) maxNum = num;
            }
        });

        // 新しいIDを生成
        const newId = 'act_' + String(maxNum + 1).padStart(3, '0');

        // 選択中のアクションをコピーして新規作成
        const newAction = {
            action_id: newId,
            name: sourceAction.name + ' (コピー)',
            prompt: sourceAction.prompt || '',
            req_stage: sourceAction.req_stage || '',
            pre_action: sourceAction.pre_action || '',
            public_action: sourceAction.public_action || '',
            next_action: sourceAction.next_action || '',
            char_page_count: sourceAction.char_page_count || '',
            effect: sourceAction.effect || '',
            agent: sourceAction.agent || '',
            compositions: sourceAction.compositions.map(comp => ({
                name: comp.name,
                tag: comp.tag || '',
                quality: comp.quality || '未評価',
                enabled: comp.enabled !== false
            }))
        };

        // 配列に追加
        actions.push(newAction);
        saveCachedData();

        // ドロップダウンを更新
        const actionSelect = document.getElementById('action');
        const newIndex = actions.length - 1;
        const option = document.createElement('option');
        option.value = newIndex;
        option.textContent = `${newAction.name} [${newAction.action_id}]`;
        actionSelect.appendChild(option);

        // 新規アクションを選択
        actionSelect.value = newIndex;
        updateActionEditUI();
        updatePromptPreview();

        showStatus(`${sourceAction.name} をコピーして ${newId} を作成しました`);
    }

    // アクション編集UIを更新
    function updateActionEditUI() {
        const actionIdx = document.getElementById('action').value;
        const container = document.getElementById('actionEditContent');

        if (actionIdx === '' || !actions[actionIdx]) {
            container.innerHTML = '<div class="no-action-message">アクションを選択してください</div>';
            return;
        }

        const action = actions[actionIdx];

        // アクション選択肢を構築（pre_action, next_action用）
        const actionOptions = actions.map(a =>
            `<option value="${a.action_id}">${a.name} [${a.action_id}]</option>`
        ).join('');

        container.innerHTML = `
            <div class="action-fields-grid">
                <div class="field-row">
                    <label>Action ID</label>
                    <span class="field-id">${action.action_id || '(未設定)'}</span>
                </div>
                <div class="field-row">
                    <label>アクション名</label>
                    <input type="text" id="edit-action-name" value="${escapeHtml(action.name || '')}" onchange="updateActionField('name', this.value)">
                </div>
                <div class="field-row">
                    <label>必要stage</label>
                    <input type="text" id="edit-req-stage" value="${escapeHtml(action.req_stage || '')}" onchange="updateActionField('req_stage', this.value)">
                </div>
                <div class="field-row">
                    <label>前提アクション</label>
                    <select id="edit-pre-action" onchange="updateActionField('pre_action', this.value)">
                        <option value="">無し</option>
                        ${actionOptions}
                    </select>
                </div>
                <div class="field-row">
                    <label>次アクション</label>
                    <select id="edit-next-action" onchange="updateActionField('next_action', this.value)">
                        <option value="">無し</option>
                        ${actionOptions}
                    </select>
                </div>
                <div class="field-row">
                    <label>公開アクション</label>
                    <select id="edit-public-action" onchange="updateActionField('public_action', this.value)">
                        <option value="">無し</option>
                        ${actionOptions}
                    </select>
                </div>
                <div class="field-row">
                    <label>キャラページ数</label>
                    <input type="number" id="edit-char-page-count" value="${action.char_page_count || ''}" min="0" onchange="updateActionField('char_page_count', this.value)">
                </div>
                <div class="field-row">
                    <label>エフェクト</label>
                    <input type="text" id="edit-effect" value="${escapeHtml(action.effect || '')}" onchange="updateActionField('effect', this.value)">
                </div>
                <div class="field-row">
                    <label>エージェント</label>
                    <input type="text" id="edit-agent" value="${escapeHtml(action.agent || '')}" onchange="updateActionField('agent', this.value)">
                </div>
                <div class="field-row prompt-field">
                    <label>プロンプト</label>
                    <textarea id="edit-action-prompt" onchange="updateActionField('prompt', this.value)">${escapeHtml(action.prompt || '')}</textarea>
                </div>
            </div>

            <!-- 構図セクション -->
            <div class="composition-section">
                <h3 class="composition-title">構図別プレビュー</h3>
                <div id="action-composition-grid" class="composition-grid"></div>
            </div>
        `;

        // セレクトボックスの値を設定
        document.getElementById('edit-pre-action').value = action.pre_action || '';
        document.getElementById('edit-next-action').value = action.next_action || '';
        document.getElementById('edit-public-action').value = action.public_action || '';

        // 構図グリッドを更新
        updateActionCompositionGrid();
    }

    // 構図グリッドを更新
    function updateActionCompositionGrid() {
        const actionIdx = document.getElementById('action').value;
        if (actionIdx === '' || !actions[actionIdx]) return;

        const action = actions[actionIdx];
        const container = document.getElementById('action-composition-grid');
        if (!container) return;

        const actionCompositions = compositionImages[action.action_id] || {};

        container.innerHTML = action.compositions.map((comp, index) => {
            const imageUrl = actionCompositions[comp.name];
            // enabledはqualityから導出（NG以外は有効）
            const isEnabled = comp.enabled !== undefined ? comp.enabled : (comp.quality !== 'NG');
            const disabledClass = isEnabled ? '' : 'disabled';

            return `
                <div class="composition-item">
                    <div class="composition-label">${comp.name}</div>
                    <div class="composition-quality">
                        ${QUALITY_OPTIONS.map(q => {
                            const isActive = comp.quality === q.value;
                            const activeClass = isActive ? `active ${q.activeClass}` : '';
                            return `<button class="quality-btn ${activeClass}" ${isActive ? 'disabled' : ''} onclick="updateActionCompositionQuality(${index}, '${q.value}')">${q.label}</button>`;
                        }).join('')}
                    </div>
                    <div class="composition-image ${disabledClass}" id="action-comp-image-${index}">
                        ${imageUrl
                            ? `<img src="${imageUrl}" alt="${comp.name}" onclick="window.open('${imageUrl}', '_blank')">`
                            : `<div class="placeholder">${isEnabled ? '未生成' : 'NG'}</div>`
                        }
                    </div>
                    <input type="text" class="composition-tag-input" value="${escapeHtml(comp.tag || '')}" placeholder="構図補正タグ" onchange="updateActionCompositionTag(${index}, this.value)">
                    <button class="btn btn-generate btn-small" onclick="generateActionCompositionImage(${index})">生成</button>
                </div>
            `;
        }).join('');
    }

    // 構図の品質を更新
    function updateActionCompositionQuality(compIndex, quality) {
        const actionIdx = document.getElementById('action').value;
        if (actionIdx === '' || !actions[actionIdx]) return;

        const action = actions[actionIdx];
        if (!action.compositions[compIndex]) return;

        // BESTを選択した場合、他のBESTをGOODに変更
        if (quality === 'best') {
            action.compositions.forEach((comp, index) => {
                if (index !== compIndex && comp.quality === 'best') {
                    comp.quality = 'good';
                }
            });
        }

        action.compositions[compIndex].quality = quality;
        action.compositions[compIndex].enabled = quality !== 'NG';

        saveCachedData();
        updateActionCompositionGrid();
        updateCompositionSelect(action.compositions);
        updatePromptPreview();
    }

    // 構図タグを更新
    function updateActionCompositionTag(compIndex, tag) {
        const actionIdx = document.getElementById('action').value;
        if (actionIdx === '' || !actions[actionIdx]) return;

        const action = actions[actionIdx];
        if (!action.compositions[compIndex]) return;

        action.compositions[compIndex].tag = tag;
        saveCachedData();
    }

    // アクションフィールドを更新
    function updateActionField(field, value) {
        const actionIdx = document.getElementById('action').value;
        if (actionIdx === '' || !actions[actionIdx]) return;

        actions[actionIdx][field] = value;
        saveCachedData();

        // 名前が変わった場合はセレクトボックスも更新
        if (field === 'name') {
            updateActionSelect();
            document.getElementById('action').value = actionIdx;
        }

        // プロンプトが変わった場合はプレビューを更新
        if (field === 'prompt') {
            updatePromptPreview();
        }
    }

    // 構図画像を生成
    async function generateActionCompositionImage(compIndex) {
        const actionIdx = document.getElementById('action').value;
        if (actionIdx === '' || !actions[actionIdx]) return;

        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return;
        }

        const modelId = document.getElementById('model').value;
        if (!modelId || !models[modelId]) {
            alert('モデルを選択してください');
            return;
        }

        const action = actions[actionIdx];
        const comp = action.compositions[compIndex];
        if (!comp) return;

        const imageDiv = document.getElementById(`action-comp-image-${compIndex}`);
        imageDiv.innerHTML = '<div class="placeholder">生成中...</div>';

        try {
            const model = models[modelId];
            const characterWithExtras = getSelectedCharacterWithExtras();

            // ページ上部と同じプロンプト構築方法を使用（構図タグのみ差し替え）
            const compositionTag = comp.tag || comp.name;

            // buildPrompt()と同じ構造でプロンプト構築
            const promptParts = [
                model.qualityPositive || '',
                getSelectedData('character', characters, 'tag'),
                getSelectedData('place', places, 'tag'),
                action.prompt || '',
                compositionTag,
                document.getElementById('customPrompt').value.trim(),
                getSelectedData('place', places, 'additionalTag'),
                getSelectedData('character', characters, 'additionalTag')
            ].filter(p => p);

            const prompt = cleanPrompt(promptParts.join(', '));
            const finalPrompt = buildFinalPrompt(prompt, characterWithExtras);

            // ページ上部と同じ設定を使用
            let seed = parseInt(document.getElementById('seed').value);
            if (seed === -1) seed = undefined;

            const result = await generateImage(apiKey, modelId, finalPrompt, {
                negativePrompt: model.qualityNegative || '',
                steps: model.steps || 20,
                cfgScale: model.cfgScale || 7,
                scheduler: model.scheduler || 'Default',
                width: parseInt(document.getElementById('width').value),
                height: parseInt(document.getElementById('height').value),
                seed: seed,
                character: characterWithExtras
            });

            // 画像を保存
            if (!compositionImages[action.action_id]) {
                compositionImages[action.action_id] = {};
            }
            compositionImages[action.action_id][comp.name] = result.imageURL;
            saveCachedData();

            // 画像を表示
            imageDiv.innerHTML = `<img src="${result.imageURL}" alt="${comp.name}" onclick="window.open('${result.imageURL}', '_blank')">`;

        } catch (error) {
            console.error(error);
            const errorMsg = translateApiError(error.message);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c; font-size: 0.8rem;">${escapeHtml(errorMsg)}</div>`;
        }
    }

    // アクションをGASに保存
    async function saveActionToGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        if (actions.length === 0) {
            alert('保存するアクションデータがありません');
            return;
        }

        showStatus('保存中...', 'loading');

        try {
            // アクションデータをGAS形式に変換
            const gasData = actions.map(action => {
                const row = {
                    'action_id': action.action_id,
                    'action name': action.name,
                    'prompt': action.prompt,
                    'req_stage': action.req_stage,
                    'pre-action': action.pre_action,
                    'public-action': action.public_action,
                    'next-action': action.next_action,
                    'char_page_count': action.char_page_count,
                    'effect': action.effect,
                    'agent': action.agent
                };

                // 各構図のquality/tagを追加
                action.compositions.forEach(comp => {
                    row[comp.name + ' quality'] = comp.quality === '未評価' ? '' : comp.quality;
                    row[comp.name + ' tag'] = comp.tag || '';
                });

                return row;
            });

            const result = await saveGasData(baseUrl, 'action', gasData);

            if (result.status === 'success') {
                showStatus('保存成功: ' + result.message);
            } else {
                showStatus('サーバーエラー: ' + result.message, 'error');
            }
        } catch (error) {
            console.error(error);
            showStatus('保存エラー: ' + error.message, 'error');
        }
    }

    // 場所選択時
    function onPlaceChange() {
        updatePromptPreview();
        updatePlaceEditUI();
    }

    // コピーして新規場所作成
    function copyAndCreateNewPlace() {
        const placeIdx = document.getElementById('place').value;
        if (placeIdx === '' || !places[placeIdx]) {
            alert('コピー元の場所を選択してください');
            return;
        }

        const sourcePlace = places[placeIdx];

        // 既存のplc_xxx形式のIDから最大番号を取得
        let maxNum = 0;
        places.forEach(place => {
            const match = (place.place_id || '').match(/^plc_(\d+)$/);
            if (match) {
                const num = parseInt(match[1], 10);
                if (num > maxNum) maxNum = num;
            }
        });

        // 新しいIDを生成
        const newId = 'plc_' + String(maxNum + 1).padStart(3, '0');

        // 選択中の場所をコピーして新規作成
        const newPlace = {
            place_id: newId,
            name: sourcePlace.name + ' (コピー)',
            tag: sourcePlace.tag || '',
            additionalTag: sourcePlace.additionalTag || '',
            req_stage: sourcePlace.req_stage || '',
            root_place: sourcePlace.root_place || '',
            default_action: sourcePlace.default_action || '',
            image: ''  // 画像はコピーしない
        };

        // 配列に追加
        places.push(newPlace);
        saveCachedData();

        // ドロップダウンを更新
        const placeSelect = document.getElementById('place');
        const newIndex = places.length - 1;
        const option = document.createElement('option');
        option.value = newIndex;
        option.textContent = `${newPlace.name} [${newPlace.place_id}]`;
        placeSelect.appendChild(option);

        // 新規場所を選択
        placeSelect.value = newIndex;
        updatePlaceEditUI();
        updatePromptPreview();

        showStatus(`${sourcePlace.name} をコピーして ${newId} を作成しました`);
    }

    // 場所編集UIを更新
    function updatePlaceEditUI() {
        const placeIdx = document.getElementById('place').value;
        const container = document.getElementById('placeEditContent');

        if (placeIdx === '' || !places[placeIdx]) {
            container.innerHTML = '<div class="no-place-message">場所を選択してください</div>';
            return;
        }

        const place = places[placeIdx];

        // ルート場所選択肢を構築（自分自身を除外）
        const rootPlaceOptions = places
            .filter(p => p.place_id !== place.place_id)
            .map(p => `<option value="${p.place_id}">${p.name} [${p.place_id}]</option>`)
            .join('');

        // デフォルトアクション選択肢を構築
        const actionOptions = actions.map(a =>
            `<option value="${a.action_id}">${a.name} [${a.action_id}]</option>`
        ).join('');

        const imageUrl = place.image || '';

        container.innerHTML = `
            <div class="edit-layout">
                <div class="edit-image-section">
                    <div class="edit-image-area" id="edit-place-image">
                        ${imageUrl
                            ? `<img src="${imageUrl}" alt="${escapeHtml(place.name)}" onclick="window.open('${imageUrl}', '_blank')">`
                            : '<div class="placeholder">画像未設定</div>'
                        }
                    </div>
                    <button class="btn btn-generate" onclick="generatePlaceImage()">標準画像生成</button>
                </div>
                <div class="edit-fields-section">
                    <div class="place-fields-grid">
                        <div class="field-row">
                            <label>Place ID</label>
                            <span class="field-id">${place.place_id || '(未設定)'}</span>
                        </div>
                        <div class="field-row">
                            <label>場所名</label>
                            <input type="text" id="edit-place-name" value="${escapeHtml(place.name || '')}" onchange="updatePlaceField('name', this.value)">
                        </div>
                        <div class="field-row">
                            <label>必要stage</label>
                            <input type="text" id="edit-req-stage" value="${escapeHtml(place.req_stage || '')}" onchange="updatePlaceField('req_stage', this.value)">
                        </div>
                        <div class="field-row">
                            <label>ルート場所</label>
                            <select id="edit-root-place" onchange="updatePlaceField('root_place', this.value)">
                                <option value="">無し</option>
                                ${rootPlaceOptions}
                            </select>
                        </div>
                        <div class="field-row">
                            <label>デフォルトアクション</label>
                            <select id="edit-default-action" onchange="updatePlaceField('default_action', this.value)">
                                <option value="">無し</option>
                                ${actionOptions}
                            </select>
                        </div>
                        <div class="field-row tag-field">
                            <label>場所タグ</label>
                            <textarea id="edit-place-tag" onchange="updatePlaceField('tag', this.value)">${escapeHtml(place.tag || '')}</textarea>
                        </div>
                        <div class="field-row tag-field">
                            <label>追加タグ</label>
                            <textarea id="edit-place-additional" onchange="updatePlaceField('additionalTag', this.value)">${escapeHtml(place.additionalTag || '')}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // セレクトボックスの値を設定
        document.getElementById('edit-root-place').value = place.root_place || '';
        document.getElementById('edit-default-action').value = place.default_action || '';
    }

    // 場所フィールドを更新
    function updatePlaceField(field, value) {
        const placeIdx = document.getElementById('place').value;
        if (placeIdx === '' || !places[placeIdx]) return;

        places[placeIdx][field] = value;
        saveCachedData();

        // 名前が変わった場合はセレクトボックスも更新
        if (field === 'name') {
            updatePlaceSelect();
            document.getElementById('place').value = placeIdx;
        }

        // タグが変わった場合はプロンプトプレビューを更新
        if (field === 'tag' || field === 'additionalTag') {
            updatePromptPreview();
        }
    }

    // 場所の標準画像を生成
    async function generatePlaceImage() {
        const placeIdx = document.getElementById('place').value;
        if (placeIdx === '' || !places[placeIdx]) {
            alert('場所を選択してください');
            return;
        }

        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return;
        }

        const modelId = document.getElementById('model').value;
        if (!modelId || !models[modelId]) {
            alert('モデルを選択してください');
            return;
        }

        const place = places[placeIdx];
        const model = models[modelId];
        const imageDiv = document.getElementById('edit-place-image');
        imageDiv.innerHTML = '<div class="placeholder">生成中...</div>';

        // 現在の選択を保存
        const savedCharacter = document.getElementById('character').value;
        const savedPlace = document.getElementById('place').value;
        const savedAction = document.getElementById('action').value;
        const savedComposition = document.getElementById('composition').value;
        const savedCustomPrompt = document.getElementById('customPrompt').value;

        try {
            // chr_024、act_037、front view に設定
            const charIndex = characters.findIndex(c => c.character_id === 'chr_024');
            if (charIndex >= 0) {
                document.getElementById('character').value = charIndex;
            }

            const actionIndex = actions.findIndex(a => a.action_id === 'act_037');
            if (actionIndex >= 0) {
                document.getElementById('action').value = actionIndex;

                // front view の構図インデックスを取得して設定
                if (actions[actionIndex].compositions) {
                    const frontViewIndex = actions[actionIndex].compositions.findIndex(c => c.name === 'front view');
                    if (frontViewIndex >= 0) {
                        document.getElementById('composition').value = frontViewIndex;
                    }
                }
            }

            // カスタムプロンプトをクリア
            document.getElementById('customPrompt').value = '';

            // 構図プレビューと全く同じ方法でプロンプト構築
            const prompt = buildPrompt();
            const characterWithExtras = getSelectedCharacterWithExtras();
            const finalPrompt = buildFinalPrompt(prompt, characterWithExtras);
            const negativePrompt = buildNegativePrompt();

            // seedも構図プレビューと同様に取得
            let seed = parseInt(document.getElementById('seed').value);
            if (seed === -1) seed = undefined;

            const result = await generateImage(apiKey, modelId, finalPrompt, {
                negativePrompt: negativePrompt,
                steps: model.steps || 20,
                cfgScale: model.cfgScale || 7,
                scheduler: model.scheduler || 'Default',
                width: 1024,
                height: 1024,
                seed: seed,
                character: characterWithExtras
            });

            // 画像URLを保存
            places[placeIdx].image = result.imageURL;
            saveCachedData();

            // 画像を表示
            imageDiv.innerHTML = `<img src="${result.imageURL}" alt="${escapeHtml(place.name)}" onclick="window.open('${result.imageURL}', '_blank')">`;
            showStatus('場所の標準画像を生成しました');

        } catch (error) {
            console.error(error);
            const errorMsg = translateApiError(error.message);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">${escapeHtml(errorMsg)}</div>`;
        } finally {
            // 選択を復元
            document.getElementById('character').value = savedCharacter;
            document.getElementById('place').value = savedPlace;
            document.getElementById('action').value = savedAction;
            document.getElementById('composition').value = savedComposition;
            document.getElementById('customPrompt').value = savedCustomPrompt;
            updatePromptPreview();
        }
    }

    // 場所をGASに保存
    async function savePlaceToGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        if (places.length === 0) {
            alert('保存する場所データがありません');
            return;
        }

        showStatus('保存中...', 'loading');

        try {
            // 場所データをGAS形式に変換
            const gasData = places.map(place => ({
                'place_id': place.place_id || '',
                'name': place.name || '',
                'tag': place.tag || '',
                'additional tag': place.additionalTag || '',
                'req_stage': place.req_stage || '',
                'root_place': place.root_place || '',
                'default action': place.default_action || '',
                'image': place.image || ''
            }));

            const result = await saveGasData(baseUrl, 'place', gasData);

            if (result.status === 'success') {
                showStatus('保存成功: ' + result.message);
            } else {
                showStatus('サーバーエラー: ' + result.message, 'error');
            }
        } catch (error) {
            console.error(error);
            showStatus('保存エラー: ' + error.message, 'error');
        }
    }

    // 全データをGASに保存
    async function saveAllToGas() {
        const baseUrl = document.getElementById('gasUrl').value.trim();
        const imageUploadUrl = document.getElementById('imageUploadUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        const hasData = characters.length > 0 || actions.length > 0 || places.length > 0;
        if (!hasData) {
            alert('保存するデータがありません');
            return;
        }

        // Runware画像があるか確認（キャラクターと場所）
        const runwareChars = characters.filter(char => isRunwareUrl(char.image));
        const runwarePlaces = places.filter(place => isRunwareUrl(place.image));
        if ((runwareChars.length > 0 || runwarePlaces.length > 0) && !imageUploadUrl) {
            alert('Runware画像をアップロードするには「画像アップロードGAS URL」を入力してください');
            return;
        }

        doSaveSettings();

        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = '保存中';

        showStatus('保存中...', 'loading');

        try {
            const results = [];

            // Runware画像をGASにアップロード
            if (runwareChars.length > 0) {
                for (let i = 0; i < characters.length; i++) {
                    const char = characters[i];
                    if (isRunwareUrl(char.image)) {
                        showStatus(`画像アップロード中: ${char.name}`, 'loading');
                        try {
                            const base64Data = await imageUrlToBase64(char.image);
                            const safeTag = (char.tag || char.name).replace(/[\/\\:*?"<>|,\s]+/g, '_').replace(/^_+|_+$/g, '');
                            const filename = `${safeTag || 'character'}.png`;
                            // 既存のGoogleドライブ画像があれば置き換え用にfileIdを取得
                            const oldFileId = null; // 初回は古いファイルなし

                            const gasUrl = await uploadImageToGas(imageUploadUrl, base64Data, filename, oldFileId);
                            characters[i].image = gasUrl;
                            saveCachedData();
                        } catch (error) {
                            console.error(`${char.name}の画像アップロード失敗:`, error);
                            results.push(`画像エラー: ${char.name}`);
                        }
                    }
                }
            }

            // Runware場所画像をGASにアップロード
            if (runwarePlaces.length > 0) {
                for (let i = 0; i < places.length; i++) {
                    const place = places[i];
                    if (isRunwareUrl(place.image)) {
                        showStatus(`場所画像アップロード中: ${place.name}`, 'loading');
                        try {
                            const base64Data = await imageUrlToBase64(place.image);
                            const safeName = (place.name || 'place').replace(/[\/\\:*?"<>|,\s]+/g, '_').replace(/^_+|_+$/g, '');
                            const filename = `place_${safeName}.png`;
                            const oldFileId = null;

                            const gasUrl = await uploadImageToGas(imageUploadUrl, base64Data, filename, oldFileId);
                            places[i].image = gasUrl;
                            saveCachedData();
                        } catch (error) {
                            console.error(`${place.name}の画像アップロード失敗:`, error);
                            results.push(`画像エラー: ${place.name}`);
                        }
                    }
                }
            }

            showStatus('データ保存中...', 'loading');

            // キャラクターデータを保存
            if (characters.length > 0) {
                const charData = characters.map(char => ({
                    character_id: char.character_id || '',
                    name: char.name || '',
                    series: char.series || '',
                    tag: char.tag || '',
                    profile: char.profile || '',
                    uniform1: char.uniform1 || '',
                    uniform2: char.uniform2 || '',
                    'additional tag': char.additionalTag || '',
                    cast: char.cast || '',
                    personality: char.personality || '',
                    image: char.image || ''
                }));
                const charResult = await saveGasData(baseUrl, 'character', charData);
                results.push(`キャラ: ${charResult.status}`);
            }

            // アクションデータを保存
            if (actions.length > 0) {
                const actionData = actions.map(action => {
                    const row = {
                        'action_id': action.action_id,
                        'action name': action.name,
                        'prompt': action.prompt,
                        'req_stage': action.req_stage,
                        'pre-action': action.pre_action,
                        'public-action': action.public_action,
                        'next-action': action.next_action,
                        'char_page_count': action.char_page_count,
                        'effect': action.effect,
                        'agent': action.agent
                    };
                    action.compositions.forEach(comp => {
                        row[comp.name + ' quality'] = comp.quality === '未評価' ? '' : comp.quality;
                        row[comp.name + ' tag'] = comp.tag || '';
                    });
                    return row;
                });
                const actionResult = await saveGasData(baseUrl, 'action', actionData);
                results.push(`アクション: ${actionResult.status}`);
            }

            // 場所データを保存
            if (places.length > 0) {
                const placeData = places.map(place => ({
                    'place_id': place.place_id || '',
                    'name': place.name || '',
                    'tag': place.tag || '',
                    'additional tag': place.additionalTag || '',
                    'req_stage': place.req_stage || '',
                    'root_place': place.root_place || '',
                    'default action': place.default_action || '',
                    'image': place.image || ''
                }));
                const placeResult = await saveGasData(baseUrl, 'place', placeData);
                results.push(`場所: ${placeResult.status}`);
            }

            showStatus('保存完了: ' + results.join(', '));
        } catch (error) {
            console.error(error);
            showStatus('保存エラー: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '保存';
        }
    }
</script>

</body>
</html>
