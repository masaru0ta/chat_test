<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ´æ‰€è¨­å®š</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        /* 2ãƒšã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .main-layout {
            display: flex;
            gap: 20px;
            height: calc(100vh - 200px);
            min-height: 500px;
        }

        .tree-pane {
            width: 280px;
            min-width: 280px;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }

        .tree-pane h3 {
            margin: 0 0 15px 0;
            color: #4a9eff;
            font-size: 0.95rem;
        }

        .content-pane {
            flex: 1;
            overflow-y: auto;
        }

        /* ãƒ„ãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .tree-node {
            margin-left: 0;
        }

        .tree-node .tree-children {
            margin-left: 20px;
            border-left: 1px solid #333;
            padding-left: 10px;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            color: #ccc;
            font-size: 0.85rem;
            transition: background 0.15s;
        }

        .tree-item:hover {
            background: #2a2a2a;
        }

        .tree-item.selected {
            background: #2a4a6a;
            color: #fff;
        }

        .tree-item .tree-icon {
            margin-right: 8px;
            font-size: 0.75rem;
            color: #666;
        }

        .tree-item .tree-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 4px;
            color: #666;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .tree-toggle:hover {
            color: #aaa;
        }

        .tree-root-label {
            color: #666;
            font-size: 0.75rem;
            margin: 15px 0 5px 0;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        /* ãƒšãƒ¼ã‚¸å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .place-tag {
            font-size: 0.7rem;
            color: #aaa;
            line-height: 1.3;
            max-height: 50px;
            overflow-y: auto;
        }

        .detail-header .btn-save {
            margin-right: 10px;
        }

        .detail-header #detail-status {
            margin-right: 15px;
        }

        .detail-info .field-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .detail-info .field-row label {
            color: #888;
            font-size: 0.85rem;
            white-space: nowrap;
            min-width: 100px;
        }

        .detail-info .field-row input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .detail-info .field-row input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .detail-info .field-row select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .detail-info .field-row select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        /* è©³ç´°ãƒšãƒ¼ã‚¸ã§ã®2ãƒšã‚¤ãƒ³å¯¾å¿œ */
        .detail-page.active {
            position: relative;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
        }

        .detail-page .detail-content {
            padding: 0;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- 2ãƒšã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div class="main-layout">
        <!-- å·¦ãƒšã‚¤ãƒ³: ãƒ„ãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼ -->
        <div class="tree-pane">
            <h3>å ´æ‰€ãƒ„ãƒªãƒ¼</h3>
            <div id="place-tree"></div>
        </div>

        <!-- å³ãƒšã‚¤ãƒ³: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="content-pane">
            <!-- å ´æ‰€ã‚°ãƒªãƒƒãƒ‰ -->
            <div id="place-grid" class="card-grid">
                <div class="empty-message">ã€ŒGASã‹ã‚‰èª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã§å ´æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
            </div>

            <!-- å ´æ‰€è©³ç´°ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼‰ -->
            <div id="detail-page" class="detail-page">
                <div class="detail-header">
                    <button class="detail-back" onclick="closeDetailPage()">â† ä¸€è¦§ã«æˆ»ã‚‹</button>
                    <div class="header-selects">
                        <label>ã‚­ãƒ£ãƒ©:</label>
                        <select id="preview-character"></select>
                        <label>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</label>
                        <select id="preview-action"></select>
                    </div>
                    <div id="detail-status"></div>
                    <div class="detail-nav">
                        <button class="btn btn-nav" onclick="navigatePlace(-1)" id="btn-prev">â† å‰</button>
                        <button class="btn btn-nav" onclick="navigatePlace(1)" id="btn-next">æ¬¡ â†’</button>
                    </div>
                </div>
                <div class="detail-content">
                    <div class="detail-main">
                        <div class="detail-image-section">
                            <div class="detail-image-area" id="detail-image"></div>
                            <button class="btn btn-generate" onclick="generateDetailImage()">ç”»åƒç”Ÿæˆ</button>
                        </div>
                        <div class="detail-info">
                            <div class="field-label">Place ID: <span id="detail-place-id" style="color: #4a9eff; font-weight: normal;"></span></div>
                            <div class="field-label">å ´æ‰€å</div>
                            <input type="text" class="field-input" id="detail-name" onchange="updatePlaceName(this.value)">
                            <div class="field-label">èª¬æ˜</div>
                            <textarea class="field-textarea" id="detail-description" onchange="updatePlaceField('description', this.value)" style="height: 60px;"></textarea>
                            <div class="field-row">
                                <label>å¿…è¦stage:</label>
                                <input type="text" id="detail-req-stage" onchange="updatePlaceField('req_stage', this.value)">
                            </div>
                            <div class="field-row">
                                <label>ãƒ«ãƒ¼ãƒˆå ´æ‰€:</label>
                                <select id="detail-root-place" onchange="updatePlaceField('root_place', this.value)"></select>
                            </div>
                            <div class="field-row">
                                <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡Œç‚º:</label>
                                <select id="detail-default-action" onchange="updatePlaceField('default_action', this.value)"></select>
                            </div>
                            <div class="field-label">å ´æ‰€ã‚¿ã‚°</div>
                            <textarea class="field-textarea" id="detail-tag" onchange="updatePlaceField('tag', this.value)"></textarea>
                            <div class="field-label">è¿½åŠ ã‚¿ã‚°</div>
                            <textarea class="field-textarea" id="detail-additional" onchange="updatePlaceField('additionalTag', this.value)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šãƒãƒ¼ -->
    <div class="settings-bar" style="margin-top: 20px;">
        <div class="settings-row">
            <label>GAS URL:</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
            <button class="btn btn-primary" onclick="loadAllFromGas()">GASã‹ã‚‰èª­ã¿è¾¼ã¿</button>
            <button class="btn btn-save" onclick="saveToGas()">GASã«ä¿å­˜</button>
            <button class="btn btn-generate" onclick="generateAllImages()" id="generateAllBtn">å…¨å ´æ‰€ç”»åƒç”Ÿæˆ</button>
        </div>
        <div class="settings-row">
            <label>Runware API Key:</label>
            <input type="password" id="apiKey" placeholder="Runware API Keyã‚’å…¥åŠ›">
        </div>
        <div class="settings-row">
            <label>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰GAS URL:</label>
            <input type="text" id="imageUploadUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec (ç”»åƒä¿å­˜ç”¨)">
        </div>
        <div id="status"></div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/prompt-utils.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script>
    const GAS_DATA_KEY = 'gas_data_cache_place';
    const PLACE_IMAGES_KEY = 'place_images';

    // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let relationships = [];
    let costumes = [];
    let placeImages = {};
    let originalGasImages = {};
    let currentDetailIndex = -1;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        const settings = loadSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY);
        if (settings.gasUrl) document.getElementById('apiUrl').value = settings.gasUrl;
        if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
        const savedImageUploadUrl = localStorage.getItem(STORAGE_KEYS.IMAGE_UPLOAD_URL);
        if (savedImageUploadUrl) document.getElementById('imageUploadUrl').value = savedImageUploadUrl;
        loadCachedData();
    });

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.addEventListener('keydown', (e) => {
        if (currentDetailIndex < 0) return;
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigatePlace(-1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigatePlace(1);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            closeDetailPage();
        }
    });

    function saveCachedData() {
        const data = { models, characters, places, actions, relationships };
        localStorage.setItem(GAS_DATA_KEY, JSON.stringify(data));
        localStorage.setItem(PLACE_IMAGES_KEY, JSON.stringify(placeImages));
    }

    function loadCachedData() {
        try {
            const cachedData = localStorage.getItem(GAS_DATA_KEY);
            if (cachedData) {
                const data = JSON.parse(cachedData);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
                relationships = data.relationships || [];
            }
            const cachedImages = localStorage.getItem(PLACE_IMAGES_KEY);
            if (cachedImages) placeImages = JSON.parse(cachedImages);

            if (places.length > 0) {
                renderPlaceGrid();
                renderPlaceTree();
                showStatusWithDetail(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ: å ´æ‰€${places.length}ä»¶`);
            }
        } catch (error) {
            console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    function doSaveSettings() {
        const gasUrl = document.getElementById('apiUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const imageUploadUrl = document.getElementById('imageUploadUrl').value.trim();
        saveSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY, gasUrl, apiKey);
        if (imageUploadUrl) localStorage.setItem(STORAGE_KEYS.IMAGE_UPLOAD_URL, imageUploadUrl);
    }

    // Runwareã®URLã‹ã©ã†ã‹ã‚’åˆ¤å®š
    function isRunwareUrl(url) {
        return url && (url.includes('runware.ai') || url.includes('im.runware'));
    }

    // Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®URLã‹ã©ã†ã‹ã‚’åˆ¤å®š
    function isGoogleDriveUrl(url) {
        return url && (url.includes('drive.google.com') || url.includes('lh3.googleusercontent.com'));
    }

    // Googleãƒ‰ãƒ©ã‚¤ãƒ–URLã‹ã‚‰fileIdã‚’æŠ½å‡º
    function extractGoogleDriveFileId(url) {
        if (!url) return null;
        let match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match) return match[1];
        match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (match) return match[1];
        return null;
    }

    // ç”»åƒURLã‚’Base64ã«å¤‰æ›
    async function imageUrlToBase64(url) {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // GASã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦æ°¸ç¶šURLã‚’å–å¾—
    async function uploadImageToGas(baseUrl, base64Data, filename, oldFileId = null) {
        const payload = {
            filename: filename,
            mimeType: 'image/png',
            image: base64Data
        };

        if (oldFileId) {
            payload.oldFileId = oldFileId;
        }

        const response = await fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.status === 'success' && result.data && result.data.directUrl) {
            return result.data.directUrl;
        }
        throw new Error(result.message || 'ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');
    }

    function showStatusWithDetail(msg, type = 'ok') {
        showStatus(msg, type);
        const detailStatus = document.getElementById('detail-status');
        if (detailStatus && currentDetailIndex >= 0) {
            detailStatus.textContent = msg;
            detailStatus.className = type === 'error' ? 'status-err' : type === 'loading' ? 'status-loading' : 'status-ok';
            if (type === 'ok') {
                setTimeout(() => {
                    detailStatus.textContent = '';
                    detailStatus.className = '';
                }, 3000);
            }
        }
    }

    async function loadAllFromGas() {
        const baseUrl = document.getElementById('apiUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        doSaveSettings();
        showStatusWithDetail('èª­ã¿è¾¼ã¿ä¸­...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData, relationshipData, costumeData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action'),
                fetchGasData(baseUrl, 'relationship'),
                fetchGasData(baseUrl, 'costume')
            ]);

            models = parseModels(modelData);
            characters = parseCharacters(characterData);
            actions = parseActionsWithCompositions(actionData);
            relationships = parseRelationships(relationshipData);
            costumes = parseCostumes(costumeData);

            // å ´æ‰€è¨­å®šï¼ˆç”»åƒURLå‡¦ç†ãŒã‚ã‚‹ãŸã‚å€‹åˆ¥ï¼‰
            originalGasImages = {};
            places = parsePlaces(placeData);
            places.forEach((place, index) => {
                const item = placeData[index];
                if (item.image) {
                    placeImages[place.place_id] = item.image;
                    if (isGoogleDriveUrl(item.image)) {
                        originalGasImages[place.name] = item.image;
                    }
                }
            });

            saveCachedData();
            renderPlaceGrid();
            renderPlaceTree();
            showStatusWithDetail(`èª­ã¿è¾¼ã¿å®Œäº†: ãƒ¢ãƒ‡ãƒ«${Object.keys(models).length}ä»¶, ã‚­ãƒ£ãƒ©${characters.length}ä»¶, å ´æ‰€${places.length}ä»¶, ã‚¢ã‚¯ã‚·ãƒ§ãƒ³${actions.length}ä»¶`);
        } catch (error) {
            console.error(error);
            showStatusWithDetail('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    async function saveToGas() {
        const baseUrl = document.getElementById('apiUrl').value.trim();
        const imageUploadUrl = document.getElementById('imageUploadUrl').value.trim();

        if (!baseUrl) {
            alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        if (places.length === 0) {
            alert('ä¿å­˜ã™ã‚‹å ´æ‰€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const runwareCount = places.filter(place => isRunwareUrl(placeImages[place.place_id])).length;
        if (runwareCount > 0 && !imageUploadUrl) {
            alert('Runwareç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€Œç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰GAS URLã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        let confirmMsg = `${places.length} ä»¶ã®å ´æ‰€ã‚’GASã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`;
        if (runwareCount > 0) {
            confirmMsg += `\n\nâ€» ${runwareCount} ä»¶ã®Runwareç”»åƒã‚’GASã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰`;
        }
        if (!confirm(confirmMsg)) return;

        doSaveSettings();
        showStatusWithDetail('ä¿å­˜ä¸­...', 'loading');

        try {
            // Runwareç”»åƒã‚’GASã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            for (let i = 0; i < places.length; i++) {
                const place = places[i];
                const imageUrl = placeImages[place.place_id];

                if (isRunwareUrl(imageUrl)) {
                    showStatusWithDetail(`ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ${i + 1}/${places.length} (${place.name})`, 'loading');
                    try {
                        const base64Data = await imageUrlToBase64(imageUrl);
                        const safeName = (place.name || 'place').replace(/[\/\\:*?"<>|,\s]+/g, '_').replace(/^_+|_+$/g, '');
                        const filename = `place_${safeName}.png`;
                        const oldImageUrl = originalGasImages[place.name];
                        const oldFileId = oldImageUrl ? extractGoogleDriveFileId(oldImageUrl) : null;

                        const gasUrl = await uploadImageToGas(imageUploadUrl, base64Data, filename, oldFileId);
                        placeImages[place.place_id] = gasUrl;
                        originalGasImages[place.name] = gasUrl;
                        saveCachedData();

                        const imageDiv = document.getElementById(`image-${i}`);
                        if (imageDiv) {
                            imageDiv.innerHTML = `<img src="${gasUrl}" alt="${place.name}" onclick="openDetailPage(${i})">`;
                        }
                    } catch (error) {
                        console.error(`${place.name}ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—:`, error);
                    }
                }
            }

            const gasData = places.map(place => ({
                'place_id': place.place_id || '',
                'name': place.name,
                'description': place.description || '',
                'tag': place.tag,
                'additional tag': place.additionalTag,
                'req_stage': place.req_stage || '',
                'root_place': place.root_place || '',
                'default action': place.default_action || '',
                'image': placeImages[place.place_id] || ''
            }));

            showStatusWithDetail('å ´æ‰€ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­...', 'loading');
            const result = await saveGasData(baseUrl, 'place', gasData);

            if (result.status === 'success') {
                showStatusWithDetail('GASã«ä¿å­˜ã—ã¾ã—ãŸ: ' + result.message);
            } else {
                throw new Error(result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        } catch (error) {
            console.error(error);
            showStatusWithDetail('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        }
    }

    // ãƒ„ãƒªãƒ¼æ§‹é€ ã‚’æ§‹ç¯‰
    function buildPlaceTree() {
        const tree = { roots: [], children: {} };

        // å­å ´æ‰€ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
        places.forEach((place, index) => {
            place._index = index;
            if (place.root_place) {
                if (!tree.children[place.root_place]) {
                    tree.children[place.root_place] = [];
                }
                tree.children[place.root_place].push(place);
            } else {
                tree.roots.push(place);
            }
        });

        return tree;
    }

    // ãƒ„ãƒªãƒ¼ãƒãƒ¼ãƒ‰ã®HTMLã‚’å†å¸°çš„ã«ç”Ÿæˆ
    function renderTreeNode(place, tree, level = 0) {
        const children = tree.children[place.place_id] || [];
        const hasChildren = children.length > 0;
        const isSelected = currentDetailIndex === place._index;

        let html = `
            <div class="tree-node">
                <div class="tree-item ${isSelected ? 'selected' : ''}" onclick="selectPlaceFromTree(${place._index})" data-index="${place._index}">
                    <span class="tree-toggle">${hasChildren ? 'â–¼' : 'ã€€'}</span>
                    <span class="tree-icon">ğŸ“</span>
                    <span class="tree-name">${place.name || '(åå‰æœªè¨­å®š)'}</span>
                </div>
        `;

        if (hasChildren) {
            html += '<div class="tree-children">';
            children.forEach(child => {
                html += renderTreeNode(child, tree, level + 1);
            });
            html += '</div>';
        }

        html += '</div>';
        return html;
    }

    // ãƒ„ãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderPlaceTree() {
        const container = document.getElementById('place-tree');

        if (places.length === 0) {
            container.innerHTML = '<div style="color: #666; font-size: 0.85rem;">å ´æ‰€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        const tree = buildPlaceTree();
        let html = '';

        // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        tree.roots.forEach(place => {
            html += renderTreeNode(place, tree);
        });

        // å­¤ç«‹ãƒãƒ¼ãƒ‰ï¼ˆè¦ªãŒå­˜åœ¨ã—ãªã„å­ãƒãƒ¼ãƒ‰ï¼‰ã‚’è¡¨ç¤º
        const orphans = places.filter(place => {
            if (!place.root_place) return false;
            return !places.some(p => p.place_id === place.root_place);
        });

        if (orphans.length > 0) {
            html += '<div class="tree-root-label">ï¼ˆè¦ªãªã—ï¼‰</div>';
            orphans.forEach(place => {
                html += renderTreeNode(place, tree);
            });
        }

        container.innerHTML = html;
    }

    // ãƒ„ãƒªãƒ¼ã‹ã‚‰å ´æ‰€ã‚’é¸æŠ
    function selectPlaceFromTree(index) {
        openDetailPage(index);
    }

    function renderPlaceGrid() {
        const container = document.getElementById('place-grid');

        if (places.length === 0) {
            container.innerHTML = '<div class="empty-message">å ´æ‰€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        container.innerHTML = places.map((place, index) => `
            <div class="card" id="card-${index}">
                <div class="card-image" id="image-${index}">
                    ${placeImages[place.place_id]
                        ? `<img src="${placeImages[place.place_id]}" alt="${place.name}" onclick="openDetailPage(${index})">`
                        : `<div class="placeholder" onclick="openDetailPage(${index})" style="cursor:pointer;">ç”»åƒæœªç”Ÿæˆ</div>`
                    }
                </div>
                <div class="card-info">
                    <div class="card-name">${place.name || '(åå‰æœªè¨­å®š)'}</div>
                    <div class="place-tag">${place.tag || ''}</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-generate btn-small" onclick="generateSingleImage(${index})">ç”»åƒç”Ÿæˆ</button>
                </div>
            </div>
        `).join('');
    }

    function getFirstModel() {
        return Object.keys(models)[0] || null;
    }

    // selectBestComposition ã¯ js/prompt-utils.js ã§å®šç¾©

    function validateGenerateSettings() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return null;
        }
        const modelId = getFirstModel();
        if (!modelId) {
            alert('ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚GASã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
            return null;
        }
        doSaveSettings();
        return { apiKey, modelId };
    }

    function buildPlacePrompt(placeIndex) {
        const place = places[placeIndex];
        if (!place) return '';

        const model = models[getFirstModel()] || {};
        const charIndex = parseInt(document.getElementById('preview-character')?.value) || 0;
        const actionIndex = parseInt(document.getElementById('preview-action')?.value) || 0;
        const char = characters[charIndex] || characters[0] || {};
        const action = actions[actionIndex] || actions[0] || {};

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸBESTæ§‹å›³ã‚’é¸æŠ
        const selectedComp = selectBestComposition(action.compositions);
        const compositionTag = selectedComp ? (selectedComp.tag || selectedComp.name) : 'front view';

        return [
            model.qualityPositive || '',
            char.tag || '',
            place.tag || '',
            action.prompt || '',
            compositionTag,
            place.additionalTag || '',
            char.additionalTag || ''
        ].filter(p => p).join(', ');
    }

    async function generateSingleImage(placeIndex) {
        const settings = validateGenerateSettings();
        if (!settings) return;

        const place = places[placeIndex];
        const imageDiv = document.getElementById(`image-${placeIndex}`);
        imageDiv.innerHTML = '<div class="generating">ç”Ÿæˆä¸­...</div>';

        try {
            const prompt = buildPlacePrompt(placeIndex);
            const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
            placeImages[place.place_id] = imageUrl;
            saveCachedData();
            imageDiv.innerHTML = `<img src="${imageUrl}" alt="${place.name}" onclick="openDetailPage(${placeIndex})">`;
        } catch (error) {
            console.error(error);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        }
    }

    async function generateAllImages() {
        const settings = validateGenerateSettings();
        if (!settings) return;

        if (places.length === 0) {
            alert('å ´æ‰€ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const btn = document.getElementById('generateAllBtn');
        btn.disabled = true;
        showStatusWithDetail(`ç”»åƒç”Ÿæˆä¸­: 0/${places.length}`, 'loading');

        for (let i = 0; i < places.length; i++) {
            const place = places[i];
            const imageDiv = document.getElementById(`image-${i}`);
            imageDiv.innerHTML = '<div class="generating">ç”Ÿæˆä¸­...</div>';

            try {
                const prompt = buildPlacePrompt(i);
                const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
                placeImages[place.place_id] = imageUrl;
                saveCachedData();
                imageDiv.innerHTML = `<img src="${imageUrl}" alt="${place.name}" onclick="openDetailPage(${i})">`;
                showStatusWithDetail(`ç”»åƒç”Ÿæˆä¸­: ${i + 1}/${places.length}`, 'loading');
            } catch (error) {
                console.error(error);
                imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼</div>`;
            }

            if (i < places.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        btn.disabled = false;
        showStatusWithDetail(`ç”»åƒç”Ÿæˆå®Œäº†: ${places.length}ä»¶`);
    }

    function openDetailPage(index) {
        const place = places[index];
        if (!place) return;

        currentDetailIndex = index;
        updateDetailPage();

        // ã‚°ãƒªãƒƒãƒ‰ã‚’éè¡¨ç¤ºã€è©³ç´°ã‚’è¡¨ç¤º
        document.getElementById('place-grid').style.display = 'none';
        document.getElementById('detail-page').classList.add('active');

        // ãƒ„ãƒªãƒ¼ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        renderPlaceTree();
    }

    function updateDetailPage() {
        const place = places[currentDetailIndex];
        if (!place) return;

        document.getElementById('detail-place-id').textContent = place.place_id || '(æœªè¨­å®š)';
        document.getElementById('detail-name').value = place.name || '';
        document.getElementById('detail-description').value = place.description || '';
        document.getElementById('detail-req-stage').value = place.req_stage || '';
        updateRootPlaceSelect(place.root_place);
        updateDefaultActionSelect(place.default_action);
        document.getElementById('detail-tag').value = place.tag || '';
        document.getElementById('detail-additional').value = place.additionalTag || '';

        const imageDiv = document.getElementById('detail-image');
        const imageUrl = placeImages[place.place_id];
        imageDiv.innerHTML = imageUrl
            ? `<img src="${imageUrl}" alt="${place.name}" onclick="window.open('${imageUrl}', '_blank')">`
            : '<div class="placeholder">ç”»åƒæœªç”Ÿæˆ</div>';

        updatePreviewSelects();
        document.getElementById('btn-prev').disabled = currentDetailIndex <= 0;
        document.getElementById('btn-next').disabled = currentDetailIndex >= places.length - 1;
    }

    function updatePreviewSelects() {
        const charSelect = document.getElementById('preview-character');
        const actionSelect = document.getElementById('preview-action');

        const charValue = charSelect.value;
        const actionValue = actionSelect.value;

        charSelect.innerHTML = characters.map((char, index) =>
            `<option value="${index}">${char.name || '(åå‰ãªã—)'}</option>`
        ).join('');

        actionSelect.innerHTML = actions.map((action, index) =>
            `<option value="${index}">${action.name || '(åå‰ãªã—)'}</option>`
        ).join('');

        if (charValue !== '' && parseInt(charValue) < characters.length) charSelect.value = charValue;
        if (actionValue !== '' && parseInt(actionValue) < actions.length) actionSelect.value = actionValue;
    }

    function closeDetailPage() {
        document.getElementById('detail-page').classList.remove('active');
        document.getElementById('place-grid').style.display = '';
        currentDetailIndex = -1;

        // ãƒ„ãƒªãƒ¼ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
        renderPlaceTree();
    }

    function updatePlaceName(name) {
        if (currentDetailIndex < 0) return;
        const place = places[currentDetailIndex];
        if (!place) return;

        place.name = name;
        saveCachedData();
        renderPlaceGrid();
        renderPlaceTree();
    }

    function updateRootPlaceSelect(currentValue) {
        const select = document.getElementById('detail-root-place');
        const currentPlace = places[currentDetailIndex];

        let options = '<option value="">ï¼ˆãªã—ï¼‰</option>';
        places.forEach(place => {
            // è‡ªåˆ†è‡ªèº«ã¯é¸æŠè‚¢ã‹ã‚‰é™¤å¤–
            if (currentPlace && place.place_id === currentPlace.place_id) return;
            const selected = place.place_id === currentValue ? 'selected' : '';
            const displayName = place.name || place.place_id;
            options += `<option value="${place.place_id}" ${selected}>${displayName}</option>`;
        });
        select.innerHTML = options;
    }

    function updateDefaultActionSelect(currentValue) {
        const select = document.getElementById('detail-default-action');

        let options = '<option value="">ï¼ˆãªã—ï¼‰</option>';
        actions.forEach(action => {
            const selected = action.action_id === currentValue ? 'selected' : '';
            const displayName = action.name || action.action_id;
            options += `<option value="${action.action_id}" ${selected}>${displayName}</option>`;
        });
        select.innerHTML = options;
    }

    function updatePlaceField(field, value) {
        if (currentDetailIndex < 0) return;
        const place = places[currentDetailIndex];
        if (!place) return;

        place[field] = value;
        saveCachedData();
        renderPlaceGrid();

        // root_placeãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ãƒ„ãƒªãƒ¼ã‚’æ›´æ–°
        if (field === 'root_place') {
            renderPlaceTree();
        }
    }

    function navigatePlace(direction) {
        const newIndex = currentDetailIndex + direction;
        if (newIndex >= 0 && newIndex < places.length) {
            currentDetailIndex = newIndex;
            updateDetailPage();
            renderPlaceTree();
        }
    }

    async function generateDetailImage() {
        if (currentDetailIndex < 0) return;

        const settings = validateGenerateSettings();
        if (!settings) return;

        const place = places[currentDetailIndex];
        const detailImageDiv = document.getElementById('detail-image');
        const cardImageDiv = document.getElementById(`image-${currentDetailIndex}`);

        detailImageDiv.innerHTML = '<div class="placeholder">ç”Ÿæˆä¸­...</div>';

        try {
            const prompt = buildPlacePrompt(currentDetailIndex);
            const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
            placeImages[place.place_id] = imageUrl;
            saveCachedData();

            detailImageDiv.innerHTML = `<img src="${imageUrl}" alt="${place.name}" onclick="window.open('${imageUrl}', '_blank')">`;
            cardImageDiv.innerHTML = `<img src="${imageUrl}" alt="${place.name}" onclick="openDetailPage(${currentDetailIndex})">`;
        } catch (error) {
            console.error(error);
            detailImageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        }
    }

    // é¸æŠä¸­ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
    function getSelectedCharacter() {
        const charIndex = parseInt(document.getElementById('preview-character')?.value);
        return charIndex >= 0 ? (characters[charIndex] || null) : null;
    }

    async function generateImageWithPrompt(modelId, apiKey, prompt) {
        const model = models[modelId] || {};
        const result = await generateImage(apiKey, modelId, prompt, {
            negativePrompt: model.qualityNegative || '',
            steps: model.steps || 20,
            cfgScale: model.cfgScale || 7,
            scheduler: model.scheduler || 'Default',
            character: getSelectedCharacter()
        });
        return result.imageURL;
    }
</script>

</body>
</html>
