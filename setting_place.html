<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>場所設定</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        /* ページ固有スタイル */
        .place-tag {
            font-size: 0.7rem;
            color: #aaa;
            line-height: 1.3;
            max-height: 50px;
            overflow-y: auto;
        }

        .detail-header .btn-save {
            margin-right: 10px;
        }

        .detail-header #detail-status {
            margin-right: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>場所設定</h1>

    <!-- 場所グリッド -->
    <div id="place-grid" class="card-grid">
        <div class="empty-message">「GASから読み込み」ボタンで場所データを読み込んでください</div>
    </div>

    <!-- 設定バー -->
    <div class="settings-bar" style="margin-top: 20px;">
        <div class="settings-row">
            <label>GAS URL:</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/xxxxxx/exec">
            <button class="btn btn-primary" onclick="loadAllFromGas()">GASから読み込み</button>
            <button class="btn btn-save" onclick="saveToGas()">GASに保存</button>
            <button class="btn btn-generate" onclick="generateAllImages()" id="generateAllBtn">全場所画像生成</button>
        </div>
        <div class="settings-row">
            <label>Runware API Key:</label>
            <input type="password" id="apiKey" placeholder="Runware API Keyを入力">
        </div>
        <div id="status"></div>
    </div>
</div>

<!-- 場所詳細ページ -->
<div id="detail-page" class="detail-page">
    <div class="detail-header">
        <button class="detail-back" onclick="closeDetailPage()">← 戻る</button>
        <h1 class="detail-title" id="detail-title"></h1>
        <div class="header-selects">
            <label>キャラ:</label>
            <select id="preview-character"></select>
            <label>アクション:</label>
            <select id="preview-action"></select>
        </div>
        <button class="btn btn-save" onclick="saveToGas()">GASに保存</button>
        <div id="detail-status"></div>
        <div class="detail-nav">
            <button class="btn btn-nav" onclick="navigatePlace(-1)" id="btn-prev">← 前</button>
            <button class="btn btn-nav" onclick="navigatePlace(1)" id="btn-next">次 →</button>
        </div>
    </div>
    <div class="detail-content">
        <div class="detail-main">
            <div class="detail-image-section">
                <div class="detail-image-area" id="detail-image"></div>
                <button class="btn btn-generate" onclick="generateDetailImage()">画像生成</button>
            </div>
            <div class="detail-info">
                <div class="field-label">場所タグ</div>
                <textarea class="field-textarea" id="detail-tag" onchange="updatePlaceField('tag', this.value)"></textarea>
                <div class="field-label">追加タグ</div>
                <textarea class="field-textarea" id="detail-additional" onchange="updatePlaceField('additionalTag', this.value)"></textarea>
            </div>
        </div>
    </div>
</div>

<script src="js/constants.js"></script>
<script src="js/gas-api.js"></script>
<script src="js/runware-api.js"></script>
<script src="js/storage.js"></script>
<script src="js/data-parser.js"></script>
<script src="js/ui-utils.js"></script>
<script>
    const GAS_DATA_KEY = 'gas_data_cache_place';
    const PLACE_IMAGES_KEY = 'place_images';

    // データストア
    let models = {};
    let characters = [];
    let places = [];
    let actions = [];
    let placeImages = {};
    let currentDetailIndex = -1;

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
        const settings = loadSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY);
        if (settings.gasUrl) document.getElementById('apiUrl').value = settings.gasUrl;
        if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
        loadCachedData();
    });

    // キーボードナビゲーション
    document.addEventListener('keydown', (e) => {
        if (currentDetailIndex < 0) return;
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigatePlace(-1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigatePlace(1);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            closeDetailPage();
        }
    });

    function saveCachedData() {
        const data = { models, characters, places, actions };
        localStorage.setItem(GAS_DATA_KEY, JSON.stringify(data));
        localStorage.setItem(PLACE_IMAGES_KEY, JSON.stringify(placeImages));
    }

    function loadCachedData() {
        try {
            const cachedData = localStorage.getItem(GAS_DATA_KEY);
            if (cachedData) {
                const data = JSON.parse(cachedData);
                models = data.models || {};
                characters = data.characters || [];
                places = data.places || [];
                actions = data.actions || [];
            }
            const cachedImages = localStorage.getItem(PLACE_IMAGES_KEY);
            if (cachedImages) placeImages = JSON.parse(cachedImages);

            if (places.length > 0) {
                renderPlaceGrid();
                showStatusWithDetail(`キャッシュから復元: 場所${places.length}件`);
            }
        } catch (error) {
            console.error('キャッシュ復元エラー:', error);
        }
    }

    function doSaveSettings() {
        const gasUrl = document.getElementById('apiUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        saveSettings(STORAGE_KEYS.GAS_URL, STORAGE_KEYS.API_KEY, gasUrl, apiKey);
    }

    function showStatusWithDetail(msg, type = 'ok') {
        showStatus(msg, type);
        const detailStatus = document.getElementById('detail-status');
        if (detailStatus && currentDetailIndex >= 0) {
            detailStatus.textContent = msg;
            detailStatus.className = type === 'error' ? 'status-err' : type === 'loading' ? 'status-loading' : 'status-ok';
            if (type === 'ok') {
                setTimeout(() => {
                    detailStatus.textContent = '';
                    detailStatus.className = '';
                }, 3000);
            }
        }
    }

    async function loadAllFromGas() {
        const baseUrl = document.getElementById('apiUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }

        doSaveSettings();
        showStatusWithDetail('読み込み中...', 'loading');

        try {
            const [modelData, characterData, placeData, actionData] = await Promise.all([
                fetchGasData(baseUrl, 'model'),
                fetchGasData(baseUrl, 'character'),
                fetchGasData(baseUrl, 'place'),
                fetchGasData(baseUrl, 'action')
            ]);

            models = parseModels(modelData);
            characters = parseCharacters(characterData);
            places = parsePlaces(placeData);
            actions = parseActionsWithCompositions(actionData);

            saveCachedData();
            renderPlaceGrid();
            showStatusWithDetail(`読み込み完了: モデル${Object.keys(models).length}件, キャラ${characters.length}件, 場所${places.length}件, アクション${actions.length}件`);
        } catch (error) {
            console.error(error);
            showStatusWithDetail('読み込みエラー: ' + error.message, 'error');
        }
    }

    async function saveToGas() {
        const baseUrl = document.getElementById('apiUrl').value.trim();
        if (!baseUrl) {
            alert('GAS URLを入力してください');
            return;
        }
        if (places.length === 0) {
            alert('保存する場所データがありません');
            return;
        }

        doSaveSettings();
        showStatusWithDetail('GASに保存中...', 'loading');

        try {
            const gasData = places.map(place => ({
                'name': place.name,
                'tag': place.tag,
                'additional tag': place.additionalTag
            }));

            const result = await saveGasData(baseUrl, 'place', gasData);

            if (result.status === 'success') {
                showStatusWithDetail('GASに保存しました: ' + result.message);
            } else {
                throw new Error(result.message || '保存に失敗しました');
            }
        } catch (error) {
            console.error(error);
            showStatusWithDetail('保存エラー: ' + error.message, 'error');
        }
    }

    function renderPlaceGrid() {
        const container = document.getElementById('place-grid');

        if (places.length === 0) {
            container.innerHTML = '<div class="empty-message">場所データがありません</div>';
            return;
        }

        container.innerHTML = places.map((place, index) => `
            <div class="card" id="card-${index}">
                <div class="card-image" id="image-${index}">
                    ${placeImages[place.name]
                        ? `<img src="${placeImages[place.name]}" alt="${place.name}" onclick="openDetailPage(${index})">`
                        : `<div class="placeholder" onclick="openDetailPage(${index})" style="cursor:pointer;">画像未生成</div>`
                    }
                </div>
                <div class="card-info">
                    <div class="card-name">${place.name || '(名前未設定)'}</div>
                    <div class="place-tag">${place.tag || ''}</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-generate btn-small" onclick="generateSingleImage(${index})">画像生成</button>
                </div>
            </div>
        `).join('');
    }

    function getFirstModel() {
        return Object.keys(models)[0] || null;
    }

    // BEST → GOOD → 未評価 の優先順位で構図を選択
    function selectBestComposition(action) {
        if (!action || !action.compositions) return null;

        const best = action.compositions.find(c => c.quality === 'best');
        if (best) return best;

        const good = action.compositions.find(c => c.quality === 'good');
        if (good) return good;

        const none = action.compositions.find(c => c.quality === '未評価');
        if (none) return none;

        return action.compositions[0] || null;
    }

    function validateGenerateSettings() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) {
            alert('Runware API Keyを入力してください');
            return null;
        }
        const modelId = getFirstModel();
        if (!modelId) {
            alert('モデルが見つかりません。GASから読み込んでください。');
            return null;
        }
        doSaveSettings();
        return { apiKey, modelId };
    }

    function buildPlacePrompt(placeIndex) {
        const place = places[placeIndex];
        if (!place) return '';

        const model = models[getFirstModel()] || {};
        const charIndex = parseInt(document.getElementById('preview-character')?.value) || 0;
        const actionIndex = parseInt(document.getElementById('preview-action')?.value) || 0;
        const char = characters[charIndex] || characters[0] || {};
        const action = actions[actionIndex] || actions[0] || {};

        // アクションに応じたBEST構図を選択
        const selectedComp = selectBestComposition(action);
        const compositionTag = selectedComp ? (selectedComp.tag || selectedComp.name) : 'front view';

        return [
            model.qualityPositive || '',
            char.tag || '',
            place.tag || '',
            action.prompt || '',
            compositionTag,
            place.additionalTag || '',
            char.additionalTag || ''
        ].filter(p => p).join(', ');
    }

    async function generateSingleImage(placeIndex) {
        const settings = validateGenerateSettings();
        if (!settings) return;

        const place = places[placeIndex];
        const imageDiv = document.getElementById(`image-${placeIndex}`);
        imageDiv.innerHTML = '<div class="generating">生成中...</div>';

        try {
            const prompt = buildPlacePrompt(placeIndex);
            const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
            placeImages[place.name] = imageUrl;
            saveCachedData();
            imageDiv.innerHTML = `<img src="${imageUrl}" alt="${place.name}" onclick="openDetailPage(${placeIndex})">`;
        } catch (error) {
            console.error(error);
            imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        }
    }

    async function generateAllImages() {
        const settings = validateGenerateSettings();
        if (!settings) return;

        if (places.length === 0) {
            alert('場所がありません');
            return;
        }

        const btn = document.getElementById('generateAllBtn');
        btn.disabled = true;
        showStatusWithDetail(`画像生成中: 0/${places.length}`, 'loading');

        for (let i = 0; i < places.length; i++) {
            const place = places[i];
            const imageDiv = document.getElementById(`image-${i}`);
            imageDiv.innerHTML = '<div class="generating">生成中...</div>';

            try {
                const prompt = buildPlacePrompt(i);
                const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
                placeImages[place.name] = imageUrl;
                saveCachedData();
                imageDiv.innerHTML = `<img src="${imageUrl}" alt="${place.name}" onclick="openDetailPage(${i})">`;
                showStatusWithDetail(`画像生成中: ${i + 1}/${places.length}`, 'loading');
            } catch (error) {
                console.error(error);
                imageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー</div>`;
            }

            if (i < places.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        btn.disabled = false;
        showStatusWithDetail(`画像生成完了: ${places.length}件`);
    }

    function openDetailPage(index) {
        const place = places[index];
        if (!place) return;

        currentDetailIndex = index;
        updateDetailPage();
        document.getElementById('detail-page').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function updateDetailPage() {
        const place = places[currentDetailIndex];
        if (!place) return;

        document.getElementById('detail-title').textContent = place.name || '(名前未設定)';
        document.getElementById('detail-tag').value = place.tag || '';
        document.getElementById('detail-additional').value = place.additionalTag || '';

        const imageDiv = document.getElementById('detail-image');
        const imageUrl = placeImages[place.name];
        imageDiv.innerHTML = imageUrl
            ? `<img src="${imageUrl}" alt="${place.name}" onclick="window.open('${imageUrl}', '_blank')">`
            : '<div class="placeholder">画像未生成</div>';

        updatePreviewSelects();
        document.getElementById('btn-prev').disabled = currentDetailIndex <= 0;
        document.getElementById('btn-next').disabled = currentDetailIndex >= places.length - 1;
    }

    function updatePreviewSelects() {
        const charSelect = document.getElementById('preview-character');
        const actionSelect = document.getElementById('preview-action');

        const charValue = charSelect.value;
        const actionValue = actionSelect.value;

        charSelect.innerHTML = characters.map((char, index) =>
            `<option value="${index}">${char.name || '(名前なし)'}</option>`
        ).join('');

        actionSelect.innerHTML = actions.map((action, index) =>
            `<option value="${index}">${action.name || '(名前なし)'}</option>`
        ).join('');

        if (charValue !== '' && parseInt(charValue) < characters.length) charSelect.value = charValue;
        if (actionValue !== '' && parseInt(actionValue) < actions.length) actionSelect.value = actionValue;
    }

    function closeDetailPage() {
        document.getElementById('detail-page').classList.remove('active');
        document.body.style.overflow = '';
        currentDetailIndex = -1;
    }

    function updatePlaceField(field, value) {
        if (currentDetailIndex < 0) return;
        const place = places[currentDetailIndex];
        if (!place) return;

        place[field] = value;
        saveCachedData();
        renderPlaceGrid();
    }

    function navigatePlace(direction) {
        const newIndex = currentDetailIndex + direction;
        if (newIndex >= 0 && newIndex < places.length) {
            currentDetailIndex = newIndex;
            updateDetailPage();
        }
    }

    async function generateDetailImage() {
        if (currentDetailIndex < 0) return;

        const settings = validateGenerateSettings();
        if (!settings) return;

        const place = places[currentDetailIndex];
        const detailImageDiv = document.getElementById('detail-image');
        const cardImageDiv = document.getElementById(`image-${currentDetailIndex}`);

        detailImageDiv.innerHTML = '<div class="placeholder">生成中...</div>';

        try {
            const prompt = buildPlacePrompt(currentDetailIndex);
            const imageUrl = await generateImageWithPrompt(settings.modelId, settings.apiKey, prompt);
            placeImages[place.name] = imageUrl;
            saveCachedData();

            detailImageDiv.innerHTML = `<img src="${imageUrl}" alt="${place.name}" onclick="window.open('${imageUrl}', '_blank')">`;
            cardImageDiv.innerHTML = `<img src="${imageUrl}" alt="${place.name}" onclick="openDetailPage(${currentDetailIndex})">`;
        } catch (error) {
            console.error(error);
            detailImageDiv.innerHTML = `<div class="placeholder" style="color: #e74c3c;">エラー: ${error.message}</div>`;
        }
    }

    async function generateImageWithPrompt(modelId, apiKey, prompt) {
        const model = models[modelId] || {};
        const result = await generateImage(apiKey, modelId, prompt, {
            negativePrompt: model.qualityNegative || '',
            steps: model.steps || 20,
            cfgScale: model.cfgScale || 7,
            scheduler: model.scheduler || 'Default'
        });
        return result.imageURL;
    }
</script>

</body>
</html>
